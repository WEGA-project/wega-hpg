<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPG Community - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏</title>
    
    <style>
        * {
            margin: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: url('assets/background01.jpg') center/cover fixed no-repeat;
            background-color: #5a9e9e;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .logo-icon {
            font-size: 32px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a9d9d 0%, #2d7a7a 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(74, 157, 157, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 157, 157, 0.5);
        }

        .btn-secondary {
            background: rgba(74, 157, 157, 0.15);
            color: #2d7a7a;
            border: 2px solid rgba(74, 157, 157, 0.4);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.15);
        }

        .btn-secondary:hover {
            background: rgba(74, 157, 157, 0.25);
            color: #1a5555;
            border-color: rgba(74, 157, 157, 0.6);
            box-shadow: 0 4px 12px rgba(45, 122, 122, 0.25);
            transform: translateY(-1px);
        }
        
        .btn-light {
            background: rgba(255, 255, 255, 0.9);
            color: #4a9d9d;
            border: 2px solid rgba(74, 157, 157, 0.3);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.1);
        }

        .btn-light:hover {
            background: rgba(255, 255, 255, 1);
            color: #2d7a7a;
            border-color: rgba(74, 157, 157, 0.5);
            box-shadow: 0 4px 12px rgba(45, 122, 122, 0.2);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .main-content {
            min-width: 0;
        }
        
        .activity-feed {
            position: sticky;
            top: 90px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .activity-feed h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #2d7a7a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .activity-item {
            padding: 16px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            border: 1px solid rgba(74, 157, 157, 0.2);
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.1);
        }
        
        .activity-item:hover {
            border-color: #4a9d9d;
            box-shadow: 0 4px 16px rgba(45, 122, 122, 0.2);
            transform: translateY(-2px);
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4a9d9d;
            flex-shrink: 0;
        }
        
        .activity-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .activity-user {
            font-weight: 600;
            color: #333;
            display: block;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .activity-action {
            font-size: 12px;
            color: #4a9d9d;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .activity-icon {
            font-size: 14px;
        }
        
        .activity-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }
        
        .activity-body {
            margin-bottom: 12px;
        }
        
        .activity-profile-card {
            background: #f8f9ff;
            border: 1px solid #e8ecff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }
        
        .activity-profile-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .activity-profile-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .activity-profile-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .activity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .activity-tag {
            background: #4a9d9d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .activity-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .activity-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        
        .activity-btn-primary {
            background: #4a9d9d;
            color: white;
        }
        
        .activity-btn-primary:hover {
            background: #3d8585;
            transform: translateY(-1px);
        }
        
        .activity-btn-secondary {
            background: white;
            color: #4a9d9d;
            border: 1px solid #4a9d9d;
        }
        
        .activity-btn-secondary:hover {
            background: #f0f9f9;
        }
        
        .activity-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .activity-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .hero {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .hero p {
            font-size: 20px;
            opacity: 0.95;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #999;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: flex;
            gap: 10px;
            align-items: center;
            color: #666;
            font-size: 14px;
        }
        
        .user-filter {
            display: flex;
            gap: 8px;
            background: white;
            border: 2px solid #4a9d9d;
            border-radius: 8px;
            padding: 4px;
        }
        
        .user-filter-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #4a9d9d;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .user-filter-btn:hover {
            background: #f0f9f9;
        }
        
        .user-filter-btn.active {
            background: #4a9d9d;
            color: white;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .profile-card {
            background: white;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .profile-photos-collage {
            position: relative;
            height: 180px;
            margin: 15px;
            perspective: 1000px;
        }
        
        .collage-photo {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            object-fit: cover;
            border: 3px solid white;
            transition: all 0.3s ease;
        }
        
        .collage-photo:nth-child(1) {
            top: 20px;
            left: 20px;
            transform: rotate(-8deg);
            z-index: 3;
        }
        
        .collage-photo:nth-child(2) {
            top: 10px;
            left: 50%;
            transform: translateX(-50%) rotate(5deg);
            z-index: 2;
        }
        
        .collage-photo:nth-child(3) {
            top: 20px;
            right: 20px;
            transform: rotate(8deg);
            z-index: 1;
        }
        
        .profile-card:hover .collage-photo:nth-child(1) {
            transform: rotate(-12deg) translateY(-5px);
        }
        
        .profile-card:hover .collage-photo:nth-child(2) {
            transform: translateX(-50%) rotate(0deg) translateY(-8px);
        }
        
        .profile-card:hover .collage-photo:nth-child(3) {
            transform: rotate(12deg) translateY(-5px);
        }
        
        .collage-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 180px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 15px;
            border-radius: 12px;
            font-size: 48px;
            opacity: 0.3;
        }

        .profile-header {
            padding: 20px 60px 22px 20px;
            background: linear-gradient(135deg, #5f8de0 0%, #6a48a5 100%);
            color: white;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-radius: 12px 12px 0 0;
        }

        .profile-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
        }

        .profile-header:hover .profile-expand-icon {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.36);
        }

        .profile-expand-icon {
            position: absolute;
            right: 22px;
            top: 22px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.24);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 12px rgba(30, 40, 90, 0.2);
        }

        .profile-title {
            font-size: 19px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 60px;
        }

        .profile-description {
            margin: 0;
            line-height: 1.45;
            font-size: 13px;
            opacity: 0.85;
            padding-left: 60px;
        }

        .author-avatar {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-body {
            padding: 20px;
        }

        .profile-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-tools {
            margin: 12px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-tools .btn-small {
            flex: none;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            padding: 5px 12px;
            background: #f0f0f0;
            border-radius: 15px;
            font-size: 12px;
            color: #555;
        }

        .profile-string-view {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-family: "Fira Code", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .journal-day {
            background: #fafbff;
            border: 1px solid #e6e9ff;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
        }
        
        .journal-day-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .journal-day-date {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e91;
        }
        
        .journal-day-weekday {
            font-size: 15px;
            color: rgba(44, 62, 145, 0.6);
            text-transform: capitalize;
            font-weight: 400;
        }
        
        .journal-day-milestones {
            font-size: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            text-align: right;
        }
        
        .journal-day-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .journal-entry {
            margin-bottom: 0;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            border-left: 4px solid #667eea;
        }
        
        .journal-entry:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .journal-entry:last-child {
            margin-bottom: 0;
        }
        
        .journal-entry-indicator {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .journal-entry-indicator-number {
            font-size: 32px;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .journal-entry-indicator-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .journal-entry-content {
            flex: 1;
            min-width: 0;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 10px;
        }

        .journal-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .journal-meta strong {
            font-size: 14px;
            color: #333;
        }

        .journal-meta span {
            font-size: 12px;
            color: #666;
        }

        .journal-description {
            font-size: 13px;
            color: #444;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .journal-entry-date {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-bottom: 10px;
        }

        .journal-profile {
            font-family: "Fira Code", "Courier New", monospace;
            font-size: 12px;
            background: #f4f7ff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #dde4ff;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }
        
        .journal-photo {
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            padding: 15px;
            border-left: 4px solid #4a9d9d;
        }
        
        .journal-photo:hover {
            box-shadow: 0 4px 12px rgba(74, 157, 157, 0.2);
        }
        
        .journal-photo-preview {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: #f5f5f5;
        }
        
        .journal-photo-preview:hover {
            transform: scale(1.05);
        }
        
        .journal-photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .journal-photo-train {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px 0;
            margin-bottom: 15px;
        }
        
        .journal-photo-train::-webkit-scrollbar {
            height: 8px;
        }
        
        .journal-photo-train::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .journal-photo-train::-webkit-scrollbar-thumb {
            background: #4a9d9d;
            border-radius: 4px;
        }
        
        .journal-photo-train::-webkit-scrollbar-thumb:hover {
            background: #3a8d8d;
        }
        
        .journal-photo-train-item {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
        }
        
        .journal-photo-train-item:hover {
            transform: scale(1.05);
            border-color: #4a9d9d;
        }
        
        .journal-photo-train-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .journal-photo-info {
            display: flex;
            flex-direction: column;
        }
        
        .journal-photo-date {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-bottom: 10px;
        }
        
        .journal-photo-description {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }
        
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-image-container {
            width: 100%;
            height: 100%;
            overflow: visible;
            cursor: grab;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-image-container.dragging {
            cursor: grabbing;
        }

        .lightbox-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            transition: transform 0.2s ease;
            user-select: none;
            -webkit-user-drag: none;
            transform-origin: center center;
        }
        
        .lightbox-controls {
            position: absolute;
            top: 70px;
            left: 20px;
            z-index: 1001;
            display: flex;
            gap: 5px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .lightbox-close:hover {
            background: #f0f0f0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-stats {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
            color: #999;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            justify-content: center;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .empty-state h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            opacity: 0.9;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .modal-content-large {
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .profile-detail {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: 100%;
        }
        
        .profile-detail-sidebar {
            border-right: 1px solid #e0e0e0;
            padding-right: 30px;
        }
        
        .profile-detail-main {
            overflow-y: auto;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        
        .profile-detail-description {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
        }
        
        .profile-detail-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .profile-detail-section {
            margin-bottom: 30px;
        }
        
        .profile-detail-section h3 {
            font-size: 18px;
            color: #2d7a7a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .profile-detail-tag {
            background: rgba(74, 157, 157, 0.1);
            color: #2d7a7a;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(74, 157, 157, 0.3);
        }
        
        .profile-detail-author {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .profile-detail-author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #4a9d9d;
        }
        
        .profile-detail-author-info {
            flex: 1;
        }
        
        .profile-detail-author-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .profile-detail-author-date {
            font-size: 12px;
            color: #999;
        }
        
        .profile-detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .profile-detail-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .profile-detail-stat[onclick]:hover {
            background: #f0f9f9;
            border-color: #4a9d9d;
            transform: translateY(-2px);
        }
        
        .profile-detail-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #4a9d9d;
            margin-bottom: 5px;
        }
        
        .profile-detail-stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .profile-gallery-placeholder {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #999;
        }
        
        @media (max-width: 968px) {
            .profile-detail {
                grid-template-columns: 1fr;
            }
            
            .profile-detail-sidebar {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding-right: 0;
                padding-bottom: 20px;
            }
            
            .profile-detail-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .profile-detail-stats {
                grid-template-columns: 1fr;
            }
        }

        .comment {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .no-comments {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .no-comments-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .comment-form {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            background: #f9f9f9;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 16px;
            }

            .profiles-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .modal-content {
                max-height: 90vh;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .activity-feed {
                position: relative;
                top: 0;
                max-height: 400px;
                order: -1;
            }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    <script src="lightbox.js"></script>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üå±</span>
                <span>HPG Community</span>
            </div>
            <div class="header-actions">
                <button id="gallery-btn" class="btn btn-secondary" onclick="window.location.href='gallery.html'" style="display: none;">
                    üì∏ –ì–∞–ª–µ—Ä–µ—è
                </button>
                <button id="upload-btn" class="btn btn-primary" onclick="showUploadForm()" style="display: none;">
                    üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </button>
                <a href="../hpg.html" class="btn btn-secondary">
                    üß™ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
                </a>
                <div id="auth-section">
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) -->
                    <button id="login-btn" class="btn btn-primary" onclick="loginWithGoogle()" style="display: none;">
                        üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                    </button>
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) -->
                    <div id="user-info" style="display: none; align-items: center; gap: 10px;">
                        <img id="user-avatar" style="width: 36px; height: 36px; border-radius: 50%;" alt="">
                        <span id="user-name" style="font-size: 14px; font-weight: 500;"></span>
                        <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 15px; font-size: 13px;">
                            –í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –ì–µ—Ä–æ–π -->
        <div class="hero">
            <h1>üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π</h1>
            <p>–ì–æ—Ç–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –≥–∏–¥—Ä–æ–ø–æ–Ω—â–∏–∫–æ–≤</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π layout —Å –¥–≤—É–º—è –∫–æ–ª–æ–Ω–∫–∞–º–∏ -->
        <div class="main-layout">
            <!-- –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Å–ª–µ–≤–∞) -->
            <div class="activity-feed">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">üì∞ –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                    <div id="activityFilterContainer" style="display: none;">
                        <div class="user-filter" style="padding: 2px;">
                            <button class="user-filter-btn active" data-filter="all" style="padding: 6px 12px; font-size: 12px;">–í—Å–µ</button>
                            <button class="user-filter-btn" data-filter="my" style="padding: 6px 12px; font-size: 12px;">–ú–æ–∏</button>
                        </div>
                    </div>
                </div>
                <div id="activityContainer">
                    <div class="activity-empty">
                        <div class="activity-empty-icon">‚è≥</div>
                        <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å–ø—Ä–∞–≤–∞) -->
            <div class="main-content">
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="filters">
                    <div class="filters-row">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é...">
                            <span class="search-icon">üîç</span>
                        </div>
                        
                        <select id="tagFilter" class="filter-select">
                            <option value="">–í—Å–µ –∫—É–ª—å—Ç—É—Ä—ã</option>
                        </select>
                        
                        <select id="sortSelect" class="filter-select">
                            <option value="views">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ ‚Üì</option>
                            <option value="date">–ü–æ –¥–∞—Ç–µ ‚Üì</option>
                            <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üë</option>
                            <option value="author">–ü–æ –∞–≤—Ç–æ—Ä—É ‚Üë</option>
                        </select>
                        
                        <div id="userFilterContainer" style="display: none;">
                            <div class="user-filter">
                                <button class="user-filter-btn active" data-filter="all">–í—Å–µ</button>
                                <button class="user-filter-btn" data-filter="my">–¢–æ–ª—å–∫–æ –º–æ–∏</button>
                            </div>
                        </div>
                        
                        <div class="stats">
                            <span id="profileCount">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>

                <!-- –°–µ—Ç–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π -->
                <div id="profilesContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAR5qXMGP8Erapla69wJ7cUbbF4MNlbkcY",
            authDomain: "wega-hpg.firebaseapp.com",
            projectId: "wega-hpg",
            storageBucket: "wega-hpg.firebasestorage.app",
            messagingSenderId: "652081809935",
            appId: "1:652081809935:web:84a407f1a6bfc719aa717a",
            measurementId: "G-W6EDZTWP3F"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        let authReady = false;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allProfiles = [];
        window.allProfiles = allProfiles; // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è lightbox
        let filteredProfiles = [];
        let userFilter = 'all'; // 'all' –∏–ª–∏ 'my' –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
        let activityFilter = 'all'; // 'all' –∏–ª–∏ 'my' –¥–ª—è –ª–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        
        // –ö–µ—à —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)
        const userPhotosCache = {};
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        const PROFILES_PER_PAGE = 24;
        let currentPage = 1;
        let totalPages = 1;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google
        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
            }
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
        let currentOpenProfileId = null;

        auth.onAuthStateChanged(user => {
            currentUser = user;
            authReady = true;
            
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email);
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('gallery-btn').style.display = 'inline-block';
                document.getElementById('upload-btn').style.display = 'block';
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-avatar').src = user.photoURL || '';
                document.getElementById('user-name').textContent = user.displayName || user.email;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ "–¢–æ–ª—å–∫–æ –º–æ–∏ / –í—Å–µ"
                document.getElementById('userFilterContainer').style.display = 'block';
                document.getElementById('activityFilterContainer').style.display = 'block';
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                if (currentOpenProfileId) {
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        modal.remove();
                        showProfileDetail(currentOpenProfileId);
                    }
                }
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('gallery-btn').style.display = 'none';
                document.getElementById('upload-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                document.getElementById('userFilterContainer').style.display = 'none';
                document.getElementById('activityFilterContainer').style.display = 'none';
                userFilter = 'all';
                activityFilter = 'all';
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
        async function loadProfiles() {
            try {
                const snapshot = await db.collection('profiles')
                    .where('public', '==', true)
                    .get();

                allProfiles = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                window.allProfiles = allProfiles; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–æ –¥–∞—Ç–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                allProfiles.sort((a, b) => {
                    return (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0);
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
                const userIds = [...new Set(allProfiles.map(p => p.userId).filter(id => id))];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ userId, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–µ—à–µ
                const uncachedUserIds = userIds.filter(id => !userPhotosCache[id]);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (uncachedUserIds.length > 0 && currentUser) {
                    try {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–∞—á–∫–∞–º–∏ (Firestore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 10 –≤ in)
                        for (let i = 0; i < uncachedUserIds.length; i += 10) {
                            const batch = uncachedUserIds.slice(i, i + 10);
                            const usersSnapshot = await db.collection('users')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            
                            usersSnapshot.forEach(doc => {
                                const userData = doc.data();
                                if (userData.photoURL) {
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à
                                    userPhotosCache[doc.id] = userData.photoURL;
                                }
                            });
                        }
                    } catch (error) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    }
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫–µ—à–∞ –∫–æ –≤—Å–µ–º –ø—Ä–æ—Ñ–∏–ª—è–º
                allProfiles.forEach(profile => {
                    if (profile.userId && userPhotosCache[profile.userId]) {
                        profile.userPhotoURL = userPhotosCache[profile.userId];
                    }
                });

                // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
                const allTags = new Set();
                allProfiles.forEach(profile => {
                    if (profile.tags && Array.isArray(profile.tags)) {
                        profile.tags.forEach(tag => allTags.add(tag));
                    }
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ç–µ–≥–æ–≤
                const tagFilter = document.getElementById('tagFilter');
                Array.from(allTags).sort().forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    tagFilter.appendChild(option);
                });

                filteredProfiles = [...allProfiles];
                renderProfiles();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ lightbox
        async function openProfileGallery(profileId) {
            try {
                const profile = allProfiles.find(p => p.id === profileId);
                if (!profile || !profile.gallery || profile.gallery.length === 0) {
                    return;
                }
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è lightbox
                const photosData = profile.gallery.map(photo => {
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∞—Ç—ã —Ñ–æ—Ç–æ
                    const allMilestones = [];
                    if (profile.milestones && profile.milestones.length > 0) {
                        const currentDate = parseTimelineDate(photo.date);
                        profile.milestones.forEach(milestone => {
                            const milestoneDate = parseTimelineDate(milestone.date);
                            const days = Math.abs(getDaysDifference(currentDate, milestoneDate));
                            
                            allMilestones.push({
                                title: milestone.title,
                                days: days,
                                isPast: milestoneDate <= currentDate,
                                isFuture: milestoneDate > currentDate
                            });
                        });
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π)
                    let solutionProfile = null;
                    if (profile.profileString) {
                        const parsed = parseProfile(profile.profileString);
                        solutionProfile = {
                            ec: calculateEC(parsed),
                            nh4no3: parsed.NH4 && parsed.NO3 ? parsed.NH4 / parsed.NO3 : 0,
                            ratios: calculateRatios(parsed),
                            daysAgo: 0,
                            comment: '',
                            profileString: profile.profileString,
                            hpgContent: profile.profile
                        };
                    }
                    
                    return {
                        url: photo.url,
                        description: photo.description || '',
                        date: photo.date,
                        author: profile.userName || '–ê–Ω–æ–Ω–∏–º',
                        profileName: profile.name,
                        profileDescription: profile.description || '',
                        profileId: profile.id,
                        allMilestones: allMilestones,
                        solutionProfile: solutionProfile
                    };
                });
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º lightbox
                openLightbox(photosData, 0);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –≥–∞–ª–µ—Ä–µ–∏:', error);
            }
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
        window.openProfileGallery = openProfileGallery;
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
        function renderProfiles() {
            const container = document.getElementById('profilesContainer');
            const profileCount = document.getElementById('profileCount');

            if (filteredProfiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h2>–ü—Ä–æ—Ñ–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h2>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                    </div>
                `;
                profileCount.textContent = '0 –ø—Ä–æ—Ñ–∏–ª–µ–π';
                return;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            totalPages = Math.ceil(filteredProfiles.length / PROFILES_PER_PAGE);
            if (currentPage > totalPages) currentPage = 1;
            
            const startIndex = (currentPage - 1) * PROFILES_PER_PAGE;
            const endIndex = startIndex + PROFILES_PER_PAGE;
            const profilesToShow = filteredProfiles.slice(startIndex, endIndex);

            profileCount.textContent = `${filteredProfiles.length} ${getProfileWord(filteredProfiles.length)}`;

            const grid = document.createElement('div');
            grid.className = 'profiles-grid';

            profilesToShow.forEach(profile => {
                const card = createProfileCard(profile);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (totalPages > 1) {
                const pagination = createPagination();
                container.appendChild(pagination);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        function createPagination() {
            const paginationDiv = document.createElement('div');
            paginationDiv.style.cssText = 'display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; flex-wrap: wrap;';
            
            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = '‚Üê –ù–∞–∑–∞–¥';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderProfiles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginationDiv.appendChild(prevBtn);
            
            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const pageInfo = document.createElement('span');
            pageInfo.style.cssText = 'color: white; font-size: 14px; font-weight: 500; padding: 0 10px;';
            pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
            paginationDiv.appendChild(pageInfo);
            
            // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-secondary';
            nextBtn.textContent = '–í–ø–µ—Ä—ë–¥ ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProfiles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginationDiv.appendChild(nextBtn);
            
            return paginationDiv;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function createProfileCard(profile) {
            const card = document.createElement('div');
            card.className = 'profile-card';

            const date = profile.modified?.toDate().toLocaleDateString('ru-RU') || '';
            const views = profile.views || 0;
            const author = profile.userName || profile.userEmail || '–ê–Ω–æ–Ω–∏–º';
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ ui-avatars.com
            const avatarUrl = profile.userPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&size=45&background=667eea&color=fff`;

            // –°–æ–∑–¥–∞—ë–º –∫–æ–ª–ª–∞–∂ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ (–±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 3 —Ñ–æ—Ç–æ)
            const gallery = profile.gallery || [];
            let photosCollageHtml = '';
            if (gallery.length > 0) {
                const photosToShow = gallery.slice(0, 3);
                photosCollageHtml = `
                    <div class="profile-photos-collage" onclick="event.stopPropagation(); openProfileGallery('${profile.id}')">
                        ${photosToShow.map(photo => `<img src="${escapeHtml(photo.url)}" class="collage-photo" alt="–§–æ—Ç–æ">`).join('')}
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="profile-header" onclick="showProfileDetail('${profile.id}')">
                    <div class="profile-expand-icon">‚õ∂</div>
                    <div class="author-avatar" title="${escapeHtml(author)}">
                        <img src="${avatarUrl}" alt="${escapeHtml(author)}">
                    </div>
                    <div class="profile-title">
                        üåê ${escapeHtml(profile.name)}
                    </div>
                    ${profile.description ? `<div class="profile-description">${escapeHtml(profile.description)}</div>` : ''}
                </div>
                ${photosCollageHtml}
                <div class="profile-body">
                    <div class="profile-meta">
                        <div class="meta-item">
                            üìÖ ${date}
                        </div>
                        <div class="meta-item">üë§ ${escapeHtml(author)}</div>
                    </div>
                    ${profile.tags && profile.tags.length > 0 ? `
                        <div class="profile-tags">
                            ${profile.tags.map(tag => `<span class="tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${(profile.profileString || (profile.journal && profile.journal.length)) ? `
                        <div class="profile-tools">
                            ${profile.profileString ? `<button class="btn btn-secondary btn-small" onclick="showProfileString('${profile.id}', '${escapeHtml(profile.name)}')">‚öóÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</button>` : ''}
                            ${profile.journal && profile.journal.length ? `<button class="btn btn-secondary btn-small" onclick="showJournal('${profile.id}', '${escapeHtml(profile.name)}')">üìì –ñ—É—Ä–Ω–∞–ª (${profile.journal.length})</button>` : ''}
                        </div>
                    ` : ''}
                    <div class="profile-stats">
                        <div class="stat-item">
                            üëÅÔ∏è ${views}
                        </div>
                        <div class="stat-item" style="cursor: pointer;" onclick="likeProfile('${profile.id}')" title="–ù—Ä–∞–≤–∏—Ç—Å—è">
                            üëç <span id="likes-${profile.id}">${profile.likes || 0}</span>
                        </div>
                        <div class="stat-item" style="cursor: pointer;" onclick="dislikeProfile('${profile.id}')" title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                            üëé <span id="dislikes-${profile.id}">${profile.dislikes || 0}</span>
                        </div>
                        <div class="stat-item">
                            üí¨ ${profile.commentsCount || 0}
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary btn-small" onclick="openInCalculator('${profile.id}')">
                            üß™ –û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="showComments('${profile.id}', '${escapeHtml(profile.name)}')">
                            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        </button>
                        <button class="btn btn-light btn-small" onclick="copyShareLink('${profile.id}', '${escapeHtml(profile.name)}')" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                            üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
        function openInCalculator(profileId) {
            window.location.href = `../hpg.html?profile=${profileId}`;
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –≤ –æ–±—ä–µ–∫—Ç
        function parseProfile(profileString) {
            const profile = {};
            if (!profileString) return profile;
            
            const parts = profileString.trim().split(/\s+/);
            parts.forEach(part => {
                const [key, value] = part.split('=');
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    profile[key] = numValue;
                }
            });
            return profile;
        }
        
        // –†–∞—Å—á–µ—Ç EC –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        function calculateEC(profile) {
            const molN = 14.0067;
            const molCa = 40.078;
            const molMg = 24.305;
            const molK = 39.0983;
            
            const vNH4 = profile.NH4 || 0;
            const vCa = profile.Ca || 0;
            const vMg = profile.Mg || 0;
            const vK = profile.K || 0;
            
            const vEC = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                        2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                        2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
            
            return vEC;
        }
        
        // –†–∞—Å—á–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π
        function calculateRatios(profile) {
            const ratios = {};
            const NO3 = profile.NO3 || 0;
            const NH4 = profile.NH4 || 0;
            const N = profile.N || 0;
            const K = profile.K || 0;
            const Ca = profile.Ca || 0;
            const Mg = profile.Mg || 0;
            
            // NH4:NO3
            if (NO3 > 0) {
                ratios.NH4_NO3 = NH4 / NO3;
            }
            
            // K:N
            if (N > 0) {
                ratios.K_N = K / N;
            }
            
            // K:Ca
            if (Ca > 0) {
                ratios.K_Ca = K / Ca;
            }
            
            // K:Mg
            if (Mg > 0) {
                ratios.K_Mg = K / Mg;
            }
            
            return ratios;
        }
        
        // –£–º–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        function smartRoundPercent(percent) {
            const absPercent = Math.abs(percent);
            if (absPercent >= 10) {
                return percent.toFixed(0);
            } else if (absPercent >= 1) {
                return percent.toFixed(1);
            } else {
                return percent.toFixed(2);
            }
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ HPG —Ñ–∞–π–ª–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏
        function parseHPGFileElements(hpgContent) {
            if (!hpgContent) return {};
            
            const lines = hpgContent.split('\n');
            const elements = {};
            
            lines.forEach(line => {
                const trimmed = line.trim();
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "Fe=4000" –∏–ª–∏ "N=220"
                const match = trimmed.match(/^([A-Za-z]+[0-9]*)=(.+)$/);
                if (match && !trimmed.startsWith('#')) {
                    const element = match[1];
                    const value = parseFloat(match[2]);
                    if (!isNaN(value)) {
                        elements[element] = value;
                    }
                }
            });
            
            return elements;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è –≤ –ø–ª–∏—Ç–æ—á–∫–∏
        function formatProfileElements(profileString, hpgContent) {
            // –ü–∞—Ä—Å–∏–º –ø–æ–ª–Ω—ã–π HPG —Ñ–∞–π–ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏
            const hpgElements = parseHPGFileElements(hpgContent);
            
            if (Object.keys(hpgElements).length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç HPG —Ñ–∞–π–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º profileString
                if (!profileString) {
                    return '<div style="color: #999; font-style: italic;">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω</div>';
                }
            }
            
            const macroElements = ['N', 'NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl'];
            const microElements = ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'];
            const allElements = [...macroElements, ...microElements];
            const allItems = [];
            
            allElements.forEach(element => {
                const value = hpgElements[element];
                if (value === undefined || isNaN(value)) return;
                
                let displayValue, roundedValue;
                
                if (macroElements.includes(element)) {
                    // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–≥/–ª - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª—ã—Ö
                    roundedValue = Math.round(value);
                    displayValue = roundedValue;
                } else if (microElements.includes(element)) {
                    // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–∫–≥/–ª –≤ HPG - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–≥/–ª
                    displayValue = (value / 1000).toFixed(3);
                    roundedValue = parseFloat(displayValue);
                }
                
                if (displayValue !== undefined && (macroElements.includes(element) || (microElements.includes(element) && roundedValue !== 0))) {
                    const isMacro = macroElements.includes(element);
                    const bgGradient = isMacro ? 
                        'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' : 
                        'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                    const borderColor = isMacro ? '#4a9d9d' : '#ff9800';
                    const textColor = isMacro ? '#2d7a7a' : '#e65100';
                    
                    const itemHtml = `
                        <div style="background: ${bgGradient}; padding: 6px 10px; border-radius: 6px; text-align: center; display: inline-block; margin: 3px; border: 1px solid ${borderColor};">
                            <div style="font-size: 14px; font-weight: 700; color: ${textColor};">${displayValue}</div>
                            <div style="font-size: 10px; color: #666;">${element}</div>
                        </div>
                    `;
                    allItems.push(itemHtml);
                }
            });
            
            return allItems.length > 0 ? 
                '<div>' + allItems.join('') + '</div>' : 
                '<div style="color: #999; font-style: italic;">–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        }
        
        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
        function compareProfiles(prev, curr) {
            const changes = [];
            const elements = ['N', 'NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo'];
            
            elements.forEach(elem => {
                const prevVal = prev[elem] || 0;
                const currVal = curr[elem] || 0;
                const diff = currVal - prevVal;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–æ–ª—å—à–µ 0.001 –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–µ–π
                if (Math.abs(diff) > 0.001) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    let changeStr = '';
                    if (prevVal > 0.01) {
                        const percent = (diff / prevVal) * 100;
                        const roundedPercent = smartRoundPercent(percent);
                        const percentSign = percent > 0 ? '+' : '';
                        changeStr = ` (${percentSign}${roundedPercent}%)`;
                    } else {
                        const sign = diff > 0 ? '+' : '';
                        changeStr = ` (${sign}${diff.toFixed(2)})`;
                    }
                    
                    changes.push(`${elem}: ${prevVal.toFixed(2)} ‚Üí ${currVal.toFixed(2)}${changeStr}`);
                }
            });
            
            return changes;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã —Å –∑–∞–ø–∏—Å—è–º–∏ –∂—É—Ä–Ω–∞–ª–∞ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
        function createTimeline(journal, gallery, milestones) {
            const timeline = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞
            if (journal && journal.length > 0) {
                journal.forEach((entry, index) => {
                    timeline.push({
                        type: 'journal',
                        date: entry.date,
                        index: index,
                        data: entry
                    });
                });
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ –¥–∞—Ç–µ
            if (gallery && gallery.length > 0) {
                const photosWithDates = gallery.filter(photo => photo.date);
                const photoGroups = groupPhotosByDate(photosWithDates);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫–∞–∫ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç
                Object.entries(photoGroups).forEach(([dateKey, photos]) => {
                    timeline.push({
                        type: 'photoGroup',
                        date: photos[0].date, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ
                        data: photos // –ú–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
                    });
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
            if (milestones && milestones.length > 0) {
                milestones.forEach(milestone => {
                    timeline.push({
                        type: 'milestone',
                        date: milestone.date,
                        data: milestone
                    });
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
            timeline.sort((a, b) => {
                const dateA = parseTimelineDate(a.date);
                const dateB = parseTimelineDate(b.date);
                return dateA - dateB;
            });
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª–µ
            timeline.forEach((item, index) => {
                item.timelineIndex = index;
            });
            
            return timeline;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã –ø–æ –¥–Ω—è–º
        function groupTimelineByDate(timeline) {
            const groups = [];
            
            timeline.forEach(item => {
                const dateObj = parseTimelineDate(item.date);
                const key = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
                
                let group = groups.find(g => g.key === key);
                if (!group) {
                    group = {
                        key,
                        date: dateObj,
                        items: []
                    };
                    groups.push(group);
                }
                
                group.items.push(item);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è: —Å–Ω–∞—á–∞–ª–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            groups.forEach(group => {
                group.items.sort((a, b) => {
                    if (a.type === 'milestone' && b.type !== 'milestone') return -1;
                    if (a.type !== 'milestone' && b.type === 'milestone') return 1;
                    return 0;
                });
            });
            
            return groups;
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
        function parseTimelineDate(value) {
            if (!value) return new Date(0);
            
            // –ï—Å–ª–∏ timestamp Firestore
            if (value.seconds) {
                return new Date(value.seconds * 1000);
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç
            const date = new Date(value);
            return isNaN(date.getTime()) ? new Date(0) : date;
        }
        
        // –†–∞—Å—á–µ—Ç —Ä–∞–∑–Ω–∏—Ü—ã –≤ –¥–Ω—è—Ö –º–µ–∂–¥—É –¥–≤—É–º—è –¥–∞—Ç–∞–º–∏
        function getDaysDifference(date1, date2) {
            const diffTime = Math.abs(date2 - date1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω–µ–π
        function formatDays(days) {
            if (days === 0) return '—Å–µ–≥–æ–¥–Ω—è';
            if (days === 1) return '1 –¥–µ–Ω—å';
            if (days >= 2 && days <= 4) return `${days} –¥–Ω—è`;
            if (days >= 5 && days <= 20) return `${days} –¥–Ω–µ–π`;
            const lastDigit = days % 10;
            const lastTwoDigits = days % 100;
            if (lastDigit === 1 && lastTwoDigits !== 11) return `${days} –¥–µ–Ω—å`;
            if (lastDigit >= 2 && lastDigit <= 4 && (lastTwoDigits < 10 || lastTwoDigits >= 20)) return `${days} –¥–Ω—è`;
            return `${days} –¥–Ω–µ–π`;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ –¥–∞—Ç–µ
        function groupPhotosByDate(photos) {
            const groups = {};
            photos.forEach(photo => {
                const photoDate = parseTimelineDate(photo.date);
                const dateKey = photoDate.toISOString().split('T')[0]; // YYYY-MM-DD
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(photo);
            });
            return groups;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è
        async function showProfileDetail(profileId) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            currentOpenProfileId = profileId;
            
            const profile = allProfiles.find(p => p.id === profileId);
            if (!profile) return;
            
            const authorAvatar = profile.userPhotoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.userName || '–ê–Ω–æ–Ω–∏–º')}&size=48&background=4a9d9d&color=fff`;
            
            const tagsHtml = profile.tags && profile.tags.length > 0 ?
                profile.tags.map(tag => `<span class="profile-detail-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`).join('') :
                '<span style="color: #999;">–¢–µ–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
            let commentsHtml = `
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #999; margin-bottom: 20px; font-size: 16px;">
                        üîí –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    </div>
                    <button class="btn btn-primary" onclick="loginWithGoogle()" style="display: inline-flex; align-items: center; gap: 8px;">
                        <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1);">
                        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                    </button>
                </div>
            `;
            if (currentUser) {
                commentsHtml = '<div style="color: #999; text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>';
                try {
                    const commentsSnapshot = await db.collection('comments')
                        .where('profileId', '==', profileId)
                        .orderBy('created', 'desc')
                        .get();
                    
                    if (commentsSnapshot.empty) {
                        commentsHtml = '<div style="color: #999; text-align: center; padding: 20px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    } else {
                        commentsHtml = '';
                        commentsSnapshot.forEach(doc => {
                            const comment = doc.data();
                            const commentAvatar = comment.userPhotoURL || 
                                `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.userName || '–ê–Ω–æ–Ω–∏–º')}&size=40&background=4a9d9d&color=fff`;
                            const commentDate = comment.created?.toDate().toLocaleDateString('ru-RU') || '';
                            
                            commentsHtml += `
                                <div class="comment" style="margin-bottom: 15px; padding: 12px; background: #f8f9ff; border-radius: 8px;">
                                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                                        <img src="${commentAvatar}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4a9d9d;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #333;">${escapeHtml(comment.userName || '–ê–Ω–æ–Ω–∏–º')}</div>
                                            <div style="font-size: 12px; color: #999;">${commentDate}</div>
                                        </div>
                                    </div>
                                    <div style="color: #555; line-height: 1.5;">${escapeHtml(comment.text)}</div>
                                </div>
                            `;
                        });
                    }
                } catch (error) {
                    commentsHtml = '<div style="color: #f44336; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
                }
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è
            let profileStringHtml = '';
            if (profile.profileString) {
                const mainParsed = parseProfile(profile.profileString);
                const mainEC = calculateEC(mainParsed);
                const mainRatios = calculateRatios(mainParsed);
                
                profileStringHtml = `
                    <div class="profile-detail-section">
                        <h3>‚öóÔ∏è –ü—Ä–æ—Ñ–∏–ª—å —Ä–∞—Å—Ç–≤–æ—Ä–∞</h3>
                        
                        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è -->
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #4a9d9d;">
                            <div style="font-weight: 700; color: #2d7a7a; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                <span>üìä</span> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—Ç–≤–æ—Ä–∞
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainEC.toFixed(3)}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">EC (–º–°–º/—Å–º)</div>
                                </div>
                                ${mainRatios.NH4_NO3 !== undefined ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.NH4_NO3.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">NH4:NO3</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_N ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_N.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:N</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_Ca ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_Ca.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:Ca</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_Mg ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_Mg.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:Mg</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–∏—Ç–∞–Ω–∏—è -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; color: #666; margin-bottom: 12px; font-size: 13px;">–ü—Ä–æ—Ñ–∏–ª—å –ø–∏—Ç–∞–Ω–∏—è:</div>
                            ${formatProfileElements(profile.profileString, profile.profile)}
                        </div>
                    </div>
                `;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∂—É—Ä–Ω–∞–ª —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
            let journalHtml = '';
            const hasJournalOrPhotos = (profile.journal && profile.journal.length > 0) || (profile.gallery && profile.gallery.length > 0);
            
            if (hasJournalOrPhotos) {
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É
                const timeline = createTimeline(profile.journal, profile.gallery, profile.milestones);
                const groupedTimeline = groupTimelineByDate(timeline);
                const journalEntriesCount = (profile.journal && profile.journal.length) || 0;
                const photosCount = (profile.gallery && profile.gallery.filter(p => p.date).length) || 0;
                
                // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø—Ä–æ—Ñ–∏–ª—è –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
                const allPhotosData = [];
                timeline.forEach((item, timelineIndex) => {
                    if (item.type === 'photoGroup') {
                        const photos = item.data;
                        const photoDate = parseTimelineDate(photos[0].date);
                        const startDate = timeline.length > 0 ? parseTimelineDate(timeline[0].date) : photoDate;
                        const prevDate = timelineIndex > 0 ? parseTimelineDate(timeline[timelineIndex - 1].date) : null;
                        const daysFromStart = getDaysDifference(startDate, photoDate);
                        const daysFromPrev = prevDate ? getDaysDifference(prevDate, photoDate) : 0;
                        
                        const dateLabel = photoDate.toLocaleDateString('ru-RU', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        let timeInfo = 'üì∏ ' + dateLabel;
                        if (daysFromStart > 0) {
                            timeInfo += ' (' + formatDays(daysFromStart) + ' –æ—Ç –Ω–∞—á–∞–ª–∞';
                            if (daysFromPrev > 0) {
                                timeInfo += ' ‚Ä¢ +' + formatDays(daysFromPrev) + ')';
                            } else {
                                timeInfo += ')';
                            }
                        }
                        
                        photos.forEach(photo => {
                            // –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∞—Ç—ã —Ñ–æ—Ç–æ
                            const allMilestones = [];
                            if (profile.milestones && profile.milestones.length > 0) {
                                const currentDate = parseTimelineDate(photo.date);
                                profile.milestones.forEach(milestone => {
                                    const milestoneDate = parseTimelineDate(milestone.date);
                                    const days = Math.abs(getDaysDifference(currentDate, milestoneDate));
                                    
                                    allMilestones.push({
                                        title: milestone.title,
                                        days: days,
                                        isPast: milestoneDate <= currentDate,
                                        isFuture: milestoneDate > currentDate
                                    });
                                });
                            }
                            
                            // –ò—â–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞—Å—Ç–≤–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
                            let solutionProfile = null;
                            const photoDate = parseTimelineDate(photo.date);
                            
                            if (profile.journal && profile.journal.length > 0) {
                                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø—Ä–æ—à–ª—É—é –∑–∞–ø–∏—Å—å —Å –ø—Ä–æ—Ñ–∏–ª–µ–º
                                let closestEntry = null;
                                let closestDays = Infinity;
                                
                                profile.journal.forEach(entry => {
                                    const entryDate = parseTimelineDate(entry.date);
                                    if (entryDate <= photoDate && entry.profile && entry.profile.trim()) {
                                        const days = getDaysDifference(entryDate, photoDate);
                                        if (days < closestDays) {
                                            closestDays = days;
                                            closestEntry = entry;
                                        }
                                    }
                                });
                                
                                if (closestEntry) {
                                    const parsed = parseProfile(closestEntry.profile);
                                    solutionProfile = {
                                        ec: calculateEC(parsed),
                                        nh4no3: parsed.NH4 && parsed.NO3 ? parsed.NH4 / parsed.NO3 : 0,
                                        ratios: calculateRatios(parsed),
                                        daysAgo: closestDays,
                                        comment: closestEntry.desc || '',
                                        profileString: closestEntry.profile,
                                        isStringFormat: true  // –ñ—É—Ä–Ω–∞–ª —Ö—Ä–∞–Ω–∏—Ç —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è, –Ω–µ HPG —Ñ–∞–π–ª—ã
                                    };
                                }
                            }
                            
                            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ - –±–µ—Ä–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                            if (!solutionProfile && profile.profileString) {
                                const parsed = parseProfile(profile.profileString);
                                solutionProfile = {
                                    ec: calculateEC(parsed),
                                    nh4no3: parsed.NH4 && parsed.NO3 ? parsed.NH4 / parsed.NO3 : 0,
                                    ratios: calculateRatios(parsed),
                                    daysAgo: 0,
                                    comment: '',
                                    profileString: profile.profileString,
                                    hpgContent: profile.profile
                                };
                            }
                            
                            allPhotosData.push({
                                url: photo.url,
                                description: photo.description || '',
                                date: photo.date,
                                dateFormatted: timeInfo,
                                author: profile.userName || '–ê–Ω–æ–Ω–∏–º',
                                profileName: profile.name,
                                profileDescription: profile.description || '',
                                profileId: profile.id,
                                allMilestones: allMilestones,
                                solutionProfile: solutionProfile
                            });
                        });
                    }
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
                if (!window.lightboxPhotoGroups) window.lightboxPhotoGroups = {};
                window.lightboxPhotoGroups['profile_' + profile.id] = allPhotosData;
                
                journalHtml = `
                    <div class="profile-detail-section">
                        <h3 onclick="toggleJournal('${profile.id}')" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                            <span id="journal-arrow-${profile.id}" style="transition: transform 0.2s; display: inline-flex; align-items: center; line-height: 1;">‚ñº</span>
                            üìì –ñ—É—Ä–Ω–∞–ª (${journalEntriesCount} ${journalEntriesCount === 1 ? '–∑–∞–ø–∏—Å—å' : '–∑–∞–ø–∏—Å–µ–π'}${photosCount > 0 ? `, ${photosCount} ${photosCount === 1 ? '—Ñ–æ—Ç–æ' : '—Ñ–æ—Ç–æ'}` : ''})
                        </h3>
                        <div id="journal-content-${profile.id}" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            ${groupedTimeline.map((dayGroup) => {
                                const dateLabel = dayGroup.date.toLocaleDateString('ru-RU', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                });
                                const weekday = dayGroup.date.toLocaleDateString('ru-RU', { weekday: 'long' });
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
                                const dayMilestoneInfo = getMilestoneDistances(dayGroup.date.toISOString(), profile.milestones);
                                let milestoneInfoHtml = '';
                                if (dayMilestoneInfo) {
                                    const parts = [];
                                    if (dayMilestoneInfo.prev) {
                                        parts.push(`<span style="color: #4caf50;">‚≠ê ${escapeHtml(dayMilestoneInfo.prev.title)}: +${formatDays(dayMilestoneInfo.prev.days)}</span>`);
                                    }
                                    if (dayMilestoneInfo.next) {
                                        parts.push(`<span style="color: #ff9800;">‚è≥ –î–æ "${escapeHtml(dayMilestoneInfo.next.title)}": ${formatDays(dayMilestoneInfo.next.days)}</span>`);
                                    }
                                    if (parts.length > 0) {
                                        milestoneInfoHtml = `<div class="journal-day-milestones">${parts.join(' ‚Ä¢ ')}</div>`;
                                    }
                                }
                                
                                return `
                                    <div class="journal-day">
                                        <div class="journal-day-header">
                                            <div style="display: flex; align-items: baseline; gap: 10px;">
                                                <div class="journal-day-date">${escapeHtml(dateLabel)}</div>
                                                <div class="journal-day-weekday">${escapeHtml(weekday)}</div>
                                            </div>
                                            ${milestoneInfoHtml}
                                        </div>
                                        <div class="journal-day-content">
                                            ${dayGroup.items.map((item) => {
                                                const timelineIndex = item.timelineIndex;
                                                // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—ã –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –¥–Ω–µ–π
                                                const currentDate = parseTimelineDate(item.date);
                                                const startDate = timeline.length > 0 ? parseTimelineDate(timeline[0].date) : currentDate;
                                                const prevDate = timelineIndex > 0 ? parseTimelineDate(timeline[timelineIndex - 1].date) : null;
                                                
                                                const daysFromStart = getDaysDifference(startDate, currentDate);
                                                const daysFromPrev = prevDate ? getDaysDifference(prevDate, currentDate) : 0;
                                    
                                    // –ï—Å–ª–∏ —ç—Ç–æ –≥—Ä—É–ø–ø–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
                                    if (item.type === 'photoGroup') {
                                        const photos = item.data;
                                        
                                        let timeInfo = `üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏`;
                                        if (daysFromStart > 0) {
                                            timeInfo += ` <span style="color: #999; font-size: 13px;">(${formatDays(daysFromStart)} –æ—Ç –Ω–∞—á–∞–ª–∞)</span>`;
                                        }
                                        
                                        // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
                                        const descriptions = photos
                                            .map(p => (p.description || '').trim())
                                            .filter(d => d)
                                            .filter((d, i, arr) => arr.indexOf(d) === i); // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
                                        
                                        const descriptionText = descriptions.length > 0 
                                            ? descriptions.join('; ') 
                                            : '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
                                        
                                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é-–≤–∞–≥–æ–Ω—á–∏–∫–∏
                                        const previewsHtml = photos.map((photo) => {
                                            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ —Ñ–æ—Ç–æ –≤ –æ–±—â–µ–º –º–∞—Å—Å–∏–≤–µ
                                            const globalIndex = allPhotosData.findIndex(p => p.url === photo.url && p.date === photo.date);
                                            return `
                                            <div class="journal-photo-train-item" onclick="openLightbox(window.lightboxPhotoGroups['profile_${profile.id}'], ${globalIndex})" title="${escapeHtml(photo.description || '–§–æ—Ç–æ')}">
                                                <img src="${escapeHtml(photo.url)}" alt="${escapeHtml(photo.description || '–§–æ—Ç–æ')}"
                                                     onerror="this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; color: #999; font-size: 24px;\\'>üì∏</div>';">
                                            </div>
                                        `}).join('');
                                        
                                        return `
                                            <div class="journal-photo">
                                                <div class="journal-photo-train">
                                                    ${previewsHtml}
                                                </div>
                                                <div class="journal-photo-info">
                                                    <div class="journal-photo-date">
                                                        ${timeInfo} ${photos.length > 1 ? `<span style="color: #999; font-size: 11px;">(${photos.length} —Ñ–æ—Ç–æ)</span>` : ''}
                                                    </div>
                                                    <div class="journal-photo-description" style="${descriptions.length === 0 ? 'color: #999; font-style: italic;' : ''}">
                                                        ${escapeHtml(descriptionText)}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // –ï—Å–ª–∏ —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                                    if (item.type === 'milestone') {
                                        const milestone = item.data;
                                        
                                        let timeInfo = '';
                                        if (daysFromStart > 0) {
                                            timeInfo = `<span style="font-size: 13px; opacity: 0.85;">${formatDays(daysFromStart)} –æ—Ç –Ω–∞—á–∞–ª–∞</span>`;
                                        }
                                        
                                        return `
                                            <div style="border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); padding: 18px; color: white;">
                                                <div style="display: flex; align-items: center; gap: 15px;">
                                                    <div style="font-size: 40px; line-height: 1;">‚≠ê</div>
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 17px; font-weight: 600; margin-bottom: 4px;">
                                                            ${escapeHtml(milestone.title)}
                                                        </div>
                                                        ${timeInfo ? `<div style="font-size: 13px; opacity: 0.9;">${timeInfo}</div>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞
                                    const entry = item.data;
                                    const index = item.index;
                                    
                                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
                                    let timeInfo = '';
                                    if (daysFromStart > 0) {
                                        timeInfo = `<span style="color: #999; font-size: 13px;">${formatDays(daysFromStart)} –æ—Ç –Ω–∞—á–∞–ª–∞</span>`;
                                    }
                                    
                                    const descriptionHtml = entry.desc ? `<div style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 10px;">${escapeHtml(entry.desc)}</div>` : '';
                                    const profileString = (entry.profile || '').trim();
                                    
                                    // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
                                    const currentParsed = parseProfile(profileString);
                                    
                                    // –í—ã—á–∏—Å–ª—è–µ–º EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
                                    let statsHtml = '';
                                    if (profileString) {
                                        const ec = calculateEC(currentParsed);
                                        const ratios = calculateRatios(currentParsed);
                                        
                                        statsHtml = `
                                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                                <div style="font-weight: 600; color: #2d7a7a; margin-bottom: 5px; font-size: 13px;">üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</div>
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px; color: #555;">
                                                    <div><strong>EC:</strong> ${ec.toFixed(3)}</div>
                                                    ${ratios.NH4_NO3 !== undefined ? `<div><strong>NH4:NO3:</strong> ${ratios.NH4_NO3.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_N ? `<div><strong>K:N:</strong> ${ratios.K_N.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_Ca ? `<div><strong>K:Ca:</strong> ${ratios.K_Ca.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_Mg ? `<div><strong>K:Mg:</strong> ${ratios.K_Mg.toFixed(2)}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —ç—Ç–∞–ø–æ–º
                                    let changesHtml = '';
                                    if (index > 0 && profileString) {
                                        const prevEntry = profile.journal[index - 1];
                                        const prevProfileString = (prevEntry.profile || '').trim();
                                        if (prevProfileString) {
                                            const prevParsed = parseProfile(prevProfileString);
                                            const changes = compareProfiles(prevParsed, currentParsed);
                                            
                                            // –í—ã—á–∏—Å–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π
                                            const prevEC = calculateEC(prevParsed);
                                            const currEC = calculateEC(currentParsed);
                                            const prevRatios = calculateRatios(prevParsed);
                                            const currRatios = calculateRatios(currentParsed);
                                            
                                            const paramChanges = [];
                                            
                                            // EC - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                            const ecDiff = currEC - prevEC;
                                            if (Math.abs(ecDiff) > 0.0001) { // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–µ–π –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
                                                // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è EC
                                                let changeStr = '';
                                                if (prevEC > 0.001) {
                                                    const percent = (ecDiff / prevEC) * 100;
                                                    const roundedPercent = smartRoundPercent(percent);
                                                    const percentSign = percent > 0 ? '+' : '';
                                                    changeStr = ` (${percentSign}${roundedPercent}%)`;
                                                } else {
                                                    const sign = ecDiff > 0 ? '+' : '';
                                                    changeStr = ` (${sign}${ecDiff.toFixed(3)})`;
                                                }
                                                
                                                paramChanges.push(`EC: ${prevEC.toFixed(3)} ‚Üí ${currEC.toFixed(3)}${changeStr}`);
                                            }
                                            
                                            // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                            const ratioKeys = ['NH4_NO3', 'K_N', 'K_Ca', 'K_Mg'];
                                            ratioKeys.forEach(key => {
                                                if (prevRatios[key] !== undefined && currRatios[key] !== undefined) {
                                                    const diff = currRatios[key] - prevRatios[key];
                                                    if (Math.abs(diff) > 0.001) { // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–µ–π –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
                                                        const label = key.replace('_', ':');
                                                        
                                                        // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
                                                        let changeStr = '';
                                                        if (prevRatios[key] > 0.01) {
                                                            const percent = (diff / prevRatios[key]) * 100;
                                                            const roundedPercent = smartRoundPercent(percent);
                                                            const percentSign = percent > 0 ? '+' : '';
                                                            changeStr = ` (${percentSign}${roundedPercent}%)`;
                                                        } else {
                                                            const sign = diff > 0 ? '+' : '';
                                                            changeStr = ` (${sign}${diff.toFixed(2)})`;
                                                        }
                                                        
                                                        paramChanges.push(`${label}: ${prevRatios[key].toFixed(2)} ‚Üí ${currRatios[key].toFixed(2)}${changeStr}`);
                                                    }
                                                }
                                            });
                                            
                                            if (changes.length > 0 || paramChanges.length > 0) {
                                                changesHtml = `
                                                    <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                                        <div style="font-weight: 600; color: #e65100; margin-bottom: 8px; font-size: 13px;">üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç—Ç–∞–ø–∞:</div>
                                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                                            ${changes.length > 0 ? `
                                                                <div>
                                                                    <div style="font-weight: 600; color: #666; margin-bottom: 5px; font-size: 12px;">–≠–ª–µ–º–µ–Ω—Ç—ã:</div>
                                                                    <div style="font-size: 12px; color: #555; line-height: 1.6;">
                                                                        ${changes.map(ch => `<div>‚Ä¢ ${ch}</div>`).join('')}
                                                                    </div>
                                                                </div>
                                                            ` : ''}
                                                            ${paramChanges.length > 0 ? `
                                                                <div>
                                                                    <div style="font-weight: 600; color: #666; margin-bottom: 5px; font-size: 12px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</div>
                                                                    <div style="font-size: 12px; color: #555; line-height: 1.6;">
                                                                        ${paramChanges.map(ch => `<div>‚Ä¢ ${ch}</div>`).join('')}
                                                                    </div>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        }
                                    }
                                    
                                    const profileHtml = profileString ? 
                                        `<pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; line-height: 1.5; margin: 0;">${escapeHtml(profileString)}</pre>` : 
                                        '<div style="color: #999; font-style: italic; font-size: 13px;">–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                                    
                                    return `
                                        <div class="journal-entry">
                                            <div class="journal-entry-indicator">
                                                <div class="journal-entry-indicator-number">${index + 1}</div>
                                                <div class="journal-entry-indicator-label">–≠–¢–ê–ü</div>
                                            </div>
                                            <div class="journal-entry-content">
                                                <div class="journal-entry-date">${timeInfo}</div>
                                                ${descriptionHtml}
                                                ${statsHtml}
                                                ${changesHtml}
                                                ${profileHtml}
                                            </div>
                                        </div>
                                    `;
                                                }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content modal-content-large">
                    <div class="modal-header">
                        <h2>üìã ${escapeHtml(profile.name)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-detail">
                            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
                            <div class="profile-detail-sidebar">
                                <!-- –ê–≤—Ç–æ—Ä -->
                                <div class="profile-detail-author">
                                    <img src="${authorAvatar}" alt="${escapeHtml(profile.userName || '–ê–Ω–æ–Ω–∏–º')}" class="profile-detail-author-avatar">
                                    <div class="profile-detail-author-info">
                                        <div class="profile-detail-author-name">${escapeHtml(profile.userName || '–ê–Ω–æ–Ω–∏–º')}</div>
                                        <div class="profile-detail-author-date">
                                            üìÖ ${profile.created?.toDate().toLocaleDateString('ru-RU') || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                                <div class="profile-detail-stats">
                                    <div class="profile-detail-stat">
                                        <div class="profile-detail-stat-value">${profile.views || 0}</div>
                                        <div class="profile-detail-stat-label">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="window.location.href='gallery.html?profile=${profile.id}'" title="–û—Ç–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é">
                                        <div class="profile-detail-stat-value">üì∏ ${(profile.gallery && profile.gallery.length) || 0}</div>
                                        <div class="profile-detail-stat-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="document.getElementById('comments-section-${profile.id}').scrollIntoView({behavior: 'smooth', block: 'start'})" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º">
                                        <div class="profile-detail-stat-value">${profile.commentsCount || 0}</div>
                                        <div class="profile-detail-stat-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="likeProfile('${profile.id}')" title="–ù—Ä–∞–≤–∏—Ç—Å—è">
                                        <div class="profile-detail-stat-value">üëç <span id="detail-likes-${profile.id}">${profile.likes || 0}</span></div>
                                        <div class="profile-detail-stat-label">–õ–∞–π–∫–æ–≤</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="dislikeProfile('${profile.id}')" title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                                        <div class="profile-detail-stat-value">üëé <span id="detail-dislikes-${profile.id}">${profile.dislikes || 0}</span></div>
                                        <div class="profile-detail-stat-label">–î–∏–∑–ª–∞–π–∫–æ–≤</div>
                                    </div>
                                </div>
                                
                                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                                ${profile.description ? `
                                    <div class="profile-detail-section">
                                        <h3>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h3>
                                        <div style="color: #666; line-height: 1.6; font-size: 14px;">${escapeHtml(profile.description)}</div>
                                    </div>
                                ` : ''}
                                
                                <!-- –¢–µ–≥–∏ -->
                                <div class="profile-detail-section">
                                    <h3>üè∑Ô∏è –¢–µ–≥–∏</h3>
                                    <div class="profile-detail-tags">
                                        ${tagsHtml}
                                    </div>
                                </div>
                                
                                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                                <div class="profile-detail-section">
                                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openInCalculator('${profile.id}')">
                                        üß™ –û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="window.location.href='gallery.html?profile=${profile.id}'">
                                        üì∏ –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π ${(profile.gallery && profile.gallery.length) ? `(${profile.gallery.length})` : ''}
                                    </button>
                                    ${currentUser && currentUser.uid === profile.userId ? `
                                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="manageMilestones('${profile.id}')">
                                            ‚≠ê –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-light" style="width: 100%;" onclick="copyShareLink('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                        üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                    </button>
                                </div>
                            </div>
                            
                            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                            <div class="profile-detail-main">
                                ${profileStringHtml}
                                ${journalHtml}
                                
                                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                                <div class="profile-detail-section" id="comments-section-${profile.id}">
                                    <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${profile.commentsCount || 0})</h3>
                                    ${currentUser ? `
                                        <div class="comment-form" style="margin-bottom: 20px;">
                                            <textarea id="detail-comment-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                                            <div class="comment-form-actions" style="margin-top: 10px;">
                                                <button class="btn btn-primary" onclick="submitDetailComment('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                                    üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div id="detailComments" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                                        ${commentsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    currentOpenProfileId = null;
                    modal.remove();
                }
            });
            
            // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º ID –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
            const closeButton = modal.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    currentOpenProfileId = null;
                });
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        async function copyShareLink(profileId, profileName) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π URL –±–µ–∑ —Ö–µ—à–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π —Ö–µ—à
            const baseUrl = window.location.href.split('#')[0];
            const shareUrl = `${baseUrl}#profile-${profileId}`;
            
            try {
                await navigator.clipboard.writeText(shareUrl);
                showNotification(`‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å "${profileName}" —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!`);
            } catch (error) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">üîó –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É</h3>
                        <div style="margin-bottom: 15px;">
                            <strong>${profileName}</strong>
                        </div>
                        <input type="text" value="${shareUrl}" readonly 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px;"
                            onclick="this.select()">
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button class="btn btn-primary" onclick="
                                const input = this.parentElement.previousElementSibling;
                                input.select();
                                document.execCommand('copy');
                                showNotification('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                                this.closest('.modal').remove();
                            ">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ ID
        function getProfileById(profileId) {
            return allProfiles.find(profile => profile.id === profileId) ||
                   filteredProfiles.find(profile => profile.id === profileId) ||
                   null;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ —Å—Ç—Ä–æ–∫–æ–π –ø—Ä–æ—Ñ–∏–ª—è
        function showProfileString(profileId, profileName) {
            const profile = getProfileById(profileId);
            const profileString = (profile?.profileString || '').trim();

            if (!profileString) {
                alert('–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚öóÔ∏è –ü—Ä–æ—Ñ–∏–ª—å: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px; color: #666;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ –ø—Ä–æ—Ñ–∏–ª—è –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ.</p>
                        <div class="profile-string-view" id="modal-profile-string">${escapeHtml(profileString)}</div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="copyProfileString('${profile.id}', event)">
                                üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        function formatJournalDate(value) {
            if (!value) {
                return '–ë–µ–∑ –¥–∞—Ç—ã';
            }

            // –ï—Å–ª–∏ timestamp Firestore
            if (value.seconds) {
                const date = new Date(value.seconds * 1000);
                return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            return value;
        }

        function showJournal(profileId, profileName) {
            const profile = getProfileById(profileId);
            if (!profile || !Array.isArray(profile.journal) || profile.journal.length === 0) {
                alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }

            const entriesHtml = profile.journal.map((entry, index) => {
                const dateLabel = formatJournalDate(entry.date);
                const descriptionHtml = entry.desc ? `<div style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 10px;">${escapeHtml(entry.desc)}</div>` : '';
                const profileString = (entry.profile || '').trim();
                const profileHtml = profileString ? `<div class="journal-profile">${escapeHtml(profileString)}</div>` : '<div class="journal-profile" style="opacity:0.6;">–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                const disabledAttr = profileString ? '' : 'disabled';
                const disabledClass = profileString ? '' : ' journal-copy-btn--disabled';
                
                // –í—ã—á–∏—Å–ª—è–µ–º –¥–Ω–∏
                const currentDate = parseTimelineDate(entry.date);
                const startDate = index === 0 ? currentDate : parseTimelineDate(profile.journal[0].date);
                const prevDate = index > 0 ? parseTimelineDate(profile.journal[index - 1].date) : null;
                
                const daysFromStart = getDaysDifference(startDate, currentDate);
                const daysFromPrev = prevDate ? getDaysDifference(prevDate, currentDate) : 0;
                
                let timeInfo = `üìÖ ${escapeHtml(dateLabel)}`;
                if (daysFromStart > 0) {
                    timeInfo += ` (${formatDays(daysFromStart)} –æ—Ç –Ω–∞—á–∞–ª–∞`;
                    if (daysFromPrev > 0) {
                        timeInfo += ` ‚Ä¢ +${formatDays(daysFromPrev)})`;
                    } else {
                        timeInfo += `)`;
                    }
                }

                return `
                    <div class="journal-entry">
                        <div class="journal-entry-indicator">
                            <div class="journal-entry-indicator-number">${index + 1}</div>
                            <div class="journal-entry-indicator-label">–≠–¢–ê–ü</div>
                        </div>
                        <div class="journal-entry-content">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div class="journal-entry-date" style="margin-bottom: 0;">${timeInfo}</div>
                                <button class="btn btn-secondary btn-small journal-copy-btn${disabledClass}" data-profile-string="${encodeURIComponent(profileString)}" ${disabledAttr}>
                                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                            ${descriptionHtml}
                            ${profileHtml}
                        </div>
                    </div>
                `;
            }).join('');

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üìì –ñ—É—Ä–Ω–∞–ª –ø—Ä–æ—Ñ–∏–ª—è: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        ${entriesHtml}
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);

            modal.querySelectorAll('.journal-copy-btn').forEach(button => {
                const profileString = decodeURIComponent(button.dataset.profileString || '');
                button.addEventListener('click', (event) => {
                    if (!profileString) {
                        event.preventDefault();
                        return;
                    }
                    copyProfileString(profileId, event, profileString);
                });
            });
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è
        async function copyProfileString(profileId, event, profileStringOverride) {
            event?.stopPropagation?.();

            let profileString = (profileStringOverride || '').trim();
            if (!profileString) {
                const profile = getProfileById(profileId);
                profileString = (profile?.profileString || '').trim();
            }

            if (!profileString) {
                alert('–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                return;
            }

            try {
                await navigator.clipboard.writeText(profileString.trim());

                const button = event?.currentTarget || event?.target;
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    button.disabled = true;
                    button.style.opacity = '0.8';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 2000);
                } else {
                    showNotification('‚úÖ –°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
                }

            } catch (error) {
                prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:', profileString);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        async function showComments(profileId, profileName) {
            // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!authReady) {
                console.log('–û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                await new Promise(resolve => {
                    const unsubscribe = auth.onAuthStateChanged(() => {
                        unsubscribe();
                        resolve();
                    });
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!currentUser) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${escapeHtml(profileName)}</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="no-comments">
                                <div class="no-comments-icon">üîê</div>
                                <h3 style="margin-bottom: 10px;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                                <p style="margin-bottom: 20px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>
                                <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                    üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" id="comments-body">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                            –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...
                        </div>
                    </div>
                    <div class="comment-form">
                        <textarea id="comment-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                        <div class="comment-form-actions">
                            <button class="btn btn-primary" onclick="submitComment('${profileId}', '${escapeHtml(profileName)}')">
                                üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ Firestore (–∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–µ –ø–æ–¥–∫–æ–ª–ª–µ–∫—Ü–∏–∏)
                const commentsSnapshot = await db.collection('comments')
                    .where('profileId', '==', profileId)
                    .get();

                const modalBody = modal.querySelector('#comments-body');

                if (commentsSnapshot.empty) {
                    modalBody.innerHTML = `
                        <div class="no-comments">
                            <div class="no-comments-icon">üí¨</div>
                            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                        </div>
                    `;
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                const comments = [];
                commentsSnapshot.forEach(doc => {
                    comments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                comments.sort((a, b) => {
                    return (b.created?.toMillis() || 0) - (a.created?.toMillis() || 0);
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–µ—à–∞)
                const userIds = [...new Set(comments.map(c => c.userId).filter(id => id))];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ userId, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–µ—à–µ
                const uncachedUserIds = userIds.filter(id => !userPhotosCache[id]);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (uncachedUserIds.length > 0 && currentUser) {
                    try {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–∞—á–∫–∞–º–∏ (Firestore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 10 –≤ in)
                        for (let i = 0; i < uncachedUserIds.length; i += 10) {
                            const batch = uncachedUserIds.slice(i, i + 10);
                            const usersSnapshot = await db.collection('users')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            
                            usersSnapshot.forEach(doc => {
                                const userData = doc.data();
                                if (userData.photoURL) {
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à
                                    userPhotosCache[doc.id] = userData.photoURL;
                                }
                            });
                        }
                    } catch (error) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
                    }
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫–µ—à–∞ –∫–æ –≤—Å–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º
                comments.forEach(comment => {
                    if (comment.userId && userPhotosCache[comment.userId]) {
                        comment.userPhotoURL = userPhotosCache[comment.userId];
                    }
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                let commentsHTML = '';
                comments.forEach(comment => {
                    const author = comment.userName || comment.userEmail || '–ê–Ω–æ–Ω–∏–º';
                    const date = comment.created?.toDate().toLocaleString('ru-RU') || '';
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ ui-avatars.com
                    const avatarUrl = comment.userPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&size=36&background=667eea&color=fff`;

                    commentsHTML += `
                        <div class="comment">
                            <div class="comment-header">
                                <div class="comment-avatar">
                                    <img src="${avatarUrl}" alt="${escapeHtml(author)}">
                                </div>
                                <div style="flex: 1;">
                                    <div class="comment-author">${escapeHtml(author)}</div>
                                    <div class="comment-date">${date}</div>
                                </div>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text)}</div>
                        </div>
                    `;
                });

                modalBody.innerHTML = commentsHTML;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
                const modalBody = modal.querySelector('#comments-body');
                modalBody.innerHTML = `
                    <div class="no-comments">
                        <div class="no-comments-icon">‚ùå</div>
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                    </div>
                `;
            }
        }

        // –õ–∞–π–∫ –ø—Ä–æ—Ñ–∏–ª—è
        async function likeProfile(profileId) {
            if (!currentUser) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ confirm
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                        <p style="margin-bottom: 20px; color: #666;">–î–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏. –í–æ–π—Ç–∏ —Å–µ–π—á–∞—Å?</p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1); margin-right: 5px;">
                                –í–æ–π—Ç–∏
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É
                const likeQuery = await db.collection('likes')
                    .where('userId', '==', currentUser.uid)
                    .where('profileId', '==', profileId)
                    .get();

                if (!likeQuery.empty) {
                    const existingLike = likeQuery.docs[0];
                    const existingType = existingLike.data().type;
                    
                    if (existingType === 'like') {
                        // –£–∂–µ –ª–∞–π–∫–Ω—É—Ç–æ - —É–±–∏—Ä–∞–µ–º –ª–∞–π–∫
                        await existingLike.ref.delete();
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        if (likesSpan) {
                            likesSpan.textContent = Math.max(0, parseInt(likesSpan.textContent) - 1);
                        }
                        if (detailLikesSpan) {
                            detailLikesSpan.textContent = Math.max(0, parseInt(detailLikesSpan.textContent) - 1);
                        }
                        
                        showNotification('–õ–∞–π–∫ —É–±—Ä–∞–Ω');
                        return;
                    } else {
                        // –ë—ã–ª –¥–∏–∑–ª–∞–π–∫ - –º–µ–Ω—è–µ–º –Ω–∞ –ª–∞–π–∫
                        await existingLike.ref.update({ type: 'like' });
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(1),
                            dislikes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (likesSpan) likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
                        if (dislikesSpan) dislikesSpan.textContent = Math.max(0, parseInt(dislikesSpan.textContent) - 1);
                        if (detailLikesSpan) detailLikesSpan.textContent = parseInt(detailLikesSpan.textContent) + 1;
                        if (detailDislikesSpan) detailDislikesSpan.textContent = Math.max(0, parseInt(detailDislikesSpan.textContent) - 1);
                        
                        showNotification('üëç –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!');
                        return;
                    }
                }

                // –ù–æ–≤—ã–π –ª–∞–π–∫
                await db.collection('likes').add({
                    userId: currentUser.uid,
                    profileId: profileId,
                    type: 'like',
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('profiles').doc(profileId).update({
                    likes: firebase.firestore.FieldValue.increment(1)
                });

                const likesSpan = document.getElementById(`likes-${profileId}`);
                const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                if (likesSpan) {
                    likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
                }
                if (detailLikesSpan) {
                    detailLikesSpan.textContent = parseInt(detailLikesSpan.textContent) + 1;
                }

                showNotification('üëç –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –î–∏–∑–ª–∞–π–∫ –ø—Ä–æ—Ñ–∏–ª—è
        async function dislikeProfile(profileId) {
            if (!currentUser) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ confirm
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                        <p style="margin-bottom: 20px; color: #666;">–î–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏. –í–æ–π—Ç–∏ —Å–µ–π—á–∞—Å?</p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1); margin-right: 5px;">
                                –í–æ–π—Ç–∏
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—Ü–µ–Ω–∫—É
                const likeQuery = await db.collection('likes')
                    .where('userId', '==', currentUser.uid)
                    .where('profileId', '==', profileId)
                    .get();

                if (!likeQuery.empty) {
                    const existingLike = likeQuery.docs[0];
                    const existingType = existingLike.data().type;
                    
                    if (existingType === 'dislike') {
                        // –£–∂–µ –¥–∏–∑–ª–∞–π–∫–Ω—É—Ç–æ - —É–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫
                        await existingLike.ref.delete();
                        await db.collection('profiles').doc(profileId).update({
                            dislikes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (dislikesSpan) {
                            dislikesSpan.textContent = Math.max(0, parseInt(dislikesSpan.textContent) - 1);
                        }
                        if (detailDislikesSpan) {
                            detailDislikesSpan.textContent = Math.max(0, parseInt(detailDislikesSpan.textContent) - 1);
                        }
                        
                        showNotification('–î–∏–∑–ª–∞–π–∫ —É–±—Ä–∞–Ω');
                        return;
                    } else {
                        // –ë—ã–ª –ª–∞–π–∫ - –º–µ–Ω—è–µ–º –Ω–∞ –¥–∏–∑–ª–∞–π–∫
                        await existingLike.ref.update({ type: 'dislike' });
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(-1),
                            dislikes: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (likesSpan) likesSpan.textContent = Math.max(0, parseInt(likesSpan.textContent) - 1);
                        if (dislikesSpan) dislikesSpan.textContent = parseInt(dislikesSpan.textContent) + 1;
                        if (detailLikesSpan) detailLikesSpan.textContent = Math.max(0, parseInt(detailLikesSpan.textContent) - 1);
                        if (detailDislikesSpan) detailDislikesSpan.textContent = parseInt(detailDislikesSpan.textContent) + 1;
                        
                        showNotification('üëé –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!');
                        return;
                    }
                }

                // –ù–æ–≤—ã–π –¥–∏–∑–ª–∞–π–∫
                await db.collection('likes').add({
                    userId: currentUser.uid,
                    profileId: profileId,
                    type: 'dislike',
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('profiles').doc(profileId).update({
                    dislikes: firebase.firestore.FieldValue.increment(1)
                });

                const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                if (dislikesSpan) {
                    dislikesSpan.textContent = parseInt(dislikesSpan.textContent) + 1;
                }
                if (detailDislikesSpan) {
                    detailDislikesSpan.textContent = parseInt(detailDislikesSpan.textContent) + 1;
                }

                showNotification('üëé –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function showUploadForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å HPG</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .hpg:</label>
                            <input type="file" id="hpg-file-input" accept=".hpg" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                        </div>
                        <div id="upload-status" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;"></div>
                        <div id="upload-form" style="display: none;"></div>
                        <div id="upload-preview" style="display: none;">
                            <details>
                                <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ (–∫–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)</summary>
                                <div id="preview-content" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
                            </details>
                        </div>
                    </div>
                    <div class="comment-form">
                        <button id="upload-submit-btn" class="btn btn-primary" style="width: 100%; display: none;" onclick="uploadHPGProfile()">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
            document.getElementById('hpg-file-input').addEventListener('change', handleFileSelect);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('upload-status');
            const previewDiv = document.getElementById('upload-preview');
            const previewContent = document.getElementById('preview-content');
            const submitBtn = document.getElementById('upload-submit-btn');

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.color = '#1976d2';
            statusDiv.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞...';

            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
                const content = await file.text();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è HPG —Ñ–∞–π–ª–∞
                const validation = validateHPGFile(content);
                
                if (!validation.valid) {
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${validation.error}`;
                    previewDiv.style.display = 'none';
                    submitBtn.style.display = 'none';
                    return;
                }

                // –ü–∞—Ä—Å–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
                const parsedData = parseHPGMetadata(content, file.name);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.innerHTML = `‚úÖ –§–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω! –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${validation.elementsCount}`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const uploadForm = document.getElementById('upload-form');
                uploadForm.style.display = 'block';
                uploadForm.innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
                        <input type="text" id="upload-name" value="${escapeHtml(parsedData.name)}" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-family: Arial, sans-serif;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="upload-description" rows="3" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; resize: vertical; font-family: Arial, sans-serif;">${escapeHtml(parsedData.description)}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <input type="text" id="upload-tags" placeholder="—Ç–æ–º–∞—Ç—ã, –≤–µ–≥–µ—Ç–∞—Ü–∏—è, –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-family: Arial, sans-serif;">
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">–ü–æ–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</div>
                    </div>
                    
                    <div style="padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50; margin-bottom: 15px;">
                        <div style="font-weight: bold; font-size: 14px; color: #2e7d32; margin-bottom: 5px;">üåê –ü—Ä–æ—Ñ–∏–ª—å –±—É–¥–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º</div>
                        <div style="font-size: 12px; color: #555;">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</div>
                    </div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞
                previewDiv.style.display = 'block';
                previewContent.textContent = content.substring(0, 1000) + (content.length > 1000 ? '\n...' : '');

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                window.uploadedHPGContent = content;
                window.uploadedHPGFilename = file.name;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
                submitBtn.style.display = 'block';

            } catch (error) {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${error.message}`;
                previewDiv.style.display = 'none';
                submitBtn.style.display = 'none';
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ HPG —Ñ–∞–π–ª–∞
        function parseHPGMetadata(content, filename) {
            const lines = content.split('\n');
            let name = filename.replace(/\.hpg$/i, '');
            let description = '';
            const profile = {};

            for (const line of lines) {
                const trimmed = line.trim();
                
                // –ü–∞—Ä—Å–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–∏–µ
                if (trimmed.startsWith('Comment=')) {
                    description = trimmed.substring(8);
                }
                // –ü–∞—Ä—Å–∏–º –∑–Ω–∞—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                else if (trimmed.includes('=') && !trimmed.startsWith('#')) {
                    const [key, value] = trimmed.split('=');
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        profile[key] = numValue;
                    }
                }
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è
            const profileString = buildProfileString(profile);

            return { name, description, profileString };
        }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞
        function buildProfileString(profile) {
            const elements = ['N', 'NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'];
            const parts = [];
            
            for (const el of elements) {
                const value = profile[el] || 0;
                parts.push(`${el}=${value}`);
            }
            
            return parts.join(' ');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è HPG —Ñ–∞–π–ª–∞
        function validateHPGFile(content) {
            const lines = content.split('\n');
            let hasVersion = false;
            let elementsCount = 0;
            const requiredElements = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
            const foundElements = new Set();

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
                if (trimmed.startsWith('version=')) {
                    hasVersion = true;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (trimmed.includes('=')) {
                    const [key] = trimmed.split('=');
                    if (requiredElements.includes(key)) {
                        foundElements.add(key);
                        elementsCount++;
                    }
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∏
            if (!hasVersion) {
                return { valid: false, error: '–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É version=' };
            }

            const missingElements = requiredElements.filter(el => !foundElements.has(el));
            if (missingElements.length > 0) {
                return { valid: false, error: `–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: ${missingElements.join(', ')}` };
            }

            return { valid: true, elementsCount: foundElements.size };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ HPG –ø—Ä–æ—Ñ–∏–ª—è –≤ –æ–±–ª–∞–∫–æ
        async function uploadHPGProfile() {
            if (!window.uploadedHPGContent || !currentUser) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }

            const name = document.getElementById('upload-name').value.trim();
            const description = document.getElementById('upload-description').value.trim();
            const tagsInput = document.getElementById('upload-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }

            const submitBtn = document.getElementById('upload-submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
                const parsedData = parseHPGMetadata(window.uploadedHPGContent, window.uploadedHPGFilename);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ Firestore
                await db.collection('profiles').add({
                    // –í–ª–∞–¥–µ–ª–µ—Ü
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    userPhotoURL: currentUser.photoURL || null,
                    
                    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
                    appKey: 'wega-hpg-profile',
                    
                    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    name: name,
                    description: description,
                    tags: tags,
                    
                    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è - –ü–û–õ–ù–´–ô —Ñ–∞–π–ª HPG
                    profile: window.uploadedHPGContent,
                    profileString: parsedData.profileString, // –°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    
                    // –ñ—É—Ä–Ω–∞–ª (–ø—É—Å—Ç–æ–π –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
                    journal: [],
                    
                    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    modified: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '1.0',
                    
                    // –ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å - –≤—Å–µ–≥–¥–∞ true –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª
                    public: true,
                    
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    downloads: 0,
                    commentsCount: 0
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.querySelector('.modal').remove();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π
                await loadProfiles();
                renderProfiles();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #667eea;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        async function submitComment(profileId, profileName) {
            const textarea = document.getElementById('comment-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                return;
            }
            
            if (!currentUser) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Firestore
                await db.collection('comments').add({
                    profileId: profileId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || '–ê–Ω–æ–Ω–∏–º',
                    userEmail: currentUser.email,
                    userPhotoURL: currentUser.photoURL || null,
                    text: text,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                await db.collection('profiles').doc(profileId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫:', err));
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                textarea.value = '';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const modal = document.querySelector('.modal');
                modal.remove();
                showComments(profileId, profileName);
                loadActivityFeed();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞
        function toggleJournal(profileId) {
            const content = document.getElementById(`journal-content-${profileId}`);
            const arrow = document.getElementById(`journal-arrow-${profileId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        async function submitDetailComment(profileId, profileName) {
            const textarea = document.getElementById('detail-comment-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                return;
            }
            
            if (!currentUser) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                return;
            }
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Firestore
                await db.collection('comments').add({
                    profileId: profileId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || '–ê–Ω–æ–Ω–∏–º',
                    userEmail: currentUser.email,
                    userPhotoURL: currentUser.photoURL || null,
                    text: text,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                await db.collection('profiles').doc(profileId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫:', err));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
                const profile = allProfiles.find(p => p.id === profileId);
                if (profile) {
                    profile.commentsCount = (profile.commentsCount || 0) + 1;
                }
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                textarea.value = '';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const modal = document.querySelector('.modal');
                modal.remove();
                showProfileDetail(profileId);
                loadActivityFeed();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        // Debounce —Ñ—É–Ω–∫—Ü–∏—è
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedTag = document.getElementById('tagFilter').value;
            const sortBy = document.getElementById('sortSelect').value;

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            filteredProfiles = allProfiles.filter(profile => {
                const matchesSearch = !searchTerm || 
                    profile.name.toLowerCase().includes(searchTerm) ||
                    (profile.description && profile.description.toLowerCase().includes(searchTerm));

                const matchesTag = !selectedTag || 
                    (profile.tags && profile.tags.includes(selectedTag));
                
                // –§–∏–ª—å—Ç—Ä "–¢–æ–ª—å–∫–æ –º–æ–∏"
                const matchesUser = userFilter === 'all' || 
                    (currentUser && profile.userId === currentUser.uid);

                return matchesSearch && matchesTag && matchesUser;
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            filteredProfiles.sort((a, b) => {
                if (sortBy === 'date') {
                    return (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0);
                } else if (sortBy === 'views') {
                    return (b.views || 0) - (a.views || 0);
                } else if (sortBy === 'name') {
                    return a.name.localeCompare(b.name, 'ru');
                } else if (sortBy === 'author') {
                    const authorA = a.userName || a.userEmail || '–ê–Ω–æ–Ω–∏–º';
                    const authorB = b.userName || b.userEmail || '–ê–Ω–æ–Ω–∏–º';
                    return authorA.localeCompare(authorB, 'ru');
                }
                return 0;
            });

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            currentPage = 1;
            renderProfiles();
        }
        
        // Debounced –≤–µ—Ä—Å–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞
        const debouncedApplyFilters = debounce(applyFilters, 300);

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeJs(text) {
            if (!text) return '';
            return String(text).replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        function getProfileWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return '–ø—Ä–æ—Ñ–∏–ª—å';
            if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return '–ø—Ä–æ—Ñ–∏–ª—è';
            return '–ø—Ä–æ—Ñ–∏–ª–µ–π';
        }

        function getViewWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return '–ø—Ä–æ—Å–º–æ—Ç—Ä';
            if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return '–ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
            return '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤';
        }

        function showError(message) {
            const container = document.getElementById('profilesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h2>–û—à–∏–±–∫–∞</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)
        async function loadActivityFeed() {
            const container = document.getElementById('activityContainer');
            
            try {
                const activities = [];
                
                // 1. –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 –ø—Ä–æ—Ñ–∏–ª–µ–π –∏–∑ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö
                const sortedProfiles = [...allProfiles]
                    .sort((a, b) => (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0))
                    .slice(0, 15);
                
                sortedProfiles.forEach(profile => {
                    activities.push({
                        type: 'profile_created',
                        timestamp: profile.modified || profile.created,
                        userId: profile.userId,
                        userName: profile.userName || '–ê–Ω–æ–Ω–∏–º',
                        userPhotoURL: profile.userPhotoURL,
                        profileId: profile.id,
                        profileName: profile.name
                    });
                });
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
                if (currentUser) {
                    try {
                        const commentsSnapshot = await db.collection('comments')
                            .orderBy('created', 'desc')
                            .limit(10)
                            .get();
                        
                        commentsSnapshot.forEach(doc => {
                            const data = doc.data();
                            activities.push({
                                type: 'comment',
                                timestamp: data.created,
                                userId: data.userId,
                                userName: data.userName || '–ê–Ω–æ–Ω–∏–º',
                                userPhotoURL: data.userPhotoURL,
                                profileId: data.profileId,
                                text: data.text
                            });
                        });
                    } catch (error) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –ª–µ–Ω—Ç—ã:', error);
                    }
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                activities.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis() || 0;
                    const timeB = b.timestamp?.toMillis() || 0;
                    return timeB - timeA;
                });
                
                // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–±—ã—Ç–∏–π
                let recentActivities = activities.slice(0, 20);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —É—á–∞—Å—Ç–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä "–ú–æ–∏")
                if (activityFilter === 'my' && currentUser) {
                    recentActivities = recentActivities.filter(activity => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–≤—Ç–æ—Ä
                        if (activity.userId === currentUser.uid) {
                            return true;
                        }
                        // –ò–ª–∏ –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ñ–∏–ª—è
                        const profile = allProfiles.find(p => p.id === activity.profileId);
                        if (profile && profile.userId === currentUser.uid) {
                            return true;
                        }
                        return false;
                    });
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                if (recentActivities.length === 0) {
                    container.innerHTML = `
                        <div class="activity-empty">
                            <div class="activity-empty-icon">üì≠</div>
                            <div>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                recentActivities.forEach(activity => {
                    html += renderActivityItem(activity);
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
                container.innerHTML = `
                    <div class="activity-empty">
                        <div class="activity-empty-icon">‚ùå</div>
                        <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                `;
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function renderActivityItem(activity) {
            const time = activity.timestamp?.toDate();
            const timeAgo = time ? getTimeAgo(time) : '';
            
            // –ê–≤–∞—Ç–∞—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const avatarUrl = activity.userPhotoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.userName)}&size=40&background=667eea&color=fff`;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            const profile = allProfiles.find(p => p.id === activity.profileId);
            
            let icon = 'üìå';
            let actionText = '';
            let bodyHtml = '';
            
            if (activity.type === 'profile_created' && profile) {
                icon = 'üì§';
                actionText = '–∑–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å';
                
                // –¢–µ–≥–∏ –ø—Ä–æ—Ñ–∏–ª—è
                const tagsHtml = profile.tags && profile.tags.length > 0 ? 
                    `<div class="activity-tags">
                        ${profile.tags.slice(0, 3).map(tag => `<span class="activity-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`).join('')}
                        ${profile.tags.length > 3 ? `<span class="activity-tag">+${profile.tags.length - 3}</span>` : ''}
                    </div>` : '';
                
                // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                const description = profile.description ? 
                    `<div style="color: #666; font-size: 13px; margin-top: 8px; line-height: 1.4;">
                        ${escapeHtml(profile.description.length > 100 ? profile.description.substring(0, 100) + '...' : profile.description)}
                    </div>` : '';
                
                bodyHtml = `
                    <div class="activity-body">
                        <div class="activity-profile-card">
                            <div class="activity-profile-title">
                                üåê ${escapeHtml(profile.name)}
                            </div>
                            <div class="activity-profile-meta">
                                <span>üëÅÔ∏è ${profile.views || 0}</span>
                                <span>üëç ${profile.likes || 0}</span>
                                <span>üí¨ ${profile.commentsCount || 0}</span>
                            </div>
                            ${description}
                            ${tagsHtml}
                        </div>
                        <div class="activity-actions">
                            <button class="activity-btn activity-btn-primary" onclick="showProfileDetail('${profile.id}')">
                                üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                            </button>
                            <button class="activity-btn activity-btn-secondary" onclick="openInCalculator('${profile.id}')">
                                üß™ –û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
                            </button>
                            <button class="activity-btn activity-btn-secondary" onclick="showComments('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            </button>
                        </div>
                    </div>
                `;
            } else if (activity.type === 'comment') {
                icon = 'üí¨';
                actionText = '–ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª –ø—Ä–æ—Ñ–∏–ª—å';
                
                // –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                const commentText = activity.text || '';
                const shortText = commentText.length > 120 ? commentText.substring(0, 120) + '...' : commentText;
                
                // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ñ–∏–ª—å, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const commentedProfile = allProfiles.find(p => p.id === activity.profileId);
                const profileName = commentedProfile ? commentedProfile.name : '–ü—Ä–æ—Ñ–∏–ª—å';
                const profileOwnerName = commentedProfile ? (commentedProfile.userName || '–ê–Ω–æ–Ω–∏–º') : '–ê–Ω–æ–Ω–∏–º';
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è
                const profileOwnerAvatar = commentedProfile?.userPhotoURL || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(profileOwnerName)}&size=32&background=764ba2&color=fff`;
                
                bodyHtml = `
                    <div class="activity-body">
                        <div class="activity-profile-card">
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e8ecff;">
                                <img src="${profileOwnerAvatar}" alt="${escapeHtml(profileOwnerName)}" 
                                     style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #764ba2;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 11px; color: #999;">–ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞:</div>
                                    <div style="font-weight: 600; color: #764ba2; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${escapeHtml(profileOwnerName)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                            <div style="color: #333; font-size: 13px; line-height: 1.6; margin-bottom: 12px; font-style: italic; border-left: 3px solid #667eea; padding-left: 12px; background: #f8f9ff; padding: 10px 10px 10px 12px; border-radius: 4px;">
                                "${escapeHtml(shortText)}"
                            </div>
                            
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
                            <div class="activity-profile-title" style="margin-bottom: 8px;">
                                üåê ${escapeHtml(profileName)}
                            </div>
                            
                            ${commentedProfile ? `
                                <div class="activity-profile-meta">
                                    <span>üëÅÔ∏è ${commentedProfile.views || 0}</span>
                                    <span>üëç ${commentedProfile.likes || 0}</span>
                                    <span>üí¨ ${commentedProfile.commentsCount || 0}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="activity-actions">
                            ${commentedProfile ? `
                                <button class="activity-btn activity-btn-primary" onclick="showProfileDetail('${activity.profileId}')">
                                    üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                </button>
                                <button class="activity-btn activity-btn-secondary" onclick="openInCalculator('${activity.profileId}')">
                                    üß™ –û—Ç–∫—Ä—ã—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
                                </button>
                                <button class="activity-btn activity-btn-secondary" onclick="showComments('${activity.profileId}', '${escapeHtml(profileName).replace(/'/g, "\\'")}')">
                                    üí¨ –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                                </button>
                            ` : `
                                <button class="activity-btn activity-btn-secondary" onclick="showComments('${activity.profileId}', '${escapeHtml(profileName).replace(/'/g, "\\'")}')">
                                    üí¨ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="activity-item">
                    <div class="activity-header">
                        <img src="${avatarUrl}" alt="${escapeHtml(activity.userName)}" class="activity-avatar">
                        <div class="activity-user-info">
                            <div class="activity-user">${escapeHtml(activity.userName)}</div>
                            <div class="activity-action">
                                <span class="activity-icon">${icon}</span>
                                ${actionText}
                            </div>
                        </div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                    ${bodyHtml}
                </div>
            `;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ "–Ω–∞–∑–∞–¥"
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è "–¢–æ–ª—å–∫–æ –º–æ–∏ / –í—Å–µ" –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
        document.querySelectorAll('#userFilterContainer .user-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                document.querySelectorAll('#userFilterContainer .user-filter-btn').forEach(b => b.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º active –Ω–∞ —Ç–µ–∫—É—â—É—é
                this.classList.add('active');
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                userFilter = this.dataset.filter;
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                applyFilters();
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è "–í—Å–µ / –ú–æ–∏" –¥–ª—è –ª–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        document.querySelectorAll('#activityFilterContainer .user-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                document.querySelectorAll('#activityFilterContainer .user-filter-btn').forEach(b => b.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º active –Ω–∞ —Ç–µ–∫—É—â—É—é
                this.classList.add('active');
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                activityFilter = this.dataset.filter;
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                loadActivityFeed();
            });
        });

        // –°–æ–±—ã—Ç–∏—è
        document.getElementById('searchInput').addEventListener('input', debouncedApplyFilters);
        document.getElementById('tagFilter').addEventListener('change', applyFilters);
        document.getElementById('sortSelect').addEventListener('change', applyFilters);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö—ç—à–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ
        function handleProfileHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#profile-')) {
                const profileId = hash.replace('#profile-', '');
                if (profileId) {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –ø—Ä–æ—Ñ–∏–ª–∏ —É—Å–ø–µ–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
                    setTimeout(() => {
                        showProfileDetail(profileId);
                    }, 100);
                }
            }
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ö—ç—à–∞
        window.addEventListener('hashchange', handleProfileHash);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadProfiles().then(() => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
            loadActivityFeed();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö—ç—à –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            handleProfileHash();
        });

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–Æ–ß–ï–í–´–ú–ò –°–û–ë–´–¢–ò–Ø–ú–ò ==========
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showCustomModal(title, body, buttons) {
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const buttonsHtml = buttons.map((btn, index) => 
                `<button class="btn ${btn.class}" data-btn-index="${index}">${btn.text}</button>`
            ).join('');
            
            modal.innerHTML = `
                <div id="customModalContent" style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 20px; color: #333;">${title}</h2>
                        <button id="customModalClose" style="border: none; background: transparent; font-size: 24px; cursor: pointer; color: #999; line-height: 1;">‚úï</button>
                    </div>
                    <div style="padding: 25px; max-height: calc(90vh - 140px); overflow-y: auto;">
                        ${body}
                    </div>
                    <div style="padding: 15px 25px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; background: #f8f9fa;">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay (—Ñ–æ–Ω)
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomModal();
                }
            });
            
            document.body.appendChild(modal);
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –∫ –∫—Ä–µ—Å—Ç–∏–∫—É
            const closeBtn = document.getElementById('customModalClose');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeCustomModal);
            }
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º callback'–∏ –∫ –∫–Ω–æ–ø–∫–∞–º
            buttons.forEach((btn, index) => {
                const btnElement = modal.querySelector(`[data-btn-index="${index}"]`);
                if (btnElement) {
                    btnElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        btn.callback();
                    });
                }
            });
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function manageMilestones(profileId) {
            const profile = getProfileById(profileId);
            if (!profile) return;
            
            showMilestonesModal(profileId);
        }
        
        function showMilestonesModal(profileId) {
            const profile = getProfileById(profileId);
            const milestones = profile.milestones || [];
            
            const milestonesListHtml = milestones.length > 0 
                ? milestones.map((m, index) => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${escapeHtml(m.title)}</div>
                            <div style="font-size: 13px; color: #666;">üìÖ ${formatJournalDate(m.date)}</div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="showEditMilestoneForm('${profileId}', ${index})" style="flex-shrink: 0;">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="deleteMilestone('${profileId}', ${index})" style="flex-shrink: 0; color: #d32f2f;">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('')
                : '<div style="text-align: center; padding: 40px; color: #999;">–ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
            
            showCustomModal(
                '–ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è',
                `
                <div style="max-width: 600px;">
                    <div style="margin-bottom: 20px; padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 13px; color: #1565c0;">
                        üí° –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–º–æ–≥–∞—é—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: "–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã", "–ü–µ—Ä–≤—ã–µ –≤—Å—Ö–æ–¥—ã", "–°–±–æ—Ä —É—Ä–æ–∂–∞—è"
                    </div>
                    <div id="milestones-list" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                        ${milestonesListHtml}
                    </div>
                </div>
                `,
                [
                    { text: '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ', class: 'btn-primary', callback: () => showAddMilestoneForm(profileId) },
                    { text: '–ó–∞–∫—Ä—ã—Ç—å', class: 'btn-secondary', callback: () => closeCustomModal() }
                ]
            );
        }
        
        function showAddMilestoneForm(profileId) {
            showCustomModal(
                '–î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                `
                <div style="max-width: 500px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>
                        <input type="text" id="milestone-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã" 
                               style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è:</label>
                        <input type="date" id="milestone-date"
                               style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                `,
                [
                    { text: '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', class: 'btn-primary', callback: () => saveMilestone(profileId) },
                    { text: '–û—Ç–º–µ–Ω–∞', class: 'btn-secondary', callback: () => showMilestonesModal(profileId) }
                ]
            );
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            setTimeout(() => document.getElementById('milestone-title')?.focus(), 100);
        }
        
        function showEditMilestoneForm(profileId, index) {
            const profile = getProfileById(profileId);
            const milestone = profile.milestones[index];
            
            showCustomModal(
                '–ò–∑–º–µ–Ω–∏—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                `
                <div style="max-width: 500px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>
                        <input type="text" id="milestone-title" value="${escapeHtml(milestone.title)}"
                               style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è:</label>
                        <input type="date" id="milestone-date" value="${milestone.date}"
                               style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                `,
                [
                    { text: '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', class: 'btn-primary', callback: () => updateMilestone(profileId, index) },
                    { text: '–û—Ç–º–µ–Ω–∞', class: 'btn-secondary', callback: () => showMilestonesModal(profileId) }
                ]
            );
        }
        
        async function saveMilestone(profileId) {
            const title = document.getElementById('milestone-title')?.value.trim();
            const date = document.getElementById('milestone-date')?.value.trim();
            
            if (!title) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è');
                return;
            }
            
            if (!date) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è');
                return;
            }
            
            try {
                const profile = getProfileById(profileId);
                const milestones = profile.milestones || [];
                
                milestones.push({ title, date });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
                milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                await db.collection('profiles').doc(profileId).update({
                    milestones: milestones
                });
                
                showNotification('‚úÖ –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeCustomModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
                await loadProfiles();
                await showProfileDetail(profileId);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
                setTimeout(() => showMilestonesModal(profileId), 100);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
            }
        }
        
        async function updateMilestone(profileId, index) {
            const title = document.getElementById('milestone-title')?.value.trim();
            const date = document.getElementById('milestone-date')?.value.trim();
            
            if (!title) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è');
                return;
            }
            
            if (!date) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è');
                return;
            }
            
            try {
                const profile = getProfileById(profileId);
                const milestones = profile.milestones || [];
                
                milestones[index] = { title, date };
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
                milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                await db.collection('profiles').doc(profileId).update({
                    milestones: milestones
                });
                
                showNotification('‚úÖ –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeCustomModal();
                
                await loadProfiles();
                await showProfileDetail(profileId);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
                setTimeout(() => showMilestonesModal(profileId), 100);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
            }
        }
        
        async function deleteMilestone(profileId, index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ?')) return;
            
            try {
                const profile = getProfileById(profileId);
                const milestones = profile.milestones || [];
                
                milestones.splice(index, 1);
                
                await db.collection('profiles').doc(profileId).update({
                    milestones: milestones
                });
                
                showNotification('‚úÖ –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeCustomModal();
                
                await loadProfiles();
                await showProfileDetail(profileId);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π
                setTimeout(() => showMilestonesModal(profileId), 100);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
        function getMilestoneDistances(currentDate, milestones) {
            if (!milestones || milestones.length === 0) return null;
            
            const current = parseTimelineDate(currentDate);
            let prevMilestone = null;
            let nextMilestone = null;
            
            for (const milestone of milestones) {
                const milestoneDate = parseTimelineDate(milestone.date);
                
                if (milestoneDate <= current) {
                    prevMilestone = { ...milestone, date: milestoneDate };
                } else if (!nextMilestone && milestoneDate > current) {
                    nextMilestone = { ...milestone, date: milestoneDate };
                    break;
                }
            }
            
            return {
                prev: prevMilestone ? {
                    title: prevMilestone.title,
                    days: getDaysDifference(prevMilestone.date, current)
                } : null,
                next: nextMilestone ? {
                    title: nextMilestone.title,
                    days: getDaysDifference(current, nextMilestone.date)
                } : null
            };
        }
    </script>
</body>
</html>
