<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPG Community - Библиотека профилей гидропоники</title>
    
    <style>
        * {
            margin: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: url('assets/background01.jpg') center/cover fixed no-repeat;
            background-color: #5a9e9e;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .logo-icon {
            font-size: 32px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a9d9d 0%, #2d7a7a 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(74, 157, 157, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 157, 157, 0.5);
        }

        .btn-secondary {
            background: rgba(74, 157, 157, 0.15);
            color: #2d7a7a;
            border: 2px solid rgba(74, 157, 157, 0.4);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.15);
        }

        .btn-secondary:hover {
            background: rgba(74, 157, 157, 0.25);
            color: #1a5555;
            border-color: rgba(74, 157, 157, 0.6);
            box-shadow: 0 4px 12px rgba(45, 122, 122, 0.25);
            transform: translateY(-1px);
        }
        
        .btn-light {
            background: rgba(255, 255, 255, 0.9);
            color: #4a9d9d;
            border: 2px solid rgba(74, 157, 157, 0.3);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.1);
        }

        .btn-light:hover {
            background: rgba(255, 255, 255, 1);
            color: #2d7a7a;
            border-color: rgba(74, 157, 157, 0.5);
            box-shadow: 0 4px 12px rgba(45, 122, 122, 0.2);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .main-content {
            min-width: 0;
        }
        
        .activity-feed {
            position: sticky;
            top: 90px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .activity-feed h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #2d7a7a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .activity-item {
            padding: 16px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            border: 1px solid rgba(74, 157, 157, 0.2);
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(45, 122, 122, 0.1);
        }
        
        .activity-item:hover {
            border-color: #4a9d9d;
            box-shadow: 0 4px 16px rgba(45, 122, 122, 0.2);
            transform: translateY(-2px);
        }
        
        .activity-item:last-child {
            margin-bottom: 0;
        }
        
        .activity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4a9d9d;
            flex-shrink: 0;
        }
        
        .activity-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .activity-user {
            font-weight: 600;
            color: #333;
            display: block;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .activity-action {
            font-size: 12px;
            color: #4a9d9d;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .activity-icon {
            font-size: 14px;
        }
        
        .activity-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
        }
        
        .activity-body {
            margin-bottom: 12px;
        }
        
        .activity-profile-card {
            background: #f8f9ff;
            border: 1px solid #e8ecff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }
        
        .activity-profile-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .activity-profile-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .activity-profile-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .activity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .activity-tag {
            background: #4a9d9d;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .activity-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .activity-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        
        .activity-btn-primary {
            background: #4a9d9d;
            color: white;
        }
        
        .activity-btn-primary:hover {
            background: #3d8585;
            transform: translateY(-1px);
        }
        
        .activity-btn-secondary {
            background: white;
            color: #4a9d9d;
            border: 1px solid #4a9d9d;
        }
        
        .activity-btn-secondary:hover {
            background: #f0f9f9;
        }
        
        .activity-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .activity-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .hero {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .hero p {
            font-size: 20px;
            opacity: 0.95;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #999;
        }

        .filter-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: flex;
            gap: 10px;
            align-items: center;
            color: #666;
            font-size: 14px;
        }
        
        .user-filter {
            display: flex;
            gap: 8px;
            background: white;
            border: 2px solid #4a9d9d;
            border-radius: 8px;
            padding: 4px;
        }
        
        .user-filter-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #4a9d9d;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .user-filter-btn:hover {
            background: #f0f9f9;
        }
        
        .user-filter-btn.active {
            background: #4a9d9d;
            color: white;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .profile-card {
            background: white;
            border-radius: 12px;
            overflow: visible;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .profile-photos-collage {
            position: relative;
            height: 180px;
            margin: 15px;
            perspective: 1000px;
        }
        
        .collage-photo {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            object-fit: cover;
            border: 3px solid white;
            transition: all 0.3s ease;
        }
        
        .collage-photo:nth-child(1) {
            top: 20px;
            left: 20px;
            transform: rotate(-8deg);
            z-index: 3;
        }
        
        .collage-photo:nth-child(2) {
            top: 10px;
            left: 50%;
            transform: translateX(-50%) rotate(5deg);
            z-index: 2;
        }
        
        .collage-photo:nth-child(3) {
            top: 20px;
            right: 20px;
            transform: rotate(8deg);
            z-index: 1;
        }
        
        .profile-card:hover .collage-photo:nth-child(1) {
            transform: rotate(-12deg) translateY(-5px);
        }
        
        .profile-card:hover .collage-photo:nth-child(2) {
            transform: translateX(-50%) rotate(0deg) translateY(-8px);
        }
        
        .profile-card:hover .collage-photo:nth-child(3) {
            transform: rotate(12deg) translateY(-5px);
        }
        
        .collage-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 180px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 15px;
            border-radius: 12px;
            font-size: 48px;
            opacity: 0.3;
        }

        .profile-header {
            padding: 20px 60px 22px 20px;
            background: linear-gradient(135deg, #5f8de0 0%, #6a48a5 100%);
            color: white;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-radius: 12px 12px 0 0;
        }

        .profile-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
        }

        .profile-header:hover .profile-expand-icon {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.36);
        }

        .profile-expand-icon {
            position: absolute;
            right: 22px;
            top: 22px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.24);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 12px rgba(30, 40, 90, 0.2);
        }

        .profile-title {
            font-size: 19px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 60px;
        }

        .profile-description {
            margin: 0;
            line-height: 1.45;
            font-size: 13px;
            opacity: 0.85;
            padding-left: 60px;
        }

        .author-avatar {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-body {
            padding: 20px;
        }

        .profile-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-tools {
            margin: 12px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-tools .btn-small {
            flex: none;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            padding: 5px 12px;
            background: #f0f0f0;
            border-radius: 15px;
            font-size: 12px;
            color: #555;
        }

        .profile-string-view {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-family: "Fira Code", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .journal-entry {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            background: #fdfdfd;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.08);
        }

        .journal-entry:last-child {
            margin-bottom: 0;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 10px;
        }

        .journal-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .journal-meta strong {
            font-size: 14px;
            color: #333;
        }

        .journal-meta span {
            font-size: 12px;
            color: #666;
        }

        .journal-description {
            font-size: 13px;
            color: #444;
            margin-top: 6px;
            line-height: 1.4;
        }

        .journal-profile {
            font-family: "Fira Code", "Courier New", monospace;
            font-size: 12px;
            background: #f4f7ff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #dde4ff;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-stats {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
            color: #999;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            justify-content: center;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .empty-state h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            opacity: 0.9;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .modal-content-large {
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .profile-detail {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: 100%;
        }
        
        .profile-detail-sidebar {
            border-right: 1px solid #e0e0e0;
            padding-right: 30px;
        }
        
        .profile-detail-main {
            overflow-y: auto;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        
        .profile-detail-description {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
        }
        
        .profile-detail-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .profile-detail-section {
            margin-bottom: 30px;
        }
        
        .profile-detail-section h3 {
            font-size: 18px;
            color: #2d7a7a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .profile-detail-tag {
            background: rgba(74, 157, 157, 0.1);
            color: #2d7a7a;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(74, 157, 157, 0.3);
        }
        
        .profile-detail-author {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .profile-detail-author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #4a9d9d;
        }
        
        .profile-detail-author-info {
            flex: 1;
        }
        
        .profile-detail-author-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        
        .profile-detail-author-date {
            font-size: 12px;
            color: #999;
        }
        
        .profile-detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .profile-detail-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .profile-detail-stat[onclick]:hover {
            background: #f0f9f9;
            border-color: #4a9d9d;
            transform: translateY(-2px);
        }
        
        .profile-detail-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #4a9d9d;
            margin-bottom: 5px;
        }
        
        .profile-detail-stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .profile-gallery-placeholder {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #999;
        }
        
        @media (max-width: 968px) {
            .profile-detail {
                grid-template-columns: 1fr;
            }
            
            .profile-detail-sidebar {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding-right: 0;
                padding-bottom: 20px;
            }
            
            .profile-detail-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .profile-detail-stats {
                grid-template-columns: 1fr;
            }
        }

        .comment {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .no-comments {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .no-comments-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .comment-form {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            background: #f9f9f9;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 32px;
            }

            .hero p {
                font-size: 16px;
            }

            .profiles-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .modal-content {
                max-height: 90vh;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .activity-feed {
                position: relative;
                top: 0;
                max-height: 400px;
                order: -1;
            }
        }
        
        /* Анимации для уведомлений */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">🌱</span>
                <span>HPG Community</span>
            </div>
            <div class="header-actions">
                <button id="gallery-btn" class="btn btn-secondary" onclick="window.location.href='gallery.html'" style="display: none;">
                    📸 Галерея
                </button>
                <button id="upload-btn" class="btn btn-primary" onclick="showUploadForm()" style="display: none;">
                    📤 Загрузить профиль
                </button>
                <a href="../hpg.html" class="btn btn-secondary">
                    🧪 Открыть калькулятор
                </a>
                <div id="auth-section">
                    <!-- Кнопка входа (показывается когда не авторизован) -->
                    <button id="login-btn" class="btn btn-primary" onclick="loginWithGoogle()" style="display: none;">
                        🔐 Войти через Google
                    </button>
                    <!-- Информация о пользователе (показывается когда авторизован) -->
                    <div id="user-info" style="display: none; align-items: center; gap: 10px;">
                        <img id="user-avatar" style="width: 36px; height: 36px; border-radius: 50%;" alt="">
                        <span id="user-name" style="font-size: 14px; font-weight: 500;"></span>
                        <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 15px; font-size: 13px;">
                            Выйти
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер -->
    <div class="container">
        <!-- Герой -->
        <div class="hero">
            <h1>📚 Библиотека профилей</h1>
            <p>Готовые рецепты питательных растворов от сообщества гидропонщиков</p>
        </div>

        <!-- Основной layout с двумя колонками -->
        <div class="main-layout">
            <!-- Лента активности (слева) -->
            <div class="activity-feed">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">📰 Лента активности</h3>
                    <div id="activityFilterContainer" style="display: none;">
                        <div class="user-filter" style="padding: 2px;">
                            <button class="user-filter-btn active" data-filter="all" style="padding: 6px 12px; font-size: 12px;">Все</button>
                            <button class="user-filter-btn" data-filter="my" style="padding: 6px 12px; font-size: 12px;">Мои</button>
                        </div>
                    </div>
                </div>
                <div id="activityContainer">
                    <div class="activity-empty">
                        <div class="activity-empty-icon">⏳</div>
                        <div>Загрузка...</div>
                    </div>
                </div>
            </div>

            <!-- Основной контент (справа) -->
            <div class="main-content">
                <!-- Фильтры -->
                <div class="filters">
                    <div class="filters-row">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Поиск по названию или описанию...">
                            <span class="search-icon">🔍</span>
                        </div>
                        
                        <select id="tagFilter" class="filter-select">
                            <option value="">Все культуры</option>
                        </select>
                        
                        <select id="sortSelect" class="filter-select">
                            <option value="views">По популярности ↓</option>
                            <option value="date">По дате ↓</option>
                            <option value="name">По названию ↑</option>
                            <option value="author">По автору ↑</option>
                        </select>
                        
                        <div id="userFilterContainer" style="display: none;">
                            <div class="user-filter">
                                <button class="user-filter-btn active" data-filter="all">Все</button>
                                <button class="user-filter-btn" data-filter="my">Только мои</button>
                            </div>
                        </div>
                        
                        <div class="stats">
                            <span id="profileCount">Загрузка...</span>
                        </div>
                    </div>
                </div>

                <!-- Сетка профилей -->
                <div id="profilesContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Загружаем профили...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAR5qXMGP8Erapla69wJ7cUbbF4MNlbkcY",
            authDomain: "wega-hpg.firebaseapp.com",
            projectId: "wega-hpg",
            storageBucket: "wega-hpg.firebasestorage.app",
            messagingSenderId: "652081809935",
            appId: "1:652081809935:web:84a407f1a6bfc719aa717a",
            measurementId: "G-W6EDZTWP3F"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Текущий пользователь
        let currentUser = null;
        let authReady = false;

        // Глобальные переменные
        let allProfiles = [];
        let filteredProfiles = [];
        let userFilter = 'all'; // 'all' или 'my' для профилей
        let activityFilter = 'all'; // 'all' или 'my' для ленты активности
        
        // Кеш фото пользователей (глобальный)
        const userPhotosCache = {};
        
        // Пагинация
        const PROFILES_PER_PAGE = 24;
        let currentPage = 1;
        let totalPages = 1;

        // Авторизация через Google
        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert('❌ Ошибка входа: ' + error.message);
            }
        }

        // Выход
        async function logout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Ошибка выхода:', error);
                alert('❌ Ошибка выхода: ' + error.message);
            }
        }

        // Отслеживание состояния авторизации
        // Глобальная переменная для хранения ID открытого профиля
        let currentOpenProfileId = null;

        auth.onAuthStateChanged(user => {
            currentUser = user;
            authReady = true;
            
            if (user) {
                // Пользователь авторизован
                console.log('Пользователь авторизован:', user.email);
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('gallery-btn').style.display = 'inline-block';
                document.getElementById('upload-btn').style.display = 'block';
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-avatar').src = user.photoURL || '';
                document.getElementById('user-name').textContent = user.displayName || user.email;
                
                // Показываем переключатели "Только мои / Все"
                document.getElementById('userFilterContainer').style.display = 'block';
                document.getElementById('activityFilterContainer').style.display = 'block';
                
                // Если открыто детальное окно профиля, обновляем его
                if (currentOpenProfileId) {
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        modal.remove();
                        showProfileDetail(currentOpenProfileId);
                    }
                }
            } else {
                // Пользователь не авторизован
                console.log('Пользователь не авторизован');
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('gallery-btn').style.display = 'none';
                document.getElementById('upload-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
                
                // Скрываем переключатели и сбрасываем фильтры
                document.getElementById('userFilterContainer').style.display = 'none';
                document.getElementById('activityFilterContainer').style.display = 'none';
                userFilter = 'all';
                activityFilter = 'all';
            }
        });

        // Загрузка профилей
        async function loadProfiles() {
            try {
                const snapshot = await db.collection('profiles')
                    .where('public', '==', true)
                    .get();

                allProfiles = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Сортируем на клиенте по дате (по умолчанию)
                allProfiles.sort((a, b) => {
                    return (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0);
                });

                // Загружаем фото пользователей из коллекции users (с кешированием)
                const userIds = [...new Set(allProfiles.map(p => p.userId).filter(id => id))];
                
                // Фильтруем только те userId, которых нет в кеше
                const uncachedUserIds = userIds.filter(id => !userPhotosCache[id]);
                
                // Загружаем фото только для авторизованных пользователей
                if (uncachedUserIds.length > 0 && currentUser) {
                    try {
                        // Загружаем данные пользователей пачками (Firestore поддерживает до 10 в in)
                        for (let i = 0; i < uncachedUserIds.length; i += 10) {
                            const batch = uncachedUserIds.slice(i, i + 10);
                            const usersSnapshot = await db.collection('users')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            
                            usersSnapshot.forEach(doc => {
                                const userData = doc.data();
                                if (userData.photoURL) {
                                    // Сохраняем в глобальный кеш
                                    userPhotosCache[doc.id] = userData.photoURL;
                                }
                            });
                        }
                    } catch (error) {
                        console.log('Не удалось загрузить фото пользователей:', error);
                    }
                }
                
                // Применяем фото из кеша ко всем профилям
                allProfiles.forEach(profile => {
                    if (profile.userId && userPhotosCache[profile.userId]) {
                        profile.userPhotoURL = userPhotosCache[profile.userId];
                    }
                });

                // Извлекаем уникальные теги
                const allTags = new Set();
                allProfiles.forEach(profile => {
                    if (profile.tags && Array.isArray(profile.tags)) {
                        profile.tags.forEach(tag => allTags.add(tag));
                    }
                });

                // Заполняем фильтр тегов
                const tagFilter = document.getElementById('tagFilter');
                Array.from(allTags).sort().forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    tagFilter.appendChild(option);
                });

                filteredProfiles = [...allProfiles];
                renderProfiles();

            } catch (error) {
                console.error('Ошибка загрузки профилей:', error);
                showError('Не удалось загрузить профили. Проверьте подключение к интернету.');
            }
        }

        // Отрисовка профилей
        function renderProfiles() {
            const container = document.getElementById('profilesContainer');
            const profileCount = document.getElementById('profileCount');

            if (filteredProfiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <h2>Профили не найдены</h2>
                        <p>Попробуйте изменить параметры поиска</p>
                    </div>
                `;
                profileCount.textContent = '0 профилей';
                return;
            }

            // Вычисляем пагинацию
            totalPages = Math.ceil(filteredProfiles.length / PROFILES_PER_PAGE);
            if (currentPage > totalPages) currentPage = 1;
            
            const startIndex = (currentPage - 1) * PROFILES_PER_PAGE;
            const endIndex = startIndex + PROFILES_PER_PAGE;
            const profilesToShow = filteredProfiles.slice(startIndex, endIndex);

            profileCount.textContent = `${filteredProfiles.length} ${getProfileWord(filteredProfiles.length)}`;

            const grid = document.createElement('div');
            grid.className = 'profiles-grid';

            profilesToShow.forEach(profile => {
                const card = createProfileCard(profile);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
            
            // Добавляем пагинацию если нужно
            if (totalPages > 1) {
                const pagination = createPagination();
                container.appendChild(pagination);
            }
        }
        
        // Создание элементов пагинации
        function createPagination() {
            const paginationDiv = document.createElement('div');
            paginationDiv.style.cssText = 'display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; flex-wrap: wrap;';
            
            // Кнопка "Предыдущая"
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = '← Назад';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderProfiles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginationDiv.appendChild(prevBtn);
            
            // Номера страниц
            const pageInfo = document.createElement('span');
            pageInfo.style.cssText = 'color: white; font-size: 14px; font-weight: 500; padding: 0 10px;';
            pageInfo.textContent = `Страница ${currentPage} из ${totalPages}`;
            paginationDiv.appendChild(pageInfo);
            
            // Кнопка "Следующая"
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-secondary';
            nextBtn.textContent = 'Вперёд →';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProfiles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginationDiv.appendChild(nextBtn);
            
            return paginationDiv;
        }

        // Создание карточки профиля
        function createProfileCard(profile) {
            const card = document.createElement('div');
            card.className = 'profile-card';

            const date = profile.modified?.toDate().toLocaleDateString('ru-RU') || '';
            const views = profile.views || 0;
            const author = profile.userName || profile.userEmail || 'Аноним';
            // Используем фото из профиля или генерируем через ui-avatars.com
            const avatarUrl = profile.userPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&size=45&background=667eea&color=fff`;

            // Создаём коллаж из галереи (берём первые 3 фото)
            const gallery = profile.gallery || [];
            let photosCollageHtml = '';
            if (gallery.length > 0) {
                const photosToShow = gallery.slice(0, 3);
                photosCollageHtml = `
                    <div class="profile-photos-collage" onclick="window.location.href='gallery.html?profile=${profile.id}'">
                        ${photosToShow.map(photo => `<img src="${escapeHtml(photo.url)}" class="collage-photo" alt="Фото">`).join('')}
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="profile-header" onclick="showProfileDetail('${profile.id}')">
                    <div class="profile-expand-icon">⛶</div>
                    <div class="author-avatar" title="${escapeHtml(author)}">
                        <img src="${avatarUrl}" alt="${escapeHtml(author)}">
                    </div>
                    <div class="profile-title">
                        🌐 ${escapeHtml(profile.name)}
                    </div>
                    ${profile.description ? `<div class="profile-description">${escapeHtml(profile.description)}</div>` : ''}
                </div>
                ${photosCollageHtml}
                <div class="profile-body">
                    <div class="profile-meta">
                        <div class="meta-item">
                            📅 ${date}
                        </div>
                        <div class="meta-item">👤 ${escapeHtml(author)}</div>
                    </div>
                    ${profile.tags && profile.tags.length > 0 ? `
                        <div class="profile-tags">
                            ${profile.tags.map(tag => `<span class="tag">🏷️ ${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${(profile.profileString || (profile.journal && profile.journal.length)) ? `
                        <div class="profile-tools">
                            ${profile.profileString ? `<button class="btn btn-secondary btn-small" onclick="showProfileString('${profile.id}', '${escapeHtml(profile.name)}')">⚗️ Профиль</button>` : ''}
                            ${profile.journal && profile.journal.length ? `<button class="btn btn-secondary btn-small" onclick="showJournal('${profile.id}', '${escapeHtml(profile.name)}')">📓 Журнал (${profile.journal.length})</button>` : ''}
                        </div>
                    ` : ''}
                    <div class="profile-stats">
                        <div class="stat-item">
                            👁️ ${views}
                        </div>
                        <div class="stat-item" style="cursor: pointer;" onclick="likeProfile('${profile.id}')" title="Нравится">
                            👍 <span id="likes-${profile.id}">${profile.likes || 0}</span>
                        </div>
                        <div class="stat-item" style="cursor: pointer;" onclick="dislikeProfile('${profile.id}')" title="Не нравится">
                            👎 <span id="dislikes-${profile.id}">${profile.dislikes || 0}</span>
                        </div>
                        <div class="stat-item">
                            💬 ${profile.commentsCount || 0}
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary btn-small" onclick="openInCalculator('${profile.id}')">
                            🧪 Открыть в калькуляторе
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="showComments('${profile.id}', '${escapeHtml(profile.name)}')">
                            💬 Комментарии
                        </button>
                        <button class="btn btn-light btn-small" onclick="copyShareLink('${profile.id}', '${escapeHtml(profile.name)}')" title="Поделиться">
                            🔗 Поделиться
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Открыть профиль в калькуляторе
        function openInCalculator(profileId) {
            window.location.href = `../hpg.html?profile=${profileId}`;
        }
        
        // Парсинг строки профиля в объект
        function parseProfile(profileString) {
            const profile = {};
            if (!profileString) return profile;
            
            const parts = profileString.trim().split(/\s+/);
            parts.forEach(part => {
                const [key, value] = part.split('=');
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    profile[key] = numValue;
                }
            });
            return profile;
        }
        
        // Расчет EC из профиля
        function calculateEC(profile) {
            const molN = 14.0067;
            const molCa = 40.078;
            const molMg = 24.305;
            const molK = 39.0983;
            
            const vNH4 = profile.NH4 || 0;
            const vCa = profile.Ca || 0;
            const vMg = profile.Mg || 0;
            const vK = profile.K || 0;
            
            const vEC = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                        2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                        2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
            
            return vEC;
        }
        
        // Расчет соотношений
        function calculateRatios(profile) {
            const ratios = {};
            const NO3 = profile.NO3 || 0;
            const NH4 = profile.NH4 || 0;
            const N = profile.N || 0;
            const K = profile.K || 0;
            const Ca = profile.Ca || 0;
            const Mg = profile.Mg || 0;
            
            // NH4:NO3
            if (NO3 > 0) {
                ratios.NH4_NO3 = NH4 / NO3;
            }
            
            // K:N
            if (N > 0) {
                ratios.K_N = K / N;
            }
            
            // K:Ca
            if (Ca > 0) {
                ratios.K_Ca = K / Ca;
            }
            
            // K:Mg
            if (Mg > 0) {
                ratios.K_Mg = K / Mg;
            }
            
            return ratios;
        }
        
        // Умное округление процента
        function smartRoundPercent(percent) {
            const absPercent = Math.abs(percent);
            if (absPercent >= 10) {
                return percent.toFixed(0);
            } else if (absPercent >= 1) {
                return percent.toFixed(1);
            } else {
                return percent.toFixed(2);
            }
        }
        
        // Сравнение двух профилей
        function compareProfiles(prev, curr) {
            const changes = [];
            const elements = ['N', 'NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo'];
            
            elements.forEach(elem => {
                const prevVal = prev[elem] || 0;
                const currVal = curr[elem] || 0;
                const diff = currVal - prevVal;
                
                // Показываем любые изменения больше 0.001 для отсечения погрешностей
                if (Math.abs(diff) > 0.001) {
                    // Вычисляем процент изменения
                    let changeStr = '';
                    if (prevVal > 0.01) {
                        const percent = (diff / prevVal) * 100;
                        const roundedPercent = smartRoundPercent(percent);
                        const percentSign = percent > 0 ? '+' : '';
                        changeStr = ` (${percentSign}${roundedPercent}%)`;
                    } else {
                        const sign = diff > 0 ? '+' : '';
                        changeStr = ` (${sign}${diff.toFixed(2)})`;
                    }
                    
                    changes.push(`${elem}: ${prevVal.toFixed(2)} → ${currVal.toFixed(2)}${changeStr}`);
                }
            });
            
            return changes;
        }
        
        // Показать детальный просмотр профиля
        async function showProfileDetail(profileId) {
            // Сохраняем ID открытого профиля
            currentOpenProfileId = profileId;
            
            const profile = allProfiles.find(p => p.id === profileId);
            if (!profile) return;
            
            const authorAvatar = profile.userPhotoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.userName || 'Аноним')}&size=48&background=4a9d9d&color=fff`;
            
            const tagsHtml = profile.tags && profile.tags.length > 0 ?
                profile.tags.map(tag => `<span class="profile-detail-tag">🏷️ ${escapeHtml(tag)}</span>`).join('') :
                '<span style="color: #999;">Теги не указаны</span>';
            
            // Загружаем комментарии (только для авторизованных)
            let commentsHtml = `
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #999; margin-bottom: 20px; font-size: 16px;">
                        🔒 Войдите, чтобы видеть комментарии
                    </div>
                    <button class="btn btn-primary" onclick="loginWithGoogle()" style="display: inline-flex; align-items: center; gap: 8px;">
                        <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1);">
                        Войти через Google
                    </button>
                </div>
            `;
            if (currentUser) {
                commentsHtml = '<div style="color: #999; text-align: center; padding: 20px;">Загрузка комментариев...</div>';
                try {
                    const commentsSnapshot = await db.collection('comments')
                        .where('profileId', '==', profileId)
                        .orderBy('created', 'desc')
                        .get();
                    
                    if (commentsSnapshot.empty) {
                        commentsHtml = '<div style="color: #999; text-align: center; padding: 20px;">Комментариев пока нет</div>';
                    } else {
                        commentsHtml = '';
                        commentsSnapshot.forEach(doc => {
                            const comment = doc.data();
                            const commentAvatar = comment.userPhotoURL || 
                                `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.userName || 'Аноним')}&size=40&background=4a9d9d&color=fff`;
                            const commentDate = comment.created?.toDate().toLocaleDateString('ru-RU') || '';
                            
                            commentsHtml += `
                                <div class="comment" style="margin-bottom: 15px; padding: 12px; background: #f8f9ff; border-radius: 8px;">
                                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                                        <img src="${commentAvatar}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4a9d9d;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #333;">${escapeHtml(comment.userName || 'Аноним')}</div>
                                            <div style="font-size: 12px; color: #999;">${commentDate}</div>
                                        </div>
                                    </div>
                                    <div style="color: #555; line-height: 1.5;">${escapeHtml(comment.text)}</div>
                                </div>
                            `;
                        });
                    }
                } catch (error) {
                    commentsHtml = '<div style="color: #f44336; text-align: center; padding: 20px;">Ошибка загрузки комментариев</div>';
                }
            }
            
            // Формируем строку профиля
            let profileStringHtml = '';
            if (profile.profileString) {
                const mainParsed = parseProfile(profile.profileString);
                const mainEC = calculateEC(mainParsed);
                const mainRatios = calculateRatios(mainParsed);
                
                profileStringHtml = `
                    <div class="profile-detail-section">
                        <h3>⚗️ Профиль раствора</h3>
                        
                        <!-- Параметры профиля -->
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #4a9d9d;">
                            <div style="font-weight: 700; color: #2d7a7a; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                <span>📊</span> Параметры раствора
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainEC.toFixed(3)}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">EC (мСм/см)</div>
                                </div>
                                ${mainRatios.NH4_NO3 !== undefined ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.NH4_NO3.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">NH4:NO3</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_N ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_N.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:N</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_Ca ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_Ca.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:Ca</div>
                                    </div>
                                ` : ''}
                                ${mainRatios.K_Mg ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <div style="font-size: 24px; font-weight: 700; color: #2d7a7a;">${mainRatios.K_Mg.toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">K:Mg</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Строка профиля -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; color: #666; margin-bottom: 8px; font-size: 13px;">Строка профиля:</div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; overflow-x: auto; color: #333;">
                                ${escapeHtml(profile.profileString)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Формируем журнал
            let journalHtml = '';
            if (profile.journal && profile.journal.length > 0) {
                journalHtml = `
                    <div class="profile-detail-section">
                        <h3 onclick="toggleJournal('${profile.id}')" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                            <span id="journal-arrow-${profile.id}" style="transition: transform 0.2s; display: inline-flex; align-items: center; line-height: 1;">▼</span>
                            📓 Журнал (${profile.journal.length})
                        </h3>
                        <div id="journal-content-${profile.id}" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                ${profile.journal.map((entry, index) => {
                                    const dateLabel = formatJournalDate(entry.date);
                                    const descriptionHtml = entry.desc ? `<div style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 10px;">${escapeHtml(entry.desc)}</div>` : '';
                                    const profileString = (entry.profile || '').trim();
                                    
                                    // Парсим текущий профиль
                                    const currentParsed = parseProfile(profileString);
                                    
                                    // Вычисляем EC и соотношения
                                    let statsHtml = '';
                                    if (profileString) {
                                        const ec = calculateEC(currentParsed);
                                        const ratios = calculateRatios(currentParsed);
                                        
                                        statsHtml = `
                                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                                <div style="font-weight: 600; color: #2d7a7a; margin-bottom: 5px; font-size: 13px;">📊 Параметры:</div>
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px; color: #555;">
                                                    <div><strong>EC:</strong> ${ec.toFixed(3)}</div>
                                                    ${ratios.NH4_NO3 !== undefined ? `<div><strong>NH4:NO3:</strong> ${ratios.NH4_NO3.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_N ? `<div><strong>K:N:</strong> ${ratios.K_N.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_Ca ? `<div><strong>K:Ca:</strong> ${ratios.K_Ca.toFixed(2)}</div>` : ''}
                                                    ${ratios.K_Mg ? `<div><strong>K:Mg:</strong> ${ratios.K_Mg.toFixed(2)}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // Сравниваем с предыдущим этапом
                                    let changesHtml = '';
                                    if (index > 0 && profileString) {
                                        const prevEntry = profile.journal[index - 1];
                                        const prevProfileString = (prevEntry.profile || '').trim();
                                        if (prevProfileString) {
                                            const prevParsed = parseProfile(prevProfileString);
                                            const changes = compareProfiles(prevParsed, currentParsed);
                                            
                                            // Вычисляем изменения EC и соотношений
                                            const prevEC = calculateEC(prevParsed);
                                            const currEC = calculateEC(currentParsed);
                                            const prevRatios = calculateRatios(prevParsed);
                                            const currRatios = calculateRatios(currentParsed);
                                            
                                            const paramChanges = [];
                                            
                                            // EC - показываем любые изменения
                                            const ecDiff = currEC - prevEC;
                                            if (Math.abs(ecDiff) > 0.0001) { // Очень низкий порог для отсечения погрешностей округления
                                                // Процент изменения EC
                                                let changeStr = '';
                                                if (prevEC > 0.001) {
                                                    const percent = (ecDiff / prevEC) * 100;
                                                    const roundedPercent = smartRoundPercent(percent);
                                                    const percentSign = percent > 0 ? '+' : '';
                                                    changeStr = ` (${percentSign}${roundedPercent}%)`;
                                                } else {
                                                    const sign = ecDiff > 0 ? '+' : '';
                                                    changeStr = ` (${sign}${ecDiff.toFixed(3)})`;
                                                }
                                                
                                                paramChanges.push(`EC: ${prevEC.toFixed(3)} → ${currEC.toFixed(3)}${changeStr}`);
                                            }
                                            
                                            // Соотношения - показываем любые изменения
                                            const ratioKeys = ['NH4_NO3', 'K_N', 'K_Ca', 'K_Mg'];
                                            ratioKeys.forEach(key => {
                                                if (prevRatios[key] !== undefined && currRatios[key] !== undefined) {
                                                    const diff = currRatios[key] - prevRatios[key];
                                                    if (Math.abs(diff) > 0.001) { // Очень низкий порог для отсечения погрешностей округления
                                                        const label = key.replace('_', ':');
                                                        
                                                        // Процент изменения соотношения
                                                        let changeStr = '';
                                                        if (prevRatios[key] > 0.01) {
                                                            const percent = (diff / prevRatios[key]) * 100;
                                                            const roundedPercent = smartRoundPercent(percent);
                                                            const percentSign = percent > 0 ? '+' : '';
                                                            changeStr = ` (${percentSign}${roundedPercent}%)`;
                                                        } else {
                                                            const sign = diff > 0 ? '+' : '';
                                                            changeStr = ` (${sign}${diff.toFixed(2)})`;
                                                        }
                                                        
                                                        paramChanges.push(`${label}: ${prevRatios[key].toFixed(2)} → ${currRatios[key].toFixed(2)}${changeStr}`);
                                                    }
                                                }
                                            });
                                            
                                            if (changes.length > 0 || paramChanges.length > 0) {
                                                changesHtml = `
                                                    <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                                        <div style="font-weight: 600; color: #e65100; margin-bottom: 8px; font-size: 13px;">🔄 Изменения от предыдущего этапа:</div>
                                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                                            ${changes.length > 0 ? `
                                                                <div>
                                                                    <div style="font-weight: 600; color: #666; margin-bottom: 5px; font-size: 12px;">Элементы:</div>
                                                                    <div style="font-size: 12px; color: #555; line-height: 1.6;">
                                                                        ${changes.map(ch => `<div>• ${ch}</div>`).join('')}
                                                                    </div>
                                                                </div>
                                                            ` : ''}
                                                            ${paramChanges.length > 0 ? `
                                                                <div>
                                                                    <div style="font-weight: 600; color: #666; margin-bottom: 5px; font-size: 12px;">Параметры:</div>
                                                                    <div style="font-size: 12px; color: #555; line-height: 1.6;">
                                                                        ${paramChanges.map(ch => `<div>• ${ch}</div>`).join('')}
                                                                    </div>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        }
                                    }
                                    
                                    const profileHtml = profileString ? 
                                        `<pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; line-height: 1.5; margin: 0;">${escapeHtml(profileString)}</pre>` : 
                                        '<div style="color: #999; font-style: italic; font-size: 13px;">Строка профиля отсутствует</div>';
                                    
                                    return `
                                        <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #4a9d9d; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                                <div style="font-weight: 700; color: #2d7a7a; font-size: 15px;">Этап ${index + 1}</div>
                                                <div style="font-size: 12px; color: #999;">📅 ${escapeHtml(dateLabel)}</div>
                                            </div>
                                            ${descriptionHtml}
                                            ${statsHtml}
                                            ${changesHtml}
                                            ${profileHtml}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content modal-content-large">
                    <div class="modal-header">
                        <h2>📋 ${escapeHtml(profile.name)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">✕</button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-detail">
                            <!-- Боковая панель -->
                            <div class="profile-detail-sidebar">
                                <!-- Автор -->
                                <div class="profile-detail-author">
                                    <img src="${authorAvatar}" alt="${escapeHtml(profile.userName || 'Аноним')}" class="profile-detail-author-avatar">
                                    <div class="profile-detail-author-info">
                                        <div class="profile-detail-author-name">${escapeHtml(profile.userName || 'Аноним')}</div>
                                        <div class="profile-detail-author-date">
                                            📅 ${profile.created?.toDate().toLocaleDateString('ru-RU') || 'Неизвестно'}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Статистика -->
                                <div class="profile-detail-stats">
                                    <div class="profile-detail-stat">
                                        <div class="profile-detail-stat-value">${profile.views || 0}</div>
                                        <div class="profile-detail-stat-label">👁️ Просмотров</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="window.location.href='gallery.html?profile=${profile.id}'" title="Открыть галерею">
                                        <div class="profile-detail-stat-value">📸 ${(profile.gallery && profile.gallery.length) || 0}</div>
                                        <div class="profile-detail-stat-label">Фотографий</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="document.getElementById('comments-section-${profile.id}').scrollIntoView({behavior: 'smooth', block: 'start'})" title="Перейти к комментариям">
                                        <div class="profile-detail-stat-value">${profile.commentsCount || 0}</div>
                                        <div class="profile-detail-stat-label">💬 Комментариев</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="likeProfile('${profile.id}')" title="Нравится">
                                        <div class="profile-detail-stat-value">👍 <span id="detail-likes-${profile.id}">${profile.likes || 0}</span></div>
                                        <div class="profile-detail-stat-label">Лайков</div>
                                    </div>
                                    <div class="profile-detail-stat" style="cursor: pointer;" onclick="dislikeProfile('${profile.id}')" title="Не нравится">
                                        <div class="profile-detail-stat-value">👎 <span id="detail-dislikes-${profile.id}">${profile.dislikes || 0}</span></div>
                                        <div class="profile-detail-stat-label">Дизлайков</div>
                                    </div>
                                </div>
                                
                                <!-- Описание -->
                                ${profile.description ? `
                                    <div class="profile-detail-section">
                                        <h3>📝 Описание</h3>
                                        <div style="color: #666; line-height: 1.6; font-size: 14px;">${escapeHtml(profile.description)}</div>
                                    </div>
                                ` : ''}
                                
                                <!-- Теги -->
                                <div class="profile-detail-section">
                                    <h3>🏷️ Теги</h3>
                                    <div class="profile-detail-tags">
                                        ${tagsHtml}
                                    </div>
                                </div>
                                
                                <!-- Действия -->
                                <div class="profile-detail-section">
                                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="openInCalculator('${profile.id}')">
                                        🧪 Открыть в калькуляторе
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="window.location.href='gallery.html?profile=${profile.id}'">
                                        📸 Галерея фотографий ${(profile.gallery && profile.gallery.length) ? `(${profile.gallery.length})` : ''}
                                    </button>
                                    <button class="btn btn-light" style="width: 100%;" onclick="copyShareLink('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                        🔗 Поделиться
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Основной контент -->
                            <div class="profile-detail-main">
                                ${profileStringHtml}
                                ${journalHtml}
                                
                                <!-- Комментарии -->
                                <div class="profile-detail-section" id="comments-section-${profile.id}">
                                    <h3>💬 Комментарии (${profile.commentsCount || 0})</h3>
                                    ${currentUser ? `
                                        <div class="comment-form" style="margin-bottom: 20px;">
                                            <textarea id="detail-comment-text" placeholder="Напишите комментарий..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                                            <div class="comment-form-actions" style="margin-top: 10px;">
                                                <button class="btn btn-primary" onclick="submitDetailComment('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                                    💬 Отправить
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div id="detailComments" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                                        ${commentsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Закрытие по клику на фон
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    currentOpenProfileId = null;
                    modal.remove();
                }
            });
            
            // Также очищаем ID при закрытии через кнопку
            const closeButton = modal.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    currentOpenProfileId = null;
                });
            }
        }

        // Копировать ссылку
        async function copyShareLink(profileId, profileName) {
            // Используем текущий URL без хеша и добавляем нужный хеш
            const baseUrl = window.location.href.split('#')[0];
            const shareUrl = `${baseUrl}#profile-${profileId}`;
            
            try {
                await navigator.clipboard.writeText(shareUrl);
                showNotification(`✅ Ссылка на профиль "${profileName}" скопирована!`);
            } catch (error) {
                // Если не удалось скопировать автоматически, показываем модальное окно
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">🔗 Скопируйте ссылку</h3>
                        <div style="margin-bottom: 15px;">
                            <strong>${profileName}</strong>
                        </div>
                        <input type="text" value="${shareUrl}" readonly 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px;"
                            onclick="this.select()">
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">Закрыть</button>
                            <button class="btn btn-primary" onclick="
                                const input = this.parentElement.previousElementSibling;
                                input.select();
                                document.execCommand('copy');
                                showNotification('✅ Ссылка скопирована!');
                                this.closest('.modal').remove();
                            ">Копировать</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Закрытие по клику на фон
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }

        // Получить профиль по ID
        function getProfileById(profileId) {
            return allProfiles.find(profile => profile.id === profileId) ||
                   filteredProfiles.find(profile => profile.id === profileId) ||
                   null;
        }

        // Показать модалку со строкой профиля
        function showProfileString(profileId, profileName) {
            const profile = getProfileById(profileId);
            const profileString = (profile?.profileString || '').trim();

            if (!profileString) {
                alert('Строка профиля недоступна');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>⚗️ Профиль: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 12px; color: #666;">Скопируйте строку и вставьте в поле профиля в калькуляторе.</p>
                        <div class="profile-string-view" id="modal-profile-string">${escapeHtml(profileString)}</div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="copyProfileString('${profile.id}', event)">
                                📋 Скопировать строку
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        function formatJournalDate(value) {
            if (!value) {
                return 'Без даты';
            }

            // Если timestamp Firestore
            if (value.seconds) {
                const date = new Date(value.seconds * 1000);
                return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            // Попробуем распарсить строку
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            return value;
        }

        function showJournal(profileId, profileName) {
            const profile = getProfileById(profileId);
            if (!profile || !Array.isArray(profile.journal) || profile.journal.length === 0) {
                alert('Журнал пуст или недоступен');
                return;
            }

            const entriesHtml = profile.journal.map((entry, index) => {
                const dateLabel = formatJournalDate(entry.date);
                const descriptionHtml = entry.desc ? `<div class="journal-description">${escapeHtml(entry.desc)}</div>` : '';
                const profileString = (entry.profile || '').trim();
                const profileHtml = profileString ? `<div class="journal-profile">${escapeHtml(profileString)}</div>` : '<div class="journal-profile" style="opacity:0.6;">Строка профиля отсутствует</div>';
                const disabledAttr = profileString ? '' : 'disabled';
                const disabledClass = profileString ? '' : ' journal-copy-btn--disabled';

                return `
                    <div class="journal-entry">
                        <div class="journal-header">
                            <div class="journal-meta">
                                <strong>Этап ${index + 1}</strong>
                                <span>${escapeHtml(dateLabel)}</span>
                            </div>
                            <button class="btn btn-secondary btn-small journal-copy-btn${disabledClass}" data-profile-string="${encodeURIComponent(profileString)}" ${disabledAttr}>
                                📋 Копировать
                            </button>
                        </div>
                        ${descriptionHtml}
                        ${profileHtml}
                    </div>
                `;
            }).join('');

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📓 Журнал профиля: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        ${entriesHtml}
                    </div>
                </div>
            `;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);

            modal.querySelectorAll('.journal-copy-btn').forEach(button => {
                const profileString = decodeURIComponent(button.dataset.profileString || '');
                button.addEventListener('click', (event) => {
                    if (!profileString) {
                        event.preventDefault();
                        return;
                    }
                    copyProfileString(profileId, event, profileString);
                });
            });
        }

        // Копировать строку профиля
        async function copyProfileString(profileId, event, profileStringOverride) {
            event?.stopPropagation?.();

            let profileString = (profileStringOverride || '').trim();
            if (!profileString) {
                const profile = getProfileById(profileId);
                profileString = (profile?.profileString || '').trim();
            }

            if (!profileString) {
                alert('Строка профиля недоступна');
                return;
            }

            try {
                await navigator.clipboard.writeText(profileString.trim());

                const button = event?.currentTarget || event?.target;
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = '✅ Скопировано!';
                    button.disabled = true;
                    button.style.opacity = '0.8';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 2000);
                } else {
                    showNotification('✅ Строка профиля скопирована');
                }

            } catch (error) {
                prompt('Скопируйте профиль:', profileString);
            }
        }

        // Показать комментарии
        async function showComments(profileId, profileName) {
            // Ждем инициализации авторизации
            if (!authReady) {
                console.log('Ожидание инициализации авторизации...');
                await new Promise(resolve => {
                    const unsubscribe = auth.onAuthStateChanged(() => {
                        unsubscribe();
                        resolve();
                    });
                });
            }
            
            // Проверяем авторизацию
            if (!currentUser) {
                // Показываем сообщение о необходимости авторизации
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>💬 Комментарии: ${escapeHtml(profileName)}</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="no-comments">
                                <div class="no-comments-icon">🔐</div>
                                <h3 style="margin-bottom: 10px;">Требуется авторизация</h3>
                                <p style="margin-bottom: 20px;">Войдите через Google чтобы просматривать комментарии</p>
                                <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                    🔐 Войти через Google
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Закрытие по клику на фон
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                return;
            }

            // Создаем модальное окно
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>💬 Комментарии: ${escapeHtml(profileName)}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body" id="comments-body">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                            Загрузка комментариев...
                        </div>
                    </div>
                    <div class="comment-form">
                        <textarea id="comment-text" placeholder="Напишите комментарий..."></textarea>
                        <div class="comment-form-actions">
                            <button class="btn btn-primary" onclick="submitComment('${profileId}', '${escapeHtml(profileName)}')">
                                💬 Отправить
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Закрытие по клику на фон
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            try {
                // Загружаем комментарии из Firestore (из отдельной коллекции, не подколлекции)
                const commentsSnapshot = await db.collection('comments')
                    .where('profileId', '==', profileId)
                    .get();

                const modalBody = modal.querySelector('#comments-body');

                if (commentsSnapshot.empty) {
                    modalBody.innerHTML = `
                        <div class="no-comments">
                            <div class="no-comments-icon">💬</div>
                            <p>Пока нет комментариев</p>
                        </div>
                    `;
                    return;
                }

                // Собираем комментарии и сортируем на клиенте
                const comments = [];
                commentsSnapshot.forEach(doc => {
                    comments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Сортируем по дате (новые сверху)
                comments.sort((a, b) => {
                    return (b.created?.toMillis() || 0) - (a.created?.toMillis() || 0);
                });

                // Загружаем фото пользователей из коллекции users (с использованием кеша)
                const userIds = [...new Set(comments.map(c => c.userId).filter(id => id))];
                
                // Фильтруем только те userId, которых нет в кеше
                const uncachedUserIds = userIds.filter(id => !userPhotosCache[id]);
                
                // Загружаем фото только для авторизованных пользователей
                if (uncachedUserIds.length > 0 && currentUser) {
                    try {
                        // Загружаем данные пользователей пачками (Firestore поддерживает до 10 в in)
                        for (let i = 0; i < uncachedUserIds.length; i += 10) {
                            const batch = uncachedUserIds.slice(i, i + 10);
                            const usersSnapshot = await db.collection('users')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            
                            usersSnapshot.forEach(doc => {
                                const userData = doc.data();
                                if (userData.photoURL) {
                                    // Сохраняем в глобальный кеш
                                    userPhotosCache[doc.id] = userData.photoURL;
                                }
                            });
                        }
                    } catch (error) {
                        console.log('Не удалось загрузить фото пользователей для комментариев:', error);
                    }
                }
                
                // Применяем фото из кеша ко всем комментариям
                comments.forEach(comment => {
                    if (comment.userId && userPhotosCache[comment.userId]) {
                        comment.userPhotoURL = userPhotosCache[comment.userId];
                    }
                });

                // Отображаем комментарии
                let commentsHTML = '';
                comments.forEach(comment => {
                    const author = comment.userName || comment.userEmail || 'Аноним';
                    const date = comment.created?.toDate().toLocaleString('ru-RU') || '';
                    // Используем фото из комментария или генерируем через ui-avatars.com
                    const avatarUrl = comment.userPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&size=36&background=667eea&color=fff`;

                    commentsHTML += `
                        <div class="comment">
                            <div class="comment-header">
                                <div class="comment-avatar">
                                    <img src="${avatarUrl}" alt="${escapeHtml(author)}">
                                </div>
                                <div style="flex: 1;">
                                    <div class="comment-author">${escapeHtml(author)}</div>
                                    <div class="comment-date">${date}</div>
                                </div>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text)}</div>
                        </div>
                    `;
                });

                modalBody.innerHTML = commentsHTML;

            } catch (error) {
                console.error('Ошибка загрузки комментариев:', error);
                const modalBody = modal.querySelector('#comments-body');
                modalBody.innerHTML = `
                    <div class="no-comments">
                        <div class="no-comments-icon">❌</div>
                        <p>Ошибка загрузки комментариев</p>
                    </div>
                `;
            }
        }

        // Лайк профиля
        async function likeProfile(profileId) {
            if (!currentUser) {
                // Показываем модальное окно вместо confirm
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">🔒 Требуется авторизация</h3>
                        <p style="margin-bottom: 20px; color: #666;">Для оценки профилей необходимо войти. Войти сейчас?</p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">Отмена</button>
                            <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1); margin-right: 5px;">
                                Войти
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                return;
            }

            try {
                // Проверяем существующую оценку
                const likeQuery = await db.collection('likes')
                    .where('userId', '==', currentUser.uid)
                    .where('profileId', '==', profileId)
                    .get();

                if (!likeQuery.empty) {
                    const existingLike = likeQuery.docs[0];
                    const existingType = existingLike.data().type;
                    
                    if (existingType === 'like') {
                        // Уже лайкнуто - убираем лайк
                        await existingLike.ref.delete();
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        if (likesSpan) {
                            likesSpan.textContent = Math.max(0, parseInt(likesSpan.textContent) - 1);
                        }
                        if (detailLikesSpan) {
                            detailLikesSpan.textContent = Math.max(0, parseInt(detailLikesSpan.textContent) - 1);
                        }
                        
                        showNotification('Лайк убран');
                        return;
                    } else {
                        // Был дизлайк - меняем на лайк
                        await existingLike.ref.update({ type: 'like' });
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(1),
                            dislikes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (likesSpan) likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
                        if (dislikesSpan) dislikesSpan.textContent = Math.max(0, parseInt(dislikesSpan.textContent) - 1);
                        if (detailLikesSpan) detailLikesSpan.textContent = parseInt(detailLikesSpan.textContent) + 1;
                        if (detailDislikesSpan) detailDislikesSpan.textContent = Math.max(0, parseInt(detailDislikesSpan.textContent) - 1);
                        
                        showNotification('👍 Спасибо за оценку!');
                        return;
                    }
                }

                // Новый лайк
                await db.collection('likes').add({
                    userId: currentUser.uid,
                    profileId: profileId,
                    type: 'like',
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('profiles').doc(profileId).update({
                    likes: firebase.firestore.FieldValue.increment(1)
                });

                const likesSpan = document.getElementById(`likes-${profileId}`);
                const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                if (likesSpan) {
                    likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
                }
                if (detailLikesSpan) {
                    detailLikesSpan.textContent = parseInt(detailLikesSpan.textContent) + 1;
                }

                showNotification('👍 Спасибо за оценку!');

            } catch (error) {
                console.error('Ошибка лайка:', error);
                showNotification('❌ Ошибка: ' + error.message);
            }
        }

        // Дизлайк профиля
        async function dislikeProfile(profileId) {
            if (!currentUser) {
                // Показываем модальное окно вместо confirm
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">🔒 Требуется авторизация</h3>
                        <p style="margin-bottom: 20px; color: #666;">Для оценки профилей необходимо войти. Войти сейчас?</p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-light" onclick="this.closest('.modal').remove()">Отмена</button>
                            <button class="btn btn-primary" onclick="loginWithGoogle(); this.closest('.modal').remove();">
                                <img src="https://www.google.com/favicon.ico" width="16" height="16" style="filter: brightness(0) invert(1); margin-right: 5px;">
                                Войти
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                return;
            }

            try {
                // Проверяем существующую оценку
                const likeQuery = await db.collection('likes')
                    .where('userId', '==', currentUser.uid)
                    .where('profileId', '==', profileId)
                    .get();

                if (!likeQuery.empty) {
                    const existingLike = likeQuery.docs[0];
                    const existingType = existingLike.data().type;
                    
                    if (existingType === 'dislike') {
                        // Уже дизлайкнуто - убираем дизлайк
                        await existingLike.ref.delete();
                        await db.collection('profiles').doc(profileId).update({
                            dislikes: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (dislikesSpan) {
                            dislikesSpan.textContent = Math.max(0, parseInt(dislikesSpan.textContent) - 1);
                        }
                        if (detailDislikesSpan) {
                            detailDislikesSpan.textContent = Math.max(0, parseInt(detailDislikesSpan.textContent) - 1);
                        }
                        
                        showNotification('Дизлайк убран');
                        return;
                    } else {
                        // Был лайк - меняем на дизлайк
                        await existingLike.ref.update({ type: 'dislike' });
                        await db.collection('profiles').doc(profileId).update({
                            likes: firebase.firestore.FieldValue.increment(-1),
                            dislikes: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        const likesSpan = document.getElementById(`likes-${profileId}`);
                        const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                        const detailLikesSpan = document.getElementById(`detail-likes-${profileId}`);
                        const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                        if (likesSpan) likesSpan.textContent = Math.max(0, parseInt(likesSpan.textContent) - 1);
                        if (dislikesSpan) dislikesSpan.textContent = parseInt(dislikesSpan.textContent) + 1;
                        if (detailLikesSpan) detailLikesSpan.textContent = Math.max(0, parseInt(detailLikesSpan.textContent) - 1);
                        if (detailDislikesSpan) detailDislikesSpan.textContent = parseInt(detailDislikesSpan.textContent) + 1;
                        
                        showNotification('👎 Спасибо за отзыв!');
                        return;
                    }
                }

                // Новый дизлайк
                await db.collection('likes').add({
                    userId: currentUser.uid,
                    profileId: profileId,
                    type: 'dislike',
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('profiles').doc(profileId).update({
                    dislikes: firebase.firestore.FieldValue.increment(1)
                });

                const dislikesSpan = document.getElementById(`dislikes-${profileId}`);
                const detailDislikesSpan = document.getElementById(`detail-dislikes-${profileId}`);
                if (dislikesSpan) {
                    dislikesSpan.textContent = parseInt(dislikesSpan.textContent) + 1;
                }
                if (detailDislikesSpan) {
                    detailDislikesSpan.textContent = parseInt(detailDislikesSpan.textContent) + 1;
                }

                showNotification('👎 Спасибо за отзыв!');

            } catch (error) {
                console.error('Ошибка дизлайка:', error);
                showNotification('❌ Ошибка: ' + error.message);
            }
        }

        // Показать форму загрузки профиля
        function showUploadForm() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📤 Загрузить профиль HPG</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Выберите файл .hpg:</label>
                            <input type="file" id="hpg-file-input" accept=".hpg" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                        </div>
                        <div id="upload-status" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;"></div>
                        <div id="upload-form" style="display: none;"></div>
                        <div id="upload-preview" style="display: none;">
                            <details>
                                <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px;">Содержимое файла (клик для просмотра)</summary>
                                <div id="preview-content" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
                            </details>
                        </div>
                    </div>
                    <div class="comment-form">
                        <button id="upload-submit-btn" class="btn btn-primary" style="width: 100%; display: none;" onclick="uploadHPGProfile()">
                            💾 Сохранить в облако
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Закрытие по клику на фон
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Обработчик выбора файла
            document.getElementById('hpg-file-input').addEventListener('change', handleFileSelect);
        }

        // Обработка выбора файла
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('upload-status');
            const previewDiv = document.getElementById('upload-preview');
            const previewContent = document.getElementById('preview-content');
            const submitBtn = document.getElementById('upload-submit-btn');

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.color = '#1976d2';
            statusDiv.innerHTML = '⏳ Проверка файла...';

            try {
                // Читаем файл
                const content = await file.text();
                
                // Валидация HPG файла
                const validation = validateHPGFile(content);
                
                if (!validation.valid) {
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.innerHTML = `❌ Ошибка: ${validation.error}`;
                    previewDiv.style.display = 'none';
                    submitBtn.style.display = 'none';
                    return;
                }

                // Парсим название и описание из файла
                const parsedData = parseHPGMetadata(content, file.name);

                // Показываем успех
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.innerHTML = `✅ Файл корректен! Найдено элементов: ${validation.elementsCount}`;

                // Показываем форму редактирования
                const uploadForm = document.getElementById('upload-form');
                uploadForm.style.display = 'block';
                uploadForm.innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Название профиля:</label>
                        <input type="text" id="upload-name" value="${escapeHtml(parsedData.name)}" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-family: Arial, sans-serif;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Описание:</label>
                        <textarea id="upload-description" rows="3" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; resize: vertical; font-family: Arial, sans-serif;">${escapeHtml(parsedData.description)}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Теги (через запятую):</label>
                        <input type="text" id="upload-tags" placeholder="томаты, вегетация, гидропоника" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-family: Arial, sans-serif;">
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">Помогут найти профиль в каталоге</div>
                    </div>
                    
                    <div style="padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50; margin-bottom: 15px;">
                        <div style="font-weight: bold; font-size: 14px; color: #2e7d32; margin-bottom: 5px;">🌐 Профиль будет публичным</div>
                        <div style="font-size: 12px; color: #555;">Другие пользователи смогут найти и использовать этот профиль в библиотеке</div>
                    </div>
                `;
                
                // Показываем предпросмотр файла
                previewDiv.style.display = 'block';
                previewContent.textContent = content.substring(0, 1000) + (content.length > 1000 ? '\n...' : '');

                // Сохраняем содержимое для загрузки
                window.uploadedHPGContent = content;
                window.uploadedHPGFilename = file.name;

                // Показываем кнопку загрузки
                submitBtn.style.display = 'block';

            } catch (error) {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.innerHTML = `❌ Ошибка чтения файла: ${error.message}`;
                previewDiv.style.display = 'none';
                submitBtn.style.display = 'none';
            }
        }

        // Парсинг метаданных из HPG файла
        function parseHPGMetadata(content, filename) {
            const lines = content.split('\n');
            let name = filename.replace(/\.hpg$/i, '');
            let description = '';
            const profile = {};

            for (const line of lines) {
                const trimmed = line.trim();
                
                // Парсим комментарий как описание
                if (trimmed.startsWith('Comment=')) {
                    description = trimmed.substring(8);
                }
                // Парсим значения элементов
                else if (trimmed.includes('=') && !trimmed.startsWith('#')) {
                    const [key, value] = trimmed.split('=');
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        profile[key] = numValue;
                    }
                }
            }

            // Формируем строку профиля
            const profileString = buildProfileString(profile);

            return { name, description, profileString };
        }

        // Построение строки профиля из объекта
        function buildProfileString(profile) {
            const elements = ['N', 'NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'];
            const parts = [];
            
            for (const el of elements) {
                const value = profile[el] || 0;
                parts.push(`${el}=${value}`);
            }
            
            return parts.join(' ');
        }

        // Валидация HPG файла
        function validateHPGFile(content) {
            const lines = content.split('\n');
            let hasVersion = false;
            let elementsCount = 0;
            const requiredElements = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
            const foundElements = new Set();

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // Проверка версии
                if (trimmed.startsWith('version=')) {
                    hasVersion = true;
                }

                // Проверка элементов
                if (trimmed.includes('=')) {
                    const [key] = trimmed.split('=');
                    if (requiredElements.includes(key)) {
                        foundElements.add(key);
                        elementsCount++;
                    }
                }
            }

            // Проверки
            if (!hasVersion) {
                return { valid: false, error: 'Файл не содержит строку version=' };
            }

            const missingElements = requiredElements.filter(el => !foundElements.has(el));
            if (missingElements.length > 0) {
                return { valid: false, error: `Отсутствуют обязательные элементы: ${missingElements.join(', ')}` };
            }

            return { valid: true, elementsCount: foundElements.size };
        }

        // Загрузка HPG профиля в облако
        async function uploadHPGProfile() {
            if (!window.uploadedHPGContent || !currentUser) {
                alert('Ошибка: нет данных для загрузки');
                return;
            }

            const name = document.getElementById('upload-name').value.trim();
            const description = document.getElementById('upload-description').value.trim();
            const tagsInput = document.getElementById('upload-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!name) {
                alert('Введите название профиля');
                return;
            }

            const submitBtn = document.getElementById('upload-submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Сохранение...';

            try {
                // Парсим строку профиля из загруженного файла
                const parsedData = parseHPGMetadata(window.uploadedHPGContent, window.uploadedHPGFilename);
                
                // Сохраняем профиль в Firestore
                await db.collection('profiles').add({
                    // Владелец
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    userPhotoURL: currentUser.photoURL || null,
                    
                    // Уникальный ключ
                    appKey: 'wega-hpg-profile',
                    
                    // Основная информация
                    name: name,
                    description: description,
                    tags: tags,
                    
                    // Данные профиля - ПОЛНЫЙ файл HPG
                    profile: window.uploadedHPGContent,
                    profileString: parsedData.profileString, // Строка профиля для быстрого копирования
                    
                    // Журнал (пустой для загруженных файлов)
                    journal: [],
                    
                    // Метаданные
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    modified: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '1.0',
                    
                    // Публичность - всегда true для загруженных через портал
                    public: true,
                    
                    // Статистика
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    downloads: 0,
                    commentsCount: 0
                });

                // Показываем успех
                showNotification('✅ Профиль успешно загружен!');
                
                // Закрываем модальное окно
                document.querySelector('.modal').remove();
                
                // Перезагружаем список профилей
                await loadProfiles();
                renderProfiles();

            } catch (error) {
                console.error('Ошибка загрузки профиля:', error);
                alert('❌ Ошибка загрузки: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = '💾 Сохранить в облако';
            }
        }

        // Показать уведомление
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #667eea;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Отправить комментарий
        async function submitComment(profileId, profileName) {
            const textarea = document.getElementById('comment-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Введите текст комментария');
                return;
            }
            
            if (!currentUser) {
                alert('Необходима авторизация');
                return;
            }
            
            try {
                // Добавляем комментарий в Firestore
                await db.collection('comments').add({
                    profileId: profileId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Аноним',
                    userEmail: currentUser.email,
                    userPhotoURL: currentUser.photoURL || null,
                    text: text,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Обновляем счетчик комментариев в профиле
                await db.collection('profiles').doc(profileId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.log('Не удалось обновить счетчик:', err));
                
                // Очищаем поле ввода
                textarea.value = '';
                
                // Перезагружаем комментарии и ленту активности
                const modal = document.querySelector('.modal');
                modal.remove();
                showComments(profileId, profileName);
                loadActivityFeed();
                
            } catch (error) {
                console.error('Ошибка отправки комментария:', error);
                alert('❌ Ошибка отправки: ' + error.message);
            }
        }

        // Сворачивание/разворачивание журнала
        function toggleJournal(profileId) {
            const content = document.getElementById(`journal-content-${profileId}`);
            const arrow = document.getElementById(`journal-arrow-${profileId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }

        // Отправить комментарий из детального просмотра
        async function submitDetailComment(profileId, profileName) {
            const textarea = document.getElementById('detail-comment-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Введите текст комментария');
                return;
            }
            
            if (!currentUser) {
                alert('Необходима авторизация');
                return;
            }
            
            try {
                // Добавляем комментарий в Firestore
                await db.collection('comments').add({
                    profileId: profileId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Аноним',
                    userEmail: currentUser.email,
                    userPhotoURL: currentUser.photoURL || null,
                    text: text,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Обновляем счетчик комментариев в профиле
                await db.collection('profiles').doc(profileId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                }).catch(err => console.log('Не удалось обновить счетчик:', err));
                
                // Обновляем данные профиля в локальном массиве
                const profile = allProfiles.find(p => p.id === profileId);
                if (profile) {
                    profile.commentsCount = (profile.commentsCount || 0) + 1;
                }
                
                // Очищаем поле ввода
                textarea.value = '';
                
                // Перезагружаем детальный просмотр и ленту активности
                const modal = document.querySelector('.modal');
                modal.remove();
                showProfileDetail(profileId);
                loadActivityFeed();
                
            } catch (error) {
                console.error('Ошибка отправки комментария:', error);
                alert('❌ Ошибка отправки: ' + error.message);
            }
        }

        // Debounce функция
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Фильтрация и поиск
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedTag = document.getElementById('tagFilter').value;
            const sortBy = document.getElementById('sortSelect').value;

            // Фильтрация
            filteredProfiles = allProfiles.filter(profile => {
                const matchesSearch = !searchTerm || 
                    profile.name.toLowerCase().includes(searchTerm) ||
                    (profile.description && profile.description.toLowerCase().includes(searchTerm));

                const matchesTag = !selectedTag || 
                    (profile.tags && profile.tags.includes(selectedTag));
                
                // Фильтр "Только мои"
                const matchesUser = userFilter === 'all' || 
                    (currentUser && profile.userId === currentUser.uid);

                return matchesSearch && matchesTag && matchesUser;
            });

            // Сортировка
            filteredProfiles.sort((a, b) => {
                if (sortBy === 'date') {
                    return (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0);
                } else if (sortBy === 'views') {
                    return (b.views || 0) - (a.views || 0);
                } else if (sortBy === 'name') {
                    return a.name.localeCompare(b.name, 'ru');
                } else if (sortBy === 'author') {
                    const authorA = a.userName || a.userEmail || 'Аноним';
                    const authorB = b.userName || b.userEmail || 'Аноним';
                    return authorA.localeCompare(authorB, 'ru');
                }
                return 0;
            });

            // Сбрасываем на первую страницу при изменении фильтров
            currentPage = 1;
            renderProfiles();
        }
        
        // Debounced версия для поиска
        const debouncedApplyFilters = debounce(applyFilters, 300);

        // Вспомогательные функции
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getProfileWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return 'профиль';
            if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return 'профиля';
            return 'профилей';
        }

        function getViewWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return 'просмотр';
            if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return 'просмотра';
            return 'просмотров';
        }

        function showError(message) {
            const container = document.getElementById('profilesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">❌</div>
                    <h2>Ошибка</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // Загрузка ленты активности (используем уже загруженные данные + комментарии)
        async function loadActivityFeed() {
            const container = document.getElementById('activityContainer');
            
            try {
                const activities = [];
                
                // 1. Берем последние 15 профилей из уже загруженных
                const sortedProfiles = [...allProfiles]
                    .sort((a, b) => (b.modified?.toMillis() || 0) - (a.modified?.toMillis() || 0))
                    .slice(0, 15);
                
                sortedProfiles.forEach(profile => {
                    activities.push({
                        type: 'profile_created',
                        timestamp: profile.modified || profile.created,
                        userId: profile.userId,
                        userName: profile.userName || 'Аноним',
                        userPhotoURL: profile.userPhotoURL,
                        profileId: profile.id,
                        profileName: profile.name
                    });
                });
                
                // 2. Загружаем последние комментарии (только для авторизованных)
                if (currentUser) {
                    try {
                        const commentsSnapshot = await db.collection('comments')
                            .orderBy('created', 'desc')
                            .limit(10)
                            .get();
                        
                        commentsSnapshot.forEach(doc => {
                            const data = doc.data();
                            activities.push({
                                type: 'comment',
                                timestamp: data.created,
                                userId: data.userId,
                                userName: data.userName || 'Аноним',
                                userPhotoURL: data.userPhotoURL,
                                profileId: data.profileId,
                                text: data.text
                            });
                        });
                    } catch (error) {
                        console.log('Не удалось загрузить комментарии для ленты:', error);
                    }
                }
                
                // Сортируем по времени
                activities.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis() || 0;
                    const timeB = b.timestamp?.toMillis() || 0;
                    return timeB - timeA;
                });
                
                // Берем только последние 20 событий
                let recentActivities = activities.slice(0, 20);
                
                // Фильтруем по участию пользователя (если выбран фильтр "Мои")
                if (activityFilter === 'my' && currentUser) {
                    recentActivities = recentActivities.filter(activity => {
                        // Показываем события где пользователь - автор
                        if (activity.userId === currentUser.uid) {
                            return true;
                        }
                        // Или где пользователь - владелец профиля
                        const profile = allProfiles.find(p => p.id === activity.profileId);
                        if (profile && profile.userId === currentUser.uid) {
                            return true;
                        }
                        return false;
                    });
                }
                
                // Отображаем активность
                if (recentActivities.length === 0) {
                    container.innerHTML = `
                        <div class="activity-empty">
                            <div class="activity-empty-icon">📭</div>
                            <div>Пока нет активности</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                recentActivities.forEach(activity => {
                    html += renderActivityItem(activity);
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки активности:', error);
                container.innerHTML = `
                    <div class="activity-empty">
                        <div class="activity-empty-icon">❌</div>
                        <div>Ошибка загрузки</div>
                    </div>
                `;
            }
        }
        
        // Отрисовка элемента активности
        function renderActivityItem(activity) {
            const time = activity.timestamp?.toDate();
            const timeAgo = time ? getTimeAgo(time) : '';
            
            // Аватарка пользователя
            const avatarUrl = activity.userPhotoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.userName)}&size=40&background=667eea&color=fff`;
            
            // Получаем полные данные профиля
            const profile = allProfiles.find(p => p.id === activity.profileId);
            
            let icon = '📌';
            let actionText = '';
            let bodyHtml = '';
            
            if (activity.type === 'profile_created' && profile) {
                icon = '📤';
                actionText = 'загрузил новый профиль';
                
                // Теги профиля
                const tagsHtml = profile.tags && profile.tags.length > 0 ? 
                    `<div class="activity-tags">
                        ${profile.tags.slice(0, 3).map(tag => `<span class="activity-tag">🏷️ ${escapeHtml(tag)}</span>`).join('')}
                        ${profile.tags.length > 3 ? `<span class="activity-tag">+${profile.tags.length - 3}</span>` : ''}
                    </div>` : '';
                
                // Описание профиля
                const description = profile.description ? 
                    `<div style="color: #666; font-size: 13px; margin-top: 8px; line-height: 1.4;">
                        ${escapeHtml(profile.description.length > 100 ? profile.description.substring(0, 100) + '...' : profile.description)}
                    </div>` : '';
                
                bodyHtml = `
                    <div class="activity-body">
                        <div class="activity-profile-card">
                            <div class="activity-profile-title">
                                🌐 ${escapeHtml(profile.name)}
                            </div>
                            <div class="activity-profile-meta">
                                <span>👁️ ${profile.views || 0}</span>
                                <span>👍 ${profile.likes || 0}</span>
                                <span>💬 ${profile.commentsCount || 0}</span>
                            </div>
                            ${description}
                            ${tagsHtml}
                        </div>
                        <div class="activity-actions">
                            <button class="activity-btn activity-btn-primary" onclick="showProfileDetail('${profile.id}')">
                                👁️ Посмотреть
                            </button>
                            <button class="activity-btn activity-btn-secondary" onclick="openInCalculator('${profile.id}')">
                                🧪 Открыть в калькуляторе
                            </button>
                            <button class="activity-btn activity-btn-secondary" onclick="showComments('${profile.id}', '${escapeHtml(profile.name).replace(/'/g, "\\'")}')">
                                💬 Комментарии
                            </button>
                        </div>
                    </div>
                `;
            } else if (activity.type === 'comment') {
                icon = '💬';
                actionText = 'прокомментировал профиль';
                
                // Текст комментария
                const commentText = activity.text || '';
                const shortText = commentText.length > 120 ? commentText.substring(0, 120) + '...' : commentText;
                
                // Находим профиль, к которому оставлен комментарий
                const commentedProfile = allProfiles.find(p => p.id === activity.profileId);
                const profileName = commentedProfile ? commentedProfile.name : 'Профиль';
                const profileOwnerName = commentedProfile ? (commentedProfile.userName || 'Аноним') : 'Аноним';
                
                // Аватарка владельца профиля
                const profileOwnerAvatar = commentedProfile?.userPhotoURL || 
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(profileOwnerName)}&size=32&background=764ba2&color=fff`;
                
                bodyHtml = `
                    <div class="activity-body">
                        <div class="activity-profile-card">
                            <!-- Информация о владельце профиля -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e8ecff;">
                                <img src="${profileOwnerAvatar}" alt="${escapeHtml(profileOwnerName)}" 
                                     style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid #764ba2;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 11px; color: #999;">Профиль автора:</div>
                                    <div style="font-weight: 600; color: #764ba2; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${escapeHtml(profileOwnerName)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Текст комментария -->
                            <div style="color: #333; font-size: 13px; line-height: 1.6; margin-bottom: 12px; font-style: italic; border-left: 3px solid #667eea; padding-left: 12px; background: #f8f9ff; padding: 10px 10px 10px 12px; border-radius: 4px;">
                                "${escapeHtml(shortText)}"
                            </div>
                            
                            <!-- Название профиля -->
                            <div class="activity-profile-title" style="margin-bottom: 8px;">
                                🌐 ${escapeHtml(profileName)}
                            </div>
                            
                            ${commentedProfile ? `
                                <div class="activity-profile-meta">
                                    <span>👁️ ${commentedProfile.views || 0}</span>
                                    <span>👍 ${commentedProfile.likes || 0}</span>
                                    <span>💬 ${commentedProfile.commentsCount || 0}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="activity-actions">
                            ${commentedProfile ? `
                                <button class="activity-btn activity-btn-primary" onclick="showProfileDetail('${activity.profileId}')">
                                    👁️ Посмотреть
                                </button>
                                <button class="activity-btn activity-btn-secondary" onclick="openInCalculator('${activity.profileId}')">
                                    🧪 Открыть в калькуляторе
                                </button>
                                <button class="activity-btn activity-btn-secondary" onclick="showComments('${activity.profileId}', '${escapeHtml(profileName).replace(/'/g, "\\'")}')">
                                    💬 Все комментарии
                                </button>
                            ` : `
                                <button class="activity-btn activity-btn-secondary" onclick="showComments('${activity.profileId}', '${escapeHtml(profileName).replace(/'/g, "\\'")}')">
                                    💬 Открыть комментарии
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="activity-item">
                    <div class="activity-header">
                        <img src="${avatarUrl}" alt="${escapeHtml(activity.userName)}" class="activity-avatar">
                        <div class="activity-user-info">
                            <div class="activity-user">${escapeHtml(activity.userName)}</div>
                            <div class="activity-action">
                                <span class="activity-icon">${icon}</span>
                                ${actionText}
                            </div>
                        </div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                    ${bodyHtml}
                </div>
            `;
        }
        
        // Функция для вычисления времени "назад"
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'только что';
            if (diffMins < 60) return `${diffMins} мин назад`;
            if (diffHours < 24) return `${diffHours} ч назад`;
            if (diffDays < 7) return `${diffDays} дн назад`;
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        // Обработчики переключателя "Только мои / Все" для профилей
        document.querySelectorAll('#userFilterContainer .user-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Убираем active со всех кнопок в этом контейнере
                document.querySelectorAll('#userFilterContainer .user-filter-btn').forEach(b => b.classList.remove('active'));
                // Добавляем active на текущую
                this.classList.add('active');
                // Устанавливаем фильтр
                userFilter = this.dataset.filter;
                // Применяем фильтры
                applyFilters();
            });
        });
        
        // Обработчики переключателя "Все / Мои" для ленты активности
        document.querySelectorAll('#activityFilterContainer .user-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Убираем active со всех кнопок в этом контейнере
                document.querySelectorAll('#activityFilterContainer .user-filter-btn').forEach(b => b.classList.remove('active'));
                // Добавляем active на текущую
                this.classList.add('active');
                // Устанавливаем фильтр
                activityFilter = this.dataset.filter;
                // Перезагружаем ленту активности
                loadActivityFeed();
            });
        });

        // События
        document.getElementById('searchInput').addEventListener('input', debouncedApplyFilters);
        document.getElementById('tagFilter').addEventListener('change', applyFilters);
        document.getElementById('sortSelect').addEventListener('change', applyFilters);

        // Обработка хэша для открытия профиля по прямой ссылке
        function handleProfileHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#profile-')) {
                const profileId = hash.replace('#profile-', '');
                if (profileId) {
                    // Небольшая задержка, чтобы профили успели загрузиться
                    setTimeout(() => {
                        showProfileDetail(profileId);
                    }, 100);
                }
            }
        }

        // Отслеживание изменения хэша
        window.addEventListener('hashchange', handleProfileHash);

        // Загрузка при старте
        loadProfiles().then(() => {
            // Загружаем ленту активности после загрузки профилей
            loadActivityFeed();
            // Проверяем хэш для автоматического открытия профиля
            handleProfileHash();
        });
    </script>
</body>
</html>
