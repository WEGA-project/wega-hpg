<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydroponic Profile Generator (HPG)</title>
    
    <script>
        // ============================================
        // –í–ï–†–°–ò–Ø –ò –î–ê–¢–ê (–∏–∑–º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å!)
        // ============================================
        const APP_VERSION = '0.221';
        const APP_DATE = '13.10.2025';
        const APP_VERSION_FULL = `${APP_VERSION} (HTML5 –ø–æ—Ä—Ç - ${APP_DATE})`;
    </script>
    
    <style>
        * {
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #c3c3c3;
            margin: 0;
            padding: 0;
            color: #202020;
        }

        .container {
            max-width: 720px;
            margin: 14px auto;
            background: #d6d6d6;
            border: 1px solid #9c9c9c;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
        }

        .header {
            background: linear-gradient(to bottom, #e6e6e6, #cccccc);
            padding: 8px 12px;
            border-bottom: 1px solid #8f8f8f;
            font-weight: bold;
            text-shadow: 0 1px 0 #f4f4f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .portal-button {
            background: linear-gradient(to bottom, #4a90e2, #357abd);
            color: white;
            border: 1px solid #2d5f8d;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .portal-button:hover {
            background: linear-gradient(to bottom, #5a9ff2, #4585c7);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .portal-button:active {
            background: linear-gradient(to bottom, #357abd, #2d5f8d);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        .tab-bar {
            display: flex;
            background: #dcdcdc;
            border-bottom: 1px solid #ccc;
        }

        .tab {
            padding: 4px 12px;
            cursor: pointer;
            border-right: 1px solid #999;
            font-size: 13px;
            color: #1f1f1f;
            user-select: none;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: #f0f0f0;
            border-bottom: 0.5px solid #f0f0f0;
            margin-bottom: -0.5px;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 8px 12px;
            background: #d3d3d3;
            min-height: 625px;
            max-height: 625px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-weight: bold;
            margin: 8px 0 6px 0;
            padding: 2px 0;
            color: #8B0000;
            font-size: 13px;
            text-shadow: 0 1px 0 #f0f0f0;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }

        .input-group label {
            min-width: 35px;
            font-weight: bold;
            font-size: 11px;
            margin-right: 3px;
        }

        input[type="number"] {
            width: 52px;
            padding: 2px 3px;
            border: 1px solid #7c7c7c;
            border-radius: 2px;
            font-size: 11px;
            text-align: right;
            font-family: Arial, sans-serif;
            background: #e9e9e9;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
        }

        input[type="number"]:focus {
            outline: 1px solid #4a90e2;
            border-color: #4a90e2;
        }

        input[type="number"].highlight-green {
            background-color: #d5efd0 !important;
        }

        input[type="number"].highlight-blue {
            background: #d7e5fe;
        }
        
        input[type="number"].wide {
            width: 90px;
        }
        
        input[type="number"].narrow {
            width: 60px;
        }

        .macro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin: 4px 0;
        }

        .macro-table th,
        .macro-table td {
            padding: 2px 3px;
        }

        .macro-table th:not(:first-child),
        .macro-table td:not(:first-child) {
            width: 56px;
        }

        .macro-table th:first-child,
        .macro-table td:first-child {
            width: 30px;
        }

        .macro-table input[type="number"] {
            width: 50px;
        }

        .macro-summary {
            width: auto !important;
        }

        .salts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background: #d6d6d6;
            margin: 8px 0;
        }

        .salts-table td,
        .salts-table th {
            padding: 2px 4px;
        }

        .salts-table td:first-child {
            width: 200px;
        }

        .salts-table input[type="number"] {
            width: 52px;
        }

        .salts-table .checkbox-cell {
            width: 40px;
        }

        .salts-table input[readonly] {
            width: 54px;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 11px;
            background: #d6d6d6;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #9c9c9c;
            padding: 2px 4px;
            text-align: center;
        }

        .matrix-table th {
            background: linear-gradient(to bottom, #e8e8e8, #d2d2d2);
            font-weight: bold;
            padding: 3px 5px;
        }

        .matrix-table td input {
            width: 100%;
            text-align: center;
            padding: 1px 2px;
            font-size: 11px;
            border: 1px solid #7c7c7c;
            background: #e9e9e9;
            box-sizing: border-box;
        }

        .matrix-table .diagonal {
            background: #d6d6d6;
            font-weight: bold;
        }
        
        .matrix-table .highlight-green-cell {
            background: #d5efd0;
        }

        .matrix-table .highlight-blue-cell {
            background: #d7e5fe;
        }

        .salts-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .salts-table thead th {
            padding: 2px 4px;
            background: transparent;
            border: none;
            font-weight: normal;
        }

        .salts-table td {
            padding: 2px 4px;
            border-bottom: 1px solid #c1c1c1;
            font-size: 11px;
        }

        .salts-table td:first-child {
            width: 35%;
            font-size: 11px;
            color: #111;
        }
        
        .salts-table td[style*="font-weight: bold"] {
            color: #8B0000;
        }
        .salts-table input[type="number"] {
            width: 100%;
            font-size: 11px;
            padding: 1px 2px;
            border: 1px solid #7c7c7c;
            background: #e9e9e9;
            box-sizing: border-box;
        }
        
        .salts-table input[readonly] {
            width: 100%;
            background: #f5f5f5;
            box-sizing: border-box;
        }
        
        .salts-table .checkbox-cell {
            width: 25px;
            text-align: center;
        }
        
        .salts-table label {
            font-weight: bold;
            margin-right: 2px;
            font-size: 10px;
        }
        
        .salts-table td {
            white-space: nowrap;
        }

        .info-panel {
            background: transparent;
            padding: 0;
            margin: 0;
            border: none;
            font-size: 11px;
            line-height: 1.45;
            color: #8B0000;
        }

        .info-panel .info-line {
            margin: 1px 0;
        }

        .bottom-panel {
            background: #d3d3d3;
            padding: 8px 10px;
            border-top: 1px solid #999;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            font-size: 11px;
        }

        .bottom-panel .bottom-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bottom-panel .bottom-row {
            display: grid;
            grid-template-columns: 140px 80px 130px 130px;
            column-gap: 8px;
            align-items: center;
        }

        .bottom-panel .bottom-row label {
            min-width: 140px;
        }

        .bottom-panel input {
            width: 80px;
            font-size: 11px;
        }

        .bottom-panel button {
            padding: 4px 12px;
            width: 130px;
            background: linear-gradient(to bottom, #e8e8e8, #cfcfcf);
            border: 1px solid #868686;
            cursor: pointer;
            border-radius: 2px;
            font-size: 11px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
        }

        .bottom-panel button:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d4d4d4);
        }

        .bottom-panel button:active {
            background: linear-gradient(to bottom, #c9c9c9, #b2b2b2);
        }
        
        .bottom-panel label {
            font-size: 11px;
            margin-right: 3px;
        }

        .bottom-panel .weights {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .bottom-panel .cost-info {
            color: #8B0000;
            font-weight: bold;
            font-size: 16px;
        }

        .bottom-panel .bottom-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            text-align: right;
            position: relative;
            min-height: 90px;
        }

        .bottom-panel .bottom-right::before {
            content: "";
            position: absolute;
            inset: 10px 0 0 0;
            opacity: 0.5;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKIAAABGCAYAAABPJ0+PAAAAxXpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabVBbDsMgDPvnFDtCXkA4Dh2dtBvs+AskndpqljBgRyYk7Z/3Kz0mCCVJrlpaKWCQJo26HRQcfTGCLHaJwsOrnqSEQSax7exXDR0PHX8BvnU75VOQPsPYrkaTyNdbUDzEs6PZ3YigFkFMbmAEdP8WlKb1/IVthyvUV5o0Kq4ybO7d71JteiPbO0y0MzIYMxdvgOfKifs0jIErudynYZxXKfpA/s3pQPoCaaFZvSULF9cAAAGDaUNDUElDQyBwcm9maWxlAAB4nH2RPUjDUBSFT1OlUioOZlBxyFCd7KIijrUKRagQaoVWHUxe+gdNWpIUF0fBteDgz2LVwcVZVwdXQRD8AXEXnBRdpMT7kkKLGB9c3sd57xzuuw8QmhWmWz1xQDdsM51MSNncqhR6RRghqmGICrNqc7Kcgu/6ukeA73cxnuV/78/Vr+UtBgQk4jirmTbxBvHMpl3jvE8sspKiEZ8TT5jUIPEj11WP3zgXXRZ4pmhm0vPEIrFU7GK1i1nJ1ImniaOablC+kPVY47zFWa/UWbtP/sJI3lhZ5jrVKJJYxBJkSFBRRxkV2IjRbpBiIU3nCR//iOuXyaWSqwxGjgVUoUNx/eB/8Hu2VmFq0kuKJIDeF8f5GANCu0Cr4Tjfx47TOgGCz8CV0fFXm8DsJ+mNjhY9Aga2gYvrjqbuAZc7wNBTTTEVVwpSCYUC8H5G35QDBm+B8Jo3t/Y5Th+ADM0qdQMcHALjRcpe93l3X/fc/r3Tnt8PVC5ymoM5BWcAAA14aVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pgo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA0LjQuMC1FeGl2MiI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpHSU1QPSJodHRwOi8vd3d3LmdpbXAub3JnL3htcC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgeG1wTU06RG9jdW1lbnRJRD0iZ2ltcDpkb2NpZDpnaW1wOjYxYzFlNTI4LTM4NWQtNDYzNC05MzM1LTJjOTI4NDNjODM3NyIKICAgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5ZTczZDE0OC0zOTZlLTQ4MTctYjFlZi0wMWRmMzU5YjI1NWYiCiAgIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoxNjFkMDhiYS00MWMxLTQ3NDQtODhiZS1kZjg5YTdlMmNlODciCiAgIGRjOkZvcm1hdD0iaW1hZ2UvcG5nIgogICBHSU1QOkFQST0iMi4wIgogICBHSU1QOlBsYXRmb3JtPSJMaW51eCIKICAgR0lNUDpUaW1lU3RhbXA9IjE3NTk4MzI3NTY1MzI2NjYiCiAgIEdJTVA6VmVyc2lvbj0iMi4xMC4zNiIKICAgdGlmZjpPcmllbnRhdGlvbj0iMSIKICAgeG1wOkNyZWF0b3JUb29sPSJHSU1QIDIuMTAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjU6MTA6MDdUMjA6MjU6NTYrMTA6MDAiCiAgIHhtcDpNb2RpZnlEYXRlPSIyMDI1OjEwOjA3VDIwOjI1OjU2KzEwOjAwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NmU1MDYxYzQtZGYwYS00MzgyLWEwZTMtODMxNGFjMjcxNDcwIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKExpbnV4KSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyNS0xMC0wN1QyMDoyNTo1NisxMDowMCIvPgogICAgPC9yZGY6U2VxPgogICA8L3htcE1NOkhpc3Rvcnk+CiAgPC9yZGY6RGVzY3JpcHRpb24+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz7Wt35cAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAEdcAABHXAFzXhzCAAAAB3RJTUUH6QoHChk4lG1UogAAB5dJREFUeNrtXduW5CAItHL6/3+ZfeptYwRBQZOJmZfZnW7jpSwKRE3pyQ8lSvv5E8+xu2A/d3iwnMXQWQdK1P3d/dzu+Sw3pd//8wBVy1Rv4L6cES1argcs0eXv5w8Asceh0IKl11nZYHyZsxLp1W6PeQMxmKMRDsIN4g3E2zwbjC/SiBEazhtAkXoxr+vWpYuAOAqY78Dl4Z1IFhsBirZeG4wPBOJd9emsiMDWiA8weU/WmFubLtCIT+v4GR47Jz9ezpT3W1nR6MVIINbeEaVPc/C9HIw7+6YGji8g8t+fMGFfCcS3re9Gt+HlpvkYnsH5j5ZpekG/crAi2Go7LkaNWNMvI3mF1gEotdQMVloJkhey46ECCtcxvSxn+c4KcGymmv58ugeqxpDeACvLWwHK6BWdrRONGrEcjHIdtRVikQYzHwBkPxGDxpXNlTeTHV/MxFAzXi/zRQ2OJzvOTLLYrGhgxK85Kr3hEoSrTJbHYOWxwv3cjBEtYRIPndgqk8u8yf89supSq+tq83itEw1HPR4BxN+A1htYA8N1aercbb17TsB0/ffdNUDWBoxM089DPkSLpbklLGREunRsjWk4BoGxM2psBuPgaiZDfd04QsemG8KnP0Zsa61LzT/ZwNWLbjktP7byNNEyA2u6/CkeKAZBjqEJdJtEC7BNJkVIo8Vo2pAIx4ZlmlSNnWtsaGlx9NbVPgD1hZIkaRPL/fDrDquJrTkWHCBazgVE4ucdoj6T3gdETzDCgd/W7OmeAMSW1uL1oR4UaLyPA8f1PX1saAV9BBBhHMgZOZg+SngIjJ9m0d+OqIGxNJckVEcXEkrsqkeLgSOfWCbUrSBFAbJvpyG84wVtL7hlvkr9ptWKEoNKLCxp2jFVzLP2KhB6TIje9qBhO5w9aD1ALMtgOiDrgGQF8SgQtYNnXWHCIAg9JgUGnSDZtRwC48GYQV/vUEqY0HS+1sue+eT1gtkHng9CqQwp0WSS/LGZPsuMgjFUZDEtI0D0YkQ9++j7cabDol/G1Th3w6x4dPtIPY3yMS/r2bCXyTV/m1m/EZpybsehBheSLtfwt9pSb5QVSK19MTNWBrze8exsQ7AmnMZbepg6DopqWmYhmbuCr9/T0rlWreh4TZvWeBvrfZg7S8tKEit6dVOeU+ixbuoN5r+T6YgmIIlxUpWAtAtWOeyjzc7xYUPupAR5W8I87mitoa90VuR6jFAIKZwbIyOOsmKk0bhjUusK1l0bWbGSB8uQH8PAt6smnRtjXRO2dsWs83FWgdBrRTi+BJzKqOWFVuKvH3UHanIOuZdCrKoPG7bkQavLsSjIHMVfZGgD/JfsTm9QkIQt7ciaJiZ9Ssqilt+gT01rtYEcmMqmSTGNqfRLniO2qo/PK4kWH0NRfZnYEAnc3rlw76J+YOvYlJxaAFcnDFOXBs7trjDkMYxz27qxjy7iVmlyhq19xsp83Lbapzs6d3GYMkD26SJNdg2fxaMHJxz1HBdemHMppb/2Gk0E0aV5eTs+A+Gblg5C0iU9/DThGBvOPl74rqyiPZplbd3V7zlMlf+ZOzsQuJMVoIo/2U4eu8M5Nu0WzZsUqOizeDY0ibPDrZvPWwrk19eaLgFthjaaD9I5rJ0vf0Zlnzuw4jGtG1uiX9pqEAsH2zEr/QDGVDDKLJiW9LXwlsMV95akVVJrTbiDbmRwy8lkq99cMK7oo05WHHNWyHmGSd+/SzJpbu78BoUWAJLEvp7Mip8hdhid0VJ4t3b+TvQFjpqTLbRH86GRvdlWz7jFpPNlxcElPgkIvWle0hbUGhBhSD2b7SRYdiDOM80wvBOTMqpYG3qoAdjj0aKzq0gttu+1QtCnt5AiFi6tn52TVtcZ0NZWjhpAyquAdD0LZ/bhwPc0Y3AApfb7GBrvgHGA+4Bc9eMvWYKy+Vf+3co8Ld2Yn0CBIPCl1M6DjDmJa/6F78HWJ9q0UZZqxQMxYuaV7gAG9DAXrtFtybSZ7chw1ejJZ4FgnKGxKOVRQhTiGIU3VXrSUojIvleklA0kerJULQ9Vpud8RFQmna72XN1wgQuYiW0PY/OWLBiMM28nxYkNcWnUb6EvFZ+rQVu3PRyKwDk/8FfY+LJh3o7z7+XfiQWw7Mjhos45/l+sGe9+Te75ulpdkup3ANsev2wZ0DTF3DbaVh5l7Rre8+/nVkuakU5QHtHz+g0cAWD83ByItmMxKKDDNHmVdeY4u2FI8UcI038boJ+waEoq9Qaov8KIXx4jUaGVRoaSfoGs/jmLoS+N+XVwJNYbswzn/iAHUPTenRjAjjMYESelAxZgeailtc8Dyqt7+RKsjlvuwiBp1mZJZNUYO0HObMVvxaiFyh7DiLaLHuXgrHSxIwrWgBpkct2ul1dey0dISKa++WjsnS1N2HZgHK/Du7uz0juHiTGJV3BTku9p0Zika+Jp7rFSE1g906N2IhelkX2CZN6COnIA6+014lUz6tVeusTUKNNufKdeP0UX77t8JzJQ2zZRWe4+oKRfse7dw0JZcApqueJ8UecsIKJwQWCYe+h6nxSGSUwnnk0N3+Ekeur6OunagEZiCVzGRbp7TAv+gbr8A6402iXlSyL4AAAAAElFTkSuQmCC');
            background-repeat: no-repeat;
            background-position: right top;
            background-size: 150px auto;
            pointer-events: none;
        }

        .bottom-panel .version-text {
            color: #0b5fa4;
            font-weight: bold;
            font-size: 12px;
        }

        .profile-string {
            width: 100%;
            padding: 5px;
            font-family: monospace;
            font-size: 8px;
            border: 1px solid #999;
            background: #fff;
            margin: 5px 0;
            white-space: nowrap;
            overflow-x: auto;
            letter-spacing: -0.5px;
        }

        .help-button {
            background: #e8e8e8;
            border: 1px solid #999;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 11px;
        }

        .help-button:hover {
            background: #d8d8d8;
        }
        
        h3 {
            font-size: 13px;
            margin: 3px 0;
            color: #000;
            font-weight: bold;
        }

        /* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ micro-inputs —É–¥–∞–ª–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ –≤–µ—Ä—Å–∏–∏ */

        .concentrates-section {
            margin: 15px 0;
        }

        .preparation-section {
            margin: 0;
        }
        
        #preparation h3 {
            margin-top: 2px;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .preparation-complex {
            margin: 2px 0;
            padding: 1px 0;
        }
        
        .prep-complex-text {
            font-size: 11px;
            color: #000;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .preparation-header {
            display: flex;
            align-items: center;
            padding: 0;
            gap: 6px;
            font-weight: bold;
            font-size: 10px;
            color: #333;
            border-bottom: 1px solid #999;
            margin-bottom: 1px;
            height: 12px;
        }
        
        .prep-checkbox-header {
            width: 18px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
            font-weight: bold;
        }
        
        .prep-input-header {
            width: 54px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
            font-weight: bold;
        }
        
        .prep-value-header {
            width: 54px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
            font-weight: bold;
        }
        
        .prep-label-header {
            flex: 1;
            text-align: left;
            flex-shrink: 0;
            font-size: 10px;
            font-weight: bold;
        }

        .preparation-section h4 {
            color: #000;
            margin-bottom: 1px;
            margin-top: 1px;
            font-size: 11px;
            font-weight: bold;
            height: 12px;
            line-height: 1;
        }

        .preparation-list {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .preparation-item {
            display: flex;
            align-items: center;
            padding: 0;
            gap: 6px;
            height: 18px;
            margin: 0;
        }

        .prep-label {
            font-weight: normal;
            color: #000;
            flex: 1;
            height: 14px;
            font-size: 10px;
            margin: 0;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.2;
        }

        .prep-value {
            font-weight: normal;
            color: #0000FF;
            background: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 10px;
            width: 54px;
            height: 18px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 2px;
            box-sizing: border-box;
            flex-shrink: 0;
            line-height: 1.2;
        }

        .preparation-subgroup {
            margin-bottom: 4px;
            padding-left: 0;
        }

        .preparation-subgroup h5 {
            margin: 1px 0 0 0;
            color: #000;
            font-size: 10px;
            font-weight: bold;
            height: 16px;
            line-height: 1.2;
        }
        
        .prep-input {
            width: 54px;
            height: 18px;
            padding: 1px 2px;
            border: 1px solid #808080;
            border-radius: 0;
            font-size: 10px;
            text-align: right;
            box-sizing: border-box;
            background: #ffffff;
            color: #000;
        }
        
        .prep-checkbox {
            width: 18px;
            height: 18px;
            margin: 0;
            flex-shrink: 0;
            accent-color: #000;
        }
        
        .mixer-input {
            width: 240px;
            height: 21px;
            padding: 1px 2px;
            border: 1px solid #808080;
            border-radius: 0;
            font-size: 11px;
            box-sizing: border-box;
            background: #ffffff;
            color: #000;
        }
        
        .mixer-number {
            width: 68px;
            height: 21px;
            padding: 1px 2px;
            border: 1px solid #808080;
            border-radius: 0;
            font-size: 11px;
            text-align: right;
            box-sizing: border-box;
            background: #ffffff;
            color: #000;
        }
        
        .preparation-buttons {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-top: 4px;
            align-items: center;
        }
        
        .prep-button {
            height: 23px;
            padding: 2px 8px;
            border: 1px solid #808080;
            cursor: pointer;
            box-sizing: border-box;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .prep-button:hover {
            background: #e0e0e0;
        }
        
        .prep-button:active {
            background: #d0d0d0;
        }

        .price-section {
            margin: 10px 0;
        }

        .price-section h4 {
            color: #000;
            margin: 6px 0;
            font-size: 13px;
            font-weight: bold;
        }

        .price-inputs {
            padding: 0;
            margin: 0 0 10px 0;
            background: none;
            border-radius: 0;
        }

        .price-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin: 2px 0;
        }

        .price-item input[type="number"],
        .price-item input[type="text"].price-input-custom {
            width: 70px;
            padding: 2px 20px 2px 4px;
            border: 1px solid #808080;
            text-align: right;
            font-size: 12px;
            box-sizing: border-box;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –∫—Ä—É—Ç–∏–ª–∫–∞–º–∏ */
        .price-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫—Ä—É—Ç–∏–ª–∫–∏ */
        .price-spinner {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            width: 16px;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
            border-left: 1px solid #808080;
        }
        
        .price-spinner button {
            flex: 1;
            margin: 0;
            padding: 0;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 8px;
            line-height: 1;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .price-spinner button:hover {
            background: #e0e0e0;
        }
        
        .price-spinner button:active {
            background: #d0d0d0;
        }
        
        .price-spinner button:first-child {
            border-bottom: 1px solid #808080;
        }

        .price-name {
            flex: 1;
            text-align: left;
        }

        .price-result {
            min-width: 130px;
            text-align: left;
            color: #000;
            font-weight: normal;
        }

        .price-total {
            margin-top: 10px;
            font-size: 13px;
            font-weight: bold;
            color: #a40000;
        }

        .concentrate-header {
            font-weight: bold;
            font-size: 14px;
            margin: 8px 0 4px 0;
            padding: 4px;
            background: #e8e8e8;
        }

        .concentrate-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .concentrate-table th {
            background: #e0e0e0;
            padding: 3px 4px;
            border: 1px solid #999;
            font-weight: bold;
            font-size: 11px;
        }

        .concentrate-table td {
            padding: 2px 4px;
            border: 1px solid #ddd;
        }

        .concentrate-table input {
            width: 65px;
            font-size: 11px;
            padding: 1px 3px;
        }

        /* –ö–æ—Ä—Ä–µ–∫—Ç–æ—Ä - –ª–µ–≥–∞—Å–∏ —Å—Ç–∏–ª—å —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º /2 * 1.7 */
        .corrector-container {
            position: relative;
            min-height: 571px;
            max-height: 571px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        .corrector-header {
            position: absolute;
            top: 7px;
            font-size: 11px;
        }

        .corrector-btn-fill {
            position: absolute;
            top: 27px;
            width: 71px;
            height: 27px;
            font-size: 11px;
            background: #e0e0e0;
            border: 1px solid #999;
            cursor: pointer;
            box-sizing: border-box;
            padding: 0 2px;
        }

        .corrector-btn-fill:hover {
            background: #d0d0d0;
        }

        .corrector-label {
            position: absolute;
            font-size: 15px;
            font-weight: bold;
        }

        .corrector-input {
            position: absolute;
            width: 71px !important;
            height: 24px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            text-align: right;
            padding: 2px 3px;
            border: 1px solid #999;
            background: white;
            box-sizing: border-box;
        }

        .corrector-input:read-only {
            background: #e8e8e8;
            color: #666;
        }

        .corrector-volume {
            position: absolute;
            top: 340px;
            width: 71px !important;
            height: 24px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            text-align: right;
            padding: 2px 3px;
            border: 1px solid #999;
            background: white;
            box-sizing: border-box;
        }

        .corrector-btn-calc {
            position: absolute;
            top: 372px;
            width: 71px;
            height: 27px;
            font-size: 11px;
            background: #e0e0e0;
            border: 1px solid #999;
            cursor: pointer;
            box-sizing: border-box;
            padding: 0 2px;
        }

        .corrector-btn-calc:hover {
            background: #d0d0d0;
        }

        .corrector-btn-journal {
            position: absolute;
            top: 401px;
            left: 321px;
            width: 71px;
            height: 27px;
            font-size: 11px;
            background: #e0e0e0;
            border: 1px solid #999;
            cursor: pointer;
            box-sizing: border-box;
            padding: 0 2px;
        }

        .corrector-btn-journal:hover {
            background: #d0d0d0;
        }

        .corrector-protocol {
            position: absolute;
            top: 27px;
            left: 394px;
            width: 297px;
            height: 539px;
            font-size: 10px;
            font-family: Arial, sans-serif;
            padding: 3px;
            border: 1px solid #999;
            background: white;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .corrector-protocol-header {
            position: absolute;
            top: 7px;
            left: 442px;
            font-size: 11px;
        }

        .corrector-btn-help {
            position: absolute;
            top: 0px;
            left: 598px;
            width: 43px;
            height: 17px;
            font-size: 10px;
            background: #e0e0e0;
            border: 1px solid #999;
            cursor: pointer;
        }

        .corrector-btn-help:hover {
            background: #d0d0d0;
        }

        .tabs-inner {
            display: flex;
            background: #e8e8e8;
            border-bottom: 1px solid #ccc;
            margin: -5px 0 2px 0;
        }

        .tab-inner {
            padding: 5px 12px;
            cursor: pointer;
            border-right: 1px solid #999;
            background: #d8d8d8;
            user-select: none;
            font-size: 12px;
            border-bottom: 0.25px solid #999;
            position: relative;
        }

        .tab-inner:hover {
            background: #e0e0e0;
        }

        .tab-inner.active {
            background: #f0f0f0;
            border-bottom: 0.5px solid #f0f0f0;
            margin-bottom: -0.5px;
            z-index: 1;
        }

        .inner-tab-content {
            display: none;
            border-top: 1px solid #ccc;
            padding: 15px;
            background: #f0f0f0;
        }

        .inner-tab-content.active {
            display: block;
        }

        .volume-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 8px 0;
        }

        .volume-inputs label {
            font-weight: bold;
            font-size: 11px;
        }

        .volume-inputs input {
            width: 80px;
            font-size: 11px;
        }
        
        .volume-inputs span {
            font-size: 11px;
        }

        /* ========== –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø (–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–¥–µ–ª—å–Ω–∞—è) ========== */
        /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media only screen and (max-width: 768px) {
            .container {
                display: none;
            }
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .mobile-version {
            display: none;
        }

        @media only screen and (max-width: 768px) {
            .mobile-version {
                display: block;
                padding: 10px;
                background: #f0f0f0;
                font-family: Arial, sans-serif;
            }

            .mobile-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #f0f0f0;
                border-bottom: 2px solid #ccc;
                z-index: 1000;
                padding: 0;
            }
            
            .mobile-header-title {
                background: #4a90e2;
                color: white;
                padding: 8px 15px;
                font-size: 15px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-header-tabs {
                display: flex;
                background: #e8e8e8;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .mobile-tab-button {
                flex: 1;
                min-width: 80px;
                padding: 8px 5px;
                border: none;
                background: #e8e8e8;
                color: #333;
                font-size: 12px;
                cursor: pointer;
                border-right: 1px solid #ccc;
                transition: background 0.2s;
            }
            
            .mobile-tab-button:last-child {
                border-right: none;
            }
            
            .mobile-tab-button.active {
                background: white;
                font-weight: bold;
                border-bottom: 3px solid #4a90e2;
            }
            
            .mobile-file-info {
                padding: 6px 15px;
                background: white;
                font-size: 11px;
                border-bottom: 1px solid #ddd;
            }
            
            .mobile-file-name {
                font-weight: bold;
                color: #333;
                margin-bottom: 2px;
            }
            
            .mobile-file-desc {
                color: #666;
            }
            
            .mobile-ratios-info {
                padding: 6px 15px;
                background: #f9f9f9;
                font-size: 11px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-ratio-item {
                display: inline-block;
                margin-right: 10px;
                color: #333;
            }
            
            .mobile-ratio-label {
                font-weight: bold;
                margin-right: 3px;
            }
            
            .mobile-ratio-value {
                color: #4a90e2;
                font-weight: bold;
            }
            
            .mobile-content-wrapper {
                margin-top: 145px;
            }
            
            .mobile-journal-container {
                display: none;
                padding: 10px;
                margin-top: 145px;
                min-height: calc(100vh - 165px);
            }
            
            .mobile-journal-list {
                background: white;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            
            .mobile-journal-item {
                padding: 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
            }
            
            .mobile-journal-item:last-child {
                border-bottom: none;
            }
            
            .mobile-journal-item:active {
                background: #e8f4ff;
            }
            
            .mobile-journal-date {
                font-weight: bold;
                color: #4a90e2;
                font-size: 13px;
                margin-bottom: 4px;
            }
            
            .mobile-journal-desc {
                color: #333;
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .mobile-journal-memo {
                color: #666;
                font-size: 11px;
                line-height: 1.4;
                white-space: pre-wrap;
            }
            
            .mobile-journal-empty {
                text-align: center;
                padding: 40px 20px;
                color: #999;
                font-size: 14px;
            }

            .mobile-notice {
                background: #fff3cd;
                border: 1px solid #ffc107;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 15px;
            }

            .mobile-notice h3 {
                margin: 0 0 10px 0;
                color: #856404;
            }

            .mobile-notice p {
                margin: 5px 0;
                line-height: 1.6;
            }

            .mobile-link {
                display: inline-block;
                background: #4a90e2;
                color: white;
                padding: 12px 20px;
                text-decoration: none;
                border-radius: 5px;
                margin-top: 10px;
            }

            .mobile-features {
                background: white;
                padding: 15px;
                border-radius: 5px;
                margin-top: 15px;
            }

            .mobile-features h4 {
                margin-top: 0;
            }

            .mobile-features ul {
                padding-left: 20px;
            }

            .mobile-features li {
                margin: 8px 0;
            }

            .mobile-input-group {
                margin-bottom: 12px;
            }

            .mobile-input-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #333;
            }

            .mobile-input-group input {
                width: 100%;
                padding: 10px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 5px;
                box-sizing: border-box;
            }

            .mobile-input-group input:focus {
                outline: none;
                border-color: #4a90e2;
            }

            /* –°–ø–æ–π–ª–µ—Ä—ã (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã) */
            .mobile-accordion {
                background: white;
                border-radius: 8px;
                margin-bottom: 10px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .mobile-accordion-header {
                padding: 15px;
                background: linear-gradient(to right, #4a90e2, #357abd);
                color: white;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: bold;
                font-size: 16px;
                user-select: none;
            }

            .mobile-accordion-header:active {
                background: linear-gradient(to right, #357abd, #2868a8);
            }

            .mobile-accordion-icon {
                transition: transform 0.3s;
                font-size: 20px;
            }

            .mobile-accordion-icon.open {
                transform: rotate(180deg);
            }

            .mobile-accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
                padding: 0 15px;
            }

            .mobile-accordion-content.open {
                max-height: 2000px;
                padding: 15px;
            }

            /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π */
            .ratio-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-top: 10px;
            }

            .ratio-item {
                padding: 8px;
                background: #f8f9fa;
                border-radius: 5px;
                text-align: center;
                font-size: 13px;
            }

            .ratio-item.optimal {
                background: #d4edda;
                border: 2px solid #28a745;
                font-weight: bold;
            }

            .ratio-label {
                font-size: 11px;
                color: #666;
                margin-bottom: 3px;
            }

            .ratio-value {
                font-size: 15px;
                font-weight: bold;
                color: #333;
            }

            /* –ò–Ω–¥–∏–∫–∞—Ü–∏—è —Å–≤–∞–π–ø–∞ —á–µ—Ä–µ–∑ —Ñ–æ–Ω –ø–æ–ª—è */
            input[type="number"].swipe-left {
                background: linear-gradient(to right, rgba(220, 53, 69, 0.2) 0%, transparent 30%) !important;
                transition: background 0.1s;
            }

            input[type="number"].swipe-right {
                background: linear-gradient(to left, rgba(40, 167, 69, 0.2) 0%, transparent 30%) !important;
                transition: background 0.1s;
            }

            /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ –±–æ–∫–∞–º –ø–æ–ª—è */
            .swipe-indicator {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                font-size: 28px;
                font-weight: bold;
                opacity: 0;
                transition: opacity 0.15s;
                pointer-events: none;
                z-index: 5;
            }

            .swipe-indicator.left {
                left: 5px;
                color: #dc3545;
            }

            .swipe-indicator.right {
                right: 5px;
                color: #28a745;
            }

            .swipe-indicator.active {
                opacity: 0.8;
            }

            .mobile-input-wrapper {
                position: relative;
                touch-action: pan-y;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <span>Hydroponic Profile Generator (HPG)</span>
            <a href="portal/index.html" class="portal-button" target="_blank">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π</a>
        </div>
        
        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('macro', this)">–ú–∞–∫—Ä–æ</div>
            <div class="tab" onclick="switchTab('micro', this)">–ú–∏–∫—Ä–æ</div>
            <div class="tab" onclick="switchTab('concentrates', this)">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã</div>
            <div class="tab" onclick="switchTab('corrector', this)">–ö–æ—Ä—Ä–µ–∫—Ç–æ—Ä</div>
            <div class="tab" onclick="switchTab('file', this)">–§–∞–π–ª</div>
            <div class="tab" onclick="switchTab('help', this)">–°–ø—Ä–∞–≤–∫–∞</div>
        </div>

        <!-- –ú–ê–ö–†–û -->
        <div id="macro" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <h3>–ú–∞–∫—Ä–æ–ø—Ä–æ—Ñ–∏–ª—å –≤ –º–≥/–ª (ppm)</h3>
                <button class="help-button" onclick="showMacroHelp()">help</button>
            </div>

            <div class="section-title">–†–∞—Å—á–µ—Ç –º–∞–∫—Ä–æ–ø—Ä–æ—Ñ–∏–ª—è –∏ –Ω–∞–≤–µ—Å–æ–∫ —Å–æ–ª–µ–π</div>
            
            <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin: 5px 0;">
                <tr>
                    <td style="width: 45px; font-weight: bold; text-align: right; padding: 2px 5px 2px 0;"></td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">N</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">P</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">K</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">Ca</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">Mg</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">S</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">Cl</td>
                    <td style="width: 75px; font-weight: bold; text-align: center; padding: 2px;">EC</td>
                </tr>
                <tr>
                    <td></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="N" value="220.000" step="1" style="width: 68px;" oninput="onNChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="P" value="40.000" step="1" class="highlight-green" style="width: 68px;" oninput="onPChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="K" value="180.000" step="1" style="width: 68px;" oninput="onMacroChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="Ca" value="200.000" step="1" style="width: 68px;" oninput="onMacroChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="Mg" value="50.000" step="1" style="width: 68px;" oninput="onMacroChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="S" value="73.049" step="1" style="width: 68px;" oninput="onSChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="Cl" value="0.00" step="1" class="highlight-green" style="width: 68px;" oninput="onClChange()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="EC" value="2.102" step="0.1" class="highlight-green" style="width: 68px;" oninput="onECChange()"></td>
                </tr>
                <tr>
                    <td style="font-weight: bold; text-align: right; padding: 2px 5px 2px 0;">NO3</td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="NO3" value="200.00" step="1" style="width: 68px;" oninput="onNO3Change()"></td>
                    <td colspan="2" style="padding: 2px 0 2px 10px;"><span id="nh4no3-info">NH4:NO3 1:10</span></td>
                    <td rowspan="2" colspan="5" style="text-align: center; vertical-align: middle; padding: 5px;">
                        <div style="display: inline-block; text-align: left; font-size: 11px; color: #8B0000;">
                            <div id="ratio-info" style="margin: 2px 0;">N:1 : 0.18 : 0.82 : 0.91 : 0.23 : 0.33 : 0 sPPM=763.05</div>
                            <div id="npk-info" style="margin: 2px 0;">NPK: 22-9-22 CaO=28% MgO=8.3% SO3=18.2%</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight: bold; text-align: right; padding: 2px 5px 2px 0;">NH4</td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="NH4" value="20.00" step="1" style="width: 68px;" oninput="onNH4Change()"></td>
                    <td style="text-align: center; padding: 2px;"><input type="number" id="NH4_ratio" value="0.100" step="0.001" class="highlight-green" style="width: 68px;" oninput="onNH4RatioChange()"></td>
                    <td></td>
                </tr>
            </table>

            <div class="section-title">–ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>N</th>
                        <th>P</th>
                        <th>K</th>
                        <th>Ca</th>
                        <th>Mg</th>
                        <th>S</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>N</th>
                        <td class="diagonal">1</td>
                        <td><input type="number" id="m_P_N" value="5.500" step="0.001" oninput="onMatrixChange('P','N')"></td>
                        <td><input type="number" id="m_K_N" value="1.222" step="0.001" class="highlight-green" oninput="onMatrixChange('K','N')"></td>
                        <td><input type="number" id="m_Ca_N" value="1.100" step="0.001" oninput="onMatrixChange('Ca','N')"></td>
                        <td><input type="number" id="m_Mg_N" value="4.400" step="0.001" oninput="onMatrixChange('Mg','N')"></td>
                        <td><input type="number" id="m_S_N" value="3.012" step="0.001" oninput="onMatrixChange('S','N')"></td>
                    </tr>
                    <tr>
                        <th>P</th>
                        <td><input type="number" id="m_N_P" value="0.182" step="0.001" oninput="onMatrixChange('N','P')"></td>
                        <td class="diagonal">1</td>
                        <td><input type="number" id="m_K_P" value="0.222" step="0.001" oninput="onMatrixChange('K','P')"></td>
                        <td><input type="number" id="m_Ca_P" value="0.200" step="0.001" class="highlight-blue" oninput="onMatrixChange('Ca','P')"></td>
                        <td><input type="number" id="m_Mg_P" value="0.800" step="0.001" oninput="onMatrixChange('Mg','P')"></td>
                        <td><input type="number" id="m_S_P" value="0.548" step="0.001" oninput="onMatrixChange('S','P')"></td>
                    </tr>
                    <tr>
                        <th>K</th>
                        <td><input type="number" id="m_N_K" value="0.818" step="0.001" oninput="onMatrixChange('N','K')"></td>
                        <td><input type="number" id="m_P_K" value="4.500" step="0.001" oninput="onMatrixChange('P','K')"></td>
                        <td class="diagonal">1</td>
                        <td><input type="number" id="m_Ca_K" value="0.900" step="0.001" oninput="onMatrixChange('Ca','K')"></td>
                        <td><input type="number" id="m_Mg_K" value="3.600" step="0.001" oninput="onMatrixChange('Mg','K')"></td>
                        <td><input type="number" id="m_S_K" value="2.464" step="0.001" oninput="onMatrixChange('S','K')"></td>
                    </tr>
                    <tr>
                        <th>Ca</th>
                        <td><input type="number" id="m_N_Ca" value="0.909" step="0.001" oninput="onMatrixChange('N','Ca')"></td>
                        <td><input type="number" id="m_P_Ca" value="5.000" step="0.001" oninput="onMatrixChange('P','Ca')"></td>
                        <td><input type="number" id="m_K_Ca" value="1.111" step="0.001" class="highlight-green" oninput="onMatrixChange('K','Ca')"></td>
                        <td class="diagonal">1</td>
                        <td><input type="number" id="m_Mg_Ca" value="4.000" step="0.001" oninput="onMatrixChange('Mg','Ca')"></td>
                        <td><input type="number" id="m_S_Ca" value="2.738" step="0.001" oninput="onMatrixChange('S','Ca')"></td>
                    </tr>
                    <tr>
                        <th>Mg</th>
                        <td><input type="number" id="m_N_Mg" value="0.227" step="0.001" oninput="onMatrixChange('N','Mg')"></td>
                        <td><input type="number" id="m_P_Mg" value="1.250" step="0.001" oninput="onMatrixChange('P','Mg')"></td>
                        <td><input type="number" id="m_K_Mg" value="0.278" step="0.001" class="highlight-green" oninput="onMatrixChange('K','Mg')"></td>
                        <td><input type="number" id="m_Ca_Mg" value="0.250" step="0.001" oninput="onMatrixChange('Ca','Mg')"></td>
                        <td class="diagonal">1</td>
                        <td><input type="number" id="m_S_Mg" value="0.684" step="0.001" oninput="onMatrixChange('S','Mg')"></td>
                    </tr>
                    <tr>
                        <th>S</th>
                        <td><input type="number" id="m_N_S" value="0.332" step="0.001" oninput="onMatrixChange('N','S')"></td>
                        <td><input type="number" id="m_P_S" value="1.826" step="0.001" oninput="onMatrixChange('P','S')"></td>
                        <td><input type="number" id="m_K_S" value="0.406" step="0.001" oninput="onMatrixChange('K','S')"></td>
                        <td><input type="number" id="m_Ca_S" value="0.365" step="0.001" oninput="onMatrixChange('Ca','S')"></td>
                        <td><input type="number" id="m_Mg_S" value="1.461" step="0.001" oninput="onMatrixChange('Mg','S')"></td>
                        <td class="diagonal">1</td>
                    </tr>
                </tbody>
            </table>

            <div class="section-title">–°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π</div>
            <table class="salts-table">
                <thead>
                    <tr style="border-bottom: 1px solid #999;">
                        <th style="text-align: left; font-weight: normal;"></th>
                        <th colspan="2" style="text-align: center; font-weight: normal; font-size: 11px; color: #8B0000;">%</th>
                        <th colspan="2" style="text-align: center; font-weight: normal; font-size: 11px; color: #8B0000;">%</th>
                        <th colspan="2" style="text-align: center; font-weight: normal; font-size: 11px; color: #8B0000;">%</th>
                        <th style="text-align: center; font-weight: normal; font-size: 11px; color: #8B0000;">–≥—Ä–∞–º–º—ã</th>
                    </tr>
                </thead>
                <tbody>
                <tr>
                    <td><span id="label_CaNO3">–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*4H2O</span></td>
                    <td style="width: 30px; font-weight: bold;">Ca</td>
                    <td style="width: 70px;"><input type="number" id="salt_CaNO3_Ca" value="16.972" step="0.001" oninput="onSaltCompositionChange('CaNO3','Ca')"></td>
                    <td style="width: 40px; font-weight: bold;">NO3</td>
                    <td style="width: 70px;"><input type="number" id="salt_CaNO3_NO3" value="11.863" step="0.001" oninput="onSaltCompositionChange('CaNO3','NO3')"></td>
                    <td style="width: 40px; font-weight: bold;">NH4</td>
                    <td style="width: 70px;"><input type="number" id="salt_CaNO3_NH4" value="0.000" step="0.001" oninput="onSaltCompositionChange('CaNO3','NH4')"></td>
                    <td style="width: 70px;"><input type="number" id="g_CaNO3" value="11.78" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_KNO3">–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π KNO3</span></td>
                    <td style="font-weight: bold;">K</td>
                    <td><input type="number" id="salt_KNO3_K" value="38.672" step="0.001" oninput="onSaltCompositionChange('KNO3','K')"></td>
                    <td style="font-weight: bold;">NO3</td>
                    <td><input type="number" id="salt_KNO3_NO3" value="13.854" step="0.001" oninput="onSaltCompositionChange('KNO3','NO3')"></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" id="g_KNO3" value="2.90" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_NH4NO3">–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π NH4NO3</span></td>
                    <td style="font-weight: bold;">NH4</td>
                    <td><input type="number" id="salt_NH4NO3_NH4" value="17.499" step="0.001" oninput="onSaltCompositionChange('NH4NO3','NH4')"></td>
                    <td style="font-weight: bold;">NO3</td>
                    <td><input type="number" id="salt_NH4NO3_NO3" value="17.499" step="0.001" oninput="onSaltCompositionChange('NH4NO3','NO3')"></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" id="g_NH4NO3" value="1.14" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_MgSO4">–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4*7H2O</span></td>
                    <td style="font-weight: bold;">Mg</td>
                    <td><input type="number" id="salt_MgSO4_Mg" value="9.861" step="0.001" oninput="onSaltCompositionChange('MgSO4','Mg')"></td>
                    <td style="font-weight: bold;">S</td>
                    <td><input type="number" id="salt_MgSO4_S" value="13.010" step="0.001" oninput="onSaltCompositionChange('MgSO4','S')"></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" id="g_MgSO4" value="5.07" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_KH2PO4">–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π KH2PO4</span></td>
                    <td style="font-weight: bold;">K</td>
                    <td><input type="number" id="salt_KH2PO4_K" value="28.731" step="0.001" oninput="onSaltCompositionChange('KH2PO4','K')"></td>
                    <td style="font-weight: bold;">P</td>
                    <td><input type="number" id="salt_KH2PO4_P" value="22.761" step="0.001" oninput="onSaltCompositionChange('KH2PO4','P')"></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" id="g_KH2PO4" value="1.76" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_K2SO4">–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π K2SO4</span></td>
                    <td style="font-weight: bold;">K</td>
                    <td><input type="number" id="salt_K2SO4_K" value="44.874" step="0.001" oninput="onSaltCompositionChange('K2SO4','K')"></td>
                    <td style="font-weight: bold;">S</td>
                    <td><input type="number" id="salt_K2SO4_S" value="18.401" step="0.001" oninput="onSaltCompositionChange('K2SO4','S')"></td>
                    <td></td>
                    <td class="checkbox-cell"><input type="checkbox" id="use_K2SO4" checked onchange="onSaltSelectionChange('K2SO4')"></td>
                    <td><input type="number" id="g_K2SO4" value="0.38" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_MgNO3">–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2*6H2O</span></td>
                    <td style="font-weight: bold;">Mg</td>
                    <td><input type="number" id="salt_MgNO3_Mg" value="9.479" step="0.001" oninput="onSaltCompositionChange('MgNO3','Mg')"></td>
                    <td style="font-weight: bold;">NO3</td>
                    <td><input type="number" id="salt_MgNO3_NO3" value="10.925" step="0.001" oninput="onSaltCompositionChange('MgNO3','NO3')"></td>
                    <td></td>
                    <td class="checkbox-cell"><input type="checkbox" id="use_MgNO3" onchange="onSaltSelectionChange('MgNO3')"></td>
                    <td><input type="number" id="g_MgNO3" value="0.00" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                <tr>
                    <td><span id="label_CaCl2">–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π CaCl2*6H2O</span></td>
                    <td style="font-weight: bold;">Ca</td>
                    <td><input type="number" id="salt_CaCl2_Ca" value="18.294" step="0.001" oninput="onSaltCompositionChange('CaCl2','Ca')"></td>
                    <td style="font-weight: bold;">Cl</td>
                    <td><input type="number" id="salt_CaCl2_Cl" value="32.366" step="0.001" oninput="onSaltCompositionChange('CaCl2','Cl')"></td>
                    <td></td>
                    <td></td>
                    <td><input type="number" id="g_CaCl2" value="0.00" step="0.01" oninput="onSaltWeightChange()"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- –ú–ò–ö–†–û -->
        <div id="micro" class="tab-content">
            <!-- –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ -->
            <div style="position: relative; height: 30px; margin-bottom: 10px;">
                <span style="position: absolute; left: 4px; top: 2px; font-size: 15px;">–ú–∏–∫—Ä–æ–ø—Ä–æ—Ñ–∏–ª—å –≤ –º–∫–≥/–ª</span>
                <span style="position: absolute; left: 360px; top: 2px; font-size: 15px; font-weight: bold;">–†–∞—Å—á–µ—Ç –Ω–∞–≤–µ—Å–æ–∫ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤</span>
                <button class="help-button" onclick="showMicroHelp()" style="position: absolute; right: 3px; top: 0; width: 43px; height: 21px; font-size: 11px;">help</button>
            </div>
            
            <!-- –ú–µ—Ç–∫–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
            <div style="position: relative; height: 20px; margin-top: 10px;">
                <label style="position: absolute; left: 25px; top: 0; font-weight: bold;">Fe</label>
                <label style="position: absolute; left: 95px; top: 0; font-weight: bold;">Mn</label>
                <label style="position: absolute; left: 170px; top: 0; font-weight: bold;">B</label>
                <label style="position: absolute; left: 245px; top: 0; font-weight: bold;">Zn</label>
                <label style="position: absolute; left: 315px; top: 0; font-weight: bold;">Cu</label>
                <label style="position: absolute; left: 390px; top: 0; font-weight: bold;">Mo</label>
                <label style="position: absolute; left: 460px; top: 0; font-weight: bold;">Co</label>
                <label style="position: absolute; left: 535px; top: 0; font-weight: bold;">Si</label>
            </div>
            
            <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
            <div style="position: relative; height: 35px; margin-bottom: 15px;">
                <input type="number" id="Fe" value="2000" step="1" oninput="onMicroChange()" 
                       style="position: absolute; left: 10px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Mn" value="550" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 82px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="B" value="500" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 154px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Zn" value="330" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 226px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Cu" value="63" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 298px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Mo" value="63" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 370px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Co" value="0" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 442px; top: 0; width: 70px; height: 27px;">
                <input type="number" id="Si" value="0" step="1" oninput="onMicroChange()"
                       style="position: absolute; left: 514px; top: 0; width: 70px; height: 27px;">
            </div>

            <!-- –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π -->
            <div id="salts-header" style="position: relative; height: 30px; margin-top: 10px;">
                <span style="position: absolute; left: 8px; top: 0; font-size: 15px;">–°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π</span>
                <span style="position: absolute; left: 125px; top: 0; font-size: 15px;">–¥–æ–ª—è (%)</span>
                <span style="position: absolute; left: 215px; top: 0; font-size: 15px;">–≥—Ä–∞–º–º—ã</span>
            </div>
            
            <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ–ª–µ–π —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
            <div id="salts-table" style="position: relative;">
                <!-- –ñ–µ–ª–µ–∑–æ -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Fe_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ñ–µ–ª–µ–∑–æ</label>
                    <input type="number" id="micro_Fe_percent" value="20.1000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Fe" value="0.09950" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ú–∞—Ä–≥–∞–Ω–µ—Ü -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Mn_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ú–∞—Ä–≥–∞–Ω–µ—Ü</label>
                    <input type="number" id="micro_Mn_percent" value="36.4000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Mn" value="0.01511" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ë–æ—Ä -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_B_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ë–æ—Ä</label>
                    <input type="number" id="micro_B_percent" value="17.5000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_B" value="0.02857" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –¶–∏–Ω–∫ -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Zn_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–¶–∏–Ω–∫</label>
                    <input type="number" id="micro_Zn_percent" value="22.7000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Zn" value="0.01454" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ú–µ–¥—å -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Cu_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ú–µ–¥—å</label>
                    <input type="number" id="micro_Cu_percent" value="25.5000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Cu" value="0.00247" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ú–æ–ª–∏–±–¥–µ–Ω -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Mo_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ú–æ–ª–∏–±–¥–µ–Ω</label>
                    <input type="number" id="micro_Mo_percent" value="54.3000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Mo" value="0.00116" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ö–æ–±–∞–ª—å—Ç -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Co_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ö–æ–±–∞–ª—å—Ç</label>
                    <input type="number" id="micro_Co_percent" value="13.0000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Co" value="0.00000" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
                
                <!-- –ö—Ä–µ–º–Ω–∏–π -->
                <div style="position: relative; height: 28px;">
                    <label id="micro_Si_label" style="position: absolute; left: 8px; top: 5px; font-size: 14px;">–ö—Ä–µ–º–Ω–∏–π</label>
                    <input type="number" id="micro_Si_percent" value="7.0000" step="0.001" oninput="onMicroCompositionChange()"
                           style="position: absolute; left: 120px; top: 2px; width: 80px; height: 23px;">
                    <input type="number" id="g_Si" value="0.00000" step="0.00001" readonly
                           style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px;">
                </div>
            </div>

            <!-- –ö–æ–º–ø–ª–µ–∫—Å –ø–æ –±–æ—Ä—É -->
            <div style="position: relative; height: 30px; margin-top: 5px;">
                <input type="checkbox" id="use_complex" onchange="onComplexChange()" 
                       style="position: absolute; left: 8px; top: 6px;">
                <label for="use_complex" style="position: absolute; left: 28px; top: 5px; font-size: 14px;">–ö–æ–º–ø–ª–µ–∫—Å –ø–æ –±–æ—Ä—É</label>
                <span id="total_micro_text" style="position: absolute; left: 205px; top: 5px; font-size: 14px; width: 80px; text-align: right;">0.16135</span>
                <input type="number" id="total_micro_grams" value="0.16135" step="0.001" oninput="onTotalMicroGramsChange()"
                       style="position: absolute; left: 205px; top: 2px; width: 80px; height: 23px; display: none;">
                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å calcConcentrates (–∞–Ω–∞–ª–æ–≥ gCmplx –∏–∑ –ª–µ–≥–∞—Å–∏) -->
                <input type="hidden" id="g_Cmplx" value="0.16135">
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–∞–≤–µ -->
            <div style="position: relative; height: 25px; margin-top: 5px;">
                <div id="micro-composition" style="position: absolute; left: 8px; top: 0; width: 670px; 
                     background: white; border: 1px solid #999; padding: 2px 4px; font-size: 13px;">
                    –°–æ—Å—Ç–∞–≤: Fe=12,395% Mn=3,409% B=3,099% Zn=2,045% Cu=0,39% Mo=0,39% Co=0% Si=0%
                </div>
            </div>

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–≤–µ–¥–µ–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
            <div style="position: relative; height: 25px; margin-top: 20px;">
                <span style="position: absolute; left: 120px; top: 0; font-size: 15px; font-weight: bold;">
                    –†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≤–æ–¥–µ (–∂–∏–¥–∫–∏–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                </span>
            </div>

            <!-- –û–±—ä–µ–º -->
            <div style="position: relative; height: 55px; margin-top: 5px;">
                <label style="position: absolute; left: 8px; top: 3px; font-size: 15px;">–û–±—ä–µ–º –¥–æ (–º–ª):</label>
                <input type="number" id="micro_volume" value="500" step="1" oninput="onMicroVolumeChange()"
                       style="position: absolute; left: 8px; top: 22px; width: 85px; height: 23px;">
                <div id="micro-dilution-info" style="position: absolute; left: 100px; top: 22px; width: 480px; 
                     border: none; border-style: none; padding: 2px 0; font-size: 13px;">
                    –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: 0,32 –≥/–ª, –ö—Ä–∞—Ç–Ω–æ—Å—Ç—å: 20:1, –†–∞—Å—Ö–æ–¥: 50 –º–ª/–ª —Ä–∞—Å—Ç–≤–æ—Ä–∞
                </div>
            </div>
        </div>

        <!-- –ö–û–ù–¶–ï–ù–¢–†–ê–¢–´ -->
        <div id="concentrates" class="tab-content">
            <div class="tabs-inner">
                <div class="tab-inner active" onclick="switchInnerTab('calc', this)">–†–∞—Å—á–µ—Ç</div>
                <div class="tab-inner" onclick="switchInnerTab('preparation', this)">–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</div>
                <div class="tab-inner" onclick="switchInnerTab('price', this)">–¶–µ–Ω–∞</div>
            </div>

            <div id="calc" class="inner-tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="margin: 0;">–†–∞—Å—á–µ—Ç –º–æ–Ω–æ—Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤</h3>
                    <button class="help-button" onclick="showCalcHelp()">help</button>
                </div>
                
                <div class="concentrate-header">
                    –†–∞—Å—Ç–≤–æ—Ä A
                    <span id="sumA" style="margin-left: 20px; font-weight: normal; font-size: 11px;">–û–±—ä–µ–º: 42,63 –º–ª, –≤–µ—Å: 42,63 –≥—Ä, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 1 –≥/–º–ª.</span>
                </div>
                <table class="concentrate-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>–≥/–ª</th>
                            <th>–≥/–º–ª</th>
                            <th>–º–ª</th>
                            <th>–≥—Ä. –∂–∏–¥–∫.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*4H2O</td>
                            <td><input type="number" id="conc_glCaNO3" value="600.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlCaNO3" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlCaNO3" value="19.63" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggCaNO3" value="19.63" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π KNO3</td>
                            <td><input type="number" id="conc_glKNO3" value="250.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlKNO3" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlKNO3" value="11.60" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggKNO3" value="11.60" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π NH4NO3</td>
                            <td><input type="number" id="conc_glNH4NO3" value="100.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlNH4NO3" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlNH4NO3" value="11.40" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggNH4NO3" value="11.40" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2*6H2O</td>
                            <td><input type="number" id="conc_glMgNO3" value="500.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlMgNO3" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlMgNO3" value="0.00" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggMgNO3" value="0.00" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π CaCl2*6H2O</td>
                            <td><input type="number" id="conc_glCaCl2" value="100.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlCaCl2" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlCaCl2" value="0.00" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggCaCl2" value="0.00" step="0.01" readonly></td>
                        </tr>
                    </tbody>
                </table>

                <div class="concentrate-header">
                    –†–∞—Å—Ç–≤–æ—Ä B
                    <span id="sumB" style="margin-left: 20px; font-weight: normal; font-size: 11px;">–û–±—ä–µ–º: 40,1 –º–ª, –≤–µ—Å: 39,87 –≥—Ä, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: 0,99 –≥/–º–ª</span>
                </div>
                <table class="concentrate-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>–≥/–ª</th>
                            <th>–≥/–º–ª</th>
                            <th>–º–ª</th>
                            <th>–≥—Ä. –∂–∏–¥–∫.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4*7H2O</td>
                            <td><input type="number" id="conc_glMgSO4" value="600.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlMgSO4" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="8.45" step="0.01" readonly></td>
                            <td><input type="number" value="8.45" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π KH2PO4</td>
                            <td><input type="number" id="conc_glKH2PO4" value="150.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlKH2PO4" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="11.73" step="0.01" readonly></td>
                            <td><input type="number" value="11.73" step="0.01" readonly></td>
                        </tr>
                        <tr>
                            <td>–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π K2SO4</td>
                            <td><input type="number" id="conc_glK2SO4" value="100.0" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlK2SO4" value="1.0000" step="0.0001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="3.80" step="0.01" readonly></td>
                            <td><input type="number" value="3.80" step="0.01" readonly></td>
                        </tr>
                        <tr style="height: 10px;"><td colspan="5"></td></tr>
                        <tr id="conc-row-Fe">
                            <td id="conc-label-Fe">–ñ–µ–ª–µ–∑–æ Fe=20,1%</td>
                            <td><input type="number" id="conc_glFe" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlFe" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="9.95" step="0.01" readonly></td>
                            <td><input type="number" value="9.95" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Mn">
                            <td id="conc-label-Mn">–ú–∞—Ä–≥–∞–Ω–µ—Ü Mn=36,4%</td>
                            <td><input type="number" id="conc_glMn" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlMn" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="1.51" step="0.01" readonly></td>
                            <td><input type="number" value="1.51" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-B">
                            <td id="conc-label-B">–ë–æ—Ä B=17,5%</td>
                            <td><input type="number" id="conc_glB" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlB" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="2.86" step="0.01" readonly></td>
                            <td><input type="number" value="2.86" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Zn">
                            <td id="conc-label-Zn">–¶–∏–Ω–∫ Zn=22,7%</td>
                            <td><input type="number" id="conc_glZn" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlZn" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="1.45" step="0.01" readonly></td>
                            <td><input type="number" value="1.45" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Cu">
                            <td id="conc-label-Cu">–ú–µ–¥—å Cu=25,5%</td>
                            <td><input type="number" id="conc_glCu" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlCu" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="0.25" step="0.01" readonly></td>
                            <td><input type="number" value="0.25" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Mo">
                            <td id="conc-label-Mo">–ú–æ–ª–∏–±–¥–µ–Ω Mo=54,3%</td>
                            <td><input type="number" id="conc_glMo" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlMo" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="0.12" step="0.01" readonly></td>
                            <td><input type="number" value="0.12" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Co">
                            <td id="conc-label-Co">–ö–æ–±–∞–ª—å—Ç Co=13%</td>
                            <td><input type="number" id="conc_glCo" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlCo" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="0.00" step="0.01" readonly></td>
                            <td><input type="number" value="0.00" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Si">
                            <td id="conc-label-Si">–ö—Ä–µ–º–Ω–∏–π Si=7%</td>
                            <td><input type="number" id="conc_glSi" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlSi" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" value="0.00" step="0.01" readonly></td>
                            <td><input type="number" value="0.00" step="0.01" readonly></td>
                        </tr>
                        <tr id="conc-row-Cmplx" style="display: none;">
                            <td id="conc-label-Cmplx">–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤</td>
                            <td><input type="number" id="conc_glCmplx" value="10.00" step="0.1" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_gmlCmplx" value="1.000" step="0.001" oninput="calcConcentrates()"></td>
                            <td><input type="number" id="conc_mlCmplx" value="0.00" step="0.01" readonly></td>
                            <td><input type="number" id="conc_ggCmplx" value="0.00" step="0.01" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="preparation" class="inner-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="margin: 0;">–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</h3>
                    <button class="help-button" onclick="showPreparationHelp()">help</button>
                </div>
                
                <!-- –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
                <div class="preparation-section">
                    <h4>–ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã</h4>
                    
                    <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ -->
                    <div class="preparation-header">
                        <div class="prep-input-header">–ü–æ–º–ø–∞</div>
                        <div class="prep-checkbox-header">–†—É—á–Ω.</div>
                        <div class="prep-value-header">–∂–∏–¥–∫ (–≥—Ä.)</div>
                        <div class="prep-label-header">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    </div>
                    
                    <!-- –†–∞—Å—Ç–≤–æ—Ä A -->
                    <div class="preparation-subgroup">
                        <h5>–†–∞—Å—Ç–≤–æ—Ä A</h5>
                        <div class="preparation-item">
                            <input type="text" id="mCaNO3" value="p1" class="prep-input">
                            <input type="checkbox" id="cbCaNO3" class="prep-checkbox">
                            <input type="text" id="g2gCaNO3" value="0.00" class="prep-input">
                            <label for="k2nCaNO3" class="prep-label">–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π 4-–≤–æ–¥–Ω—ã–π  (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mKNO3" value="p2" class="prep-input">
                            <input type="checkbox" id="cbKNO3" class="prep-checkbox">
                            <input type="text" id="g2gKNO3" value="0.00" class="prep-input">
                            <label for="k2nKNO3" class="prep-label">–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mNH4NO3" value="p3" class="prep-input">
                            <input type="checkbox" id="cbNH4NO3" class="prep-checkbox">
                            <input type="text" id="g2gNH4NO3" value="0.00" class="prep-input">
                            <label for="k2nNH4NO3" class="prep-label">–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mMgNO3" value="" class="prep-input">
                            <input type="checkbox" id="cbMgNO3" class="prep-checkbox">
                            <input type="text" id="g2gMgNO3" value="0.00" class="prep-input">
                            <label for="k2nMgNO3" class="prep-label">–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π 6-–≤–æ–¥–Ω—ã–π (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mCaCl2" value="" class="prep-input">
                            <input type="checkbox" id="cbCaCl2" class="prep-checkbox">
                            <input type="text" id="g2gCaCl2" value="0.00" class="prep-input">
                            <label for="k2nCaCl2" class="prep-label">–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π (—á.)</label>
                        </div>
                    </div>
                    
                    <!-- –†–∞—Å—Ç–≤–æ—Ä B -->
                    <div class="preparation-subgroup">
                        <h5>–†–∞—Å—Ç–≤–æ—Ä B</h5>
                        <div class="preparation-item">
                            <input type="text" id="mMgSO4" value="p4" class="prep-input">
                            <input type="checkbox" id="cbMgSO4" class="prep-checkbox">
                            <input type="text" id="g2gMgSO4" value="0.00" class="prep-input">
                            <label for="k2nMgSO4" class="prep-label">–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π 7-–≤–æ–¥–Ω—ã–π (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mKH2PO4" value="p5" class="prep-input">
                            <input type="checkbox" id="cbKH2PO4" class="prep-checkbox">
                            <input type="text" id="g2gKH2PO4" value="0.00" class="prep-input">
                            <label for="k2nKH2PO4" class="prep-label">–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π 1-–∑–∞–º–µ—â–µ–Ω–Ω—ã–π (—á.)</label>
                        </div>
                        <div class="preparation-item">
                            <input type="text" id="mK2SO4" value="p6" class="prep-input">
                            <input type="checkbox" id="cbK2SO4" class="prep-checkbox">
                            <input type="text" id="g2gK2SO4" value="0.00" class="prep-input">
                            <label for="k2nK2SO4" class="prep-label">–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π –±–µ–∑–≤–æ–¥–Ω—ã–π (—á.)</label>
                        </div>
                    </div>
                </div>
                
                <!-- –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
                <div class="preparation-section">
                    <h4>–ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã</h4>
                    
                    <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ -->
                    <div class="preparation-header">
                        <div class="prep-input-header">–ü–æ–º–ø–∞</div>
                        <div class="prep-checkbox-header">–†—É—á–Ω.</div>
                        <div class="prep-value-header">–∂–∏–¥–∫ (–≥—Ä.)</div>
                        <div class="prep-label-header">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    </div>
                    
                    <!-- –ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                    <div class="preparation-item" id="complex-micro-item" style="display: none;">
                        <input type="text" id="mCmplx" value="" class="prep-input">
                        <input type="checkbox" id="cbCmplx" class="prep-checkbox">
                        <input type="text" id="g2gCmplx" value="0.00" class="prep-input">
                        <label for="l2Cmplx" class="prep-label" id="l2Cmplx">–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤</label>
                    </div>
                    
                    <!-- –û—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
                    <div class="preparation-item" id="individual-micro-Fe">
                        <input type="text" id="mFe" value="" class="prep-input">
                        <input type="checkbox" id="cbFe" class="prep-checkbox">
                        <input type="text" id="g2gFe" value="0.00" class="prep-input">
                        <label for="l2Fe" class="prep-label">–ñ–µ–ª–µ–∑–æ (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Mn">
                        <input type="text" id="mMn" value="" class="prep-input">
                        <input type="checkbox" id="cbMn" class="prep-checkbox">
                        <input type="text" id="g2gMn" value="0.00" class="prep-input">
                        <label for="l2Mn" class="prep-label">–ú–∞—Ä–≥–∞–Ω–µ—Ü (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-B">
                        <input type="text" id="mB" value="" class="prep-input">
                        <input type="checkbox" id="cbB" class="prep-checkbox">
                        <input type="text" id="g2gB" value="0.00" class="prep-input">
                        <label for="l2B" class="prep-label">–ë–æ—Ä (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Zn">
                        <input type="text" id="mZn" value="" class="prep-input">
                        <input type="checkbox" id="cbZn" class="prep-checkbox">
                        <input type="text" id="g2gZn" value="0.00" class="prep-input">
                        <label for="l2Zn" class="prep-label">–¶–∏–Ω–∫ (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Cu">
                        <input type="text" id="mCu" value="" class="prep-input">
                        <input type="checkbox" id="cbCu" class="prep-checkbox">
                        <input type="text" id="g2gCu" value="0.00" class="prep-input">
                        <label for="l2Cu" class="prep-label">–ú–µ–¥—å (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Mo">
                        <input type="text" id="mMo" value="" class="prep-input">
                        <input type="checkbox" id="cbMo" class="prep-checkbox">
                        <input type="text" id="g2gMo" value="0.00" class="prep-input">
                        <label for="l2Mo" class="prep-label">–ú–æ–ª–∏–±–¥–µ–Ω (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Co">
                        <input type="text" id="mCo" value="" class="prep-input">
                        <input type="checkbox" id="cbCo" class="prep-checkbox">
                        <input type="text" id="g2gCo" value="0.00" class="prep-input">
                        <label for="l2Co" class="prep-label">–ö–æ–±–∞–ª—å—Ç (%)</label>
                    </div>
                    <div class="preparation-item" id="individual-micro-Si">
                        <input type="text" id="mSi" value="" class="prep-input">
                        <input type="checkbox" id="cbSi" class="prep-checkbox">
                        <input type="text" id="g2gSi" value="0.00" class="prep-input">
                        <label for="l2Si" class="prep-label">–ö—Ä–µ–º–Ω–∏–π (%)</label>
                    </div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Å–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="preparation-section">
                    <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Å–µ—Ä–∞</h4>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="addrMixer" style="font-size: 11px;">–ê–¥—Ä–µ—Å:</label>
                        <input type="text" id="addrMixer" value="mixer.local" class="prep-input mixer-input">
                        <label for="nmix" style="font-size: 11px;">–ù–æ–º–µ—Ä:</label>
                        <input type="number" id="nmix" value="1" class="prep-input mixer-number">
                        <button id="btnManufacture" class="prep-button">–ò–∑–≥–æ—Ç–æ–≤–∏—Ç—å</button>
                        <button id="btnToProfile" class="prep-button">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
                        <button id="btnToJournal" class="prep-button">–í–Ω–µ—Å—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª</button>
                    </div>
                </div>
            </div>

            <div id="price" class="inner-tab-content">
                <h3>–¶–µ–Ω–∞</h3>
                
                <div class="price-section">
                    <h4>–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º</h4>
                    <div class="price-inputs">
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_CaNO3" class="price-input-custom" value="0.4000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_CaNO3" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_CaNO3" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π 4-–≤–æ–¥–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_CaNO3">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_KNO3" class="price-input-custom" value="0.3500" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_KNO3" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_KNO3" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_KNO3">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_NH4NO3" class="price-input-custom" value="0.2500" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_NH4NO3" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_NH4NO3" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_NH4NO3">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_MgNO3" class="price-input-custom" value="0.3500" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_MgNO3" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_MgNO3" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π 6-–≤–æ–¥–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_MgNO3">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_MgSO4" class="price-input-custom" value="0.1200" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_MgSO4" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_MgSO4" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π 7-–≤–æ–¥–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_MgSO4">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_KH2PO4" class="price-input-custom" value="0.4000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_KH2PO4" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_KH2PO4" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π 1-–∑–∞–º–µ—â–µ–Ω–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_KH2PO4">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_K2SO4" class="price-input-custom" value="0.3200" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_K2SO4" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_K2SO4" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π –±–µ–∑–≤–æ–¥–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_K2SO4">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_CaCl2" class="price-input-custom" value="7.7000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_CaCl2" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_CaCl2" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π (—á.)</span>
                            <span class="price-result" id="price_result_CaCl2">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="price-section">
                    <h4>–ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã</h4>
                    <div class="price-inputs">
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Fe" class="price-input-custom" value="3.0000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Fe" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Fe" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ñ–µ–ª–µ–∑–æ (%)</span>
                            <span class="price-result" id="price_result_Fe">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Mn" class="price-input-custom" value="0.3000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Mn" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Mn" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ú–∞—Ä–≥–∞–Ω–µ—Ü (%)</span>
                            <span class="price-result" id="price_result_Mn">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_B" class="price-input-custom" value="0.4000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_B" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_B" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ë–æ—Ä (%)</span>
                            <span class="price-result" id="price_result_B">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Zn" class="price-input-custom" value="0.1500" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Zn" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Zn" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–¶–∏–Ω–∫ (%)</span>
                            <span class="price-result" id="price_result_Zn">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Cu" class="price-input-custom" value="0.4000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Cu" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Cu" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ú–µ–¥—å (%)</span>
                            <span class="price-result" id="price_result_Cu">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Mo" class="price-input-custom" value="3.0000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Mo" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Mo" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ú–æ–ª–∏–±–¥–µ–Ω (%)</span>
                            <span class="price-result" id="price_result_Mo">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Co" class="price-input-custom" value="2.3000" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Co" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Co" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–æ–±–∞–ª—å—Ç (%)</span>
                            <span class="price-result" id="price_result_Co">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Si" class="price-input-custom" value="0.2700" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Si" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Si" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö—Ä–µ–º–Ω–∏–π (%)</span>
                            <span class="price-result" id="price_result_Si">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                        <div class="price-item" style="display: none;">
                            <div class="price-input-wrapper">
                                <input type="text" id="price_Cmplx" class="price-input-custom" value="0.0500" oninput="updatePriceResults()">
                                <div class="price-spinner">
                                    <button data-input="price_Cmplx" data-delta="0.0001">‚ñ≤</button>
                                    <button data-input="price_Cmplx" data-delta="-0.0001">‚ñº</button>
                                </div>
                            </div>
                            <span class="price-name">–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤</span>
                            <span class="price-result" id="price_result_Cmplx">0.00 –≥. —Ü–µ–Ω–∞: 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="price-total">
                    –°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="total_price">0.00</span> –∑–∞ 1 –ª–∏—Ç—Ä: <span id="price_per_liter">0.00</span>
                </div>
            </div>
            
            <!-- –û–±—â–∏–π –±–ª–æ–∫ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–≤–∫–ª–∞–¥–æ–∫ –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤ -->
            <div class="volume-inputs">
                <label>–¢–∞—Ä–∞ A (–º–ª)</label>
                <input type="number" id="tank_A" value="500" step="1" oninput="calcConcentrates()">
                <span id="lVolA">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç A (20:1) . –î–æ–ª–∏—Ç—å –≤–æ–¥—ã: 457–º–ª. –ü–æ 50 –º–ª –Ω–∞ 1–ª.</span>
            </div>
            <div class="volume-inputs">
                <label>–¢–∞—Ä–∞ B (–º–ª)</label>
                <input type="number" id="tank_B" value="500" step="1" oninput="calcConcentrates()">
                <span id="lVolB">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç B (20:1) . –î–æ–ª–∏—Ç—å –≤–æ–¥—ã: 460–º–ª. –ü–æ 50 –º–ª –Ω–∞ 1–ª.</span>
            </div>
        </div>

        <!-- –ö–û–†–†–ï–ö–¢–û–† -->
        <div id="corrector" class="tab-content">
            <div class="corrector-container">
                <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ -->
                <div class="corrector-header" style="left: 48px;">–ò—Å—Ö–æ–¥–Ω—ã–π</div>
                <div class="corrector-header" style="left: 136px;">–¢–µ–∫—É—â–∏–π</div>
                <div class="corrector-header" style="left: 223px;">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–π</div>
                <div class="corrector-header" style="left: 321px;">–ò—Ç–æ–≥–æ–≤—ã–π</div>
                <div class="corrector-protocol-header">–ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏</div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ "–ó–∞–ø–æ–ª–Ω–∏—Ç—å" -->
                <button class="corrector-btn-fill" style="left: 48px;" onclick="fillColumn('initial')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                <button class="corrector-btn-fill" style="left: 223px;" onclick="fillColumn('correcting')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                <button class="corrector-btn-fill" style="left: 321px;" onclick="fillColumn('final')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                
                <!-- –ú–µ—Ç–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ª–µ–≤–∞ -->
                <label class="corrector-label" style="top: 68px; left: 20px;">N</label>
                <label class="corrector-label" style="top: 95px; left: 3px;">NO3</label>
                <label class="corrector-label" style="top: 121px; left: 3px;">NH4</label>
                <label class="corrector-label" style="top: 146px; left: 20px;">P</label>
                <label class="corrector-label" style="top: 173px; left: 20px;">K</label>
                <label class="corrector-label" style="top: 199px; left: 14px;">Ca</label>
                <label class="corrector-label" style="top: 226px; left: 14px;">Mg</label>
                <label class="corrector-label" style="top: 253px; left: 22px;">S</label>
                <label class="corrector-label" style="top: 279px; left: 19px;">Cl</label>
                <label class="corrector-label" style="top: 306px; left: 15px;">EC</label>
                <label class="corrector-label" style="top: 343px; left: 68px;">–û–±—ä–µ–º</label>
                
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 1: –ò—Å—Ö–æ–¥–Ω—ã–π (Left=48) -->
                <input type="number" class="corrector-input" style="top: 63px; left: 48px;" id="corr_init_N" value="220.00" step="0.01" readonly>
                <input type="number" class="corrector-input" style="top: 90px; left: 48px;" id="corr_init_NO3" value="200.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 116px; left: 48px;" id="corr_init_NH4" value="20.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 143px; left: 48px;" id="corr_init_P" value="40.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 168px; left: 48px;" id="corr_init_K" value="180.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 196px; left: 48px;" id="corr_init_Ca" value="200.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 221px; left: 48px;" id="corr_init_Mg" value="50.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 248px; left: 48px;" id="corr_init_S" value="73.049" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 274px; left: 48px;" id="corr_init_Cl" value="0.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 301px; left: 48px;" id="corr_init_EC" value="2.102" step="0.001" readonly>
                <input type="number" class="corrector-volume" style="left: 136px;" id="corr_init_vol" value="10.0" step="0.1" oninput="onCorrectorChange()">
                <button class="corrector-btn-calc" style="left: 48px;" onclick="calcCorrection('initial')">–í —Ä–∞—Å—á–µ—Ç</button>
                
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 2: –¢–µ–∫—É—â–∏–π (Left=136) -->
                <input type="number" class="corrector-input" style="top: 63px; left: 136px;" id="corr_curr_N" value="220.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 90px; left: 136px;" id="corr_curr_NO3" value="200.00" step="0.01" readonly>
                <input type="number" class="corrector-input" style="top: 116px; left: 136px;" id="corr_curr_NH4" value="20.00" step="0.01" readonly>
                <input type="number" class="corrector-input" style="top: 143px; left: 136px;" id="corr_curr_P" value="40.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 168px; left: 136px;" id="corr_curr_K" value="180.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 196px; left: 136px;" id="corr_curr_Ca" value="200.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 221px; left: 136px;" id="corr_curr_Mg" value="50.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 248px; left: 136px;" id="corr_curr_S" value="73.049" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 274px; left: 136px;" id="corr_curr_Cl" value="0.00" step="0.01" readonly>
                <input type="number" class="corrector-input" style="top: 301px; left: 136px;" id="corr_curr_EC" value="2.102" step="0.001" oninput="onCorrectorChange()">
                <button class="corrector-btn-calc" style="left: 136px;" onclick="calcCorrection('current')">–í —Ä–∞—Å—á–µ—Ç</button>
                
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 3: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–π (Left=223) -->
                <input type="number" class="corrector-input" style="top: 63px; left: 223px;" id="corr_corr_N" value="220.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 90px; left: 223px;" id="corr_corr_NO3" value="200.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 116px; left: 223px;" id="corr_corr_NH4" value="20.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 143px; left: 223px;" id="corr_corr_P" value="40.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 168px; left: 223px;" id="corr_corr_K" value="180.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 196px; left: 223px;" id="corr_corr_Ca" value="200.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 221px; left: 223px;" id="corr_corr_Mg" value="50.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 248px; left: 223px;" id="corr_corr_S" value="73.049" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 274px; left: 223px;" id="corr_corr_Cl" value="0.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 301px; left: 223px;" id="corr_corr_EC" value="2.102" step="0.001" readonly>
                <input type="number" class="corrector-volume" style="left: 223px;" id="corr_corr_vol" value="20.0" step="0.1" readonly>
                <button class="corrector-btn-calc" style="left: 223px;" onclick="calcCorrection('correcting')">–í —Ä–∞—Å—á–µ—Ç</button>
                
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 4: –ò—Ç–æ–≥–æ–≤—ã–π (Left=321) -->
                <input type="number" class="corrector-input" style="top: 63px; left: 321px;" id="corr_final_N" value="220.000" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 90px; left: 321px;" id="corr_final_NO3" value="200.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 116px; left: 321px;" id="corr_final_NH4" value="20.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 143px; left: 321px;" id="corr_final_P" value="40.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 168px; left: 321px;" id="corr_final_K" value="180.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 196px; left: 321px;" id="corr_final_Ca" value="200.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 221px; left: 321px;" id="corr_final_Mg" value="50.000" step="0.001" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 248px; left: 321px;" id="corr_final_S" value="73.049" step="0.001" readonly>
                <input type="number" class="corrector-input" style="top: 274px; left: 321px;" id="corr_final_Cl" value="0.00" step="0.01" oninput="onCorrectorChange()">
                <input type="number" class="corrector-input" style="top: 301px; left: 321px;" id="corr_final_EC" value="2.102" step="0.001" readonly>
                <input type="number" class="corrector-volume" style="left: 321px;" id="corr_final_vol" value="30.0" step="0.1" oninput="onCorrectorChange()">
                <button class="corrector-btn-calc" style="left: 321px;" onclick="calcCorrection('final')">–í —Ä–∞—Å—á–µ—Ç</button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ "–í –∂—É—Ä–Ω–∞–ª" -->
                <button class="corrector-btn-journal" onclick="saveCorrectorToJournal()">–í –∂—É—Ä–Ω–∞–ª</button>
                
                <!-- –ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ -->
                <textarea class="corrector-protocol" id="corrector_protocol" readonly>–û–°–ù–û–í–ù–û–ï:
–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –Ω–∞: 200%
–î–æ–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞: 33%
–ò–∑–º–µ–Ω–µ–Ω–∏–µ EC –Ω–∞: 0%
–ò–∑–º–µ–Ω–µ–Ω–∏–µ N –æ–±—â–∏–π –Ω–∞: 0%

–ü–†–û–§–ò–õ–¨:
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è NO3 –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è NH4 –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è P –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è K –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Ca –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Mg –Ω–∞: 0%
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è S –Ω–∞: 0 ppm
–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Cl –Ω–∞: 0 ppm

–°–û–û–¢–ù–û–®–ï–ù–ò–Ø:
NH4:NO3 –¥–æ 0,1 –ø–æ—Å–ª–µ 0,1
K:N –¥–æ 0,818 –ø–æ—Å–ª–µ 0,818
K:Ca –¥–æ 0,9 –ø–æ—Å–ª–µ 0,9
K:Mg –¥–æ 3,6 –ø–æ—Å–ª–µ 3,6</textarea>
                
                <!-- –ö–Ω–æ–ø–∫–∞ help -->
                <button class="corrector-btn-help" onclick="showCorrectorHelp()">help</button>
            </div>
        </div>

        <!-- –§–ê–ô–õ -->
        <div id="file" class="tab-content" style="position: relative; max-height: 470px; overflow: hidden; font-family: Arial; font-size: 15px;">
            <!-- –ö–Ω–æ–ø–∫–∞ help —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É -->
            <button onclick="showFileHelp()" style="position: absolute; left: 663px; top: 3px; width: 59px; height: 21px; font-size: 14px; padding: 0;">help</button>
            
            <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
            <div style="position: absolute; left: 8px; top: 3px; font-weight: bold; font-size: 15px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
            
            <label style="position: absolute; left: 19px; top: 36px; font-size: 15px;">–ò–º—è —Ñ–∞–π–ª–∞:</label>
            <input type="text" id="file_filename" value="default.hpg" oninput="updateMobileFileInfo()" style="position: absolute; left: 120px; top: 30px; width: 582px; height: 24px; font-family: Arial; font-size: 15px;">
            
            <label style="position: absolute; left: 19px; top: 65px; font-size: 15px;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <input type="text" id="file_comment" value="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é" oninput="updateMobileFileInfo()" style="position: absolute; left: 120px; top: 62px; width: 582px; height: 24px; font-family: Arial; font-size: 15px;">
            
            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ -->
            <button onclick="fileOpen()" style="position: absolute; left: 11px; top: 95px; width: 106px; height: 30px; font-size: 15px;">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button onclick="fileSaveAs()" style="position: absolute; left: 123px; top: 95px; width: 138px; height: 30px; font-size: 15px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫</button>
            <button onclick="fileLoadFertilizers()" style="position: absolute; left: 267px; top: 95px; width: 208px; height: 30px; font-size: 15px;">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏—è</button>
            <button onclick="fileLoadProfile()" style="position: absolute; left: 481px; top: 95px; width: 208px; height: 30px; font-size: 15px;">–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            
            <!-- –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ -->
            <div style="position: absolute; left: 8px; top: 130px; width: 691px; border: 1px solid #999; background: #f0f0f0; padding: 5px; border-radius: 3px;">
                <!-- –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω -->
                <div id="cloud-login-section" style="display: none;">
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</div>
                    <div style="font-size: 12px; margin-bottom: 5px;">–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –≤ –æ–±–ª–∞–∫–µ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button id="btn-google-login" onclick="loginWithGoogle()" style="flex: 1; height: 28px; font-size: 14px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                            üîµ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                        </button>
                        <button onclick="showSecurityInfo()" style="width: 28px; height: 28px; background: #ffc107; color: #000; border: none; border-radius: 3px; cursor: pointer; font-size: 16px; font-weight: bold;" title="–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å">
                            ‚ö†Ô∏è
                        </button>
                    </div>
                </div>
                
                <!-- –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω -->
                <div id="cloud-logged-in-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img id="user-avatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 50%; display: none;">
                            <div>
                                <div id="user-name" style="font-weight: bold; font-size: 13px;"></div>
                                <div id="user-email" style="font-size: 11px; color: #666;"></div>
                            </div>
                        </div>
                        <button onclick="logout()" style="width: 70px; height: 22px; font-size: 12px;">–í—ã–π—Ç–∏</button>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="saveProfileToCloud()" style="flex: 1; height: 26px; font-size: 12px; background: #34a853; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button onclick="showCloudProfilesModal()" style="flex: 1; height: 26px; font-size: 12px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                            üì• –ú–æ–∏
                        </button>
                        <button onclick="showPublicProfilesModal()" style="flex: 1; height: 26px; font-size: 12px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                            üåç –ö–∞—Ç–∞–ª–æ–≥
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π -->
            <div style="position: absolute; left: 8px; top: 225px; font-weight: bold; font-size: 15px;">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
            
            <select id="file_journal_list" size="4" style="position: absolute; left: 8px; top: 251px; width: 691px; height: 85px; font-family: Arial; font-size: 15px;">
            </select>
            
            <label style="position: absolute; left: 8px; top: 344px; font-size: 15px;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <label style="position: absolute; left: 134px; top: 344px; font-size: 15px;">–î–∞—Ç–∞:</label>
            
            <input type="date" id="file_journal_date" value="" style="position: absolute; left: 169px; top: 339px; width: 138px; height: 24px; font-family: Arial; font-size: 15px;">
            
            <button onclick="journalAdd()" style="position: absolute; left: 315px; top: 339px; width: 101px; height: 24px; font-size: 15px;">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="journalUpdate()" style="position: absolute; left: 423px; top: 339px; width: 66px; height: 24px; font-size: 15px;">–û–±–Ω–æ–≤.</button>
            <button onclick="journalDelete()" style="position: absolute; left: 494px; top: 339px; width: 80px; height: 24px; font-size: 15px;">–£–¥–∞–ª–∏—Ç—å</button>
            
            <textarea id="file_journal_memo" style="position: absolute; left: 8px; top: 367px; width: 691px; height: 70px; font-family: Arial; font-size: 15px; resize: none;"></textarea>
            
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –≤ –∂—É—Ä–Ω–∞–ª–µ -->
            <div style="position: absolute; left: 8px; top: 446px; font-size: 15px;">–ü—Ä–æ—Ñ–∏–ª—å –≤ –∂—É—Ä–Ω–∞–ª–µ:</div>
            <!-- –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∫ pr2 –≤ –ª–µ–≥–∞—Å–∏) -->
            <input type="text" id="file_profile_info" readonly style="position: absolute; left: 8px; top: 464px; width: 691px; height: 13px; font-family: Arial; font-size: 12px; border: none; background: transparent; color: #000000;">
            
            <button onclick="acceptProfileFromJournal()" style="position: absolute; left: 243px; top: 482px; width: 257px; height: 23px; font-size: 15px; line-height: 23px; white-space: nowrap;">–ü—Ä–∏–Ω—è—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –∂—É—Ä–Ω–∞–ª–∞</button>
            
            <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ (–ø–æ–∑–∏—Ü–∏–∏ —É–≤–µ–ª–∏—á–µ–Ω—ã –Ω–∞ 40%) -->
            <!-- –°—Ç—Ä–æ–∫–∞ 1 -->
            <span id="rN" style="position: absolute; left: 6px; top: 519px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rNO3" style="position: absolute; left: 62px; top: 519px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rNH4" style="position: absolute; left: 123px; top: 519px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rFe" style="position: absolute; left: 197px; top: 519px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rCo" style="position: absolute; left: 274px; top: 519px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 2 -->
            <span id="rP" style="position: absolute; left: 6px; top: 533px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rMn" style="position: absolute; left: 197px; top: 533px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rSi" style="position: absolute; left: 274px; top: 533px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 2.5 (Cl) -->
            <span id="rCl" style="position: absolute; left: 62px; top: 547px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 3 -->
            <span id="rK" style="position: absolute; left: 6px; top: 547px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rB" style="position: absolute; left: 197px; top: 547px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 4 -->
            <span id="rCa" style="position: absolute; left: 6px; top: 561px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rZn" style="position: absolute; left: 197px; top: 561px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 5 -->
            <span id="rMg" style="position: absolute; left: 6px; top: 575px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rCu" style="position: absolute; left: 197px; top: 575px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            
            <!-- –°—Ç—Ä–æ–∫–∞ 6 -->
            <span id="rS" style="position: absolute; left: 6px; top: 589px; font-family: Arial; font-size: 10px; color: #000000;"></span>
            <span id="rMo" style="position: absolute; left: 197px; top: 589px; font-family: Arial; font-size: 10px; color: #000000;"></span>
        </div>

        <!-- –°–ü–†–ê–í–ö–ê -->
        <div id="help" class="tab-content">
            <h3>–°–ø—Ä–∞–≤–∫–∞ - Hydroponic Profile Generator</h3>
            <div style="line-height: 1.6; padding: 10px;">
                <p><strong>–í–µ—Ä—Å–∏—è:</strong> <span id="help-version"></span></p>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π –º–∏–Ω–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π –ø—Ä–∏ –≥–∏–¥—Ä–æ–ø–æ–Ω–Ω–æ–º –º–µ—Ç–æ–¥–µ –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è.</p>
                
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin: 15px 0;">
                    <h4 style="margin-top: 0; color: #856404;">‚ö†Ô∏è –û –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h4>
                    <p style="margin: 8px 0;">–≠—Ç–æ HTML5 –≤–µ—Ä—Å–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è WEGA-HPG, –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å –ø–æ–º–æ—â—å—é –ò–ò.</p>
                    <p style="margin: 8px 0;"><strong>–¶–µ–ª—å –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (Lazarus/Free Pascal) –≤ –≤–µ–±-—Ñ–æ—Ä–º–∞—Ç–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤, –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>
                    <p style="margin: 8px 0;"><strong>–í–∞–∂–Ω–æ:</strong></p>
                    <ul style="margin: 8px 0 8px 20px;">
                        <li>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–∂–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</li>
                        <li>–í–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏ –∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö</li>
                        <li>–ü–æ—Ä—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è</li>
                        <li>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤ .hpg —Å–æ–≤–º–µ—Å—Ç–∏–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π</li>
                        <li>–î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–≤–µ—Ä—è—Ç—å—Å—è —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π</li>
                    </ul>
                    <p style="margin: 8px 0; font-size: 13px; color: #856404;">
                        <strong>–ï—Å–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º</strong>, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –ø–æ—Ä—Ç–∞, –∑–∞—Ç–µ–º —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –≤ –∫–∞–Ω–∞–ª–µ –ø—Ä–æ–µ–∫—Ç–∞ 
                        <a href="https://t.me/WEGA_SERVER/20744" target="_blank" style="color: #0066cc;">https://t.me/WEGA_SERVER/20744</a>
                        –∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ:
                    </p>
                    <ul style="margin: 4px 0 8px 20px; font-size: 12px; color: #856404;">
                        <li>–§–∞–π–ª .hpg —Å –∫–æ—Ç–æ—Ä—ã–º –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞</li>
                        <li>–°–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ HPG</li>
                        <li>–°–∫—Ä–∏–Ω—à–æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç HTML5 –ø–æ—Ä—Ç</li>
                    </ul>
                </div>
                
                <h4 style="margin-top: 20px;">–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</h4>
                <ul style="margin-left: 20px;">
                    <li>–†–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–æ–Ω–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞</li>
                    <li>–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–∏—Ç–∞–Ω–∏—è —á–µ—Ä–µ–∑ NPKCaMgSCl</li>
                    <li>–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ EC</li>
                    <li>–ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤</li>
                    <li>–°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ–∫–æ–º–ø–ª–µ–∫—Å–∞</li>
                    <li>–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤ –Ω–∞ –ê –∏ –ë</li>
                    <li>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É–¥–æ–±—Ä–µ–Ω–∏–π</li>
                    <li>–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∞</li>
                    <li>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–º–µ–Ω –ø—Ä–æ—Ñ–∏–ª—è–º–∏</li>
                    <li>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</li>
                </ul>

                <h4 style="margin-top: 20px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã:</h4>
                <p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: <a href="https://github.com/WEGA-project/WEGA-HPG" target="_blank">WEGA-project/WEGA-HPG</a></p>
                <p>HTML5 –ø–æ—Ä—Ç: <a href="https://github.com/WEGA-project/wega-hpg" target="_blank">WEGA-project/wega-hpg</a></p>
                <p>Wiki: <a href="https://github.com/WEGA-project/WEGA-HPG/wiki" target="_blank">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></p>
            </div>
        </div>

        <!-- –°—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è - –æ–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ -->
        <div style="background: #d3d3d3; padding: 8px 12px;">
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" class="profile-string" id="profile-string" value="N=220 NO3=200 NH4=20 P=40 K=180 Ca=200 Mg=50 S=73 Cl=0 Fe=2 Mn=0.55 B=0.5 Zn=0.33 Cu=0.063 Mo=0.063 Co=0 Si=0" style="flex: 1;">
                <button id="parse-button" onclick="parseProfile()" style="background: #c0ffc0; border: 1px solid #999; padding: 5px 10px; cursor: pointer; font-weight: bold;">OK</button>
            </div>
        </div>

        <!-- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
        <div class="bottom-panel">
            <div class="bottom-left">
                <div class="bottom-row">
                    <label>–û–±—ä–µ–º –≤ –ª–∏—Ç—Ä–∞—Ö</label>
                    <input type="number" id="volume" value="10.0" step="0.1" oninput="onVolumeChange()">
                    <button onclick="saveFullState()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="loadCompositions()">–í–µ—Ä–Ω—É—Ç—å —Å–æ—Å—Ç–∞–≤—ã</button>
                </div>
                <div class="bottom-row">
                    <label>–°–æ–ª–µ–π –≤ –≥—Ä–∞–º–º–∞—Ö:</label>
                    <input type="number" id="total-salts" value="23.20" step="0.01" readonly>
                    <button onclick="recalculate()">–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                    <button onclick="loadProfileOnly()">–í–µ—Ä–Ω—É—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>
                <div class="cost-info">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="bottom_total_price">0.00</span> –∑–∞ 1 –ª–∏—Ç—Ä: <span id="bottom_price_per_liter">0.00</span></div>
            </div>
            <div class="bottom-right">
                <div class="version-text">Hydroponic Profile Generator <span id="desktop-version"></span></div>
            </div>
        </div>
    </div>

    <script>
        // –ú–æ–ª—è—Ä–Ω—ã–µ –º–∞—Å—Å—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const molN = 14.0067;
        const molP = 30.973762;
        const molK = 39.0983;
        const molCa = 40.078;
        const molMg = 24.305;
        const molS = 32.065;
        const molCl = 35.453;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
        let currentProfile = {
            N: 220, NO3: 200, NH4: 20, P: 40, K: 180, Ca: 200, Mg: 50, S: 73.049, Cl: 0, EC: 2.102,
            Fe: 2000, Mn: 550, B: 500, Zn: 330, Cu: 63, Mo: 63, Co: 0, Si: 0,
            volume: 10.0
        };

        // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π (–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤–∫–∏)
        let saltCompositions = {
            CaNO3: { Ca: 16.972, NO3: 11.863, NH4: 0.000 },
            KNO3: { K: 38.672, NO3: 13.854 },
            NH4NO3: { NH4: 17.499, NO3: 17.499 },
            MgSO4: { Mg: 9.861, S: 13.010 },
            KH2PO4: { K: 28.731, P: 22.761 },
            K2SO4: { K: 44.874, S: 18.401 },
            MgNO3: { Mg: 9.479, NO3: 10.925 },
            CaCl2: { Ca: 18.294, Cl: 32.366 }
        };

        // –§–ª–∞–≥–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–ª–µ–π
        let useK2SO4 = false;
        let useMgNO3 = false;

        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        let isUpdating = false;

        const roundTo = (value, decimals) => {
            if (!Number.isFinite(value)) return NaN;
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        };

        const setInputValue = (id, value, decimals, { force = false } = {}) => {
            const input = document.getElementById(id);
            if (!input || !Number.isFinite(value)) return;
            if (document.activeElement === input && !force) return;
            if (typeof decimals === 'number') {
                input.value = roundTo(value, decimals).toFixed(decimals);
            } else {
                input.value = value;
            }
        };


        const parseInput = (id, fallback = 0) => {
            const el = document.getElementById(id);
            if (!el) return fallback;
            const value = parseFloat(String(el.value).replace(',', '.'));
            return Number.isFinite(value) ? value : fallback;
        };

        const parseSaltValue = (id) => {
            const el = document.getElementById(id);
            if (!el) return 0;
            const value = parseFloat(String(el.value).replace(',', '.'));
            return Number.isFinite(value) ? value : 0;
        };

        const getSaltPercent = (salt, ion) => parseSaltValue(`salt_${salt}_${ion}`);

        const setSaltPercent = (salt, ion, value) => {
            setInputValue(`salt_${salt}_${ion}`, value, 3, { force: true });
        };

        const equalsRounded = (value, target, decimals = 1) => roundTo(value, decimals) === target;

        const nearZero = (value, epsilon = 1e-6) => Math.abs(value) < epsilon;

        const formatPercent = (value) => roundTo(value, 1).toFixed(1);

        const getSaltWeight = (salt) => parseSaltValue(`g_${salt}`);

        function getValues() {
            const data = {
                NO3: parseInput('NO3'),
                NH4: parseInput('NH4'),
                NH4_ratio: parseInput('NH4_ratio'),
                P: parseInput('P'),
                K: parseInput('K'),
                Ca: parseInput('Ca'),
                Mg: parseInput('Mg'),
                S: parseInput('S'),
                Cl: parseInput('Cl'),
                EC: parseInput('EC'),
                volume: parseInput('volume', 10),
                Fe: parseInput('Fe'),
                Mn: parseInput('Mn'),
                B: parseInput('B'),
                Zn: parseInput('Zn'),
                Cu: parseInput('Cu'),
                Mo: parseInput('Mo'),
                Co: parseInput('Co'),
                Si: parseInput('Si')
            };

            // N –≤—Å–µ–≥–¥–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ —Å—É–º–º–∞ NO3 + NH4 (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ getVar)
            data.N = data.NO3 + data.NH4;
            // –û–±–Ω–æ–≤–ª—è–µ–º N —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ –ò –Ω–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ onNChange
            const nInput = document.getElementById('N');
            if (!isUpdating && document.activeElement !== nInput) {
                setInputValue('N', data.N, 3);
            }

            currentProfile = { ...currentProfile, ...data };
            return data;
        }

        function calculateCa(values) {
            const data = values || getValues();
            const vNH4 = data.NH4;
            const vP = data.P;
            const vMg = data.Mg;
            const vK = data.K;
            const vNO3 = data.NO3;
            const vS = data.S;
            const vCl = data.Cl;


            const numerator = -molCa * (vNH4 * molP * molMg * molK * molS * molCl - 
                        vP * molN * molMg * molK * molS * molCl + 
                        2 * vMg * molN * molP * molK * molS * molCl + 
                        vK * molN * molP * molMg * molS * molCl - 
                        vNO3 * molP * molMg * molK * molS * molCl - 
                        2 * vS * molN * molP * molMg * molK * molCl - 
                        vCl * molN * molP * molMg * molK * molS);
            
            const denominator = 2 * molN * molP * molMg * molK * molS * molCl;
            
            const vCa = numerator / denominator;


            if (Number.isFinite(vCa)) {
                data.Ca = vCa;
                currentProfile.Ca = vCa;
                setInputValue('Ca', vCa, 3, { force: true });
            }

            return data;
        }

        function calcAll(values, options = {}) {
            const opts = { skipCalculateS: false, ...options };
            const data = values || getValues();

            if (!opts.skipCalculateS) {
                calculateS(data);
            }
            calcEC(data);
            calcWeight(data);
            calcRatios(data);
            genNH4NO3event(data);
            updateInfo(data);
            updateProfileString(data);
            
            // –†–∞—Å—á–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤
            calcConcentrates();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
            updatePriceResults();

            Object.assign(currentProfile, data);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            autoSaveState();
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–±–∏–ª—å–Ω—ã–º
            if (typeof updateMobileDisplay === 'function') updateMobileDisplay();

            return data;
        }

        // –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –≤–∫–ª—é—á–∞—è Ca (–¥–ª—è –∑–µ–ª–µ–Ω—ã—Ö –ø–æ–ª–µ–π P, Cl)
        function calcAllWithCa(values, options = {}) {
            const data = values || getValues();

            if (!options.skipCalculateS) {
                calculateS(data);
            }
            calculateCa(data);
            calcEC(data);
            calcWeight(data);
            calcRatios(data);
            genNH4NO3event(data);
            updateInfo(data);
            updateProfileString(data);
            
            // –†–∞—Å—á–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤
            calcConcentrates();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
            updatePriceResults();

            Object.assign(currentProfile, data);

            return data;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName, tabElement) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç —Ç–∞–±–∞ (–ø—Ä–∏ –∫–ª–∏–∫–µ), –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ
            // –ò–Ω–∞—á–µ (–ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏) –Ω–∞–π—Ç–∏ —Ç–∞–± –ø–æ —Ç–µ–∫—Å—Ç—É –≤–∫–ª–∞–¥–∫–∏
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                // –ù–∞–π—Ç–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∞–± –≤ –ø–∞–Ω–µ–ª–∏
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ localStorage
            localStorage.setItem('activeTab', tabName);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤–∫–ª–∞–¥–æ–∫ (–≤ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞—Ö)
        function switchInnerTab(tabName, tabElement) {
            document.querySelectorAll('.inner-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-inner').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                // –ù–∞–π—Ç–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç–∞–±
                document.querySelectorAll('.tab-inner').forEach(tab => {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–∏ "calc" –∏–ª–∏ "preparation"
            if (tabName === 'calc' || tabName === 'preparation') {
                calcConcentrates();
            }
            
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≤–∫–ª–∞–¥–∫—É –≤ localStorage
            localStorage.setItem('activeInnerTab', tabName);
        }

        // –†–∞—Å—á–µ—Ç EC
        function calcEC(values) {
            const data = values || getValues();
            const vNH4 = data.NH4;
            const vCa = data.Ca;
            const vMg = data.Mg;
            const vK = data.K;
            const vN = data.N;

            const vEC = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                        2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                        2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);

            data.EC = vEC;
            currentProfile.EC = vEC;
            setInputValue('EC', vEC, 3, { force: true });
            
            return data;
        }

        // –†–∞—Å—á–µ—Ç —Å–µ—Ä—ã 
        function calculateS(values) {
            const data = values || getValues();
            const vNH4 = data.NH4;
            const vCa = data.Ca;
            const vMg = data.Mg;
            const vK = data.K;
            const vNO3 = data.NO3;
            const vP = data.P;
            const vCl = data.Cl;

            const vS = (-molS * (-vNH4 * molCa * molMg * molK * molP * molCl - 
                       2 * vCa * molN * molMg * molK * molP * molCl - 
                       2 * vMg * molN * molCa * molK * molP * molCl - 
                       vK * molN * molCa * molMg * molP * molCl + 
                       vNO3 * molCa * molMg * molK * molP * molCl + 
                       vP * molN * molCa * molMg * molK * molCl + 
                       vCl * molN * molCa * molMg * molK * molP)) / 
                       (2 * (molN * molCa * molMg * molK * molP * molCl));

            if (Number.isFinite(vS)) {
                data.S = vS;
                currentProfile.S = vS;
                setInputValue('S', vS, 3, { force: true });
            }

            return data;
        }

        // –†–∞—Å—á–µ—Ç –Ω–∞–≤–µ—Å–æ–∫ —Å–æ–ª–µ–π
        function calcWeight(values) {
            const data = values || getValues();

            const V = data.volume;
            const vP = data.P;
            const vK = data.K;
            const vCa = data.Ca;
            const vMg = data.Mg;
            const vS = data.S;
            const vNH4 = data.NH4;
            const vCl = data.Cl;

            const vKH2PO4_P = saltCompositions.KH2PO4.P;
            const vKH2PO4_K = saltCompositions.KH2PO4.K;
            const vCaNO3_Ca = saltCompositions.CaNO3.Ca;
            const vCaNO3_NH4 = saltCompositions.CaNO3.NH4;
            const vCaCl2_Ca = saltCompositions.CaCl2.Ca;
            const vCaCl2_Cl = saltCompositions.CaCl2.Cl;
            const vNH4NO3_NH4 = saltCompositions.NH4NO3.NH4;
            const vMgSO4_Mg = saltCompositions.MgSO4.Mg;
            const vMgSO4_S = saltCompositions.MgSO4.S;
            const vKNO3_K = saltCompositions.KNO3.K;
            const vK2SO4_K = saltCompositions.K2SO4.K;
            const vK2SO4_S = saltCompositions.K2SO4.S;
            const vMgNO3_Mg = saltCompositions.MgNO3.Mg;

            let sKH2PO4 = 0, sKNO3 = 0, sCaNO3 = 0, sMgNO3 = 0, sMgSO4 = 0, sK2SO4 = 0, sNH4NO3 = 0, sCaCl2 = 0;

            const safe = (value) => Number.isFinite(value) ? value : 0;

            if (useK2SO4 && !useMgNO3) {
                sKH2PO4 = safe(vP / vKH2PO4_P);
                sKNO3 = safe(-(-vK * vKH2PO4_P * vK2SO4_S * vMgSO4_Mg + 
                          vP * vKH2PO4_K * vK2SO4_S * vMgSO4_Mg + 
                          vK2SO4_K * vKH2PO4_P * vS * vMgSO4_Mg - 
                          vK2SO4_K * vKH2PO4_P * vMg * vMgSO4_S) / 
                          (vKNO3_K * vKH2PO4_P * vK2SO4_S * vMgSO4_Mg));
                sCaNO3 = safe((vCa * vCaCl2_Cl - vCl * vCaCl2_Ca) / (vCaNO3_Ca * vCaCl2_Cl));
                sMgNO3 = 0;
                sMgSO4 = safe(vMg / vMgSO4_Mg);
                sK2SO4 = safe((vS * vMgSO4_Mg - vMg * vMgSO4_S) / (vK2SO4_S * vMgSO4_Mg));
                sNH4NO3 = safe(-(-vNH4 * vCaNO3_Ca * vCaCl2_Cl + 
                            vCaNO3_NH4 * vCa * vCaCl2_Cl - 
                            vCaNO3_NH4 * vCl * vCaCl2_Ca) / 
                            (vNH4NO3_NH4 * vCaNO3_Ca * vCaCl2_Cl));
                sCaCl2 = safe(vCl / vCaCl2_Cl);
            } else if (!useK2SO4 && useMgNO3) {
                sKH2PO4 = safe(vP / vKH2PO4_P);
                sKNO3 = safe((vK * vKH2PO4_P - vP * vKH2PO4_K) / (vKNO3_K * vKH2PO4_P));
                sCaNO3 = safe((vCa * vCaCl2_Cl - vCl * vCaCl2_Ca) / (vCaNO3_Ca * vCaCl2_Cl));
                sMgNO3 = safe((vMg * vMgSO4_S - vMgSO4_Mg * vS) / (vMgNO3_Mg * vMgSO4_S));
                sMgSO4 = safe(vS / vMgSO4_S);
                sK2SO4 = 0;
                sNH4NO3 = safe((vNH4 * vCaNO3_Ca * vCaCl2_Cl - 
                           vCaNO3_NH4 * vCa * vCaCl2_Cl + 
                           vCaNO3_NH4 * vCl * vCaCl2_Ca) / 
                           (vNH4NO3_NH4 * vCaNO3_Ca * vCaCl2_Cl));
                sCaCl2 = safe(vCl / vCaCl2_Cl);
            } else {
                sKH2PO4 = safe(vP / vKH2PO4_P);
                sKNO3 = safe((vK * vKH2PO4_P - vP * vKH2PO4_K) / (vKNO3_K * vKH2PO4_P));
                sCaNO3 = safe((vCa * vCaCl2_Cl - vCl * vCaCl2_Ca) / (vCaNO3_Ca * vCaCl2_Cl));
                sMgNO3 = 0;
                sMgSO4 = safe(vMg / vMgSO4_Mg);
                sK2SO4 = 0;
                sNH4NO3 = safe(-(-vNH4 * vCaNO3_Ca * vCaCl2_Cl + 
                            vCaNO3_NH4 * vCa * vCaCl2_Cl - 
                            vCaNO3_NH4 * vCl * vCaCl2_Ca) / 
                            (vNH4NO3_NH4 * vCaNO3_Ca * vCaCl2_Cl));
                sCaCl2 = safe(vCl / vCaCl2_Cl);
            }

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏)
            let vDecimalPlaces = 3;
            let vStep = 0.001;
            if (V >= 1) { vDecimalPlaces = 3; vStep = 0.001; }
            if (V >= 10) { vDecimalPlaces = 2; vStep = 0.01; }
            if (V >= 100) { vDecimalPlaces = 1; vStep = 0.1; }
            if (V >= 1000) { vDecimalPlaces = 0; vStep = 1; }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º step –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å –≤–µ—Å–∞–º–∏
            ['g_CaNO3', 'g_KNO3', 'g_NH4NO3', 'g_MgSO4', 'g_KH2PO4', 'g_K2SO4', 'g_MgNO3', 'g_CaCl2'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.step = vStep;
            });

            const grams = (value) => roundTo(value * V / 10, vDecimalPlaces);

            setInputValue('g_CaNO3', grams(sCaNO3), vDecimalPlaces, { force: true });
            setInputValue('g_KNO3', grams(sKNO3), vDecimalPlaces, { force: true });
            setInputValue('g_NH4NO3', grams(sNH4NO3), vDecimalPlaces, { force: true });
            setInputValue('g_MgSO4', grams(sMgSO4), vDecimalPlaces, { force: true });
            setInputValue('g_KH2PO4', grams(sKH2PO4), vDecimalPlaces, { force: true });
            setInputValue('g_K2SO4', grams(sK2SO4), vDecimalPlaces, { force: true });
            setInputValue('g_MgNO3', grams(sMgNO3), vDecimalPlaces, { force: true });
            setInputValue('g_CaCl2', grams(sCaCl2), vDecimalPlaces, { force: true });

            const totalSalts = grams(sCaNO3 + sKNO3 + sNH4NO3 + sMgSO4 + sKH2PO4 + sK2SO4 + sMgNO3 + sCaCl2);
            setInputValue('total-salts', totalSalts, vDecimalPlaces, { force: true });

            return data;
        }

        function calcRatios(values) {
            const data = values || getValues();
            const { N, P, K, Ca, Mg, S, Cl, NH4, NO3 } = data;

            if (N <= 0 || P <= 0 || K <= 0 || Ca <= 0 || Mg <= 0 || S <= 0 || NH4 <= 0 || NO3 <= 0) {
                return data;
            }

            const ratio = (a, b) => (b !== 0 ? a / b : NaN);
            const setRatio = (id, value, decimals = 3) => {
                if (Number.isFinite(value)) setInputValue(id, value, decimals);
            };

            setRatio('m_N_P', ratio(N, P));
            setRatio('m_N_K', ratio(N, K));
            setRatio('m_N_Ca', ratio(N, Ca));
            setRatio('m_N_Mg', ratio(N, Mg));
            setRatio('m_N_S', ratio(N, S));

            setRatio('m_P_N', ratio(P, N));
            setRatio('m_P_K', ratio(P, K));
            setRatio('m_P_Ca', ratio(P, Ca));
            setRatio('m_P_Mg', ratio(P, Mg));
            setRatio('m_P_S', ratio(P, S));

            setRatio('m_K_N', ratio(K, N));
            setRatio('m_K_P', ratio(K, P));
            setRatio('m_K_Ca', ratio(K, Ca));
            setRatio('m_K_Mg', ratio(K, Mg));
            setRatio('m_K_S', ratio(K, S));

            setRatio('m_Ca_N', ratio(Ca, N));
            setRatio('m_Ca_P', ratio(Ca, P));
            setRatio('m_Ca_K', ratio(Ca, K));
            setRatio('m_Ca_Mg', ratio(Ca, Mg));
            setRatio('m_Ca_S', ratio(Ca, S));

            setRatio('m_Mg_N', ratio(Mg, N));
            setRatio('m_Mg_P', ratio(Mg, P));
            setRatio('m_Mg_K', ratio(Mg, K));
            setRatio('m_Mg_Ca', ratio(Mg, Ca));
            setRatio('m_Mg_S', ratio(Mg, S));

            setRatio('m_S_N', ratio(S, N));
            setRatio('m_S_P', ratio(S, P));
            setRatio('m_S_K', ratio(S, K));
            setRatio('m_S_Ca', ratio(S, Ca));
            setRatio('m_S_Mg', ratio(S, Mg));

            const nh4ratio = ratio(NH4, NO3);
            if (Number.isFinite(nh4ratio)) setInputValue('NH4_ratio', nh4ratio, 3);

            return data;
        }

        function genNH4NO3event(values) {
            const data = values || getValues();
            const ratioLabel = document.getElementById('nh4no3-info');
            if (!ratioLabel) return;

            if (data.NH4 > 0) {
                ratioLabel.textContent = `NH4:NO3 1:${roundTo(data.NO3 / data.NH4, 0)}`;
            } else {
                ratioLabel.textContent = 'NO3=100%';
            }

            return data;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π
        function updateInfo(values) {
            const data = values || getValues();

            const vN = data.N;
            const vP = data.P;
            const vK = data.K;
            const vCa = data.Ca;
            const vMg = data.Mg;
            const vS = data.S;
            const vCl = data.Cl;
            const vSUM = vN + vP + vK + vCa + vMg + vS + vCl;

            const ratioLine = vN > 0
                ? `N:1 : ${roundTo(vP / vN, 2)} : ${roundTo(vK / vN, 2)} : ${roundTo(vCa / vN, 2)} : ${roundTo(vMg / vN, 2)} : ${roundTo(vS / vN, 2)} : ${roundTo(vCl / vN, 0)} sPPM=${roundTo(vSUM, 2)}`
                : 'N: --';
            document.getElementById('ratio-info').textContent = ratioLine;

            const npkN = Math.round(vN / 10);
            const npkP = Math.round(vP / 0.436421 / 10);
            const npkK = Math.round(vK / 0.830148 / 10);
            const CaO = roundTo(vCa / 0.714691 / 10 * 10, 1) / 10;
            const MgO = roundTo(vMg / 0.603036 / 10 * 10, 1) / 10;
            const SO3 = roundTo(vS / 0.400496 / 10 * 10, 1) / 10;

            const npkInfo = `NPK: ${npkN}-${npkP}-${npkK} CaO=${CaO.toFixed(1)}% MgO=${MgO.toFixed(1)}% SO3=${SO3.toFixed(1)}%`;
            document.getElementById('npk-info').textContent = npkInfo;

            return data;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function updateProfileString(values) {
            const data = values || currentProfile;
            const Fe = parseFloat(document.getElementById('Fe').value) || 0;
            const Mn = parseFloat(document.getElementById('Mn').value) || 0;
            const B = parseFloat(document.getElementById('B').value) || 0;
            const Zn = parseFloat(document.getElementById('Zn').value) || 0;
            const Cu = parseFloat(document.getElementById('Cu').value) || 0;
            const Mo = parseFloat(document.getElementById('Mo').value) || 0;
            const Co = parseFloat(document.getElementById('Co').value) || 0;
            const Si = parseFloat(document.getElementById('Si').value) || 0;

            const profileStr = `N=${Math.round(data.N)} NO3=${roundTo(data.NO3, 2)} NH4=${roundTo(data.NH4, 2)} P=${roundTo(data.P, 2)} K=${roundTo(data.K, 2)} Ca=${roundTo(data.Ca, 2)} Mg=${roundTo(data.Mg, 2)} S=${roundTo(data.S, 1)} Cl=${roundTo(data.Cl, 1)} Fe=${roundTo(Fe / 1000, 3)} Mn=${roundTo(Mn / 1000, 3)} B=${roundTo(B / 1000, 3)} Zn=${roundTo(Zn / 1000, 3)} Cu=${roundTo(Cu / 1000, 3)} Mo=${roundTo(Mo / 1000, 3)} Co=${roundTo(Co / 1000, 3)} Si=${roundTo(Si / 1000, 3)}`;

            document.getElementById('profile-string').value = profileStr;
            return data;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function onMacroChange() {
            calcAll();
        }

        function onNChange() {
            if (isUpdating) return;
            
            isUpdating = true;
            
            const N = parseInput('N');
            const ratio = parseInput('NH4_ratio');
            
            if (N !== 0) {
                const NO3 = N / (ratio + 1);
                const NH4 = ratio * N / (ratio + 1);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π
                const no3Input = document.getElementById('NO3');
                const nh4Input = document.getElementById('NH4');
                if (no3Input) no3Input.value = NO3.toFixed(2);
                if (nh4Input) nh4Input.value = NH4.toFixed(2);
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout —á—Ç–æ–±—ã –¥–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            setTimeout(() => {
                calcAll();
                isUpdating = false;
            }, 0);
        }

        function onNO3Change() {
            if (isUpdating) return;
            calcAll();
        }

        function onNH4Change() {
            if (isUpdating) return;
            calcAll();
        }

        function onNH4RatioChange() {
            const ratio = parseInput('NH4_ratio');
            const N = parseInput('N');
            const NO3 = N / (ratio + 1);
            const NH4 = ratio * N / (ratio + 1);

            setInputValue('NO3', NO3, 2, { force: true });
            setInputValue('NH4', NH4, 2, { force: true });

            calcECtoVal();
            calcAll();
        }

        function onPChange() {
            calcAllWithCa();
        }

        function onClChange() {
            calcAllWithCa();
        }

        function onSChange() {
            const values = getValues();
            calculateCa(values);
            calcEC(values);
            calcWeight(values);
            calcRatios(values);
            genNH4NO3event(values);
            updateInfo(values);
            updateProfileString(values);
            Object.assign(currentProfile, values);
        }

        function calcECtoVal() {
            const vEC = parseInput('EC');
            const vKN = parseInput('m_K_N');
            const vKCa = parseInput('m_K_Ca');
            const vKMg = parseInput('m_K_Mg');
            const vNH4NO3 = parseInput('NH4_ratio');
            const vP = parseInput('P');
            const vCl = parseInput('Cl');

            // –†–∞—Å—á–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const rN = (vKMg * vKCa) / (vKCa * vKN + vKMg * vKN + vKMg * vKCa + vKMg * vKCa * vKN);
            const rK = (vKN * vKMg * vKCa) / (vKCa * vKN + vKMg * vKN + vKMg * vKCa + vKMg * vKCa * vKN);
            const rCa = (vKMg * vKN) / (vKCa * vKN + vKMg * vKN + vKMg * vKCa + vKMg * vKCa * vKN);
            const rMg = (vKCa * vKN) / (vKCa * vKN + vKMg * vKN + vKMg * vKCa + vKMg * vKCa * vKN);
            const rNH4 = (rN * vNH4NO3) / (1 + vNH4NO3);

            // –†–∞—Å—á–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—â–µ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
            const r = (0.10526315789473684211 * molN * molCa * molMg * molK * (100 * vEC - 19)) / 
                     (rNH4 * molCa * molMg * molK + 2 * rCa * molN * molMg * molK + 
                      2 * rMg * molN * molCa * molK + rK * molN * molCa * molMg);

            // –ü–µ—Ä–µ—Å—á–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const vN = rN * r;
            const vK = rK * r;
            const vCa = rCa * r;
            const vMg = rMg * r;
            const vNH4 = rNH4 * r;
            const vNO3 = vN - vNH4;

            // –†–∞—Å—á–µ—Ç —Å–µ—Ä—ã —á–µ—Ä–µ–∑ –∏–æ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
            const vS = (molS * (vNH4 * molCa * molMg * molK * molP + 2 * vCa * molN * molMg * molK * molP + 
                       2 * vMg * molN * molCa * molK * molP + vK * molN * molCa * molMg * molP - 
                       vNO3 * molCa * molMg * molK * molP - vP * molN * molCa * molMg * molK)) / 
                       (2 * (molN * molCa * molMg * molK * molP));

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π
            setInputValue('NO3', vNO3, 2, { force: true });
            setInputValue('NH4', vNH4, 2, { force: true });
            setInputValue('K', vK, 3, { force: true });
            setInputValue('Ca', vCa, 3, { force: true });
            setInputValue('Mg', vMg, 3, { force: true });
            setInputValue('S', vS, 3, { force: true });
            setInputValue('N', vN, 3, { force: true });

            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            calcAll();
        }

        function onECChange() {
            calcECtoVal();
        }

        function onVolumeChange() {
            calcAll();
            microToWeght();
            calcConcentrates(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã –∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
            if (typeof updateMobileDisplay === 'function') updateMobileDisplay(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–±–∏–ª—å–Ω—ã–º
        }

        function parseProfile() {
            const profileStr = document.getElementById('profile-string').value.trim();
            const parts = profileStr.split(/\s+/);
            const parseButton = document.getElementById('parse-button');

            if (parts.length !== 17) {
                parseButton.style.background = '#ff8080';
                parseButton.textContent = 'NO';
                return;
            }

            try {
                const values = {};
                parts.forEach(part => {
                    const [key, val] = part.split('=');
                    if (key && val !== undefined) {
                        values[key] = parseFloat(val.replace(',', '.'));
                    }
                });

                if (values.N !== undefined) setInputValue('N', values.N, 3, { force: true });
                if (values.NO3 !== undefined) setInputValue('NO3', values.NO3, 2, { force: true });
                if (values.NH4 !== undefined) setInputValue('NH4', values.NH4, 2, { force: true });
                if (values.P !== undefined) setInputValue('P', values.P, 3, { force: true });
                if (values.K !== undefined) setInputValue('K', values.K, 3, { force: true });
                if (values.Ca !== undefined) setInputValue('Ca', values.Ca, 3, { force: true });
                if (values.Mg !== undefined) setInputValue('Mg', values.Mg, 3, { force: true });
                if (values.S !== undefined) setInputValue('S', values.S, 3, { force: true });
                if (values.Cl !== undefined) setInputValue('Cl', values.Cl, 3, { force: true });

                if (values.Fe !== undefined) setInputValue('Fe', values.Fe * 1000, 0, { force: true });
                if (values.Mn !== undefined) setInputValue('Mn', values.Mn * 1000, 0, { force: true });
                if (values.B !== undefined) setInputValue('B', values.B * 1000, 0, { force: true });
                if (values.Zn !== undefined) setInputValue('Zn', values.Zn * 1000, 0, { force: true });
                if (values.Cu !== undefined) setInputValue('Cu', values.Cu * 1000, 0, { force: true });
                if (values.Mo !== undefined) setInputValue('Mo', values.Mo * 1000, 0, { force: true });
                if (values.Co !== undefined) setInputValue('Co', values.Co * 1000, 0, { force: true });
                if (values.Si !== undefined) setInputValue('Si', values.Si * 1000, 0, { force: true });

                calculateS();
                calcEC();
                calcAll();

                parseButton.style.background = '#c0ffc0';
                parseButton.textContent = 'OK';
            } catch (e) {
                parseButton.style.background = '#ff8080';
                parseButton.textContent = 'NO';
            }
        }

        function onMatrixChange(row, col) {
            const fieldId = `m_${row}_${col}`;
            const inverseId = `m_${col}_${row}`;
            const value = parseFloat(document.getElementById(fieldId).value.replace(',', '.'));
            if (!Number.isFinite(value) || value === 0) return;

            const updateInverse = () => {
                const inverseField = document.getElementById(inverseId);
                if (inverseField && document.activeElement !== inverseField) {
                    inverseField.value = (1 / value).toFixed(3);
                }
            };

            if (fieldId === 'm_K_N' || fieldId === 'm_K_Ca' || fieldId === 'm_K_Mg') {
                const values = getValues();
                if (fieldId === 'm_K_N') {
                    values.K = values.N * value;
                } else if (fieldId === 'm_K_Ca') {
                    values.K = values.Ca * value;
                } else if (fieldId === 'm_K_Mg') {
                    values.K = values.Mg * value;
                }
                setInputValue('K', values.K, 3, { force: true });
                updateInverse();
                calcECtoVal();
                calcAll();
                return;
            }

            const values = getValues();
            let needsCaRecalc = false;

            const applyRatio = (target, source, ratio) => {
                const newValue = source * ratio;
                if (Number.isFinite(newValue)) {
                    values[target] = newValue;
                    setInputValue(target, newValue, 3, { force: true });
                    if (target === 'S') needsCaRecalc = true;
                }
            };

            if (row === 'N') {
                if (col === 'P') applyRatio('N', values.P, value);
                if (col === 'K') applyRatio('N', values.K, value);
                if (col === 'Ca') applyRatio('N', values.Ca, value);
                if (col === 'Mg') applyRatio('N', values.Mg, value);
                if (col === 'S') applyRatio('N', values.S, value);
                values.NO3 = values.N / (values.NH4_ratio + 1);
                values.NH4 = values.NH4_ratio * values.N / (values.NH4_ratio + 1);
            } else if (row === 'P') {
                if (col === 'N') applyRatio('P', values.N, value);
                if (col === 'K') applyRatio('P', values.K, value);
                if (col === 'Ca') applyRatio('P', values.Ca, value);
                if (col === 'Mg') applyRatio('P', values.Mg, value);
                if (col === 'S') applyRatio('P', values.S, value);
            } else if (row === 'K') {
                if (col === 'N') applyRatio('K', values.N, value);
                if (col === 'P') applyRatio('K', values.P, value);
                if (col === 'Ca') applyRatio('K', values.Ca, value);
                if (col === 'Mg') applyRatio('K', values.Mg, value);
                if (col === 'S') applyRatio('K', values.S, value);
            } else if (row === 'Ca') {
                if (col === 'N') applyRatio('Ca', values.N, value);
                if (col === 'P') applyRatio('Ca', values.P, value);
                if (col === 'K') applyRatio('Ca', values.K, value);
                if (col === 'Mg') applyRatio('Ca', values.Mg, value);
                if (col === 'S') applyRatio('Ca', values.S, value);
            } else if (row === 'Mg') {
                if (col === 'N') applyRatio('Mg', values.N, value);
                if (col === 'P') applyRatio('Mg', values.P, value);
                if (col === 'K') applyRatio('Mg', values.K, value);
                if (col === 'Ca') applyRatio('Mg', values.Ca, value);
                if (col === 'S') applyRatio('Mg', values.S, value);
            } else if (row === 'S') {
                if (col === 'N') applyRatio('S', values.N, value);
                if (col === 'P') applyRatio('S', values.P, value);
                if (col === 'K') applyRatio('S', values.K, value);
                if (col === 'Ca') applyRatio('S', values.Ca, value);
                if (col === 'Mg') applyRatio('S', values.Mg, value);
            }

            updateInverse();

            setInputValue('N', values.N, 3, { force: true });
            setInputValue('P', values.P, 3, { force: true });
            setInputValue('K', values.K, 3, { force: true });
            setInputValue('Ca', values.Ca, 3, { force: true });
            setInputValue('Mg', values.Mg, 3, { force: true });
            setInputValue('S', values.S, 3, { force: true });
            setInputValue('NO3', values.NO3, 3, { force: true });
            setInputValue('NH4', values.NH4, 3, { force: true });

            if (needsCaRecalc) {
                calculateCa(values);
            }

            calcAll();
        }

        function syncSaltCompositions() {
            saltCompositions.CaNO3.Ca = getSaltPercent('CaNO3', 'Ca');
            saltCompositions.CaNO3.NO3 = getSaltPercent('CaNO3', 'NO3');
            saltCompositions.CaNO3.NH4 = getSaltPercent('CaNO3', 'NH4');

            saltCompositions.KNO3.K = getSaltPercent('KNO3', 'K');
            saltCompositions.KNO3.NO3 = getSaltPercent('KNO3', 'NO3');

            saltCompositions.NH4NO3.NH4 = getSaltPercent('NH4NO3', 'NH4');
            saltCompositions.NH4NO3.NO3 = getSaltPercent('NH4NO3', 'NO3');

            saltCompositions.MgSO4.Mg = getSaltPercent('MgSO4', 'Mg');
            saltCompositions.MgSO4.S = getSaltPercent('MgSO4', 'S');

            saltCompositions.KH2PO4.K = getSaltPercent('KH2PO4', 'K');
            saltCompositions.KH2PO4.P = getSaltPercent('KH2PO4', 'P');

            saltCompositions.K2SO4.K = getSaltPercent('K2SO4', 'K');
            saltCompositions.K2SO4.S = getSaltPercent('K2SO4', 'S');

            saltCompositions.MgNO3.Mg = getSaltPercent('MgNO3', 'Mg');
            saltCompositions.MgNO3.NO3 = getSaltPercent('MgNO3', 'NO3');

            saltCompositions.CaCl2.Ca = getSaltPercent('CaCl2', 'Ca');
            saltCompositions.CaCl2.Cl = getSaltPercent('CaCl2', 'Cl');
        }

        function updateSaltLabels() {
            const labelCaNO3 = document.getElementById('label_CaNO3');
            if (labelCaNO3) {
                const ca = getSaltPercent('CaNO3', 'Ca');
                const no3 = getSaltPercent('CaNO3', 'NO3');
                const nh4 = getSaltPercent('CaNO3', 'NH4');
                let text;
                if (nearZero(nh4) && equalsRounded(ca, 17, 0)) {
                    text = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*4H2O';
                } else if (nearZero(nh4) && equalsRounded(ca, 20, 0)) {
                    text = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*2H2O';
                } else if (nearZero(nh4) && equalsRounded(ca, 24.4, 1)) {
                    text = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2';
                } else {
                    text = `–°–µ–ª–∏—Ç—Ä–∞ –∫–∞–ª—å—Ü–∏–µ–≤–∞—è CaO-${formatPercent(ca / 0.714691)}% N-${formatPercent(nh4 + no3)}%`;
                }
                labelCaNO3.textContent = text;
            }

            const labelKNO3 = document.getElementById('label_KNO3');
            if (labelKNO3) {
                const k = getSaltPercent('KNO3', 'K');
                const no3 = getSaltPercent('KNO3', 'NO3');
                const text = equalsRounded(k, 38.7, 1)
                    ? '–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π KNO3'
                    : `–°–µ–ª–∏—Ç—Ä–∞ –∫–∞–ª–∏–µ–≤–∞—è K2O-${formatPercent(k / 0.830148)}% N-${formatPercent(no3)}%`;
                labelKNO3.textContent = text;
            }

            const labelNH4NO3 = document.getElementById('label_NH4NO3');
            if (labelNH4NO3) {
                const nh4 = getSaltPercent('NH4NO3', 'NH4');
                const no3 = getSaltPercent('NH4NO3', 'NO3');
                const text = equalsRounded(no3, 17.5, 1)
                    ? '–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π NH4NO3'
                    : `–°–µ–ª–∏—Ç—Ä–∞ –∞–º–º–∏–∞—á–Ω–∞—è N-${formatPercent(nh4 + no3)}%`;
                labelNH4NO3.textContent = text;
            }

            const labelMgSO4 = document.getElementById('label_MgSO4');
            if (labelMgSO4) {
                const mg = getSaltPercent('MgSO4', 'Mg');
                const s = getSaltPercent('MgSO4', 'S');
                let text;
                if (equalsRounded(mg, 9.9, 1)) {
                    text = '–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4*7H2O';
                } else if (equalsRounded(mg, 20.2, 1)) {
                    text = '–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4';
                } else {
                    text = `–°—É–ª—å—Ñ–∞—Ç –º–∞–≥–Ω–∏—è MgO-${formatPercent(mg / 0.603036)}% SO3-${formatPercent(s / 0.400496)}%`;
                }
                labelMgSO4.textContent = text;
            }

            const labelKH2PO4 = document.getElementById('label_KH2PO4');
            if (labelKH2PO4) {
                const k = getSaltPercent('KH2PO4', 'K');
                const p = getSaltPercent('KH2PO4', 'P');
                const text = equalsRounded(k, 28.7, 1)
                    ? '–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π KH2PO4'
                    : `–ú–æ–Ω–æ—Ñ–æ—Å—Ñ–∞—Ç –∫–∞–ª–∏—è K2O-${formatPercent(k / 0.830148)}% P2O5-${formatPercent(p / 0.436421)}%`;
                labelKH2PO4.textContent = text;
            }

            const labelK2SO4 = document.getElementById('label_K2SO4');
            if (labelK2SO4) {
                const k = getSaltPercent('K2SO4', 'K');
                const s = getSaltPercent('K2SO4', 'S');
                const text = equalsRounded(k, 44.9, 1)
                    ? '–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π K2SO4'
                    : `–°—É–ª—å—Ñ–∞—Ç –∫–∞–ª–∏—è K2O-${formatPercent(k / 0.830148)}% SO3-${formatPercent(s / 0.400496)}%`;
                labelK2SO4.textContent = text;
            }

            const labelMgNO3 = document.getElementById('label_MgNO3');
            if (labelMgNO3) {
                const mg = getSaltPercent('MgNO3', 'Mg');
                const no3 = getSaltPercent('MgNO3', 'NO3');
                let text;
                if (equalsRounded(mg, 9.5, 1)) {
                    text = '–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2*6H2O';
                } else if (equalsRounded(mg, 16.4, 1)) {
                    text = '–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2';
                } else {
                    text = `–°–µ–ª–∏—Ç—Ä–∞ –º–∞–≥–Ω–∏–µ–≤–∞—è MgO-${formatPercent(mg / 0.603036)}% N-${formatPercent(no3)}%`;
                }
                labelMgNO3.textContent = text;
            }

            const labelCaCl2 = document.getElementById('label_CaCl2');
            if (labelCaCl2) {
                const ca = getSaltPercent('CaCl2', 'Ca');
                const cl = getSaltPercent('CaCl2', 'Cl');
                let text;
                if (equalsRounded(ca, 18.3, 1)) {
                    text = '–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π CaCl2*6H2O';
                } else if (equalsRounded(ca, 36.1, 1)) {
                    text = '–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è –±–µ–∑–≤–æ–¥–Ω—ã–π CaCl2';
                } else {
                    text = `–ö–∞–ª—å—Ü–∏–π —Ö–ª–æ—Ä–∏—Å—Ç—ã–π CaO-${formatPercent(ca / 0.714691)}% Cl-${formatPercent(cl)}%`;
                }
                labelCaCl2.textContent = text;
            }
        }

        function onSaltCompositionChange(salt, changedIon) {
            if (isUpdating) return;
            isUpdating = true;
            try {
                if (salt) {
                    switch (salt) {
                        case 'CaNO3': {
                            let ca = getSaltPercent('CaNO3', 'Ca');
                            let no3 = getSaltPercent('CaNO3', 'NO3');
                            let nh4 = getSaltPercent('CaNO3', 'NH4');
                            if (changedIon === 'Ca') {
                                no3 = (2 * ca * molN + nh4 * molCa) / molCa;
                                setSaltPercent('CaNO3', 'NO3', no3);
                            } else if (changedIon === 'NH4') {
                                no3 = (2 * ca * molN + nh4 * molCa) / molCa;
                                setSaltPercent('CaNO3', 'NO3', no3);
                                ca = -molCa * (nh4 - no3) / (2 * molN);
                                setSaltPercent('CaNO3', 'Ca', ca);
                            } else if (changedIon === 'NO3') {
                                ca = -molCa * (nh4 - no3) / (2 * molN);
                                setSaltPercent('CaNO3', 'Ca', ca);
                            }
                            break;
                        }
                        case 'KNO3': {
                            let k = getSaltPercent('KNO3', 'K');
                            let no3 = getSaltPercent('KNO3', 'NO3');
                            if (changedIon === 'K') {
                                no3 = (k * molN) / molK;
                                setSaltPercent('KNO3', 'NO3', no3);
                            } else if (changedIon === 'NO3') {
                                k = (no3 * molK) / molN;
                                setSaltPercent('KNO3', 'K', k);
                            }
                            break;
                        }
                        case 'NH4NO3': {
                            const value = getSaltPercent('NH4NO3', changedIon);
                            setSaltPercent('NH4NO3', changedIon === 'NH4' ? 'NO3' : 'NH4', value);
                            break;
                        }
                        case 'MgSO4': {
                            let mg = getSaltPercent('MgSO4', 'Mg');
                            let s = getSaltPercent('MgSO4', 'S');
                            if (changedIon === 'Mg') {
                                s = (mg * molS) / molMg;
                                setSaltPercent('MgSO4', 'S', s);
                            } else if (changedIon === 'S') {
                                mg = (s * molMg) / molS;
                                setSaltPercent('MgSO4', 'Mg', mg);
                            }
                            break;
                        }
                        case 'KH2PO4': {
                            let k = getSaltPercent('KH2PO4', 'K');
                            let p = getSaltPercent('KH2PO4', 'P');
                            if (changedIon === 'K') {
                                p = (k * molP) / molK;
                                setSaltPercent('KH2PO4', 'P', p);
                            } else if (changedIon === 'P') {
                                k = (p * molK) / molP;
                                setSaltPercent('KH2PO4', 'K', k);
                            }
                            break;
                        }
                        case 'K2SO4': {
                            let k = getSaltPercent('K2SO4', 'K');
                            let s = getSaltPercent('K2SO4', 'S');
                            if (changedIon === 'K') {
                                s = (k * molS) / (2 * molK);
                                setSaltPercent('K2SO4', 'S', s);
                            } else if (changedIon === 'S') {
                                k = (s * 2 * molK) / molS;
                                setSaltPercent('K2SO4', 'K', k);
                            }
                            break;
                        }
                        case 'MgNO3': {
                            let mg = getSaltPercent('MgNO3', 'Mg');
                            let no3 = getSaltPercent('MgNO3', 'NO3');
                            if (changedIon === 'Mg') {
                                no3 = (2 * mg * molN) / molMg;
                                setSaltPercent('MgNO3', 'NO3', no3);
                            } else if (changedIon === 'NO3') {
                                mg = 0.5 * (no3 / molN) * molMg;
                                setSaltPercent('MgNO3', 'Mg', mg);
                            }
                            break;
                        }
                        case 'CaCl2': {
                            let ca = getSaltPercent('CaCl2', 'Ca');
                            let cl = getSaltPercent('CaCl2', 'Cl');
                            if (changedIon === 'Ca') {
                                cl = (2 * ca / molCa) * molCl;
                                setSaltPercent('CaCl2', 'Cl', cl);
                            } else if (changedIon === 'Cl') {
                                ca = 0.5 * (cl / molCl) * molCa;
                                setSaltPercent('CaCl2', 'Ca', ca);
                            }
                            break;
                        }
                    }
                }

                syncSaltCompositions();
                updateSaltLabels();
                updateSaltNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π (–∫–∞–∫ SoilName –≤ –ª–µ–≥–∞—Å–∏)
                calcWeight(getValues());
                applyWeightsToProfile({ sync: false });
                calcConcentrates(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã –∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∫ CalcConc –≤ –ª–µ–≥–∞—Å–∏)
                autoSaveState();
            } finally {
                isUpdating = false;
            }
        }

        function applyWeightsToProfile({ sync = true } = {}) {
            const V = parseInput('volume', 10);
            if (!Number.isFinite(V) || V <= 0) return;

            if (sync) syncSaltCompositions();

            const factor = 0.1 * V;
            if (factor === 0) return;

            const sCaNO3 = getSaltWeight('CaNO3');
            const sKNO3 = getSaltWeight('KNO3');
            const sNH4NO3 = getSaltWeight('NH4NO3');
            const sMgSO4 = getSaltWeight('MgSO4');
            const sKH2PO4 = getSaltWeight('KH2PO4');
            const sK2SO4 = useK2SO4 ? getSaltWeight('K2SO4') : 0;
            const sMgNO3 = useMgNO3 ? getSaltWeight('MgNO3') : 0;
            const sCaCl2 = getSaltWeight('CaCl2');

            const comps = saltCompositions;

            const vNO3 = (sCaNO3 * comps.CaNO3.NO3 +
                          sNH4NO3 * comps.NH4NO3.NO3 +
                          sKNO3 * comps.KNO3.NO3 +
                          sMgNO3 * comps.MgNO3.NO3) / factor;

            const vNH4 = (sCaNO3 * comps.CaNO3.NH4 +
                          sNH4NO3 * comps.NH4NO3.NH4) / factor;

            const vN = vNO3 + vNH4;
            const vP = (sKH2PO4 * comps.KH2PO4.P) / factor;
            const vK = (sKNO3 * comps.KNO3.K +
                        sKH2PO4 * comps.KH2PO4.K +
                        sK2SO4 * comps.K2SO4.K) / factor;
            const vCa = (sCaNO3 * comps.CaNO3.Ca + sCaCl2 * comps.CaCl2.Ca) / factor;
            const vMg = (sMgSO4 * comps.MgSO4.Mg + sMgNO3 * comps.MgNO3.Mg) / factor;
            const vCl = (sCaCl2 * comps.CaCl2.Cl) / factor;
            const vNH4NO3ratio = vNO3 !== 0 ? vNH4 / vNO3 : 0;

            setInputValue('NO3', vNO3, 3, { force: true });
            setInputValue('NH4', vNH4, 3, { force: true });
            setInputValue('N', vN, 3, { force: true });
            setInputValue('P', vP, 3, { force: true });
            setInputValue('K', vK, 3, { force: true });
            setInputValue('Ca', vCa, 3, { force: true });
            setInputValue('Mg', vMg, 3, { force: true });
            setInputValue('Cl', vCl, 3, { force: true });
            setInputValue('NH4_ratio', vNH4NO3ratio, 3, { force: true });

            let values = getValues();
            values.N = vN;
            values.NO3 = vNO3;
            values.NH4 = vNH4;
            values.P = vP;
            values.K = vK;
            values.Ca = vCa;
            values.Mg = vMg;
            values.Cl = vCl;
            values.NH4_ratio = vNH4NO3ratio;

            values = calculateS(values);
            values = calculateCa(values);
            calcAll(values, { skipCalculateS: true });
        }

        function onSaltWeightChange() {
            if (isUpdating) return;
            isUpdating = true;
            try {
                applyWeightsToProfile({ sync: true });
                calcConcentrates(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã –∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∫ CalcConc –≤ –ª–µ–≥–∞—Å–∏)
                autoSaveState();
            } finally {
                isUpdating = false;
            }
        }

        function onSaltSelectionChange(changedCheckbox) {
            const k2so4Checkbox = document.getElementById('use_K2SO4');
            const mgno3Checkbox = document.getElementById('use_MgNO3');
            
            // –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
            if (changedCheckbox === 'K2SO4') {
                if (k2so4Checkbox.checked) {
                    mgno3Checkbox.checked = false;
                } else {
                    mgno3Checkbox.checked = true;
                }
            } else if (changedCheckbox === 'MgNO3') {
                if (mgno3Checkbox.checked) {
                    k2so4Checkbox.checked = false;
                } else {
                    k2so4Checkbox.checked = true;
                }
            }
            
            useK2SO4 = k2so4Checkbox.checked;
            useMgNO3 = mgno3Checkbox.checked;
            calcAll();
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∏–∫—Ä–æ –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏
        let agFe = 20.1, agMn = 36.4, agB = 17.5, agZn = 22.7, agCu = 25.5, agMo = 54.3, agCo = 13.0, agSi = 7.0;
        let vdFe = 20.1, vdMn = 36.4, vdB = 17.5, vdZn = 22.7, vdCu = 25.5, vdMo = 54.3, vdCo = 13.0, vdSi = 7.0;
        let gmSUM = 0;
        
        // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
        function onMicroChange() {
            updateProfileString();
            microToWeght();
            updateMicroNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            calcConcentrates();
            if (typeof updateMobileDisplay === 'function') updateMobileDisplay(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –º–æ–±–∏–ª—å–Ω—ã–º
            autoSaveState();
        }

        function onMicroCompositionChange() {
            microToWeght(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≥—Ä–∞–º–º—ã –∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
            updateProfileString(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ –ø–æ—Å–ª–µ microToWeght)
            updateMicroNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            calcConcentrates();
            autoSaveState();
        }

        function toMicrocomplex() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ —Å–æ—Å—Ç–∞–≤–∞ –º–∏–∫—Ä–æ–∫–æ–º–ø–ª–µ–∫—Å–∞ –∏–∑ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏)
            const gFe = parseFloat(document.getElementById('g_Fe').value) || 0;
            const gMn = parseFloat(document.getElementById('g_Mn').value) || 0;
            const gB = parseFloat(document.getElementById('g_B').value) || 0;
            const gZn = parseFloat(document.getElementById('g_Zn').value) || 0;
            const gCu = parseFloat(document.getElementById('g_Cu').value) || 0;
            const gMo = parseFloat(document.getElementById('g_Mo').value) || 0;
            const gCo = parseFloat(document.getElementById('g_Co').value) || 0;
            const gSi = parseFloat(document.getElementById('g_Si').value) || 0;
            
            gmSUM = gFe + gMn + gB + gZn + gCu + gMo + gCo + gSi;
            
            const V = parseFloat(document.getElementById('volume').value) || 10;
            const Fe = parseFloat(document.getElementById('Fe').value) || 0;
            const Mn = parseFloat(document.getElementById('Mn').value) || 0;
            const B = parseFloat(document.getElementById('B').value) || 0;
            const Zn = parseFloat(document.getElementById('Zn').value) || 0;
            const Cu = parseFloat(document.getElementById('Cu').value) || 0;
            const Mo = parseFloat(document.getElementById('Mo').value) || 0;
            const Co = parseFloat(document.getElementById('Co').value) || 0;
            const Si = parseFloat(document.getElementById('Si').value) || 0;
            
            if (gmSUM > 0) {
                agFe = (Fe * V) / (gmSUM * 10000);
                agMn = (Mn * V) / (gmSUM * 10000);
                agB = (B * V) / (gmSUM * 10000);
                agZn = (Zn * V) / (gmSUM * 10000);
                agCu = (Cu * V) / (gmSUM * 10000);
                agMo = (Mo * V) / (gmSUM * 10000);
                agCo = (Co * V) / (gmSUM * 10000);
                agSi = (Si * V) / (gmSUM * 10000);
            }

            const totalStr = gmSUM.toFixed(5);
            const totalInput = document.getElementById('total_micro_grams');
            if (totalInput && !document.getElementById('use_complex')?.checked) totalInput.value = totalStr;
            const hiddenTotal = document.getElementById('g_Cmplx');
            if (hiddenTotal && !document.getElementById('use_complex')?.checked) hiddenTotal.value = totalStr;
            const totalLabel = document.getElementById('total_micro_text');
            if (totalLabel) totalLabel.textContent = totalStr;

            updateMicroDilutionInfo();
        }

        function updateMicroDilutionInfo() {
            const infoEl = document.getElementById('micro-dilution-info');
            if (!infoEl) return;

            const V = parseFloat(document.getElementById('volume').value) || 0;
            const microVol = parseFloat(document.getElementById('micro_volume').value) || 0;

            let total = gmSUM;

            if (!Number.isFinite(total) || total <= 0) {
                if (document.getElementById('use_complex')?.checked) {
                    const totalInput = parseFloat(document.getElementById('total_micro_grams')?.value);
                    if (Number.isFinite(totalInput)) total = totalInput;
                } else {
                    const gIds = ['g_Fe', 'g_Mn', 'g_B', 'g_Zn', 'g_Cu', 'g_Mo', 'g_Co', 'g_Si'];
                    total = gIds.reduce((acc, id) => acc + (parseFloat(document.getElementById(id)?.value) || 0), 0);
                }
            }

            if (microVol <= 0 || total <= 0 || V <= 0) {
                infoEl.textContent = '–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: 0,00 –≥/–ª, –ö—Ä–∞—Ç–Ω–æ—Å—Ç—å: 0:1, –†–∞—Å—Ö–æ–¥: 0,0 –º–ª/–ª —Ä–∞—Å—Ç–≤–æ—Ä–∞';
                return;
            }

            const concentration = Math.round((total * 1000 / microVol) * 100) / 100;
            const dilution = Math.round((V / microVol) * 1000);
            const usage = Math.round((microVol / V) * 10) / 10;

            const format = (value, decimals) => value.toFixed(decimals).replace('.', ',');

            infoEl.textContent = `–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: ${format(concentration, 2)} –≥/–ª, –ö—Ä–∞—Ç–Ω–æ—Å—Ç—å: ${dilution}:1, –†–∞—Å—Ö–æ–¥: ${format(usage, 1)} –º–ª/–ª —Ä–∞—Å—Ç–≤–æ—Ä–∞`;
        }
        
        function onComplexChange(skipRecalcPercents = false) {
            const checkbox = document.getElementById('use_complex');
            if (!skipRecalcPercents) {
                autoSaveState();
            }
            const complexField = document.getElementById('complex_value');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–±–ª–∏—Ü—ã —Å–æ–ª–µ–π
            const saltsTable = document.getElementById('salts-table');
            const saltsHeader = document.getElementById('salts-header');
            
            // –ü–æ–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ë–ï–ó –±–æ—Ä–∞! –ë–æ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º)
            const microFields = ['Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Co', 'Si'];
            
            if (checkbox.checked) {
                // –†–ï–ñ–ò–ú –ö–û–ú–ü–õ–ï–ö–°–ê (–∞–Ω–∞–ª–æ–≥ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1895-1948)
                
                // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º –∫–æ–º–ø–ª–µ–∫—Å–∞
                vdFe = parseFloat(document.getElementById('micro_Fe_percent').value) || 20.1;
                vdMn = parseFloat(document.getElementById('micro_Mn_percent').value) || 36.4;
                vdB = parseFloat(document.getElementById('micro_B_percent').value) || 17.5;
                vdZn = parseFloat(document.getElementById('micro_Zn_percent').value) || 22.7;
                vdCu = parseFloat(document.getElementById('micro_Cu_percent').value) || 25.5;
                vdMo = parseFloat(document.getElementById('micro_Mo_percent').value) || 54.3;
                vdCo = parseFloat(document.getElementById('micro_Co_percent').value) || 13.0;
                vdSi = parseFloat(document.getElementById('micro_Si_percent').value) || 7.0;
                
                // 2-3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞
                // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ)
                if (!skipRecalcPercents) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞
                    toMicrocomplex();
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ–ª—è–º–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–º–ø–ª–µ–∫—Å–µ
                    // agFe –∏ –¥—Ä—É–≥–∏–µ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (—Ñ–æ—Ä–º—É–ª–∞ –¥–µ–ª–∏—Ç –Ω–∞ 10000, —á—Ç–æ –¥–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã)
                    document.getElementById('micro_Fe_percent').value = agFe.toFixed(4);
                    document.getElementById('micro_Mn_percent').value = agMn.toFixed(4);
                    document.getElementById('micro_B_percent').value = agB.toFixed(4);
                    document.getElementById('micro_Zn_percent').value = agZn.toFixed(4);
                    document.getElementById('micro_Cu_percent').value = agCu.toFixed(4);
                    document.getElementById('micro_Mo_percent').value = agMo.toFixed(4);
                    document.getElementById('micro_Co_percent').value = agCo.toFixed(4);
                    document.getElementById('micro_Si_percent').value = agSi.toFixed(4);
                }
                
                // 4. –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –í –¢–û–ß–ù–û–°–¢–ò –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ (—Å—Ç—Ä–æ–∫–∏ 1909-1918):
                // –°–∫—Ä—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –∫–æ–ª–æ–Ω–∫—É –≥—Ä–∞–º–º–æ–≤, –ù–û –ù–ï –°–ö–†–´–í–ê–ï–ú —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏!
                ['g_Fe', 'g_Mn', 'g_B', 'g_Zn', 'g_Cu', 'g_Mo', 'g_Co', 'g_Si'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.style.display = 'none';
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–≥—Ä–∞–º–º—ã" –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º "–¥–æ–ª—è (%)"
                if (saltsHeader) {
                    const gramsLabel = saltsHeader.querySelector('span[style*="left: 215px"]');
                    if (gramsLabel) gramsLabel.style.display = 'none';
                }
                
                // 5. –î–µ–ª–∞–µ–º –ú–ò–ö–†–û–≠–õ–ï–ú–ï–ù–¢–´ (–≤–µ—Ä—Ö–Ω–∏–µ –ø–æ–ª—è) readonly (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1898-1906)
                // –ö–†–û–ú–ï B - –æ–Ω –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º!
                // –í–ê–ñ–ù–û: –ø—Ä–æ—Ü–µ–Ω—Ç—ã (dFe, dMn –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏ –í–°–ï–ì–î–ê!
                microFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.readOnly = true;
                        field.style.background = '#e8e8e8';
                    }
                });
                
                // B –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º (—Å—Ç—Ä–æ–∫–∞ 1900 –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ –ª–µ–≥–∞—Å–∏)
                document.getElementById('B').readOnly = false;
                document.getElementById('B').style.background = '';
                
                // 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≥—Ä–∞–º–º–æ–≤ –∫–æ–º–ø–ª–µ–∫—Å–∞
                document.getElementById('total_micro_grams').style.display = 'block';
                document.getElementById('total_micro_text').style.display = 'none';
                document.getElementById('total_micro_grams').value = gmSUM.toFixed(5);
                
                // 7. –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 1919)
                const microComposition = document.getElementById('micro-composition');
                if (microComposition) microComposition.style.display = 'none';
                
                // 8. –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Å—Ç—Ä–æ–∫ –≤ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞—Ö (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1922-1930)
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(elem => {
                    const row = document.getElementById(`conc-row-${elem}`);
                    if (row) row.style.display = 'none';
                });
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–º–ø–ª–µ–∫—Å–∞
                const cmplxRow = document.getElementById('conc-row-Cmplx');
                if (cmplxRow) cmplxRow.style.display = '';
                
            } else {
                // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú (–∞–Ω–∞–ª–æ–≥ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1841-1894)
                
                // 1. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
                document.getElementById('micro_Fe_percent').value = vdFe.toFixed(4);
                document.getElementById('micro_Mn_percent').value = vdMn.toFixed(4);
                document.getElementById('micro_B_percent').value = vdB.toFixed(4);
                document.getElementById('micro_Zn_percent').value = vdZn.toFixed(4);
                document.getElementById('micro_Cu_percent').value = vdCu.toFixed(4);
                document.getElementById('micro_Mo_percent').value = vdMo.toFixed(4);
                document.getElementById('micro_Co_percent').value = vdCo.toFixed(4);
                document.getElementById('micro_Si_percent').value = vdSi.toFixed(4);
                
                // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É –≥—Ä–∞–º–º–æ–≤ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1846-1853)
                ['g_Fe', 'g_Mn', 'g_B', 'g_Zn', 'g_Cu', 'g_Mo', 'g_Co', 'g_Si'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.style.display = '';
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–≥—Ä–∞–º–º—ã"
                if (saltsHeader) {
                    const gramsLabel = saltsHeader.querySelector('span[style*="left: 215px"]');
                    if (gramsLabel) gramsLabel.style.display = '';
                }
                
                // 3. –£–±–∏—Ä–∞–µ–º readonly —Å–æ –≤—Å–µ—Ö –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1878-1886)
                microFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.readOnly = false;
                        field.style.background = '';
                    }
                });
                
                // 4. –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≥—Ä–∞–º–º–æ–≤ –∫–æ–º–ø–ª–µ–∫—Å–∞
                document.getElementById('total_micro_grams').style.display = 'none';
                document.getElementById('total_micro_text').style.display = 'block';
                document.getElementById('total_micro_text').textContent = gmSUM.toFixed(5);
                
                // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 1888)
                const microComposition = document.getElementById('micro-composition');
                if (microComposition) microComposition.style.display = 'block';
                
                // 6. –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Å—Ç—Ä–æ–∫ –≤ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞—Ö (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1856-1864)
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(elem => {
                    const row = document.getElementById(`conc-row-${elem}`);
                    if (row) row.style.display = '';
                });
                // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–º–ø–ª–µ–∫—Å–∞
                const cmplxRow = document.getElementById('conc-row-Cmplx');
                if (cmplxRow) cmplxRow.style.display = 'none';
            }
            
            microToWeght();
            updateMicroNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ü–µ–Ω (–∞–Ω–∞–ª–æ–≥ price() –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1096-1144)
            const priceItemsCmplx = document.querySelector('#price_result_Cmplx')?.closest('.price-item');
            const priceItemsFe = document.querySelector('#price_result_Fe')?.closest('.price-item');
            const priceItemsMn = document.querySelector('#price_result_Mn')?.closest('.price-item');
            const priceItemsB = document.querySelector('#price_result_B')?.closest('.price-item');
            const priceItemsZn = document.querySelector('#price_result_Zn')?.closest('.price-item');
            const priceItemsCu = document.querySelector('#price_result_Cu')?.closest('.price-item');
            const priceItemsMo = document.querySelector('#price_result_Mo')?.closest('.price-item');
            const priceItemsCo = document.querySelector('#price_result_Co')?.closest('.price-item');
            const priceItemsSi = document.querySelector('#price_result_Si')?.closest('.price-item');
            
            if (checkbox.checked) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                if (priceItemsCmplx) priceItemsCmplx.style.display = 'flex';
                if (priceItemsFe) priceItemsFe.style.display = 'none';
                if (priceItemsMn) priceItemsMn.style.display = 'none';
                if (priceItemsB) priceItemsB.style.display = 'none';
                if (priceItemsZn) priceItemsZn.style.display = 'none';
                if (priceItemsCu) priceItemsCu.style.display = 'none';
                if (priceItemsMo) priceItemsMo.style.display = 'none';
                if (priceItemsCo) priceItemsCo.style.display = 'none';
                if (priceItemsSi) priceItemsSi.style.display = 'none';
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤ —Ñ–æ—Ä–º–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1922-1930)
                const complexItem = document.getElementById('complex-micro-item');
                if (complexItem) complexItem.style.display = '';
                
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(element => {
                    const item = document.getElementById(`individual-micro-${element}`);
                    if (item) item.style.display = 'none';
                });
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                if (priceItemsCmplx) priceItemsCmplx.style.display = 'none';
                if (priceItemsFe) priceItemsFe.style.display = 'flex';
                if (priceItemsMn) priceItemsMn.style.display = 'flex';
                if (priceItemsB) priceItemsB.style.display = 'flex';
                if (priceItemsZn) priceItemsZn.style.display = 'flex';
                if (priceItemsCu) priceItemsCu.style.display = 'flex';
                if (priceItemsMo) priceItemsMo.style.display = 'flex';
                if (priceItemsCo) priceItemsCo.style.display = 'flex';
                if (priceItemsSi) priceItemsSi.style.display = 'flex';
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤ —Ñ–æ—Ä–º–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1856-1864)
                const complexItem = document.getElementById('complex-micro-item');
                if (complexItem) complexItem.style.display = 'none';
                
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(element => {
                    const item = document.getElementById(`individual-micro-${element}`);
                    if (item) item.style.display = '';
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
            updatePriceResults();
        }

        function onMicroVolumeChange() {
            microToWeght();
        }
        
        function onTotalMicroGramsChange() {
            const totalInput = document.getElementById('total_micro_grams');
            if (!totalInput) return;

            const totalGrams = parseFloat(totalInput.value);
            if (!Number.isFinite(totalGrams)) return;

            const normalized = totalGrams.toFixed(5);
            totalInput.value = normalized;

            const gCmplxInput = document.getElementById('g_Cmplx');
            if (gCmplxInput) gCmplxInput.value = normalized;

            gmSUM = totalGrams;

            if (document.getElementById('use_complex')?.checked) {
                applyComplexGrams(totalGrams);
            } else {
                toMicrocomplex();
                updateMicroDilutionInfo();
            }

            autoSaveState();
        }

        function microToWeght() {
            // –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ –ª–µ–≥–∞—Å–∏ procedure microToWeght
            const V = parseFloat(document.getElementById('volume').value) || 10;
            const Fe = parseFloat(document.getElementById('Fe').value) || 0;
            const Mn = parseFloat(document.getElementById('Mn').value) || 0;
            const B = parseFloat(document.getElementById('B').value) || 0;
            const Zn = parseFloat(document.getElementById('Zn').value) || 0;
            const Cu = parseFloat(document.getElementById('Cu').value) || 0;
            const Mo = parseFloat(document.getElementById('Mo').value) || 0;
            const Co = parseFloat(document.getElementById('Co').value) || 0;
            const Si = parseFloat(document.getElementById('Si').value) || 0;

            const pFe = parseFloat(document.getElementById('micro_Fe_percent').value) || 0;
            const pMn = parseFloat(document.getElementById('micro_Mn_percent').value) || 0;
            const pB = parseFloat(document.getElementById('micro_B_percent').value) || 0;
            const pZn = parseFloat(document.getElementById('micro_Zn_percent').value) || 0;
            const pCu = parseFloat(document.getElementById('micro_Cu_percent').value) || 0;
            const pMo = parseFloat(document.getElementById('micro_Mo_percent').value) || 0;
            const pCo = parseFloat(document.getElementById('micro_Co_percent').value) || 0;
            const pSi = parseFloat(document.getElementById('micro_Si_percent').value) || 0;
            
            const isComplexMode = document.getElementById('use_complex').checked;
            
            if (!isComplexMode) {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ if (kF.chKComplex.Checked = False)
                // if Kf.dFe.value >0 then Kf.gFe.value:=Kf.Fe.value/Kf.dFe.value*Kf.V.value/10000
                document.getElementById('g_Fe').value = (pFe > 0 ? (Fe / pFe * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Mn').value = (pMn > 0 ? (Mn / pMn * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_B').value = (pB > 0 ? (B / pB * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Zn').value = (pZn > 0 ? (Zn / pZn * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Cu').value = (pCu > 0 ? (Cu / pCu * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Mo').value = (pMo > 0 ? (Mo / pMo * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Co').value = (pCo > 0 ? (Co / pCo * V / 10000).toFixed(5) : '0.00000');
                document.getElementById('g_Si').value = (pSi > 0 ? (Si / pSi * V / 10000).toFixed(5) : '0.00000');
                
                toMicrocomplex();
                
            } else {
                // –†–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞ - –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ else
                // if Kf.dB.value >0 then Kf.gCmplx.value:=Kf.B.value/Kf.dB.value*Kf.V.value/10000
                const complexValue = pB > 0 ? (B / pB * V / 10000) : 0;
                gmSUM = complexValue;
                document.getElementById('total_micro_grams').value = complexValue.toFixed(5);
                document.getElementById('g_Cmplx').value = complexValue.toFixed(5); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è calcConcentrates
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–ø–ª–µ–∫—Å–∞
                // Kf.Fe.value:=10000*Kf.gCmplx.value* (Kf.dFe.value/Kf.V.value)
                const updateMicroFromComplex = (id, percent) => {
                    const input = document.getElementById(id);
                    if (!input) return;
                    if (complexValue > 0 && percent > 0 && V > 0) {
                        input.value = Math.round(10000 * complexValue * (percent / V));
                    } else {
                        input.value = '0';
                    }
                };

                updateMicroFromComplex('Fe', pFe);
                updateMicroFromComplex('Mn', pMn);
                // –ë–æ—Ä –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏)
                updateMicroFromComplex('Zn', pZn);
                updateMicroFromComplex('Cu', pCu);
                updateMicroFromComplex('Mo', pMo);
                updateMicroFromComplex('Co', pCo);
                updateMicroFromComplex('Si', pSi);
            }
            
            const totalGramsStr = gmSUM.toFixed(5);
            document.getElementById('total_micro_grams').value = totalGramsStr;
            document.getElementById('g_Cmplx').value = totalGramsStr;
            if (!isComplexMode) {
                document.getElementById('total_micro_text').textContent = totalGramsStr;
            }

            updateMicroDilutionInfo();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ agXX –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏
            // –§–æ—Ä–º—É–ª–∞ –∏–∑ –ª–µ–≥–∞—Å–∏: round(agFe*1000)/1000 - –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 3 –∑–Ω–∞–∫–æ–≤
            const composition = `–°–æ—Å—Ç–∞–≤: Fe=${(Math.round(agFe*1000)/1000).toFixed(3)}% Mn=${(Math.round(agMn*1000)/1000).toFixed(3)}% B=${(Math.round(agB*1000)/1000).toFixed(3)}% Zn=${(Math.round(agZn*1000)/1000).toFixed(3)}% Cu=${(Math.round(agCu*1000)/1000).toFixed(3)}% Mo=${(Math.round(agMo*1000)/1000).toFixed(3)}% Co=${(Math.round(agCo*1000)/1000).toFixed(3)}% Si=${(Math.round(agSi*1000)/1000).toFixed(3)}%`;
            document.getElementById('micro-composition').textContent = composition;

            // –†–∞–∑–≤–µ–¥–µ–Ω–∏–µ
            const microVol = parseFloat(document.getElementById('micro_volume').value) || 500;
            if (microVol > 0 && gmSUM > 0) {
                const concentration = (gmSUM * 1000 / microVol).toFixed(2);
                const dilution = Math.round(1000 * V / microVol);
                const usage = Math.round(microVol / V);
                document.getElementById('micro-dilution-info').textContent = 
                    `–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: ${concentration} –≥/–ª, –ö—Ä–∞—Ç–Ω–æ—Å—Ç—å: ${dilution}:1, –†–∞—Å—Ö–æ–¥: ${usage} –º–ª/–ª —Ä–∞—Å—Ç–≤–æ—Ä–∞`;
            }
        }
        
        // –û–±—Ä–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–µ—Ä–µ—Å—á–µ—Ç –∏–∑ –≥—Ä–∞–º–º–æ–≤ —Å–æ–ª–µ–π –í –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã (–∞–Ω–∞–ª–æ–≥ WeghtTomicro –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1960-1987)
        function weightToMicro() {
            const V = parseFloat(document.getElementById('volume').value) || 10;
            
            const gFe = parseFloat(document.getElementById('g_Fe').value) || 0;
            const gMn = parseFloat(document.getElementById('g_Mn').value) || 0;
            const gB = parseFloat(document.getElementById('g_B').value) || 0;
            const gZn = parseFloat(document.getElementById('g_Zn').value) || 0;
            const gCu = parseFloat(document.getElementById('g_Cu').value) || 0;
            const gMo = parseFloat(document.getElementById('g_Mo').value) || 0;
            const gCo = parseFloat(document.getElementById('g_Co').value) || 0;
            const gSi = parseFloat(document.getElementById('g_Si').value) || 0;
            
            const dFe = parseFloat(document.getElementById('micro_Fe_percent').value) || 0;
            const dMn = parseFloat(document.getElementById('micro_Mn_percent').value) || 0;
            const dB = parseFloat(document.getElementById('micro_B_percent').value) || 0;
            const dZn = parseFloat(document.getElementById('micro_Zn_percent').value) || 0;
            const dCu = parseFloat(document.getElementById('micro_Cu_percent').value) || 0;
            const dMo = parseFloat(document.getElementById('micro_Mo_percent').value) || 0;
            const dCo = parseFloat(document.getElementById('micro_Co_percent').value) || 0;
            const dSi = parseFloat(document.getElementById('micro_Si_percent').value) || 0;
            
            const isComplexMode = document.getElementById('use_complex').checked;
            
            if (!isComplexMode) {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: Kf.Fe.value:=10000*Kf.gFe.value* (Kf.dFe.value/Kf.V.value)
                document.getElementById('Fe').value = Math.round(10000 * gFe * (dFe / V));
                document.getElementById('Mn').value = Math.round(10000 * gMn * (dMn / V));
                document.getElementById('B').value = Math.round(10000 * gB * (dB / V));
                document.getElementById('Zn').value = Math.round(10000 * gZn * (dZn / V));
                document.getElementById('Cu').value = Math.round(10000 * gCu * (dCu / V));
                document.getElementById('Mo').value = Math.round(10000 * gMo * (dMo / V));
                document.getElementById('Co').value = Math.round(10000 * gCo * (dCo / V));
                document.getElementById('Si').value = Math.round(10000 * gSi * (dSi / V));
                gmSUM = gFe + gMn + gB + gZn + gCu + gMo + gCo + gSi;
                const totalStr = gmSUM.toFixed(5);
                const totalLabel = document.getElementById('total_micro_text');
                if (totalLabel) totalLabel.textContent = totalStr;
                const totalInput = document.getElementById('total_micro_grams');
                if (totalInput) totalInput.value = totalStr;
                const hiddenTotal = document.getElementById('g_Cmplx');
                if (hiddenTotal) hiddenTotal.value = totalStr;
            } else {
                // –†–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º gCmplx
                const gCmplx = parseFloat(document.getElementById('total_micro_grams').value) || 0;
                document.getElementById('Fe').value = Math.round(10000 * gCmplx * (dFe / V));
                document.getElementById('Mn').value = Math.round(10000 * gCmplx * (dMn / V));
                document.getElementById('B').value = Math.round(10000 * gCmplx * (dB / V));
                document.getElementById('Zn').value = Math.round(10000 * gCmplx * (dZn / V));
                document.getElementById('Cu').value = Math.round(10000 * gCmplx * (dCu / V));
                document.getElementById('Mo').value = Math.round(10000 * gCmplx * (dMo / V));
                document.getElementById('Co').value = Math.round(10000 * gCmplx * (dCo / V));
                document.getElementById('Si').value = Math.round(10000 * gCmplx * (dSi / V));
                gmSUM = gCmplx;
            }
            
            // –í—ã–∑—ã–≤–∞–µ–º genProfile –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 1986)
            updateProfileString();
            autoSaveState();
            updateMicroDilutionInfo();
        }
        
        function applyComplexGrams(total) {
            const normalized = total.toFixed(5);
            const gCmplxInput = document.getElementById('g_Cmplx');
            const totalInput = document.getElementById('total_micro_grams');
            if (gCmplxInput) gCmplxInput.value = normalized;
            if (totalInput) totalInput.value = normalized;

            gmSUM = total;
            weightToMicro();
        }

        function onComplexGramsChange() {
            const totalInput = document.getElementById('total_micro_grams');
            if (!totalInput) return;

            const total = parseFloat(totalInput.value);
            if (!Number.isFinite(total)) return;

            applyComplexGrams(total);
            autoSaveState();
        }

        // –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
        function saveProfile() {
            getValues();
            const profileData = JSON.stringify(currentProfile, null, 2);
            document.getElementById('profile-data').value = profileData;
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            localStorage.setItem('hpg_profile', profileData);
            alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        function loadProfile() {
            const savedProfile = localStorage.getItem('hpg_profile');
            if (savedProfile) {
                try {
                    currentProfile = JSON.parse(savedProfile);
                    applyProfile();
                    alert('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω');
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
                }
            } else {
                alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        }
        
        // ========== –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ F5) ==========
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
        function autoSaveState() {
            try {
                const getMacro = (salt, ions) => ions.reduce((acc, ion) => {
                    acc[ion] = getSaltPercent(salt, ion);
                    return acc;
                }, {});

                const readMicro = (id) => {
                    const value = parseFloat(document.getElementById(id)?.value);
                    return Number.isFinite(value) ? value : 0;
                };

                const readProfileValue = (id, fallback = 0) => parseInput(id, fallback);

                const profileSnapshot = {
                    N: readProfileValue('N'),
                    NO3: readProfileValue('NO3'),
                    NH4: readProfileValue('NH4'),
                    P: readProfileValue('P'),
                    K: readProfileValue('K'),
                    Ca: readProfileValue('Ca'),
                    Mg: readProfileValue('Mg'),
                    S: readProfileValue('S'),
                    Cl: readProfileValue('Cl'),
                    EC: readProfileValue('EC'),
                    Fe: readProfileValue('Fe'),
                    Mn: readProfileValue('Mn'),
                    B: readProfileValue('B'),
                    Zn: readProfileValue('Zn'),
                    Cu: readProfileValue('Cu'),
                    Mo: readProfileValue('Mo'),
                    Co: readProfileValue('Co'),
                    Si: readProfileValue('Si'),
                    volume: readProfileValue('volume', 10)
                };

                currentProfile = { ...currentProfile, ...profileSnapshot };

                const state = {
                    profile: profileSnapshot,
                    volume: profileSnapshot.volume,
                    useK2SO4: document.getElementById('use_K2SO4')?.checked || false,
                    useMgNO3: document.getElementById('use_MgNO3')?.checked || false,
                    useComplex: document.getElementById('use_complex')?.checked || false,
                    macroPercents: {
                        CaNO3: getMacro('CaNO3', ['Ca', 'NO3', 'NH4']),
                        KNO3: getMacro('KNO3', ['K', 'NO3']),
                        NH4NO3: getMacro('NH4NO3', ['NH4', 'NO3']),
                        MgSO4: getMacro('MgSO4', ['Mg', 'S']),
                        KH2PO4: getMacro('KH2PO4', ['K', 'P']),
                        K2SO4: getMacro('K2SO4', ['K', 'S']),
                        MgNO3: getMacro('MgNO3', ['Mg', 'NO3']),
                        CaCl2: getMacro('CaCl2', ['Ca', 'Cl'])
                    },
                    microPercents: {
                        Fe: readMicro('micro_Fe_percent'),
                        Mn: readMicro('micro_Mn_percent'),
                        B: readMicro('micro_B_percent'),
                        Zn: readMicro('micro_Zn_percent'),
                        Cu: readMicro('micro_Cu_percent'),
                        Mo: readMicro('micro_Mo_percent'),
                        Co: readMicro('micro_Co_percent'),
                        Si: readMicro('micro_Si_percent')
                    },
                    timestamp: Date.now()
                };
                localStorage.setItem('hpg_autosave', JSON.stringify(state));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function restoreAutoSave() {
            try {
                const saved = localStorage.getItem('hpg_autosave');
                if (!saved) return false;

                const state = JSON.parse(saved);

                const age = Date.now() - (state.timestamp || 0);
                if (age > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('hpg_autosave');
                    return false;
                }

                const setCheckbox = (id, value) => {
                    if (value === undefined) return;
                    const el = document.getElementById(id);
                    if (el) el.checked = value;
                };

                setCheckbox('use_K2SO4', state.useK2SO4);
                setCheckbox('use_MgNO3', state.useMgNO3);
                setCheckbox('use_complex', state.useComplex);

                useK2SO4 = !!document.getElementById('use_K2SO4')?.checked;
                useMgNO3 = !!document.getElementById('use_MgNO3')?.checked;

                const useComplexFlag = !!document.getElementById('use_complex')?.checked;
                toggleMicroElements(useComplexFlag);

                if (state.macroPercents) {
                    const mp = state.macroPercents;
                    const restoreMacro = (salt, ion, obj) => {
                        if (!obj) return;
                        const value = obj[ion];
                        if (!Number.isFinite(value)) return;
                        setSaltPercent(salt, ion, value);
                    };

                    restoreMacro('CaNO3', 'Ca', mp.CaNO3);
                    restoreMacro('CaNO3', 'NO3', mp.CaNO3);
                    restoreMacro('CaNO3', 'NH4', mp.CaNO3);
                    restoreMacro('KNO3', 'K', mp.KNO3);
                    restoreMacro('KNO3', 'NO3', mp.KNO3);
                    restoreMacro('NH4NO3', 'NH4', mp.NH4NO3);
                    restoreMacro('NH4NO3', 'NO3', mp.NH4NO3);
                    restoreMacro('MgSO4', 'Mg', mp.MgSO4);
                    restoreMacro('MgSO4', 'S', mp.MgSO4);
                    restoreMacro('KH2PO4', 'K', mp.KH2PO4);
                    restoreMacro('KH2PO4', 'P', mp.KH2PO4);
                    restoreMacro('K2SO4', 'K', mp.K2SO4);
                    restoreMacro('K2SO4', 'S', mp.K2SO4);
                    restoreMacro('MgNO3', 'Mg', mp.MgNO3);
                    restoreMacro('MgNO3', 'NO3', mp.MgNO3);
                    restoreMacro('CaCl2', 'Ca', mp.CaCl2);
                    restoreMacro('CaCl2', 'Cl', mp.CaCl2);
                }

                if (state.microPercents) {
                    const restoreMicro = (id, value) => {
                        if (!Number.isFinite(value)) return;
                        setInputValue(id, value, 4, { force: true });
                    };

                    restoreMicro('micro_Fe_percent', state.microPercents.Fe);
                    restoreMicro('micro_Mn_percent', state.microPercents.Mn);
                    restoreMicro('micro_B_percent', state.microPercents.B);
                    restoreMicro('micro_Zn_percent', state.microPercents.Zn);
                    restoreMicro('micro_Cu_percent', state.microPercents.Cu);
                    restoreMicro('micro_Mo_percent', state.microPercents.Mo);
                    restoreMicro('micro_Co_percent', state.microPercents.Co);
                    restoreMicro('micro_Si_percent', state.microPercents.Si);

                    if (Number.isFinite(state.microPercents.Fe)) vdFe = state.microPercents.Fe;
                    if (Number.isFinite(state.microPercents.Mn)) vdMn = state.microPercents.Mn;
                    if (Number.isFinite(state.microPercents.B)) vdB = state.microPercents.B;
                    if (Number.isFinite(state.microPercents.Zn)) vdZn = state.microPercents.Zn;
                    if (Number.isFinite(state.microPercents.Cu)) vdCu = state.microPercents.Cu;
                    if (Number.isFinite(state.microPercents.Mo)) vdMo = state.microPercents.Mo;
                    if (Number.isFinite(state.microPercents.Co)) vdCo = state.microPercents.Co;
                    if (Number.isFinite(state.microPercents.Si)) vdSi = state.microPercents.Si;
                }

                syncSaltCompositions();
                updateSaltLabels();
                updateSaltNames();

                if (state.profile) {
                    Object.assign(currentProfile, state.profile);
                    applyProfile();
                } else {
                    const restoredVolume = parseFloat(state.volume);
                    if (Number.isFinite(restoredVolume)) {
                        document.getElementById('volume').value = restoredVolume;
                    }
                }

                console.log('–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', e);
                return false;
            }
        }

        // ========== –†–ê–ë–û–¢–ê –° –ü–û–õ–ù–´–ú –°–û–°–¢–û–Ø–ù–ò–ï–ú (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ SaveFile/LoadFirt/loadPrf) ==========
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø—Ä–æ—Ñ–∏–ª—å + —Å–æ—Å—Ç–∞–≤—ã + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
        // –ê–Ω–∞–ª–æ–≥ SaveFile –≤ –ª–µ–≥–∞—Å–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –í–°–Å –≤ localStorage['hpg_full_state']
        function saveFullState() {
            const fullState = {
                // –ü—Ä–æ—Ñ–∏–ª—å
                profile: {
                    N: parseFloat(document.getElementById('N')?.value) || 0,
                    NO3: parseFloat(document.getElementById('NO3')?.value) || 0,
                    NH4: parseFloat(document.getElementById('NH4')?.value) || 0,
                    P: parseFloat(document.getElementById('P')?.value) || 0,
                    K: parseFloat(document.getElementById('K')?.value) || 0,
                    Ca: parseFloat(document.getElementById('Ca')?.value) || 0,
                    Mg: parseFloat(document.getElementById('Mg')?.value) || 0,
                    S: parseFloat(document.getElementById('S')?.value) || 0,
                    Cl: parseFloat(document.getElementById('Cl')?.value) || 0,
                    EC: parseFloat(document.getElementById('EC')?.value) || 0,
                    Fe: parseFloat(document.getElementById('Fe')?.value) || 0,
                    Mn: parseFloat(document.getElementById('Mn')?.value) || 0,
                    B: parseFloat(document.getElementById('B')?.value) || 0,
                    Zn: parseFloat(document.getElementById('Zn')?.value) || 0,
                    Cu: parseFloat(document.getElementById('Cu')?.value) || 0,
                    Mo: parseFloat(document.getElementById('Mo')?.value) || 0,
                    Co: parseFloat(document.getElementById('Co')?.value) || 0,
                    Si: parseFloat(document.getElementById('Si')?.value) || 0,
                    volume: parseFloat(document.getElementById('volume')?.value) || 10
                },
                
                // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π (%)
                saltCompositions: {
                    CaNO3: {
                        Ca: parseFloat(document.getElementById('salt_CaNO3_Ca')?.value) || 0,
                        NO3: parseFloat(document.getElementById('salt_CaNO3_NO3')?.value) || 0,
                        NH4: parseFloat(document.getElementById('salt_CaNO3_NH4')?.value) || 0
                    },
                    KNO3: {
                        K: parseFloat(document.getElementById('salt_KNO3_K')?.value) || 0,
                        NO3: parseFloat(document.getElementById('salt_KNO3_NO3')?.value) || 0
                    },
                    NH4NO3: {
                        NH4: parseFloat(document.getElementById('salt_NH4NO3_NH4')?.value) || 0,
                        NO3: parseFloat(document.getElementById('salt_NH4NO3_NO3')?.value) || 0
                    },
                    MgSO4: {
                        Mg: parseFloat(document.getElementById('salt_MgSO4_Mg')?.value) || 0,
                        S: parseFloat(document.getElementById('salt_MgSO4_S')?.value) || 0
                    },
                    KH2PO4: {
                        K: parseFloat(document.getElementById('salt_KH2PO4_K')?.value) || 0,
                        P: parseFloat(document.getElementById('salt_KH2PO4_P')?.value) || 0
                    },
                    K2SO4: {
                        K: parseFloat(document.getElementById('salt_K2SO4_K')?.value) || 0,
                        S: parseFloat(document.getElementById('salt_K2SO4_S')?.value) || 0
                    },
                    MgNO3: {
                        Mg: parseFloat(document.getElementById('salt_MgNO3_Mg')?.value) || 0,
                        NO3: parseFloat(document.getElementById('salt_MgNO3_NO3')?.value) || 0
                    },
                    CaCl2: {
                        Ca: parseFloat(document.getElementById('salt_CaCl2_Ca')?.value) || 0,
                        Cl: parseFloat(document.getElementById('salt_CaCl2_Cl')?.value) || 0
                    }
                },
                
                // –î–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (%)
                microCompositions: {
                    Fe: parseFloat(document.getElementById('micro_Fe_percent')?.value) || 0,
                    Mn: parseFloat(document.getElementById('micro_Mn_percent')?.value) || 0,
                    B: parseFloat(document.getElementById('micro_B_percent')?.value) || 0,
                    Zn: parseFloat(document.getElementById('micro_Zn_percent')?.value) || 0,
                    Cu: parseFloat(document.getElementById('micro_Cu_percent')?.value) || 0,
                    Mo: parseFloat(document.getElementById('micro_Mo_percent')?.value) || 0,
                    Co: parseFloat(document.getElementById('micro_Co_percent')?.value) || 0,
                    Si: parseFloat(document.getElementById('micro_Si_percent')?.value) || 0
                },
                
                // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ (–≥/–ª)
                concentrations: {
                    glCaNO3: parseFloat(document.getElementById('conc_glCaNO3')?.value) || 0,
                    glKNO3: parseFloat(document.getElementById('conc_glKNO3')?.value) || 0,
                    glNH4NO3: parseFloat(document.getElementById('conc_glNH4NO3')?.value) || 0,
                    glMgNO3: parseFloat(document.getElementById('conc_glMgNO3')?.value) || 0,
                    glMgSO4: parseFloat(document.getElementById('conc_glMgSO4')?.value) || 0,
                    glKH2PO4: parseFloat(document.getElementById('conc_glKH2PO4')?.value) || 0,
                    glK2SO4: parseFloat(document.getElementById('conc_glK2SO4')?.value) || 0,
                    glCaCl2: parseFloat(document.getElementById('conc_glCaCl2')?.value) || 0,
                    glCmplx: parseFloat(document.getElementById('conc_glCmplx')?.value) || 0,
                    glFe: parseFloat(document.getElementById('conc_glFe')?.value) || 0,
                    glMn: parseFloat(document.getElementById('conc_glMn')?.value) || 0,
                    glB: parseFloat(document.getElementById('conc_glB')?.value) || 0,
                    glZn: parseFloat(document.getElementById('conc_glZn')?.value) || 0,
                    glCu: parseFloat(document.getElementById('conc_glCu')?.value) || 0,
                    glMo: parseFloat(document.getElementById('conc_glMo')?.value) || 0,
                    glCo: parseFloat(document.getElementById('conc_glCo')?.value) || 0,
                    glSi: parseFloat(document.getElementById('conc_glSi')?.value) || 0
                },
                
                // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ (–≥/–º–ª)
                densities: {
                    gmlCaNO3: parseFloat(document.getElementById('conc_gmlCaNO3')?.value) || 0,
                    gmlKNO3: parseFloat(document.getElementById('conc_gmlKNO3')?.value) || 0,
                    gmlNH4NO3: parseFloat(document.getElementById('conc_gmlNH4NO3')?.value) || 0,
                    gmlMgNO3: parseFloat(document.getElementById('conc_gmlMgNO3')?.value) || 0,
                    gmlMgSO4: parseFloat(document.getElementById('conc_gmlMgSO4')?.value) || 0,
                    gmlKH2PO4: parseFloat(document.getElementById('conc_gmlKH2PO4')?.value) || 0,
                    gmlK2SO4: parseFloat(document.getElementById('conc_gmlK2SO4')?.value) || 0,
                    gmlCaCl2: parseFloat(document.getElementById('conc_gmlCaCl2')?.value) || 0,
                    gmlCmplx: parseFloat(document.getElementById('conc_gmlCmplx')?.value) || 0,
                    gmlFe: parseFloat(document.getElementById('conc_gmlFe')?.value) || 0,
                    gmlMn: parseFloat(document.getElementById('conc_gmlMn')?.value) || 0,
                    gmlB: parseFloat(document.getElementById('conc_gmlB')?.value) || 0,
                    gmlZn: parseFloat(document.getElementById('conc_gmlZn')?.value) || 0,
                    gmlCu: parseFloat(document.getElementById('conc_gmlCu')?.value) || 0,
                    gmlMo: parseFloat(document.getElementById('conc_gmlMo')?.value) || 0,
                    gmlCo: parseFloat(document.getElementById('conc_gmlCo')?.value) || 0,
                    gmlSi: parseFloat(document.getElementById('conc_gmlSi')?.value) || 0
                },
                
                // –¶–µ–Ω—ã
                prices: {
                    CaNO3: parseFloat(document.getElementById('price_CaNO3')?.value) || 0,
                    KNO3: parseFloat(document.getElementById('price_KNO3')?.value) || 0,
                    NH4NO3: parseFloat(document.getElementById('price_NH4NO3')?.value) || 0,
                    MgNO3: parseFloat(document.getElementById('price_MgNO3')?.value) || 0,
                    MgSO4: parseFloat(document.getElementById('price_MgSO4')?.value) || 0,
                    KH2PO4: parseFloat(document.getElementById('price_KH2PO4')?.value) || 0,
                    K2SO4: parseFloat(document.getElementById('price_K2SO4')?.value) || 0,
                    CaCl2: parseFloat(document.getElementById('price_CaCl2')?.value) || 0,
                    Fe: parseFloat(document.getElementById('price_Fe')?.value) || 0,
                    Mn: parseFloat(document.getElementById('price_Mn')?.value) || 0,
                    B: parseFloat(document.getElementById('price_B')?.value) || 0,
                    Zn: parseFloat(document.getElementById('price_Zn')?.value) || 0,
                    Cu: parseFloat(document.getElementById('price_Cu')?.value) || 0,
                    Mo: parseFloat(document.getElementById('price_Mo')?.value) || 0,
                    Co: parseFloat(document.getElementById('price_Co')?.value) || 0,
                    Si: parseFloat(document.getElementById('price_Si')?.value) || 0,
                    Cmplx: parseFloat(document.getElementById('price_Cmplx')?.value) || 0
                },
                
                // –ß–µ–∫–±–æ–∫—Å—ã
                flags: {
                    use_K2SO4: document.getElementById('use_K2SO4')?.checked || false,
                    use_MgNO3: document.getElementById('use_MgNO3')?.checked || false,
                    use_complex: document.getElementById('use_complex')?.checked || false
                },
                
                // –ù–∞–∑–≤–∞–Ω–∏—è –ø–æ–º–ø
                pumpNames: {
                    mCaNO3: document.getElementById('mCaNO3')?.value || '',
                    mKNO3: document.getElementById('mKNO3')?.value || '',
                    mNH4NO3: document.getElementById('mNH4NO3')?.value || '',
                    mMgNO3: document.getElementById('mMgNO3')?.value || '',
                    mCaCl2: document.getElementById('mCaCl2')?.value || '',
                    mMgSO4: document.getElementById('mMgSO4')?.value || '',
                    mKH2PO4: document.getElementById('mKH2PO4')?.value || '',
                    mK2SO4: document.getElementById('mK2SO4')?.value || '',
                    mFe: document.getElementById('mFe')?.value || '',
                    mMn: document.getElementById('mMn')?.value || '',
                    mB: document.getElementById('mB')?.value || '',
                    mZn: document.getElementById('mZn')?.value || '',
                    mCu: document.getElementById('mCu')?.value || '',
                    mMo: document.getElementById('mMo')?.value || '',
                    mCo: document.getElementById('mCo')?.value || '',
                    mSi: document.getElementById('mSi')?.value || '',
                    mCmplx: document.getElementById('mCmplx')?.value || ''
                },
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Å–µ—Ä–∞
                mixer: {
                    addrMixer: document.getElementById('addrMixer')?.value || 'mixer.local',
                    nmix: document.getElementById('nmix')?.value || '1'
                },
                
                // –û–±—ä–µ–º—ã –±–∞–∫–æ–≤
                tanks: {
                    tank_A: parseFloat(document.getElementById('tank_A')?.value) || 500,
                    tank_B: parseFloat(document.getElementById('tank_B')?.value) || 500
                },
                
                // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                meta: {
                    filename: document.getElementById('file_filename')?.value || 'default.hpg',
                    comment: document.getElementById('file_comment')?.value || '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é'
                }
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('hpg_full_state', JSON.stringify(fullState));
            alert('–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–∞–≤–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ù–ï —Ç—Ä–æ–≥–∞—è –ø—Ä–æ—Ñ–∏–ª—å)
        // –ê–Ω–∞–ª–æ–≥ LoadFirt –≤ –ª–µ–≥–∞—Å–∏ - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, —Ü–µ–Ω—ã, —á–µ–∫–±–æ–∫—Å—ã –∏ —Ç.–¥.
        // –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å (N, P, K, Fe –∏ —Ç.–¥.)
        function loadCompositions() {
            const savedState = localStorage.getItem('hpg_full_state');
            if (!savedState) {
                alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"');
                return;
            }
            
            try {
                const state = JSON.parse(savedState);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π
                if (state.saltCompositions) {
                    Object.keys(state.saltCompositions).forEach(salt => {
                        Object.keys(state.saltCompositions[salt]).forEach(element => {
                            const id = `salt_${salt}_${element}`;
                            const el = document.getElementById(id);
                            if (el) el.value = state.saltCompositions[salt][element];
                        });
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (state.microCompositions) {
                    Object.keys(state.microCompositions).forEach(element => {
                        const el = document.getElementById(`micro_${element}_percent`);
                        if (el) el.value = state.microCompositions[element];
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
                if (state.concentrations) {
                    Object.keys(state.concentrations).forEach(key => {
                        const el = document.getElementById(`conc_${key}`);
                        if (el) el.value = state.concentrations[key];
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
                if (state.densities) {
                    Object.keys(state.densities).forEach(key => {
                        const el = document.getElementById(`conc_${key}`);
                        if (el) el.value = state.densities[key];
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã
                if (state.prices) {
                    Object.keys(state.prices).forEach(key => {
                        const el = document.getElementById(`price_${key}`);
                        if (el) el.value = state.prices[key];
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã
                if (state.flags) {
                    if (state.flags.use_K2SO4 !== undefined) {
                        const el = document.getElementById('use_K2SO4');
                        if (el) {
                            el.checked = state.flags.use_K2SO4;
                            useK2SO4 = state.flags.use_K2SO4;
                        }
                    }
                    if (state.flags.use_MgNO3 !== undefined) {
                        const el = document.getElementById('use_MgNO3');
                        if (el) {
                            el.checked = state.flags.use_MgNO3;
                            useMgNO3 = state.flags.use_MgNO3;
                        }
                    }
                    if (state.flags.use_complex !== undefined) {
                        const el = document.getElementById('use_complex');
                        if (el) el.checked = state.flags.use_complex;
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–º–ø
                if (state.pumpNames) {
                    Object.keys(state.pumpNames).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = state.pumpNames[key];
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Å–µ—Ä–∞
                if (state.mixer) {
                    if (state.mixer.addrMixer) {
                        const el = document.getElementById('addrMixer');
                        if (el) el.value = state.mixer.addrMixer;
                    }
                    if (state.mixer.nmix) {
                        const el = document.getElementById('nmix');
                        if (el) el.value = state.mixer.nmix;
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä–µ–º—ã –±–∞–∫–æ–≤
                if (state.tanks) {
                    if (state.tanks.tank_A) {
                        const el = document.getElementById('tank_A');
                        if (el) el.value = state.tanks.tank_A;
                    }
                    if (state.tanks.tank_B) {
                        const el = document.getElementById('tank_B');
                        if (el) el.value = state.tanks.tank_B;
                    }
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                syncSaltCompositions();
                updateSaltLabels();
                updateSaltNames();
                updateMicroNames();
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ LoadFirt)
                calcAll();
                onMicroChange();
                calcConcentrates();
                updatePriceResults();
                
                alert('–°–æ—Å—Ç–∞–≤—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–∞–≤–æ–≤:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–∞–≤–æ–≤');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª—è (–ù–ï —Ç—Ä–æ–≥–∞—è —Å–æ—Å—Ç–∞–≤—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
        // –ê–Ω–∞–ª–æ–≥ loadPrf –≤ –ª–µ–≥–∞—Å–∏ - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å (N, P, K, Fe –∏ —Ç.–¥.)
        // –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç —Å–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, —Ü–µ–Ω—ã –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function loadProfileOnly() {
            const savedState = localStorage.getItem('hpg_full_state');
            if (!savedState) {
                alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"');
                return;
            }
            
            try {
                const state = JSON.parse(savedState);
                
                if (!state.profile) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª—å
                const profile = state.profile;
                
                // –ú–∞–∫—Ä–æ–ø—Ä–æ—Ñ–∏–ª—å
                if (profile.N !== undefined) document.getElementById('N').value = profile.N;
                if (profile.NO3 !== undefined) document.getElementById('NO3').value = profile.NO3;
                if (profile.NH4 !== undefined) document.getElementById('NH4').value = profile.NH4;
                if (profile.P !== undefined) document.getElementById('P').value = profile.P;
                if (profile.K !== undefined) document.getElementById('K').value = profile.K;
                if (profile.Ca !== undefined) document.getElementById('Ca').value = profile.Ca;
                if (profile.Mg !== undefined) document.getElementById('Mg').value = profile.Mg;
                if (profile.S !== undefined) document.getElementById('S').value = profile.S;
                if (profile.Cl !== undefined) document.getElementById('Cl').value = profile.Cl;
                
                // –ú–∏–∫—Ä–æ–ø—Ä–æ—Ñ–∏–ª—å
                if (profile.Fe !== undefined) document.getElementById('Fe').value = profile.Fe;
                if (profile.Mn !== undefined) document.getElementById('Mn').value = profile.Mn;
                if (profile.B !== undefined) document.getElementById('B').value = profile.B;
                if (profile.Zn !== undefined) document.getElementById('Zn').value = profile.Zn;
                if (profile.Cu !== undefined) document.getElementById('Cu').value = profile.Cu;
                if (profile.Mo !== undefined) document.getElementById('Mo').value = profile.Mo;
                if (profile.Co !== undefined) document.getElementById('Co').value = profile.Co;
                if (profile.Si !== undefined) document.getElementById('Si').value = profile.Si;
                
                // –û–±—ä–µ–º
                if (profile.volume !== undefined) document.getElementById('volume').value = profile.volume;
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ loadPrf)
                calcAll();
                onMicroChange();
                calcConcentrates();
                updatePriceResults();
                
                alert('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }

        function exportProfile() {
            getValues();
            updateProfileString();
            const profileStr = document.getElementById('profile-string').textContent;
            
            const blob = new Blob([profileStr], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = document.getElementById('filename').value || 'profile.hpg';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importProfile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.hpg,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const content = event.target.result;
                    parseProfileString(content);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function parseProfileString(str) {
            // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: N=220 NO3=200 NH4=20 P=40 ...
            const parts = str.trim().split(/\s+/);
            parts.forEach(part => {
                const [key, value] = part.split('=');
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    if (key === 'N') currentProfile.N = numValue;
                    else if (key === 'NO3') currentProfile.NO3 = numValue;
                    else if (key === 'NH4') currentProfile.NH4 = numValue;
                    else if (key === 'P') currentProfile.P = numValue;
                    else if (key === 'K') currentProfile.K = numValue;
                    else if (key === 'Ca') currentProfile.Ca = numValue;
                    else if (key === 'Mg') currentProfile.Mg = numValue;
                    else if (key === 'S') currentProfile.S = numValue;
                    else if (key === 'Cl') currentProfile.Cl = numValue;
                    else if (key === 'Fe') currentProfile.Fe = numValue * 1000;
                    else if (key === 'Mn') currentProfile.Mn = numValue * 1000;
                    else if (key === 'B') currentProfile.B = numValue * 1000;
                    else if (key === 'Zn') currentProfile.Zn = numValue * 1000;
                    else if (key === 'Cu') currentProfile.Cu = numValue * 1000;
                    else if (key === 'Mo') currentProfile.Mo = numValue * 1000;
                    else if (key === 'Co') currentProfile.Co = numValue * 1000;
                    else if (key === 'Si') currentProfile.Si = numValue * 1000;
                }
            });
            applyProfile();
            alert('–ü—Ä–æ—Ñ–∏–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
        }

        function applyProfile() {
            document.getElementById('N').value = currentProfile.N.toFixed(3);
            document.getElementById('P').value = currentProfile.P.toFixed(3);
            document.getElementById('K').value = currentProfile.K.toFixed(3);
            document.getElementById('Ca').value = currentProfile.Ca.toFixed(3);
            document.getElementById('Mg').value = currentProfile.Mg.toFixed(3);
            document.getElementById('S').value = currentProfile.S.toFixed(3);
            document.getElementById('Cl').value = currentProfile.Cl.toFixed(2);
            document.getElementById('EC').value = currentProfile.EC.toFixed(3);
            document.getElementById('NO3').value = currentProfile.NO3.toFixed(2);
            document.getElementById('NH4').value = currentProfile.NH4.toFixed(2);
            document.getElementById('Fe').value = currentProfile.Fe || 2000;
            document.getElementById('Mn').value = currentProfile.Mn || 550;
            document.getElementById('B').value = currentProfile.B || 500;
            document.getElementById('Zn').value = currentProfile.Zn || 330;
            document.getElementById('Cu').value = currentProfile.Cu || 63;
            document.getElementById('Mo').value = currentProfile.Mo || 63;
            document.getElementById('Co').value = currentProfile.Co || 0;
            document.getElementById('Si').value = currentProfile.Si || 0;
            document.getElementById('volume').value = currentProfile.volume || 10;
            
            onMacroChange();
            onMicroChange();
        }

        // ===== –§–£–ù–ö–¶–ò–ò –í–ö–õ–ê–î–ö–ò "–§–ê–ô–õ" =====
        
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –∂—É—Ä–Ω–∞–ª–∞
        let journalEntries = [];

        // –ö—ç—à –æ–±–ª–∞—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–ª—é—á ‚Äî –∏–º—è –±–µ–∑ .hpg, –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
        let userCloudProfilesMap = new Map();
        let currentMatchedCloudProfile = null;
        let isCloudProfilesLoaded = false;
        
        // –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞
        let catalogGrouping = 'users'; // 'users', 'tags', 'none'
        
        function fileOpen() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.hpg,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('file_filename').value = file.name;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // –û—á–∏—â–∞–µ–º localStorage –∏ –∂—É—Ä–Ω–∞–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                        localStorage.removeItem('hpg_profile');
                        localStorage.removeItem('hpg_journal');
                        journalEntries = [];
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
                        const content = event.target.result;
                        parseFullFile(content);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –¢–û–õ–¨–ö–û —Å–æ—Å—Ç–∞–≤–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ (–∞–Ω–∞–ª–æ–≥ LoadFirt –≤ –ª–µ–≥–∞—Å–∏)
        // –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å (N, P, K, Fe –∏ —Ç.–¥.)
        function parseCompositionsOnly(content) {
            const lines = content.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || !line.includes('=') || line.startsWith('#') || line.startsWith('date=')) return;
                
                const [key, value] = line.split('=');
                if (!value) return;
                const trimmedValue = value.trim();
                const numValue = parseFloat(trimmedValue);
                
                // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                if (key === 'CaNO3_Ca' && !isNaN(numValue)) setSaltPercent('CaNO3', 'Ca', numValue);
                else if (key === 'CaNO3_NO3' && !isNaN(numValue)) setSaltPercent('CaNO3', 'NO3', numValue);
                else if (key === 'CaNO3_NH4' && !isNaN(numValue)) setSaltPercent('CaNO3', 'NH4', numValue);
                else if (key === 'KNO3_K' && !isNaN(numValue)) setSaltPercent('KNO3', 'K', numValue);
                else if (key === 'KNO3_NO3' && !isNaN(numValue)) setSaltPercent('KNO3', 'NO3', numValue);
                else if (key === 'NH4NO3_NH4' && !isNaN(numValue)) setSaltPercent('NH4NO3', 'NH4', numValue);
                else if (key === 'NH4NO3_NO3' && !isNaN(numValue)) setSaltPercent('NH4NO3', 'NO3', numValue);
                else if (key === 'MgSO4_Mg' && !isNaN(numValue)) setSaltPercent('MgSO4', 'Mg', numValue);
                else if (key === 'MgSO4_S' && !isNaN(numValue)) setSaltPercent('MgSO4', 'S', numValue);
                else if (key === 'KH2PO4_K' && !isNaN(numValue)) setSaltPercent('KH2PO4', 'K', numValue);
                else if (key === 'KH2PO4_P' && !isNaN(numValue)) setSaltPercent('KH2PO4', 'P', numValue);
                else if (key === 'K2SO4_K' && !isNaN(numValue)) setSaltPercent('K2SO4', 'K', numValue);
                else if (key === 'K2SO4_S' && !isNaN(numValue)) setSaltPercent('K2SO4', 'S', numValue);
                else if (key === 'MgNO3_Mg' && !isNaN(numValue)) setSaltPercent('MgNO3', 'Mg', numValue);
                else if (key === 'MgNO3_NO3' && !isNaN(numValue)) setSaltPercent('MgNO3', 'NO3', numValue);
                else if (key === 'CaCl2_Ca' && !isNaN(numValue)) setSaltPercent('CaCl2', 'Ca', numValue);
                else if (key === 'CaCl2_Cl' && !isNaN(numValue)) setSaltPercent('CaCl2', 'Cl', numValue);
                
                // –î–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–ª—è—Ö
                else if (key === 'dFe' && !isNaN(numValue)) setInputValue('micro_Fe_percent', numValue, 4);
                else if (key === 'dMn' && !isNaN(numValue)) setInputValue('micro_Mn_percent', numValue, 4);
                else if (key === 'dB' && !isNaN(numValue)) setInputValue('micro_B_percent', numValue, 4);
                else if (key === 'dZn' && !isNaN(numValue)) setInputValue('micro_Zn_percent', numValue, 4);
                else if (key === 'dCu' && !isNaN(numValue)) setInputValue('micro_Cu_percent', numValue, 4);
                else if (key === 'dMo' && !isNaN(numValue)) setInputValue('micro_Mo_percent', numValue, 4);
                else if (key === 'dCo' && !isNaN(numValue)) setInputValue('micro_Co_percent', numValue, 4);
                else if (key === 'dSi' && !isNaN(numValue)) setInputValue('micro_Si_percent', numValue, 4);
                
                // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ (–≥/–ª)
                else if (key === 'glCaNO3' && !isNaN(numValue)) setInputValue('conc_glCaNO3', numValue, 1);
                else if (key === 'glKNO3' && !isNaN(numValue)) setInputValue('conc_glKNO3', numValue, 1);
                else if (key === 'glNH4NO3' && !isNaN(numValue)) setInputValue('conc_glNH4NO3', numValue, 1);
                else if (key === 'glMgNO3' && !isNaN(numValue)) setInputValue('conc_glMgNO3', numValue, 1);
                else if (key === 'glMgSO4' && !isNaN(numValue)) setInputValue('conc_glMgSO4', numValue, 1);
                else if (key === 'glK2SO4' && !isNaN(numValue)) setInputValue('conc_glK2SO4', numValue, 1);
                else if (key === 'glKH2PO4' && !isNaN(numValue)) setInputValue('conc_glKH2PO4', numValue, 1);
                else if (key === 'glCaCl2' && !isNaN(numValue)) setInputValue('conc_glCaCl2', numValue, 1);
                else if (key === 'glCmplx' && !isNaN(numValue)) setInputValue('conc_glCmplx', numValue, 2);
                else if (key === 'glFe' && !isNaN(numValue)) setInputValue('conc_glFe', numValue, 2);
                else if (key === 'glMn' && !isNaN(numValue)) setInputValue('conc_glMn', numValue, 2);
                else if (key === 'glB' && !isNaN(numValue)) setInputValue('conc_glB', numValue, 2);
                else if (key === 'glZn' && !isNaN(numValue)) setInputValue('conc_glZn', numValue, 2);
                else if (key === 'glCu' && !isNaN(numValue)) setInputValue('conc_glCu', numValue, 2);
                else if (key === 'glMo' && !isNaN(numValue)) setInputValue('conc_glMo', numValue, 2);
                else if (key === 'glCo' && !isNaN(numValue)) setInputValue('conc_glCo', numValue, 2);
                else if (key === 'glSi' && !isNaN(numValue)) setInputValue('conc_glSi', numValue, 2);
                
                // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ (–≥/–º–ª)
                else if (key === 'gmlCaNO3' && !isNaN(numValue)) setInputValue('conc_gmlCaNO3', numValue, 4);
                else if (key === 'gmlKNO3' && !isNaN(numValue)) setInputValue('conc_gmlKNO3', numValue, 4);
                else if (key === 'gmlNH4NO3' && !isNaN(numValue)) setInputValue('conc_gmlNH4NO3', numValue, 4);
                else if (key === 'gmlMgNO3' && !isNaN(numValue)) setInputValue('conc_gmlMgNO3', numValue, 4);
                else if (key === 'gmlMgSO4' && !isNaN(numValue)) setInputValue('conc_gmlMgSO4', numValue, 4);
                else if (key === 'gmlK2SO4' && !isNaN(numValue)) setInputValue('conc_gmlK2SO4', numValue, 4);
                else if (key === 'gmlKH2PO4' && !isNaN(numValue)) setInputValue('conc_gmlKH2PO4', numValue, 4);
                else if (key === 'gmlCaCl2' && !isNaN(numValue)) setInputValue('conc_gmlCaCl2', numValue, 4);
                else if (key === 'gmlCmplx' && !isNaN(numValue)) setInputValue('conc_gmlCmplx', numValue, 3);
                else if (key === 'gmlFe' && !isNaN(numValue)) setInputValue('conc_gmlFe', numValue, 3);
                else if (key === 'gmlMn' && !isNaN(numValue)) setInputValue('conc_gmlMn', numValue, 3);
                else if (key === 'gmlB' && !isNaN(numValue)) setInputValue('conc_gmlB', numValue, 3);
                else if (key === 'gmlZn' && !isNaN(numValue)) setInputValue('conc_gmlZn', numValue, 3);
                else if (key === 'gmlCu' && !isNaN(numValue)) setInputValue('conc_gmlCu', numValue, 3);
                else if (key === 'gmlMo' && !isNaN(numValue)) setInputValue('conc_gmlMo', numValue, 3);
                else if (key === 'gmlCo' && !isNaN(numValue)) setInputValue('conc_gmlCo', numValue, 3);
                else if (key === 'gmlSi' && !isNaN(numValue)) setInputValue('conc_gmlSi', numValue, 3);
                
                // –ß–µ–∫–±–æ–∫—Å—ã
                else if (key === 'chK2SO4') {
                    const el = document.getElementById('use_K2SO4');
                    if (el) {
                        el.checked = (trimmedValue.toLowerCase() === 'true');
                        useK2SO4 = el.checked;
                    }
                }
                else if (key === 'chMgNO3') {
                    const el = document.getElementById('use_MgNO3');
                    if (el) {
                        el.checked = (trimmedValue.toLowerCase() === 'true');
                        useMgNO3 = el.checked;
                    }
                }
                else if (key === 'chkComplex') {
                    const el = document.getElementById('use_complex');
                    if (el) el.checked = (trimmedValue.toLowerCase() === 'true');
                }
                
                // –ù–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π (m)
                else if (key === 'mCaNO3') { const el = document.getElementById('mCaNO3'); if (el) el.value = trimmedValue; }
                else if (key === 'mKNO3') { const el = document.getElementById('mKNO3'); if (el) el.value = trimmedValue; }
                else if (key === 'mNH4NO3') { const el = document.getElementById('mNH4NO3'); if (el) el.value = trimmedValue; }
                else if (key === 'mMgNO3') { const el = document.getElementById('mMgNO3'); if (el) el.value = trimmedValue; }
                else if (key === 'mCaCl2') { const el = document.getElementById('mCaCl2'); if (el) el.value = trimmedValue; }
                else if (key === 'mMgSO4') { const el = document.getElementById('mMgSO4'); if (el) el.value = trimmedValue; }
                else if (key === 'mKH2PO4') { const el = document.getElementById('mKH2PO4'); if (el) el.value = trimmedValue; }
                else if (key === 'mK2SO4') { const el = document.getElementById('mK2SO4'); if (el) el.value = trimmedValue; }
                else if (key === 'mFe') { const el = document.getElementById('mFe'); if (el) el.value = trimmedValue; }
                else if (key === 'mMn') { const el = document.getElementById('mMn'); if (el) el.value = trimmedValue; }
                else if (key === 'mB') { const el = document.getElementById('mB'); if (el) el.value = trimmedValue; }
                else if (key === 'mZn') { const el = document.getElementById('mZn'); if (el) el.value = trimmedValue; }
                else if (key === 'mCu') { const el = document.getElementById('mCu'); if (el) el.value = trimmedValue; }
                else if (key === 'mMo') { const el = document.getElementById('mMo'); if (el) el.value = trimmedValue; }
                else if (key === 'mCo') { const el = document.getElementById('mCo'); if (el) el.value = trimmedValue; }
                else if (key === 'mSi') { const el = document.getElementById('mSi'); if (el) el.value = trimmedValue; }
                else if (key === 'mCmplx') { const el = document.getElementById('mCmplx'); if (el) el.value = trimmedValue; }
                
                // –¶–µ–Ω—ã
                else if (key === 'pCaNO3' && !isNaN(numValue)) setInputValue('price_CaNO3', numValue, 4);
                else if (key === 'pKNO3' && !isNaN(numValue)) setInputValue('price_KNO3', numValue, 4);
                else if (key === 'pNH4NO3' && !isNaN(numValue)) setInputValue('price_NH4NO3', numValue, 4);
                else if (key === 'pMgNO3' && !isNaN(numValue)) setInputValue('price_MgNO3', numValue, 4);
                else if (key === 'pMgSO4' && !isNaN(numValue)) setInputValue('price_MgSO4', numValue, 4);
                else if (key === 'pKH2PO4' && !isNaN(numValue)) setInputValue('price_KH2PO4', numValue, 4);
                else if (key === 'pK2SO4' && !isNaN(numValue)) setInputValue('price_K2SO4', numValue, 4);
                else if (key === 'pCaCl2' && !isNaN(numValue)) setInputValue('price_CaCl2', numValue, 4);
                else if (key === 'pFe' && !isNaN(numValue)) setInputValue('price_Fe', numValue, 4);
                else if (key === 'pMn' && !isNaN(numValue)) setInputValue('price_Mn', numValue, 4);
                else if (key === 'pB' && !isNaN(numValue)) setInputValue('price_B', numValue, 4);
                else if (key === 'pZn' && !isNaN(numValue)) setInputValue('price_Zn', numValue, 4);
                else if (key === 'pCu' && !isNaN(numValue)) setInputValue('price_Cu', numValue, 4);
                else if (key === 'pMo' && !isNaN(numValue)) setInputValue('price_Mo', numValue, 4);
                else if (key === 'pCo' && !isNaN(numValue)) setInputValue('price_Co', numValue, 4);
                else if (key === 'pSi' && !isNaN(numValue)) setInputValue('price_Si', numValue, 4);
                else if (key === 'pCmplx' && !isNaN(numValue)) setInputValue('price_Cmplx', numValue, 4);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Å–µ—Ä–∞
                else if (key === 'addrMixer') { const el = document.getElementById('addrMixer'); if (el) el.value = trimmedValue; }
                else if (key === 'nmix') { const el = document.getElementById('nmix'); if (el) el.value = trimmedValue; }
                
                // –û–±—ä–µ–º—ã –±–∞–∫–æ–≤
                else if (key === 'tank_A' && !isNaN(numValue)) setInputValue('tank_A', numValue, 0);
                else if (key === 'tank_B' && !isNaN(numValue)) setInputValue('tank_B', numValue, 0);
            });
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ LoadFirt)
            syncSaltCompositions();
            updateSaltLabels();
            updateSaltNames();
            updateMicroNames();
            calcAll();
            onMicroChange();
            calcConcentrates();
            updatePriceResults();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã - –æ–Ω–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            const complexCheckbox = document.getElementById('use_complex');
            if (complexCheckbox) {
                onComplexChange(true); // true = –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            }
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –¢–û–õ–¨–ö–û –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ —Ñ–∞–π–ª–∞ (–∞–Ω–∞–ª–æ–≥ loadPrf –≤ –ª–µ–≥–∞—Å–∏)
        // –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç —Å–æ—Å—Ç–∞–≤—ã, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, —Ü–µ–Ω—ã –∏ –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function parseProfileOnly(content) {
            const lines = content.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || !line.includes('=') || line.startsWith('#') || line.startsWith('date=')) return;
                
                const [key, value] = line.split('=');
                if (!value) return;
                const numValue = parseFloat(value.trim());
                
                // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                if (key === 'N' && !isNaN(numValue)) setInputValue('N', numValue, 3);
                else if (key === 'NO3' && !isNaN(numValue)) setInputValue('NO3', numValue, 2);
                else if (key === 'NH4' && !isNaN(numValue)) setInputValue('NH4', numValue, 2);
                else if (key === 'P' && !isNaN(numValue)) setInputValue('P', numValue, 3);
                else if (key === 'K' && !isNaN(numValue)) setInputValue('K', numValue, 3);
                else if (key === 'Ca' && !isNaN(numValue)) setInputValue('Ca', numValue, 3);
                else if (key === 'Mg' && !isNaN(numValue)) setInputValue('Mg', numValue, 3);
                else if (key === 'S' && !isNaN(numValue)) setInputValue('S', numValue, 3);
                else if (key === 'Cl' && !isNaN(numValue)) setInputValue('Cl', numValue, 1);
                
                // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                else if (key === 'Fe' && !isNaN(numValue)) setInputValue('Fe', numValue, 3);
                else if (key === 'Mn' && !isNaN(numValue)) setInputValue('Mn', numValue, 3);
                else if (key === 'B' && !isNaN(numValue)) setInputValue('B', numValue, 3);
                else if (key === 'Zn' && !isNaN(numValue)) setInputValue('Zn', numValue, 3);
                else if (key === 'Cu' && !isNaN(numValue)) setInputValue('Cu', numValue, 3);
                else if (key === 'Mo' && !isNaN(numValue)) setInputValue('Mo', numValue, 3);
                else if (key === 'Co' && !isNaN(numValue)) setInputValue('Co', numValue, 3);
                else if (key === 'Si' && !isNaN(numValue)) setInputValue('Si', numValue, 3);
                
                // –û–±—ä–µ–º
                else if (key === 'V' && !isNaN(numValue)) setInputValue('volume', numValue, 1);
            });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ loadPrf)
            calcAll();
            onMicroChange();
            calcConcentrates();
            updatePriceResults();
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ .hpg –≤–∫–ª—é—á–∞—è –∂—É—Ä–Ω–∞–ª
        function parseFullFile(content) {
            const lines = content.split('\n');
            let comment = '';
            const tempJournal = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                if (line.startsWith('Comment=')) {
                    comment = line.substring(8);
                    document.getElementById('file_comment').value = comment;
                }
                // –ü–∞—Ä—Å–∏–Ω–≥ –∂—É—Ä–Ω–∞–ª–∞
                else if (line.startsWith('date=')) {
                    // –§–æ—Ä–º–∞—Ç: date=2024-10-10;–û–ø–∏—Å–∞–Ω–∏–µ;N=220 NO3=200...
                    const parts = line.substring(5).split(';');
                    if (parts.length >= 3) {
                        const date = parts[0];
                        const desc = parts[1];
                        const profileStr = parts[2];
                        
                        // –ü–∞—Ä—Å–∏–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Å—Ç—Ä–æ–∫–∏
                        const profile = {};
                        const profileParts = profileStr.trim().split(/\s+/);
                        profileParts.forEach(part => {
                            const [key, value] = part.split('=');
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                profile[key] = numValue;
                            }
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª
                        tempJournal.push({
                            date: date,
                            desc: desc,
                            memo: '', // –í –ª–µ–≥–∞—Å–∏ —Ñ–æ—Ä–º–∞—Ç–µ –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ memo
                            profile: profileStr,
                            fullProfile: profile
                        });
                    }
                }
                // –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è
                else if (line.includes('=') && !line.startsWith('#')) {
                    const [key, value] = line.split('=');
                    // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π (–Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–º–ø) —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    const trimmedValue = value ? value.trim() : '';
                    const numValue = parseFloat(trimmedValue);
                    
                    // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                    if (key === 'N' && !isNaN(numValue)) currentProfile.N = numValue;
                    else if (key === 'NO3' && !isNaN(numValue)) currentProfile.NO3 = numValue;
                    else if (key === 'NH4' && !isNaN(numValue)) currentProfile.NH4 = numValue;
                    else if (key === 'P' && !isNaN(numValue)) currentProfile.P = numValue;
                    else if (key === 'K' && !isNaN(numValue)) currentProfile.K = numValue;
                    else if (key === 'Ca' && !isNaN(numValue)) currentProfile.Ca = numValue;
                    else if (key === 'Mg' && !isNaN(numValue)) currentProfile.Mg = numValue;
                    else if (key === 'S' && !isNaN(numValue)) currentProfile.S = numValue;
                    else if (key === 'Cl' && !isNaN(numValue)) currentProfile.Cl = numValue;
                    // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                    else if (key === 'Fe' && !isNaN(numValue)) currentProfile.Fe = numValue;
                    else if (key === 'Mn' && !isNaN(numValue)) currentProfile.Mn = numValue;
                    else if (key === 'B' && !isNaN(numValue)) currentProfile.B = numValue;
                    else if (key === 'Zn' && !isNaN(numValue)) currentProfile.Zn = numValue;
                    else if (key === 'Cu' && !isNaN(numValue)) currentProfile.Cu = numValue;
                    else if (key === 'Mo' && !isNaN(numValue)) currentProfile.Mo = numValue;
                    else if (key === 'Co' && !isNaN(numValue)) currentProfile.Co = numValue;
                    else if (key === 'Si' && !isNaN(numValue)) currentProfile.Si = numValue;
                    else if (key === 'V' && !isNaN(numValue)) currentProfile.volume = numValue;
                    
                    // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤)
                    else if (key === 'CaNO3_Ca' && !isNaN(numValue)) setSaltPercent('CaNO3', 'Ca', numValue);
                    else if (key === 'CaNO3_NO3' && !isNaN(numValue)) setSaltPercent('CaNO3', 'NO3', numValue);
                    else if (key === 'CaNO3_NH4' && !isNaN(numValue)) setSaltPercent('CaNO3', 'NH4', numValue);
                    else if (key === 'KNO3_K' && !isNaN(numValue)) setSaltPercent('KNO3', 'K', numValue);
                    else if (key === 'KNO3_NO3' && !isNaN(numValue)) setSaltPercent('KNO3', 'NO3', numValue);
                    else if (key === 'NH4NO3_NH4' && !isNaN(numValue)) setSaltPercent('NH4NO3', 'NH4', numValue);
                    else if (key === 'NH4NO3_NO3' && !isNaN(numValue)) setSaltPercent('NH4NO3', 'NO3', numValue);
                    else if (key === 'MgSO4_Mg' && !isNaN(numValue)) setSaltPercent('MgSO4', 'Mg', numValue);
                    else if (key === 'MgSO4_S' && !isNaN(numValue)) setSaltPercent('MgSO4', 'S', numValue);
                    else if (key === 'KH2PO4_K' && !isNaN(numValue)) setSaltPercent('KH2PO4', 'K', numValue);
                    else if (key === 'KH2PO4_P' && !isNaN(numValue)) setSaltPercent('KH2PO4', 'P', numValue);
                    else if (key === 'K2SO4_K' && !isNaN(numValue)) setSaltPercent('K2SO4', 'K', numValue);
                    else if (key === 'K2SO4_S' && !isNaN(numValue)) setSaltPercent('K2SO4', 'S', numValue);
                    else if (key === 'MgNO3_Mg' && !isNaN(numValue)) setSaltPercent('MgNO3', 'Mg', numValue);
                    else if (key === 'MgNO3_NO3' && !isNaN(numValue)) setSaltPercent('MgNO3', 'NO3', numValue);
                    else if (key === 'CaCl2_Ca' && !isNaN(numValue)) setSaltPercent('CaCl2', 'Ca', numValue);
                    else if (key === 'CaCl2_Cl' && !isNaN(numValue)) setSaltPercent('CaCl2', 'Cl', numValue);
                    
                    // –î–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–ª—è—Ö
                    else if (key === 'dFe' && !isNaN(numValue)) setInputValue('micro_Fe_percent', numValue, 4);
                    else if (key === 'dMn' && !isNaN(numValue)) setInputValue('micro_Mn_percent', numValue, 4);
                    else if (key === 'dB' && !isNaN(numValue)) setInputValue('micro_B_percent', numValue, 4);
                    else if (key === 'dZn' && !isNaN(numValue)) setInputValue('micro_Zn_percent', numValue, 4);
                    else if (key === 'dCu' && !isNaN(numValue)) setInputValue('micro_Cu_percent', numValue, 4);
                    else if (key === 'dMo' && !isNaN(numValue)) setInputValue('micro_Mo_percent', numValue, 4);
                    else if (key === 'dCo' && !isNaN(numValue)) setInputValue('micro_Co_percent', numValue, 4);
                    else if (key === 'dSi' && !isNaN(numValue)) setInputValue('micro_Si_percent', numValue, 4);
                    
                    // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (gl)
                    else if (key === 'glCaNO3' && !isNaN(numValue)) setInputValue('conc_glCaNO3', numValue, 1);
                    else if (key === 'glKNO3' && !isNaN(numValue)) setInputValue('conc_glKNO3', numValue, 1);
                    else if (key === 'glNH4NO3' && !isNaN(numValue)) setInputValue('conc_glNH4NO3', numValue, 1);
                    else if (key === 'glMgNO3' && !isNaN(numValue)) setInputValue('conc_glMgNO3', numValue, 1);
                    else if (key === 'glMgSO4' && !isNaN(numValue)) setInputValue('conc_glMgSO4', numValue, 1);
                    else if (key === 'glK2SO4' && !isNaN(numValue)) setInputValue('conc_glK2SO4', numValue, 1);
                    else if (key === 'glKH2PO4' && !isNaN(numValue)) setInputValue('conc_glKH2PO4', numValue, 1);
                    else if (key === 'glCaCl2' && !isNaN(numValue)) setInputValue('conc_glCaCl2', numValue, 1);
                    else if (key === 'glCmplx' && !isNaN(numValue)) setInputValue('conc_glCmplx', numValue, 2);
                    else if (key === 'glFe' && !isNaN(numValue)) setInputValue('conc_glFe', numValue, 2);
                    else if (key === 'glMn' && !isNaN(numValue)) setInputValue('conc_glMn', numValue, 2);
                    else if (key === 'glB' && !isNaN(numValue)) setInputValue('conc_glB', numValue, 2);
                    else if (key === 'glZn' && !isNaN(numValue)) setInputValue('conc_glZn', numValue, 2);
                    else if (key === 'glCu' && !isNaN(numValue)) setInputValue('conc_glCu', numValue, 2);
                    else if (key === 'glMo' && !isNaN(numValue)) setInputValue('conc_glMo', numValue, 2);
                    else if (key === 'glCo' && !isNaN(numValue)) setInputValue('conc_glCo', numValue, 2);
                    else if (key === 'glSi' && !isNaN(numValue)) setInputValue('conc_glSi', numValue, 2);
                    
                    // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (gml)
                    else if (key === 'gmlCaNO3' && !isNaN(numValue)) setInputValue('conc_gmlCaNO3', numValue, 4);
                    else if (key === 'gmlKNO3' && !isNaN(numValue)) setInputValue('conc_gmlKNO3', numValue, 4);
                    else if (key === 'gmlNH4NO3' && !isNaN(numValue)) setInputValue('conc_gmlNH4NO3', numValue, 4);
                    else if (key === 'gmlMgNO3' && !isNaN(numValue)) setInputValue('conc_gmlMgNO3', numValue, 4);
                    else if (key === 'gmlMgSO4' && !isNaN(numValue)) setInputValue('conc_gmlMgSO4', numValue, 4);
                    else if (key === 'gmlK2SO4' && !isNaN(numValue)) setInputValue('conc_gmlK2SO4', numValue, 4);
                    else if (key === 'gmlKH2PO4' && !isNaN(numValue)) setInputValue('conc_gmlKH2PO4', numValue, 4);
                    else if (key === 'gmlCaCl2' && !isNaN(numValue)) setInputValue('conc_gmlCaCl2', numValue, 4);
                    else if (key === 'gmlCmplx' && !isNaN(numValue)) setInputValue('conc_gmlCmplx', numValue, 3);
                    else if (key === 'gmlFe' && !isNaN(numValue)) setInputValue('conc_gmlFe', numValue, 3);
                    else if (key === 'gmlMn' && !isNaN(numValue)) setInputValue('conc_gmlMn', numValue, 3);
                    else if (key === 'gmlB' && !isNaN(numValue)) setInputValue('conc_gmlB', numValue, 3);
                    else if (key === 'gmlZn' && !isNaN(numValue)) setInputValue('conc_gmlZn', numValue, 3);
                    else if (key === 'gmlCu' && !isNaN(numValue)) setInputValue('conc_gmlCu', numValue, 3);
                    else if (key === 'gmlMo' && !isNaN(numValue)) setInputValue('conc_gmlMo', numValue, 3);
                    else if (key === 'gmlCo' && !isNaN(numValue)) setInputValue('conc_gmlCo', numValue, 3);
                    else if (key === 'gmlSi' && !isNaN(numValue)) setInputValue('conc_gmlSi', numValue, 3);
                    
                    // –ß–µ–∫–±–æ–∫—Å—ã (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ StrToBool - —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
                    else if (key === 'chkComplex') {
                        const checkbox = document.getElementById('use_complex');
                        if (checkbox) {
                            const lowerValue = trimmedValue.toLowerCase();
                            checkbox.checked = (lowerValue === 'true' || lowerValue === '1' || lowerValue === 'yes');
                            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω chkComplex:', trimmedValue, '‚Üí', checkbox.checked);
                        }
                    }
                    else if (key === 'chK2SO4') {
                        const checkbox = document.getElementById('use_K2SO4'); // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
                        if (checkbox) {
                            const lowerValue = trimmedValue.toLowerCase();
                            checkbox.checked = (lowerValue === 'true' || lowerValue === '1' || lowerValue === 'yes');
                            useK2SO4 = checkbox.checked; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                        }
                    }
                    else if (key === 'chMgNO3') {
                        const checkbox = document.getElementById('use_MgNO3'); // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
                        if (checkbox) {
                            const lowerValue = trimmedValue.toLowerCase();
                            checkbox.checked = (lowerValue === 'true' || lowerValue === '1' || lowerValue === 'yes');
                            useMgNO3 = checkbox.checked; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                        }
                    }
                    
                    // –ù–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π (m) - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
                    else if (key === 'mCaNO3') { const el = document.getElementById('mCaNO3'); if (el) el.value = trimmedValue; }
                    else if (key === 'mKNO3') { const el = document.getElementById('mKNO3'); if (el) el.value = trimmedValue; }
                    else if (key === 'mNH4NO3') { const el = document.getElementById('mNH4NO3'); if (el) el.value = trimmedValue; }
                    else if (key === 'mMgNO3') { const el = document.getElementById('mMgNO3'); if (el) el.value = trimmedValue; }
                    else if (key === 'mMgSO4') { const el = document.getElementById('mMgSO4'); if (el) el.value = trimmedValue; }
                    else if (key === 'mKH2PO4') { const el = document.getElementById('mKH2PO4'); if (el) el.value = trimmedValue; }
                    else if (key === 'mK2SO4') { const el = document.getElementById('mK2SO4'); if (el) el.value = trimmedValue; }
                    else if (key === 'mCaCl2') { const el = document.getElementById('mCaCl2'); if (el) el.value = trimmedValue; }
                    else if (key === 'mCmplx') { const el = document.getElementById('mCmplx'); if (el) el.value = trimmedValue; }
                    else if (key === 'mFe') { const el = document.getElementById('mFe'); if (el) el.value = trimmedValue; }
                    else if (key === 'mMn') { const el = document.getElementById('mMn'); if (el) el.value = trimmedValue; }
                    else if (key === 'mB') { const el = document.getElementById('mB'); if (el) el.value = trimmedValue; }
                    else if (key === 'mZn') { const el = document.getElementById('mZn'); if (el) el.value = trimmedValue; }
                    else if (key === 'mCu') { const el = document.getElementById('mCu'); if (el) el.value = trimmedValue; }
                    else if (key === 'mMo') { const el = document.getElementById('mMo'); if (el) el.value = trimmedValue; }
                    else if (key === 'mCo') { const el = document.getElementById('mCo'); if (el) el.value = trimmedValue; }
                    else if (key === 'mSi') { const el = document.getElementById('mSi'); if (el) el.value = trimmedValue; }
                    else if (key === 'addrMixer') { const el = document.getElementById('addrMixer'); if (el) el.value = trimmedValue; }
                    else if (key === 'nmix' && !isNaN(numValue)) setInputValue('nmix', numValue, 0);
                    
                    // –û–±—ä–µ–º—ã –±–∞–∫–æ–≤
                    else if (key === 'tAml' && !isNaN(numValue)) setInputValue('tank_A', numValue, 0);
                    else if (key === 'tBml' && !isNaN(numValue)) setInputValue('tank_B', numValue, 0);
                    
                    // –¶–µ–Ω—ã (cg)
                    else if (key === 'cgCaNO3' && !isNaN(numValue)) setInputValue('price_CaNO3', numValue, 4);
                    else if (key === 'cgKNO3' && !isNaN(numValue)) setInputValue('price_KNO3', numValue, 4);
                    else if (key === 'cgNH4NO3' && !isNaN(numValue)) setInputValue('price_NH4NO3', numValue, 4);
                    else if (key === 'cgMgNO3' && !isNaN(numValue)) setInputValue('price_MgNO3', numValue, 4);
                    else if (key === 'cgMgSO4' && !isNaN(numValue)) setInputValue('price_MgSO4', numValue, 4);
                    else if (key === 'cgK2SO4' && !isNaN(numValue)) setInputValue('price_K2SO4', numValue, 4);
                    else if (key === 'cgKH2PO4' && !isNaN(numValue)) setInputValue('price_KH2PO4', numValue, 4);
                    else if (key === 'cgCaCl2' && !isNaN(numValue)) setInputValue('price_CaCl2', numValue, 4);
                    else if (key === 'cgCmplx' && !isNaN(numValue)) setInputValue('price_Cmplx', numValue, 4);
                    else if (key === 'cgFe' && !isNaN(numValue)) setInputValue('price_Fe', numValue, 4);
                    else if (key === 'cgMn' && !isNaN(numValue)) setInputValue('price_Mn', numValue, 4);
                    else if (key === 'cgB' && !isNaN(numValue)) setInputValue('price_B', numValue, 4);
                    else if (key === 'cgZn' && !isNaN(numValue)) setInputValue('price_Zn', numValue, 4);
                    else if (key === 'cgCu' && !isNaN(numValue)) setInputValue('price_Cu', numValue, 4);
                    else if (key === 'cgMo' && !isNaN(numValue)) setInputValue('price_Mo', numValue, 4);
                    else if (key === 'cgCo' && !isNaN(numValue)) setInputValue('price_Co', numValue, 4);
                    else if (key === 'cgSi' && !isNaN(numValue)) setInputValue('price_Si', numValue, 4);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∂—É—Ä–Ω–∞–ª
            journalEntries = tempJournal;
            updateJournalList();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            applyProfile();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ (–≤—Å–µ–≥–¥–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã - –æ–Ω–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ñ–∞–π–ª–∞
            const complexCheckbox = document.getElementById('use_complex');
            if (complexCheckbox) {
                onComplexChange(true); // true = –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateMobileDisplay();
            updateMobileResults();
            updateMobileSaltsValues();
            
            showCustomAlert('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ—Ñ–∏–ª—å –∏ –∂—É—Ä–Ω–∞–ª (' + tempJournal.length + ' –∑–∞–ø–∏—Å–µ–π) –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.');
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ)
        function getMicroPercent(element) {
            const id = 'micro_' + element + '_percent';
            const input = document.getElementById(id);
            return input ? (parseFloat(input.value) || 0) : 0;
        }
        
        function getConcentration(salt) {
            const id = 'conc_gl' + salt;
            const input = document.getElementById(id);
            return input ? (parseFloat(input.value) || 0) : 0;
        }
        
        function getDensity(salt) {
            const id = 'conc_gml' + salt;
            const input = document.getElementById(id);
            return input ? (parseFloat(input.value) || 0) : 0;
        }
        
        function getSaltName(salt) {
            const id = 'm' + salt;
            const input = document.getElementById(id);
            return input ? input.value : '';
        }
        
        function getTankVolume(tank) {
            const id = 'tank_' + tank;
            const input = document.getElementById(id);
            return input ? (parseFloat(input.value) || 0) : 0;
        }
        
        function getPrice(salt) {
            const id = 'price_' + salt;
            const input = document.getElementById(id);
            return input ? (parseFloat(input.value) || 0) : 0;
        }
        
        function fileSaveAs() {
            getValues();
            const comment = document.getElementById('file_comment').value;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ .hpg (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ SaveFile)
            let content = '';
            content += 'version=Hydroponic Profile Generator HTML5 https://github.com/siv237/HPG\n';
            content += 'Comment=' + (comment || '') + '\n';
            
            // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            content += 'N=' + currentProfile.N + '\n';
            content += 'NH4=' + currentProfile.NH4 + '\n';
            content += 'NO3=' + currentProfile.NO3 + '\n';
            content += 'P=' + currentProfile.P + '\n';
            content += 'K=' + currentProfile.K + '\n';
            content += 'Ca=' + currentProfile.Ca + '\n';
            content += 'Mg=' + currentProfile.Mg + '\n';
            content += 'S=' + currentProfile.S + '\n';
            content += 'Cl=' + currentProfile.Cl + '\n';
            
            // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π - –ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (Macro %)
            content += 'CaNO3_Ca=' + getSaltPercent('CaNO3', 'Ca') + '\n';
            content += 'CaNO3_NO3=' + getSaltPercent('CaNO3', 'NO3') + '\n';
            content += 'CaNO3_NH4=' + getSaltPercent('CaNO3', 'NH4') + '\n';
            content += 'KNO3_K=' + getSaltPercent('KNO3', 'K') + '\n';
            content += 'KNO3_NO3=' + getSaltPercent('KNO3', 'NO3') + '\n';
            content += 'NH4NO3_NH4=' + getSaltPercent('NH4NO3', 'NH4') + '\n';
            content += 'NH4NO3_NO3=' + getSaltPercent('NH4NO3', 'NO3') + '\n';
            content += 'MgSO4_Mg=' + getSaltPercent('MgSO4', 'Mg') + '\n';
            content += 'MgSO4_S=' + getSaltPercent('MgSO4', 'S') + '\n';
            content += 'KH2PO4_K=' + getSaltPercent('KH2PO4', 'K') + '\n';
            content += 'KH2PO4_P=' + getSaltPercent('KH2PO4', 'P') + '\n';
            content += 'K2SO4_K=' + getSaltPercent('K2SO4', 'K') + '\n';
            content += 'K2SO4_S=' + getSaltPercent('K2SO4', 'S') + '\n';
            content += 'MgNO3_Mg=' + getSaltPercent('MgNO3', 'Mg') + '\n';
            content += 'MgNO3_NO3=' + getSaltPercent('MgNO3', 'NO3') + '\n';
            content += 'CaCl2_Ca=' + getSaltPercent('CaCl2', 'Ca') + '\n';
            content += 'CaCl2_Cl=' + getSaltPercent('CaCl2', 'Cl') + '\n';
            
            // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            content += 'Fe=' + currentProfile.Fe + '\n';
            content += 'Mn=' + currentProfile.Mn + '\n';
            content += 'B=' + currentProfile.B + '\n';
            content += 'Zn=' + currentProfile.Zn + '\n';
            content += 'Cu=' + currentProfile.Cu + '\n';
            content += 'Mo=' + currentProfile.Mo + '\n';
            content += 'Co=' + currentProfile.Co + '\n';
            content += 'Si=' + currentProfile.Si + '\n';
            
            // –î–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–ª—è—Ö (Micro %)
            content += 'dFe=' + getMicroPercent('Fe') + '\n';
            content += 'dMn=' + getMicroPercent('Mn') + '\n';
            content += 'dB=' + getMicroPercent('B') + '\n';
            content += 'dZn=' + getMicroPercent('Zn') + '\n';
            content += 'dCu=' + getMicroPercent('Cu') + '\n';
            content += 'dMo=' + getMicroPercent('Mo') + '\n';
            content += 'dCo=' + getMicroPercent('Co') + '\n';
            content += 'dSi=' + getMicroPercent('Si') + '\n';
            
            // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (gl)
            content += 'glCaNO3=' + getConcentration('CaNO3') + '\n';
            content += 'glKNO3=' + getConcentration('KNO3') + '\n';
            content += 'glNH4NO3=' + getConcentration('NH4NO3') + '\n';
            content += 'glMgNO3=' + getConcentration('MgNO3') + '\n';
            content += 'glMgSO4=' + getConcentration('MgSO4') + '\n';
            content += 'glK2SO4=' + getConcentration('K2SO4') + '\n';
            content += 'glKH2PO4=' + getConcentration('KH2PO4') + '\n';
            content += 'glCaCl2=' + getConcentration('CaCl2') + '\n';
            content += 'glCmplx=' + getConcentration('Cmplx') + '\n';
            content += 'glFe=' + getConcentration('Fe') + '\n';
            content += 'glMn=' + getConcentration('Mn') + '\n';
            content += 'glB=' + getConcentration('B') + '\n';
            content += 'glZn=' + getConcentration('Zn') + '\n';
            content += 'glCu=' + getConcentration('Cu') + '\n';
            content += 'glMo=' + getConcentration('Mo') + '\n';
            content += 'glCo=' + getConcentration('Co') + '\n';
            content += 'glSi=' + getConcentration('Si') + '\n';
            
            // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (gml)
            content += 'gmlCaNO3=' + getDensity('CaNO3') + '\n';
            content += 'gmlKNO3=' + getDensity('KNO3') + '\n';
            content += 'gmlNH4NO3=' + getDensity('NH4NO3') + '\n';
            content += 'gmlMgNO3=' + getDensity('MgNO3') + '\n';
            content += 'gmlMgSO4=' + getDensity('MgSO4') + '\n';
            content += 'gmlK2SO4=' + getDensity('K2SO4') + '\n';
            content += 'gmlKH2PO4=' + getDensity('KH2PO4') + '\n';
            content += 'gmlCaCl2=' + getDensity('CaCl2') + '\n';
            content += 'gmlCmplx=' + getDensity('Cmplx') + '\n';
            content += 'gmlFe=' + getDensity('Fe') + '\n';
            content += 'gmlMn=' + getDensity('Mn') + '\n';
            content += 'gmlB=' + getDensity('B') + '\n';
            content += 'gmlZn=' + getDensity('Zn') + '\n';
            content += 'gmlCu=' + getDensity('Cu') + '\n';
            content += 'gmlMo=' + getDensity('Mo') + '\n';
            content += 'gmlCo=' + getDensity('Co') + '\n';
            content += 'gmlSi=' + getDensity('Si') + '\n';
            
            // –ß–µ–∫–±–æ–∫—Å—ã (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ - True/False —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã)
            content += 'chkComplex=' + (document.getElementById('use_complex')?.checked ? 'True' : 'False') + '\n';
            content += 'chK2SO4=' + (document.getElementById('use_K2SO4')?.checked ? 'True' : 'False') + '\n';
            content += 'chMgNO3=' + (document.getElementById('use_MgNO3')?.checked ? 'True' : 'False') + '\n';
            
            // –û–±—ä–µ–º
            content += 'V=' + (currentProfile.volume || 10) + '\n';
            
            // –ù–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π (m)
            content += 'mCaNO3=' + getSaltName('CaNO3') + '\n';
            content += 'mKNO3=' + getSaltName('KNO3') + '\n';
            content += 'mNH4NO3=' + getSaltName('NH4NO3') + '\n';
            content += 'mMgNO3=' + getSaltName('MgNO3') + '\n';
            content += 'mMgSO4=' + getSaltName('MgSO4') + '\n';
            content += 'mKH2PO4=' + getSaltName('KH2PO4') + '\n';
            content += 'mK2SO4=' + getSaltName('K2SO4') + '\n';
            content += 'mCaCl2=' + getSaltName('CaCl2') + '\n';
            content += 'mCmplx=' + getSaltName('Cmplx') + '\n';
            content += 'mFe=' + getSaltName('Fe') + '\n';
            content += 'mMn=' + getSaltName('Mn') + '\n';
            content += 'mB=' + getSaltName('B') + '\n';
            content += 'mZn=' + getSaltName('Zn') + '\n';
            content += 'mCu=' + getSaltName('Cu') + '\n';
            content += 'mMo=' + getSaltName('Mo') + '\n';
            content += 'mCo=' + getSaltName('Co') + '\n';
            content += 'mSi=' + getSaltName('Si') + '\n';
            content += 'addrMixer=' + (document.getElementById('addrMixer')?.value || '') + '\n';
            content += 'nmix=' + (document.getElementById('nmix')?.value || '') + '\n';
            
            // –û–±—ä–µ–º—ã –±–∞–∫–æ–≤
            content += 'tAml=' + getTankVolume('A') + '\n';
            content += 'tBml=' + getTankVolume('B') + '\n';
            
            // –¶–µ–Ω—ã (cg)
            content += 'cgCaNO3=' + getPrice('CaNO3') + '\n';
            content += 'cgKNO3=' + getPrice('KNO3') + '\n';
            content += 'cgNH4NO3=' + getPrice('NH4NO3') + '\n';
            content += 'cgMgNO3=' + getPrice('MgNO3') + '\n';
            content += 'cgMgSO4=' + getPrice('MgSO4') + '\n';
            content += 'cgK2SO4=' + getPrice('K2SO4') + '\n';
            content += 'cgKH2PO4=' + getPrice('KH2PO4') + '\n';
            content += 'cgCaCl2=' + getPrice('CaCl2') + '\n';
            content += 'cgCmplx=' + getPrice('Cmplx') + '\n';
            content += 'cgFe=' + getPrice('Fe') + '\n';
            content += 'cgMn=' + getPrice('Mn') + '\n';
            content += 'cgB=' + getPrice('B') + '\n';
            content += 'cgZn=' + getPrice('Zn') + '\n';
            content += 'cgCu=' + getPrice('Cu') + '\n';
            content += 'cgMo=' + getPrice('Mo') + '\n';
            content += 'cgCo=' + getPrice('Co') + '\n';
            content += 'cgSi=' + getPrice('Si') + '\n';
            
            // –ñ—É—Ä–Ω–∞–ª (–≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞)
            journalEntries.forEach(entry => {
                // –§–æ—Ä–º–∞—Ç: date=2024-10-10;–û–ø–∏—Å–∞–Ω–∏–µ;N=220 NO3=200...
                content += 'date=' + entry.date + ';' + entry.desc + ';' + entry.profile + '\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = document.getElementById('file_filename').value || 'profile.hpg';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // –ü–æ–¥–≥—Ä—É–∑–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ (–∞–Ω–∞–ª–æ–≥ Button4Click –≤ –ª–µ–≥–∞—Å–∏)
        // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¢–û–õ–¨–ö–û —Å–æ—Å—Ç–∞–≤—ã, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, —Ü–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ù–ï —Ç—Ä–æ–≥–∞—è –ø—Ä–æ—Ñ–∏–ª—å
        function fileLoadFertilizers() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.hpg,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const content = event.target.result;
                            parseCompositionsOnly(content);
                            alert(`–°–æ—Å—Ç–∞–≤—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ñ–∞–π–ª–∞: ${file.name}`);
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–¥–æ–±—Ä–µ–Ω–∏–π:', err);
                            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —É–¥–æ–±—Ä–µ–Ω–∏–π');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // –ü–æ–¥–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ —Ñ–∞–π–ª–∞ (–∞–Ω–∞–ª–æ–≥ Button5Click –≤ –ª–µ–≥–∞—Å–∏)
        // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–æ—Ñ–∏–ª—å (N, P, K, Fe –∏ —Ç.–¥.), –ù–ï —Ç—Ä–æ–≥–∞—è —Å–æ—Å—Ç–∞–≤—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function fileLoadProfile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.hpg,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const content = event.target.result;
                            parseProfileOnly(content);
                            alert(`–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞: ${file.name}`);
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
                            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø—Ä–æ—Ñ–∏–ª—è');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function showMacroHelp() {
            window.open('https://github.com/siv237/HPG/wiki/Macro', '_blank');
        }
        
        function showMicroHelp() {
            window.open('https://github.com/siv237/HPG/wiki/Micro', '_blank');
        }
        
        function showCalcHelp() {
            window.open('https://github.com/siv237/HPG/wiki/raschet', '_blank');
        }
        
        function showPreparationHelp() {
            window.open('https://github.com/siv237/HPG/wiki/izgotovlenie', '_blank');
        }
        
        function showCorrectorHelp() {
            window.open('https://github.com/siv237/HPG/wiki/correction', '_blank');
        }
        
        function showFileHelp() {
            window.open('https://github.com/siv237/HPG/wiki/file', '_blank');
        }
        
        function journalAdd() {
            const memo = document.getElementById('file_journal_memo').value;
            const date = document.getElementById('file_journal_date').value;
            
            if (!memo || !date) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É');
                return;
            }
            
            getValues();
            updateProfileString();
            const profileStr = document.getElementById('profile-string').value;
            
            const entry = {
                desc: memo,  // –û–ø–∏—Å–∞–Ω–∏–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑ memo
                date: date,
                memo: memo,
                profile: profileStr,
                fullProfile: {...currentProfile}
            };
            
            journalEntries.push(entry);
            updateJournalList();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('file_journal_date').value = '';
            document.getElementById('file_journal_memo').value = '';
        }
        
        function journalUpdate() {
            const select = document.getElementById('file_journal_list');
            const selectedIndex = select.selectedIndex;
            
            if (selectedIndex < 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                return;
            }
            
            const memo = document.getElementById('file_journal_memo').value;
            const date = document.getElementById('file_journal_date').value;
            
            if (!memo || !date) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—É');
                return;
            }
            
            getValues();
            updateProfileString();
            const profileStr = document.getElementById('profile-string').value;
            
            journalEntries[selectedIndex] = {
                desc: memo,  // –û–ø–∏—Å–∞–Ω–∏–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑ memo
                date: date,
                memo: memo,
                profile: profileStr,
                fullProfile: {...currentProfile}
            };
            
            updateJournalList();
        }
        
        function journalDelete() {
            const select = document.getElementById('file_journal_list');
            const selectedIndex = select.selectedIndex;
            
            if (selectedIndex < 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å?')) {
                journalEntries.splice(selectedIndex, 1);
                updateJournalList();
                document.getElementById('file_journal_date').value = '';
                document.getElementById('file_journal_memo').value = '';
                clearFileProfileDetails();
            }
        }
        
        function updateJournalList() {
            const select = document.getElementById('file_journal_list');
            select.innerHTML = '';
            
            journalEntries.forEach((entry, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${entry.date} - ${entry.desc}`;
                select.appendChild(option);
            });
            
            // –ï—Å–ª–∏ –∂—É—Ä–Ω–∞–ª –ø—É—Å—Ç–æ–π, –æ—á–∏—â–∞–µ–º –ø–æ–ª—è
            if (journalEntries.length === 0) {
                document.getElementById('file_journal_date').value = '';
                document.getElementById('file_journal_memo').value = '';
                document.getElementById('file_profile_info').value = ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º .value –¥–ª—è input
                clearFileProfileDetails();
            }
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            localStorage.setItem('hpg_journal', JSON.stringify(journalEntries));
        }
        
        function acceptProfileFromJournal() {
            const select = document.getElementById('file_journal_list');
            const selectedIndex = select.selectedIndex;
            
            if (selectedIndex < 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ –∂—É—Ä–Ω–∞–ª–∞');
                return;
            }
            
            // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ file_profile_info –≤ profile-string (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: profile.Caption := pr2.Caption)
            const profileFromJournal = document.getElementById('file_profile_info').value;
            document.getElementById('profile-string').value = profileFromJournal;
            
            // –í—ã–∑—ã–≤–∞–µ–º –ø–∞—Ä—Å–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: LoadProfile)
            parseProfile();
        }
        
        function clearFileProfileDetails() {
            document.getElementById('rN').textContent = '';
            document.getElementById('rNO3').textContent = '';
            document.getElementById('rNH4').textContent = '';
            document.getElementById('rP').textContent = '';
            document.getElementById('rK').textContent = '';
            document.getElementById('rCa').textContent = '';
            document.getElementById('rMg').textContent = '';
            document.getElementById('rS').textContent = '';
            document.getElementById('rCl').textContent = '';
            document.getElementById('rFe').textContent = '';
            document.getElementById('rMn').textContent = '';
            document.getElementById('rB').textContent = '';
            document.getElementById('rZn').textContent = '';
            document.getElementById('rCu').textContent = '';
            document.getElementById('rMo').textContent = '';
            document.getElementById('rCo').textContent = '';
            document.getElementById('rSi').textContent = '';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('file_journal_list');
            if (select) {
                select.addEventListener('change', function() {
                    const selectedIndex = this.selectedIndex;
                    if (selectedIndex >= 0 && selectedIndex < journalEntries.length) {
                        const entry = journalEntries[selectedIndex];
                        document.getElementById('file_journal_date').value = entry.date;
                        document.getElementById('file_journal_memo').value = entry.memo || entry.desc;  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
                        document.getElementById('file_profile_info').value = entry.profile;
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                        getValues();
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏)
                        const p = entry.fullProfile;
                        
                        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
                        const calcPercent = (current, journal) => {
                            if (journal > 0) {
                                return Math.round((current - journal) / journal * 100);
                            }
                            return 0;
                        };
                        
                        // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                        const vN = currentProfile.N || 0;
                        const vNO3 = currentProfile.NO3 || 0;
                        const vNH4 = currentProfile.NH4 || 0;
                        const vP = currentProfile.P || 0;
                        const vK = currentProfile.K || 0;
                        const vCa = currentProfile.Ca || 0;
                        const vMg = currentProfile.Mg || 0;
                        const vS = currentProfile.S || 0;
                        const vCl = currentProfile.Cl || 0;
                        
                        // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                        const vFe = currentProfile.Fe || 0;
                        const vMn = currentProfile.Mn || 0;
                        const vB = currentProfile.B || 0;
                        const vZn = currentProfile.Zn || 0;
                        const vCu = currentProfile.Cu || 0;
                        const vMo = currentProfile.Mo || 0;
                        const vCo = currentProfile.Co || 0;
                        const vSi = currentProfile.Si || 0;
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
                        document.getElementById('rN').textContent = p.N > 0 ? `N:(${calcPercent(vN, p.N)}%)` : '';
                        document.getElementById('rNO3').textContent = p.NO3 > 0 ? `NO3:(${calcPercent(vNO3, p.NO3)}%)` : '';
                        document.getElementById('rNH4').textContent = p.NH4 > 0 ? `NH4:(${calcPercent(vNH4, p.NH4)}%)` : '';
                        document.getElementById('rP').textContent = p.P > 0 ? `P:(${calcPercent(vP, p.P)}%)` : '';
                        document.getElementById('rK').textContent = p.K > 0 ? `K:(${calcPercent(vK, p.K)}%)` : '';
                        document.getElementById('rCa').textContent = p.Ca > 0 ? `Ca:(${calcPercent(vCa, p.Ca)}%)` : '';
                        document.getElementById('rMg').textContent = p.Mg > 0 ? `Mg:(${calcPercent(vMg, p.Mg)}%)` : '';
                        document.getElementById('rS').textContent = p.S > 0 ? `S:(${calcPercent(vS, p.S)}%)` : '';
                        document.getElementById('rCl').textContent = p.Cl > 0 ? `Cl:(${calcPercent(vCl, p.Cl)}%)` : '-';
                        
                        // –î–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–µ–ª–∏–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ 1000 (–º–∫–≥/–ª -> –º–≥/–ª)
                        document.getElementById('rFe').textContent = p.Fe > 0 ? `Fe:(${calcPercent(vFe/1000, p.Fe)}%)` : 'Fe: -';
                        document.getElementById('rMn').textContent = p.Mn > 0 ? `Mn:(${calcPercent(vMn/1000, p.Mn)}%)` : 'Mn: -';
                        document.getElementById('rB').textContent = p.B > 0 ? `B:(${calcPercent(vB/1000, p.B)}%)` : 'B: -';
                        document.getElementById('rZn').textContent = p.Zn > 0 ? `Zn:(${calcPercent(vZn/1000, p.Zn)}%)` : 'Zn: -';
                        document.getElementById('rCu').textContent = p.Cu > 0 ? `Cu:(${calcPercent(vCu/1000, p.Cu)}%)` : 'Cu: -';
                        document.getElementById('rMo').textContent = p.Mo > 0 ? `Mo:(${calcPercent(vMo/1000, p.Mo)}%)` : 'Mo: -';
                        document.getElementById('rCo').textContent = p.Co > 0 ? `Co:(${calcPercent(vCo/1000, p.Co)}%)` : 'Co: -';
                        document.getElementById('rSi').textContent = p.Si > 0 ? `Si:(${calcPercent(vSi/1000, p.Si)}%)` : 'Si: -';
                    }
                });
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –∏–∑ localStorage
            const savedJournal = localStorage.getItem('hpg_journal');
            if (savedJournal) {
                try {
                    journalEntries = JSON.parse(savedJournal);
                    updateJournalList();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞:', e);
                }
            }
        });

        // –ö–æ—Ä—Ä–µ–∫—Ç–æ—Ä
        function fillColumn(columnName) {
            getValues();
            const prefix = columnName === 'initial' ? 'init' : 
                          columnName === 'current' ? 'curr' : 
                          columnName === 'correcting' ? 'corr' : 'final';
            
            document.getElementById(`corr_${prefix}_N`).value = currentProfile.N.toFixed(3);
            document.getElementById(`corr_${prefix}_NO3`).value = currentProfile.NO3.toFixed(2);
            document.getElementById(`corr_${prefix}_NH4`).value = currentProfile.NH4.toFixed(2);
            document.getElementById(`corr_${prefix}_P`).value = currentProfile.P.toFixed(3);
            document.getElementById(`corr_${prefix}_K`).value = currentProfile.K.toFixed(3);
            document.getElementById(`corr_${prefix}_Ca`).value = currentProfile.Ca.toFixed(3);
            document.getElementById(`corr_${prefix}_Mg`).value = currentProfile.Mg.toFixed(3);
            document.getElementById(`corr_${prefix}_S`).value = currentProfile.S.toFixed(3);
            document.getElementById(`corr_${prefix}_Cl`).value = currentProfile.Cl.toFixed(1);
            document.getElementById(`corr_${prefix}_EC`).value = currentProfile.EC.toFixed(3);
        }

        // ===== –§–£–ù–ö–¶–ò–ò –ö–û–†–†–ï–ö–¢–û–†–ê =====
        
        // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
        let activeCorrectColumn = null;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
        function onCorrectorChange(event) {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
            korrection();
        }
        
        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ korrection –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 2580)
        function korrection() {
            // –ò—Å—Ö–æ–¥–Ω—ã–π (0) - –∫–æ–ª–æ–Ω–∫–∞ init
            const V_0 = parseFloat(document.getElementById('corr_init_vol').value) || 10;
            const V_2 = parseFloat(document.getElementById('corr_final_vol').value) || 30;
            
            // –¢–µ–∫—É—â–∏–π (1) - –∫–æ–ª–æ–Ω–∫–∞ curr  
            let V_1 = 10; // —Ç–µ–∫—É—â–∏–π –≤—Å–µ–≥–¥–∞ 10 –ª–∏—Ç—Ä–æ–≤ (—É—Å–ª–æ–≤–Ω–æ)
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º V_2 –µ—Å–ª–∏ –æ–Ω –º–µ–Ω—å—à–µ V_1
            if (V_0 >= V_2) {
                document.getElementById('corr_final_vol').value = (V_0 + 10).toFixed(1);
            }
            
            // –ü–µ—Ä–µ—Å—á–µ—Ç S –∏ EC –¥–ª—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ
            calculateCorrectorS('init');
            calculateCorrectorEC('init');
            const N_0 = parseFloat(document.getElementById('corr_init_NO3').value) + 
                       parseFloat(document.getElementById('corr_init_NH4').value);
            document.getElementById('corr_init_N').value = N_0.toFixed(3);
            
            // –¢–µ–∫—É—â–∏–π = –∏—Å—Ö–æ–¥–Ω—ã–π √ó (EC_1 / EC_0) - —É—á–µ—Ç –∏—Å–ø–∞—Ä–µ–Ω–∏—è –≤–æ–¥—ã
            const EC_0 = parseFloat(document.getElementById('corr_init_EC').value) || 1;
            const EC_1 = parseFloat(document.getElementById('corr_curr_EC').value) || EC_0;
            const kEC = EC_0 !== 0 ? EC_1 / EC_0 : 1;
            
            const elements = ['NO3', 'NH4', 'P', 'K', 'Ca', 'Mg', 'Cl'];
            elements.forEach(elem => {
                const val_0 = parseFloat(document.getElementById(`corr_init_${elem}`).value) || 0;
                document.getElementById(`corr_curr_${elem}`).value = (val_0 * kEC).toFixed(elem === 'NO3' || elem === 'NH4' ? 2 : 3);
            });
            
            // S –∏ N –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ
            calculateCorrectorS('curr');
            const N_1 = parseFloat(document.getElementById('corr_curr_NO3').value) + 
                       parseFloat(document.getElementById('corr_curr_NH4').value);
            document.getElementById('corr_curr_N').value = N_1.toFixed(3);
            document.getElementById('corr_curr_EC').value = EC_1.toFixed(3);
            
            // –û–±—ä–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–≥–æ
            const V_k = V_2 - V_1;
            document.getElementById('corr_corr_vol').value = V_k.toFixed(1);
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ –±–∞–ª–∞–Ω—Å–∞ –º–∞—Å—Å:
            // C_k = (C_2 * V_2 - C_1 * V_1) / V_k
            elements.forEach(elem => {
                const C_1 = parseFloat(document.getElementById(`corr_curr_${elem}`).value) || 0;
                const C_2 = parseFloat(document.getElementById(`corr_final_${elem}`).value) || 0;
                const C_k = V_k !== 0 ? (C_2 * V_2 - C_1 * V_1) / V_k : 0;
                document.getElementById(`corr_corr_${elem}`).value = C_k.toFixed(elem === 'NO3' || elem === 'NH4' ? 2 : 3);
            });
            
            // S, EC –∏ N –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–µ–≥–æ
            calculateCorrectorS('corr');
            calculateCorrectorEC('corr');
            const N_k = parseFloat(document.getElementById('corr_corr_NO3').value) + 
                       parseFloat(document.getElementById('corr_corr_NH4').value);
            document.getElementById('corr_corr_N').value = N_k.toFixed(3);
            
            // S, EC –∏ N –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ
            calculateCorrectorS('final');
            calculateCorrectorEC('final');
            const N_2 = parseFloat(document.getElementById('corr_final_NO3').value) + 
                       parseFloat(document.getElementById('corr_final_NH4').value);
            document.getElementById('corr_final_N').value = N_2.toFixed(3);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
            updateCorrectionProtocol();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ (–∞–Ω–∞–ª–æ–≥ mkorr –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 2667-2689)
        function updateCorrectionProtocol() {
            const protocol = document.getElementById('corrector_protocol');
            if (!protocol) return;
            
            const V_1 = 10;
            const V_2 = parseFloat(document.getElementById('corr_final_vol').value) || 30;
            const EC_1 = parseFloat(document.getElementById('corr_curr_EC').value) || 1;
            const EC_2 = parseFloat(document.getElementById('corr_final_EC').value) || 1;
            const N_1 = parseFloat(document.getElementById('corr_curr_N').value) || 0;
            const N_2 = parseFloat(document.getElementById('corr_final_N').value) || 0;
            
            const NO3_1 = parseFloat(document.getElementById('corr_curr_NO3').value) || 1;
            const NO3_2 = parseFloat(document.getElementById('corr_final_NO3').value) || 1;
            const NH4_1 = parseFloat(document.getElementById('corr_curr_NH4').value) || 1;
            const NH4_2 = parseFloat(document.getElementById('corr_final_NH4').value) || 1;
            const P_1 = parseFloat(document.getElementById('corr_curr_P').value) || 1;
            const P_2 = parseFloat(document.getElementById('corr_final_P').value) || 1;
            const K_1 = parseFloat(document.getElementById('corr_curr_K').value) || 1;
            const K_2 = parseFloat(document.getElementById('corr_final_K').value) || 1;
            const Ca_1 = parseFloat(document.getElementById('corr_curr_Ca').value) || 1;
            const Ca_2 = parseFloat(document.getElementById('corr_final_Ca').value) || 1;
            const Mg_1 = parseFloat(document.getElementById('corr_curr_Mg').value) || 1;
            const Mg_2 = parseFloat(document.getElementById('corr_final_Mg').value) || 1;
            const S_1 = parseFloat(document.getElementById('corr_curr_S').value) || 0;
            const S_2 = parseFloat(document.getElementById('corr_final_S').value) || 0;
            const Cl_1 = parseFloat(document.getElementById('corr_curr_Cl').value) || 0;
            const Cl_2 = parseFloat(document.getElementById('corr_final_Cl').value) || 0;
            
            let text = '–û–°–ù–û–í–ù–û–ï:\n';
            text += `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –Ω–∞: ${Math.round((V_2 - V_1) / V_1 * 100)}%\n`;
            text += `–î–æ–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞: ${Math.round(V_1 / V_2 * 100)}%\n`;
            text += `–ò–∑–º–µ–Ω–µ–Ω–∏–µ EC –Ω–∞: ${Math.round((EC_2 - EC_1) / EC_1 * 100)}%\n`;
            text += `–ò–∑–º–µ–Ω–µ–Ω–∏–µ N –æ–±—â–∏–π –Ω–∞: ${Math.round((N_2 - N_1) / N_1 * 100)}%\n\n`;
            
            text += '–ü–†–û–§–ò–õ–¨:\n';
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è NO3 –Ω–∞: ${Math.round((NO3_2 - NO3_1) / NO3_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è NH4 –Ω–∞: ${Math.round((NH4_2 - NH4_1) / NH4_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è P –Ω–∞: ${Math.round((P_2 - P_1) / P_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è K –Ω–∞: ${Math.round((K_2 - K_1) / K_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Ca –Ω–∞: ${Math.round((Ca_2 - Ca_1) / Ca_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Mg –Ω–∞: ${Math.round((Mg_2 - Mg_1) / Mg_1 * 100)}%\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è S –Ω–∞: ${Math.round(S_2 - S_1)} ppm\n`;
            text += `–ö–æ—Ä—Ä–µ–∫—Ü–∏—è Cl –Ω–∞: ${Math.round(Cl_2 - Cl_1)} ppm\n\n`;
            
            text += '–°–û–û–¢–ù–û–®–ï–ù–ò–Ø:\n';
            text += `NH4:NO3 –¥–æ ${(NH4_1/NO3_1).toFixed(3)} –ø–æ—Å–ª–µ ${(NH4_2/NO3_2).toFixed(3)}\n`;
            text += `K:N –¥–æ ${(K_1/N_1).toFixed(3)} –ø–æ—Å–ª–µ ${(K_2/N_2).toFixed(3)}\n`;
            text += `K:Ca –¥–æ ${(K_1/Ca_1).toFixed(3)} –ø–æ—Å–ª–µ ${(K_2/Ca_2).toFixed(3)}\n`;
            text += `K:Mg –¥–æ ${(K_1/Mg_1).toFixed(3)} –ø–æ—Å–ª–µ ${(K_2/Mg_2).toFixed(3)}`;
            
            protocol.value = text;
        }
        
        // –†–∞—Å—á–µ—Ç —Å–µ—Ä—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ CalculateS)
        function calculateCorrectorS(prefix) {
            const molN = 14.0067;
            const molP = 30.973762;
            const molK = 39.0983;
            const molCa = 40.078;
            const molMg = 24.305;
            const molS = 32.065;
            const molCl = 35.453;
            
            const NO3 = parseFloat(document.getElementById(`corr_${prefix}_NO3`).value) || 0;
            const NH4 = parseFloat(document.getElementById(`corr_${prefix}_NH4`).value) || 0;
            const P = parseFloat(document.getElementById(`corr_${prefix}_P`).value) || 0;
            const K = parseFloat(document.getElementById(`corr_${prefix}_K`).value) || 0;
            const Ca = parseFloat(document.getElementById(`corr_${prefix}_Ca`).value) || 0;
            const Mg = parseFloat(document.getElementById(`corr_${prefix}_Mg`).value) || 0;
            const Cl = parseFloat(document.getElementById(`corr_${prefix}_Cl`).value) || 0;
            
            // –§–æ—Ä–º—É–ª–∞ –∏–∑ –ª–µ–≥–∞—Å–∏ (—Å—Ç—Ä–æ–∫–∞ 1029)
            const S = (-molS * (-NH4*molCa*molMg*molK*molP*molCl - 2*Ca*molN*molMg*molK*molP*molCl - 
                      2*Mg*molN*molCa*molK*molP*molCl - K*molN*molCa*molMg*molP*molCl + 
                      NO3*molCa*molMg*molK*molP*molCl + P*molN*molCa*molMg*molK*molCl + 
                      Cl*molN*molCa*molMg*molK*molP)) / (2*molN*molCa*molMg*molK*molP*molCl);
            
            const sField = document.getElementById(`corr_${prefix}_S`);
            if (sField) {
                // –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞–∂–µ –¥–ª—è readonly –ø–æ–ª–µ–π
                sField.value = S.toFixed(3);
            }
        }
        
        // –†–∞—Å—á–µ—Ç EC –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ CalcEC)
        function calculateCorrectorEC(prefix) {
            const molN = 14.0067;
            const molK = 39.0983;
            const molCa = 40.078;
            const molMg = 24.305;
            
            const NH4 = parseFloat(document.getElementById(`corr_${prefix}_NH4`).value) || 0;
            const K = parseFloat(document.getElementById(`corr_${prefix}_K`).value) || 0;
            const Ca = parseFloat(document.getElementById(`corr_${prefix}_Ca`).value) || 0;
            const Mg = parseFloat(document.getElementById(`corr_${prefix}_Mg`).value) || 0;
            
            // –§–æ—Ä–º—É–ª–∞ –∏–∑ –ª–µ–≥–∞—Å–∏ (—Å—Ç—Ä–æ–∫–∞ 1017)
            const EC = 0.095 * (NH4*molCa*molMg*molK + 2*Ca*molN*molMg*molK + 
                       2*Mg*molN*molCa*molK + K*molN*molCa*molMg + 2*molN*molCa*molMg*molK) / 
                       (molN*molCa*molMg*molK);
            
            const ecField = document.getElementById(`corr_${prefix}_EC`);
            if (ecField) {
                // –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞–∂–µ –¥–ª—è readonly –ø–æ–ª–µ–π
                ecField.value = EC.toFixed(3);
            }
        }
        
        
        // –ö–Ω–æ–ø–∫–∞ "–í —Ä–∞—Å—á–µ—Ç" - –ø–µ—Ä–µ–Ω–æ—Å –∑–Ω–∞—á–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        function calcCorrection(columnName) {
            const prefix = columnName === 'initial' ? 'init' : 
                          columnName === 'current' ? 'curr' : 
                          columnName === 'correcting' ? 'corr' : 'final';
            
            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('N').value = document.getElementById(`corr_${prefix}_N`).value;
            document.getElementById('NO3').value = document.getElementById(`corr_${prefix}_NO3`).value;
            document.getElementById('NH4').value = document.getElementById(`corr_${prefix}_NH4`).value;
            document.getElementById('P').value = document.getElementById(`corr_${prefix}_P`).value;
            document.getElementById('K').value = document.getElementById(`corr_${prefix}_K`).value;
            document.getElementById('Ca').value = document.getElementById(`corr_${prefix}_Ca`).value;
            document.getElementById('Mg').value = document.getElementById(`corr_${prefix}_Mg`).value;
            document.getElementById('S').value = document.getElementById(`corr_${prefix}_S`).value;
            document.getElementById('Cl').value = document.getElementById(`corr_${prefix}_Cl`).value;
            document.getElementById('EC').value = document.getElementById(`corr_${prefix}_EC`).value;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–º
            const vol = document.getElementById(`corr_${prefix}_vol`);
            if (vol && vol.value) {
                document.getElementById('volume').value = vol.value;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
            calcAll();
        }
        
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initCorrector() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
            const correctorInputs = document.querySelectorAll('.corrector-input');
            correctorInputs.forEach(input => {
                input.addEventListener('input', onCorrectorChange);
                input.addEventListener('focus', function(e) {
                    const id = e.target.id;
                    if (id.includes('_init_')) activeCorrectColumn = 'init';
                    else if (id.includes('_corr_')) activeCorrectColumn = 'corr';
                    else if (id.includes('_final_')) activeCorrectColumn = 'final';
                });
            });
            
            // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
            korrection();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∂—É—Ä–Ω–∞–ª –∫–æ—Ä—Ä–µ–∫—Ü–∏–π (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ tojrnlClick)
        function saveCorrectorToJournal() {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ yyyy-mm-dd
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            // –ü–æ–ª—É—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ–±—ä–µ–º
            const finalVolume = parseFloat(document.getElementById('corr_final_vol')?.value) || 30;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: m1.Text)
            const desc = `–ö–æ—Ä—Ä–µ–∫—Ç–æ—Ä. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞—Å—Ç–≤–æ—Ä –¥–æ ${finalVolume} –ª–∏—Ç—Ä–æ–≤.`;
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ò—Ç–æ–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (N_2, NO3_2 –∏ —Ç.–¥. –≤ –ª–µ–≥–∞—Å–∏)
            const N = parseFloat(document.getElementById('corr_final_N')?.value) || 0;
            const NO3 = parseFloat(document.getElementById('corr_final_NO3')?.value) || 0;
            const NH4 = parseFloat(document.getElementById('corr_final_NH4')?.value) || 0;
            const P = parseFloat(document.getElementById('corr_final_P')?.value) || 0;
            const K = parseFloat(document.getElementById('corr_final_K')?.value) || 0;
            const Ca = parseFloat(document.getElementById('corr_final_Ca')?.value) || 0;
            const Mg = parseFloat(document.getElementById('corr_final_Mg')?.value) || 0;
            const S = parseFloat(document.getElementById('corr_final_S')?.value) || 0;
            const Cl = parseFloat(document.getElementById('corr_final_Cl')?.value) || 0;
            
            // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã (–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏)
            const Fe = (parseFloat(document.getElementById('Fe')?.value) || 0) / 1000;
            const Mn = (parseFloat(document.getElementById('Mn')?.value) || 0) / 1000;
            const B = (parseFloat(document.getElementById('B')?.value) || 0) / 1000;
            const Zn = (parseFloat(document.getElementById('Zn')?.value) || 0) / 1000;
            const Cu = (parseFloat(document.getElementById('Cu')?.value) || 0) / 1000;
            const Mo = (parseFloat(document.getElementById('Mo')?.value) || 0) / 1000;
            const Co = (parseFloat(document.getElementById('Co')?.value) || 0) / 1000;
            const Si = (parseFloat(document.getElementById('Si')?.value) || 0) / 1000;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ str)
            const profileStr = `N=${N} NO3=${NO3} NH4=${NH4} P=${P} K=${K} Ca=${Ca} Mg=${Mg} S=${S} Cl=${Cl} Fe=${Fe} Mn=${Mn} B=${B} Zn=${Zn} Cu=${Cu} Mo=${Mo} Co=${Co} Si=${Si}`;
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: date=...;...;...)
            const journalEntry = {
                date: dateStr,
                desc: desc,
                memo: desc, // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
                profile: profileStr
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∂—É—Ä–Ω–∞–ª
            journalEntries.push(journalEntry);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∂—É—Ä–Ω–∞–ª –ø–æ –¥–∞—Ç–µ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ DStr.Sort)
            journalEntries.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å–≤–µ—Ä—Ö—É
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∂—É—Ä–Ω–∞–ª–∞
            updateJournalList();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–§–∞–π–ª" —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            switchTab('file', document.querySelector('[onclick*="file"]'));
            
            alert('–î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∂—É—Ä–Ω–∞–ª');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ CalcConc –∏–∑ –ª–µ–≥–∞—Å–∏)
        // –í –ª–µ–≥–∞—Å–∏ CalcConc –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï CalcWeight –∏ microToWeght
        // –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è gCaNO3, gKNO3, gFe –∏ —Ç.–¥.
        function calcConcentrates() {
            const volume = parseFloat(document.getElementById('volume').value) || 10;
            
            // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (–≥/–ª) - —á–∏—Ç–∞–µ–º –∏–∑ –ø–æ–ª–µ–π –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const glCaNO3 = parseFloat(document.getElementById('conc_glCaNO3')?.value) || 600;
            const glKNO3 = parseFloat(document.getElementById('conc_glKNO3')?.value) || 250;
            const glNH4NO3 = parseFloat(document.getElementById('conc_glNH4NO3')?.value) || 100;
            const glMgNO3 = parseFloat(document.getElementById('conc_glMgNO3')?.value) || 500;
            const glCaCl2 = parseFloat(document.getElementById('conc_glCaCl2')?.value) || 100;
            const glMgSO4 = parseFloat(document.getElementById('conc_glMgSO4')?.value) || 600;
            const glKH2PO4 = parseFloat(document.getElementById('conc_glKH2PO4')?.value) || 150;
            const glK2SO4 = parseFloat(document.getElementById('conc_glK2SO4')?.value) || 100;
            const glFe = parseFloat(document.getElementById('conc_glFe')?.value) || 10;
            const glMn = parseFloat(document.getElementById('conc_glMn')?.value) || 10;
            const glB = parseFloat(document.getElementById('conc_glB')?.value) || 10;
            const glZn = parseFloat(document.getElementById('conc_glZn')?.value) || 10;
            const glCu = parseFloat(document.getElementById('conc_glCu')?.value) || 10;
            const glMo = parseFloat(document.getElementById('conc_glMo')?.value) || 10;
            const glCo = parseFloat(document.getElementById('conc_glCo')?.value) || 10;
            const glSi = parseFloat(document.getElementById('conc_glSi')?.value) || 10;
            const glCmplx = parseFloat(document.getElementById('conc_glCmplx')?.value) || 10;
            
            // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ (–≥/–º–ª) - —á–∏—Ç–∞–µ–º –∏–∑ –ø–æ–ª–µ–π –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            const gmlCaNO3 = parseFloat(document.getElementById('conc_gmlCaNO3')?.value) || 1;
            const gmlKNO3 = parseFloat(document.getElementById('conc_gmlKNO3')?.value) || 1;
            const gmlNH4NO3 = parseFloat(document.getElementById('conc_gmlNH4NO3')?.value) || 1;
            const gmlMgNO3 = parseFloat(document.getElementById('conc_gmlMgNO3')?.value) || 1;
            const gmlCaCl2 = parseFloat(document.getElementById('conc_gmlCaCl2')?.value) || 1;
            const gmlMgSO4 = parseFloat(document.getElementById('conc_gmlMgSO4')?.value) || 1;
            const gmlKH2PO4 = parseFloat(document.getElementById('conc_gmlKH2PO4')?.value) || 1;
            const gmlK2SO4 = parseFloat(document.getElementById('conc_gmlK2SO4')?.value) || 1;
            const gmlFe = parseFloat(document.getElementById('conc_gmlFe')?.value) || 1;
            const gmlMn = parseFloat(document.getElementById('conc_gmlMn')?.value) || 1;
            const gmlB = parseFloat(document.getElementById('conc_gmlB')?.value) || 1;
            const gmlZn = parseFloat(document.getElementById('conc_gmlZn')?.value) || 1;
            const gmlCu = parseFloat(document.getElementById('conc_gmlCu')?.value) || 1;
            const gmlMo = parseFloat(document.getElementById('conc_gmlMo')?.value) || 1;
            const gmlCo = parseFloat(document.getElementById('conc_gmlCo')?.value) || 1;
            const gmlSi = parseFloat(document.getElementById('conc_gmlSi')?.value) || 1;
            const gmlCmplx = parseFloat(document.getElementById('conc_gmlCmplx')?.value) || 1;
            
            // –ß–∏—Ç–∞–µ–º –≥—Ä–∞–º–º—ã —Å–æ–ª–µ–π –∏–∑ –ø–æ–ª–µ–π (—É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω—ã –≤ calcWeight)
            // –í –ª–µ–≥–∞—Å–∏: Kf.mlCaNO3.Value:=Kf.gCaNO3.value/Kf.glCaNO3.value*1000
            const gCaNO3 = parseFloat(document.getElementById('g_CaNO3')?.value) || 0;
            const gKNO3 = parseFloat(document.getElementById('g_KNO3')?.value) || 0;
            const gNH4NO3 = parseFloat(document.getElementById('g_NH4NO3')?.value) || 0;
            const gMgNO3 = parseFloat(document.getElementById('g_MgNO3')?.value) || 0;
            const gCaCl2 = parseFloat(document.getElementById('g_CaCl2')?.value) || 0;
            const gMgSO4 = parseFloat(document.getElementById('g_MgSO4')?.value) || 0;
            const gKH2PO4 = parseFloat(document.getElementById('g_KH2PO4')?.value) || 0;
            const gK2SO4 = parseFloat(document.getElementById('g_K2SO4')?.value) || 0;
            
            // –ß–∏—Ç–∞–µ–º –≥—Ä–∞–º–º—ã –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –ø–æ–ª–µ–π (—É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω—ã –≤ microToWeght)
            // –í –ª–µ–≥–∞—Å–∏: if Kf.dFe.value >0 then Kf.gFe.value:=Kf.Fe.value/Kf.dFe.value*Kf.V.value/10000
            const gFe = parseFloat(document.getElementById('g_Fe')?.value) || 0;
            const gMn = parseFloat(document.getElementById('g_Mn')?.value) || 0;
            const gB = parseFloat(document.getElementById('g_B')?.value) || 0;
            const gZn = parseFloat(document.getElementById('g_Zn')?.value) || 0;
            const gCu = parseFloat(document.getElementById('g_Cu')?.value) || 0;
            const gMo = parseFloat(document.getElementById('g_Mo')?.value) || 0;
            const gCo = parseFloat(document.getElementById('g_Co')?.value) || 0;
            const gSi = parseFloat(document.getElementById('g_Si')?.value) || 0;
            
            // –ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å—É–º–º–∞ –≤—Å–µ—Ö)
            const gCmplx = gFe + gMn + gB + gZn + gCu + gMo + gCo + gSi;
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è Fe, Mn –∏ —Ç.–¥. –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ mlFe
            const Fe = parseFloat(document.getElementById('Fe')?.value) || 0;
            const Mn = parseFloat(document.getElementById('Mn')?.value) || 0;
            const B = parseFloat(document.getElementById('B')?.value) || 0;
            const Zn = parseFloat(document.getElementById('Zn')?.value) || 0;
            const Cu = parseFloat(document.getElementById('Cu')?.value) || 0;
            const Mo = parseFloat(document.getElementById('Mo')?.value) || 0;
            const Co = parseFloat(document.getElementById('Co')?.value) || 0;
            const Si = parseFloat(document.getElementById('Si')?.value) || 0;
            
            const dFe = parseFloat(document.getElementById('micro_Fe_percent').value) || 20.1;
            const dMn = parseFloat(document.getElementById('micro_Mn_percent').value) || 36.4;
            const dB = parseFloat(document.getElementById('micro_B_percent').value) || 17.5;
            const dZn = parseFloat(document.getElementById('micro_Zn_percent').value) || 22.7;
            const dCu = parseFloat(document.getElementById('micro_Cu_percent').value) || 25.5;
            const dMo = parseFloat(document.getElementById('micro_Mo_percent').value) || 54.3;
            const dCo = parseFloat(document.getElementById('micro_Co_percent').value) || 13.0;
            const dSi = parseFloat(document.getElementById('micro_Si_percent').value) || 7.0;
            
            // –†–∞—Å—á–µ—Ç –º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞
            // –î–ª—è –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤: mlCaNO3 = gCaNO3 / glCaNO3 * 1000
            const mlCaNO3 = gCaNO3 / glCaNO3 * 1000;
            const mlKNO3 = gKNO3 / glKNO3 * 1000;
            const mlNH4NO3 = gNH4NO3 / glNH4NO3 * 1000;
            const mlMgNO3 = gMgNO3 / glMgNO3 * 1000;
            const mlCaCl2 = gCaCl2 / glCaCl2 * 1000;
            const mlMgSO4 = gMgSO4 / glMgSO4 * 1000;
            const mlKH2PO4 = gKH2PO4 / glKH2PO4 * 1000;
            const mlK2SO4 = gK2SO4 / glK2SO4 * 1000;
            
            // –î–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤: mlFe = (Fe / dFe * V / 10) / glFe (–ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 1559)
            const mlFe = dFe > 0 ? ((Fe / dFe * volume / 10) / glFe) : 0;
            const mlMn = dMn > 0 ? ((Mn / dMn * volume / 10) / glMn) : 0;
            const mlB = dB > 0 ? ((B / dB * volume / 10) / glB) : 0;
            const mlZn = dZn > 0 ? ((Zn / dZn * volume / 10) / glZn) : 0;
            const mlCu = dCu > 0 ? ((Cu / dCu * volume / 10) / glCu) : 0;
            const mlMo = dMo > 0 ? ((Mo / dMo * volume / 10) / glMo) : 0;
            const mlCo = dCo > 0 ? ((Co / dCo * volume / 10) / glCo) : 0;
            const mlSi = dSi > 0 ? ((Si / dSi * volume / 10) / glSi) : 0;
            const mlCmplx = dB > 0 ? ((B / dB * volume / 10) / glCmplx) : 0;
            
            // –†–∞—Å—á–µ—Ç –≥—Ä–∞–º–º–æ–≤ –¥–ª—è –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: ggCaNO3 = gmlCaNO3 * mlCaNO3)
            const ggCaNO3 = gmlCaNO3 * mlCaNO3;
            const ggKNO3 = gmlKNO3 * mlKNO3;
            const ggNH4NO3 = gmlNH4NO3 * mlNH4NO3;
            const ggMgNO3 = gmlMgNO3 * mlMgNO3;
            const ggCaCl2 = gmlCaCl2 * mlCaCl2;
            const ggMgSO4 = gmlMgSO4 * mlMgSO4;
            const ggKH2PO4 = gmlKH2PO4 * mlKH2PO4;
            const ggK2SO4 = gmlK2SO4 * mlK2SO4;
            const ggFe = gmlFe * mlFe;
            const ggMn = gmlMn * mlMn;
            const ggB = gmlB * mlB;
            const ggZn = gmlZn * mlZn;
            const ggCu = gmlCu * mlCu;
            const ggMo = gmlMo * mlMo;
            const ggCo = gmlCo * mlCo;
            const ggSi = gmlSi * mlSi;
            const ggCmplx = gmlCmplx * mlCmplx;
            
            // –†–∞—Å—á–µ—Ç —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ A –∏ B (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ CalcConc —Å—Ç—Ä–æ–∫–∏ 1672-1712)
            const Av = Math.round((mlCaNO3 + mlKNO3 + mlNH4NO3 + mlMgNO3 + mlCaCl2) * 10000) / 10000;
            const Am = Math.round((ggCaNO3 + ggKNO3 + ggNH4NO3 + ggMgNO3 + ggCaCl2) * 10000) / 10000;
            const Ak = Math.round(Am / Av * 100) / 100;
            
            const useComplex = document.getElementById('use_complex')?.checked;
            let Bv, Bm, Bk;
            if (useComplex) {
                Bv = Math.round((mlMgSO4 + mlKH2PO4 + mlK2SO4 + mlCmplx) * 10000) / 10000;
                Bm = Math.round((ggMgSO4 + ggKH2PO4 + ggK2SO4 + ggCmplx) * 10000) / 10000;
                Bk = Math.round(Bm / Bv * 1000) / 1000;
            } else {
                Bv = mlMgSO4 + mlKH2PO4 + mlK2SO4 + mlFe + mlMn + mlB + mlZn + mlMo + mlCu + mlCo + mlSi;
                Bm = Math.round((ggMgSO4 + ggKH2PO4 + ggK2SO4 + ggFe + ggMn + ggB + ggZn + ggMo + ggCo + ggSi) * 100) / 100;
                Bk = Math.round(Bm / Bv * 100) / 100;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            const sumAElement = document.getElementById('sumA');
            const sumBElement = document.getElementById('sumB');
            if (sumAElement) {
                sumAElement.textContent = `–û–±—ä–µ–º: ${Av.toFixed(2)} –º–ª, –≤–µ—Å: ${Am.toFixed(2)} –≥—Ä, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: ${Ak.toFixed(2)} –≥/–º–ª.`;
            }
            if (sumBElement) {
                sumBElement.textContent = `–û–±—ä–µ–º: ${(Math.round(Bv * 10) / 10).toFixed(1)} –º–ª, –≤–µ—Å: ${Bm.toFixed(2)} –≥—Ä, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å: ${Bk.toFixed(2)} –≥/–º–ª`;
            }
            
            // –†–∞—Å—á—ë—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞—Ä–µ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1675-1680, 1708-1712)
            const tAml = parseFloat(document.getElementById('tank_A')?.value) || 500;
            const tBml = parseFloat(document.getElementById('tank_B')?.value) || 500;
            
            const Ac = tAml !== 0 ? Math.round(volume / tAml * 1000) : 0;
            const Aw = Math.round(tAml - Av);
            const Aml = Math.round(tAml / volume * 1000) / 1000;
            
            const Bc = tBml !== 0 ? Math.round(volume / tBml * 1000) : 0;
            const Bw = Math.round(tBml - Bv);
            const Bml = Math.round(tBml / volume * 1000) / 1000;
            
            const lVolAElement = document.getElementById('lVolA');
            const lVolBElement = document.getElementById('lVolB');
            if (lVolAElement) {
                lVolAElement.textContent = `–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç A (${Ac}:1) . –î–æ–ª–∏—Ç—å –≤–æ–¥—ã: ${Aw}–º–ª. –ü–æ ${Aml} –º–ª –Ω–∞ 1–ª.`;
            }
            if (lVolBElement) {
                lVolBElement.textContent = `–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç B (${Bc}:1) . –î–æ–ª–∏—Ç—å –≤–æ–¥—ã: ${Bw}–º–ª. –ü–æ ${Bml} –º–ª –Ω–∞ 1–ª.`;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞—Å—á–µ—Ç–∞ (–ø–µ—Ä–µ–¥–∞—ë–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ ml* –∏ gg*)
            updateConcentrateTable('A', {
                CaNO3: { g_l: glCaNO3, g_ml: gmlCaNO3, ml: mlCaNO3, gr: ggCaNO3 },
                KNO3: { g_l: glKNO3, g_ml: gmlKNO3, ml: mlKNO3, gr: ggKNO3 },
                NH4NO3: { g_l: glNH4NO3, g_ml: gmlNH4NO3, ml: mlNH4NO3, gr: ggNH4NO3 },
                MgNO3: { g_l: glMgNO3, g_ml: gmlMgNO3, ml: mlMgNO3, gr: ggMgNO3 },
                CaCl2: { g_l: glCaCl2, g_ml: gmlCaCl2, ml: mlCaCl2, gr: ggCaCl2 }
            });
            
            // –í —Ä–µ–∂–∏–º–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–ª–µ–∫—Å, –∏–Ω–∞—á–µ –≤—Å–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
            const microData = useComplex ? {
                Cmplx: { g_l: glCmplx, g_ml: gmlCmplx, ml: mlCmplx, gr: ggCmplx }
            } : {
                Fe: { g_l: glFe, g_ml: gmlFe, ml: mlFe, gr: ggFe },
                Mn: { g_l: glMn, g_ml: gmlMn, ml: mlMn, gr: ggMn },
                B: { g_l: glB, g_ml: gmlB, ml: mlB, gr: ggB },
                Zn: { g_l: glZn, g_ml: gmlZn, ml: mlZn, gr: ggZn },
                Cu: { g_l: glCu, g_ml: gmlCu, ml: mlCu, gr: ggCu },
                Mo: { g_l: glMo, g_ml: gmlMo, ml: mlMo, gr: ggMo },
                Co: { g_l: glCo, g_ml: gmlCo, ml: mlCo, gr: ggCo },
                Si: { g_l: glSi, g_ml: gmlSi, ml: mlSi, gr: ggSi }
            };
            
            updateConcentrateTable('B', {
                MgSO4: { g_l: glMgSO4, g_ml: gmlMgSO4, ml: mlMgSO4, gr: ggMgSO4 },
                KH2PO4: { g_l: glKH2PO4, g_ml: gmlKH2PO4, ml: mlKH2PO4, gr: ggKH2PO4 },
                K2SO4: { g_l: glK2SO4, g_ml: gmlK2SO4, ml: mlK2SO4, gr: ggK2SO4 },
                ...microData
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
            updateSaltNames();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–ø–µ—Ä–µ–¥–∞—ë–º gg* - –≥—Ä–∞–º–º—ã –¥–ª—è –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è)
            updatePreparationTab({
                CaNO3: ggCaNO3, KNO3: ggKNO3, NH4NO3: ggNH4NO3, MgNO3: ggMgNO3, CaCl2: ggCaCl2,
                MgSO4: ggMgSO4, KH2PO4: ggKH2PO4, K2SO4: ggK2SO4,
                Fe: ggFe, Mn: ggMn, B: ggB, Zn: ggZn, Cu: ggCu, Mo: ggMo, Co: ggCo, Si: ggSi,
                Cmplx: ggCmplx
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ —Ü–µ–Ω—ã - –Ω–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ updatePriceResults() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ calcAll()
            // –∏ –±–µ—Ä–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–æ–ª–µ–π g_CaNO3, g_KNO3 –∏ —Ç.–¥.
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (–∞–Ω–∞–ª–æ–≥ legacy —Å—Ç—Ä–æ–∫–∏ 1623-1630)
        function updateMicroNames() {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–ª—è—Ö (–∞–Ω–∞–ª–æ–≥ legacy —Å—Ç—Ä–æ–∫–∏ 1623-1630)
            const dFe = parseFloat(document.getElementById('micro_Fe_percent').value) || 0;
            const dMn = parseFloat(document.getElementById('micro_Mn_percent').value) || 0;
            const dB = parseFloat(document.getElementById('micro_B_percent').value) || 0;
            const dZn = parseFloat(document.getElementById('micro_Zn_percent').value) || 0;
            const dCu = parseFloat(document.getElementById('micro_Cu_percent').value) || 0;
            const dMo = parseFloat(document.getElementById('micro_Mo_percent').value) || 0;
            const dCo = parseFloat(document.getElementById('micro_Co_percent').value) || 0;
            const dSi = parseFloat(document.getElementById('micro_Si_percent').value) || 0;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤: "–ñ–µ–ª–µ–∑–æ Fe=20.1%"
            const nFe = '–ñ–µ–ª–µ–∑–æ Fe=' + dFe + '%';
            const nMn = '–ú–∞—Ä–≥–∞–Ω–µ—Ü Mn=' + dMn + '%';
            const nB = '–ë–æ—Ä B=' + dB + '%';
            const nZn = '–¶–∏–Ω–∫ Zn=' + dZn + '%';
            const nCu = '–ú–µ–¥—å Cu=' + dCu + '%';
            const nMo = '–ú–æ–ª–∏–±–¥–µ–Ω Mo=' + dMo + '%';
            const nCo = '–ö–æ–±–∞–ª—å—Ç Co=' + dCo + '%';
            const nSi = '–ö—Ä–µ–º–Ω–∏–π Si=' + dSi + '%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ "–†–∞—Å—á–µ—Ç –º–æ–Ω–æ—Ä–∞—Å—Ç–≤–æ—Ä–æ–≤ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤" (—Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏)
            const concLabelFe = document.getElementById('conc-label-Fe');
            const concLabelMn = document.getElementById('conc-label-Mn');
            const concLabelB = document.getElementById('conc-label-B');
            const concLabelZn = document.getElementById('conc-label-Zn');
            const concLabelCu = document.getElementById('conc-label-Cu');
            const concLabelMo = document.getElementById('conc-label-Mo');
            const concLabelCo = document.getElementById('conc-label-Co');
            const concLabelSi = document.getElementById('conc-label-Si');
            
            if (concLabelFe) concLabelFe.textContent = nFe;
            if (concLabelMn) concLabelMn.textContent = nMn;
            if (concLabelB) concLabelB.textContent = nB;
            if (concLabelZn) concLabelZn.textContent = nZn;
            if (concLabelCu) concLabelCu.textContent = nCu;
            if (concLabelMo) concLabelMo.textContent = nMo;
            if (concLabelCo) concLabelCo.textContent = nCo;
            if (concLabelSi) concLabelSi.textContent = nSi;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ú–∏–∫—Ä–æ" –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π" (–±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ)
            const microLabelFe = document.getElementById('micro_Fe_label');
            const microLabelMn = document.getElementById('micro_Mn_label');
            const microLabelB = document.getElementById('micro_B_label');
            const microLabelZn = document.getElementById('micro_Zn_label');
            const microLabelCu = document.getElementById('micro_Cu_label');
            const microLabelMo = document.getElementById('micro_Mo_label');
            const microLabelCo = document.getElementById('micro_Co_label');
            const microLabelSi = document.getElementById('micro_Si_label');
            
            if (microLabelFe) microLabelFe.textContent = '–ñ–µ–ª–µ–∑–æ';
            if (microLabelMn) microLabelMn.textContent = '–ú–∞—Ä–≥–∞–Ω–µ—Ü';
            if (microLabelB) microLabelB.textContent = '–ë–æ—Ä';
            if (microLabelZn) microLabelZn.textContent = '–¶–∏–Ω–∫';
            if (microLabelCu) microLabelCu.textContent = '–ú–µ–¥—å';
            if (microLabelMo) microLabelMo.textContent = '–ú–æ–ª–∏–±–¥–µ–Ω';
            if (microLabelCo) microLabelCo.textContent = '–ö–æ–±–∞–ª—å—Ç';
            if (microLabelSi) microLabelSi.textContent = '–ö—Ä–µ–º–Ω–∏–π';
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö (–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ, —Ü–µ–Ω—ã)
            return {
                Fe: nFe,
                Mn: nMn,
                B: nB,
                Zn: nZn,
                Cu: nCu,
                Mo: nMo,
                Co: nCo,
                Si: nSi
            };
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π —Å–æ–ª–µ–π –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (–∞–Ω–∞–ª–æ–≥ SoilName –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1990-2073)
        function updateSaltNames() {
            const round1 = (val) => Math.round(val * 10) / 10;
            
            // –ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π
            const CaNO3_Ca = parseFloat(document.getElementById('salt_CaNO3_Ca')?.value) || 16.972;
            const CaNO3_NO3 = parseFloat(document.getElementById('salt_CaNO3_NO3')?.value) || 11.863;
            const CaNO3_NH4 = parseFloat(document.getElementById('salt_CaNO3_NH4')?.value) || 0;
            
            let nCaNO3;
            if (CaNO3_NH4 === 0) {
                const ca = round1(CaNO3_Ca);
                if (ca === 17) nCaNO3 = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*4H2O';
                else if (ca === 20) nCaNO3 = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2*2H2O';
                else if (ca === 24.4) nCaNO3 = '–ö–∞–ª—å—Ü–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Ca(NO3)2';
                else nCaNO3 = `–°–µ–ª–∏—Ç—Ä–∞ –∫–∞–ª—å—Ü–∏–µ–≤–∞—è CaO-${round1(CaNO3_Ca/0.714691)}% N-${round1(CaNO3_NH4+CaNO3_NO3)}%`;
            } else {
                nCaNO3 = `–°–µ–ª–∏—Ç—Ä–∞ –∫–∞–ª—å—Ü–∏–µ–≤–∞—è CaO-${round1(CaNO3_Ca/0.714691)}% N-${round1(CaNO3_NH4+CaNO3_NO3)}%`;
            }
            
            // –ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π
            const KNO3_K = parseFloat(document.getElementById('salt_KNO3_K')?.value) || 38.672;
            const KNO3_NO3 = parseFloat(document.getElementById('salt_KNO3_NO3')?.value) || 13.854;
            const nKNO3 = round1(KNO3_K) === 38.7 
                ? '–ö–∞–ª–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π KNO3'
                : `–°–µ–ª–∏—Ç—Ä–∞ –∫–∞–ª–∏–µ–≤–∞—è K2O-${round1(KNO3_K/0.830148)}% N-${round1(KNO3_NO3)}%`;
            
            // –ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π
            const NH4NO3_NH4 = parseFloat(document.getElementById('salt_NH4NO3_NH4')?.value) || 17.499;
            const NH4NO3_NO3 = parseFloat(document.getElementById('salt_NH4NO3_NO3')?.value) || 17.499;
            const nNH4NO3 = round1(NH4NO3_NO3) === 17.5
                ? '–ê–º–º–æ–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π NH4NO3'
                : `–°–µ–ª–∏—Ç—Ä–∞ –∞–º–º–∏–∞—á–Ω–∞—è N-${round1(NH4NO3_NH4+NH4NO3_NO3)}%`;
            
            // –ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π
            const MgSO4_Mg = parseFloat(document.getElementById('salt_MgSO4_Mg')?.value) || 9.861;
            const MgSO4_S = parseFloat(document.getElementById('salt_MgSO4_S')?.value) || 13.01;
            let nMgSO4;
            const mg = round1(MgSO4_Mg);
            if (mg === 9.9) nMgSO4 = '–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4*7H2O';
            else if (mg === 20.2) nMgSO4 = '–ú–∞–≥–Ω–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π MgSO4';
            else nMgSO4 = `–°—É–ª—å—Ñ–∞—Ç –º–∞–≥–Ω–∏—è MgO-${round1(MgSO4_Mg/0.603036)}% SO3-${round1(MgSO4_S/0.400496)}%`;
            
            // –ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π
            const KH2PO4_K = parseFloat(document.getElementById('salt_KH2PO4_K')?.value) || 28.731;
            const KH2PO4_P = parseFloat(document.getElementById('salt_KH2PO4_P')?.value) || 22.761;
            const nKH2PO4 = round1(KH2PO4_K) === 28.7
                ? '–ö–∞–ª–∏–π —Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π KH2PO4'
                : `–ú–æ–Ω–æ—Ñ–æ—Å—Ñ–∞—Ç –∫–∞–ª–∏—è K2O-${round1(KH2PO4_K/0.830148)}% P2O5-${round1(KH2PO4_P/0.436421)}%`;
            
            // –ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π
            const K2SO4_K = parseFloat(document.getElementById('salt_K2SO4_K')?.value) || 44.874;
            const K2SO4_S = parseFloat(document.getElementById('salt_K2SO4_S')?.value) || 18.401;
            const nK2SO4 = round1(K2SO4_K) === 44.9
                ? '–ö–∞–ª–∏–π —Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π K2SO4'
                : `–°—É–ª—å—Ñ–∞—Ç –∫–∞–ª–∏—è K2O-${round1(K2SO4_K/0.830148)}% SO3-${round1(K2SO4_S/0.400496)}%`;
            
            // –ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π
            const MgNO3_Mg = parseFloat(document.getElementById('salt_MgNO3_Mg')?.value) || 9.479;
            const MgNO3_NO3 = parseFloat(document.getElementById('salt_MgNO3_NO3')?.value) || 10.926;
            let nMgNO3;
            const mgn = round1(MgNO3_Mg);
            if (mgn === 9.5) nMgNO3 = '–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2*6H2O';
            else if (mgn === 16.4) nMgNO3 = '–ú–∞–≥–Ω–∏–π –∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π Mg(NO3)2';
            else nMgNO3 = `–°–µ–ª–∏—Ç—Ä–∞ –º–∞–≥–Ω–∏–µ–≤–∞—è MgO-${round1(MgNO3_Mg/0.603036)}% N-${round1(MgNO3_NO3)}%`;
            
            // –•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è
            const CaCl2_Ca = parseFloat(document.getElementById('salt_CaCl2_Ca')?.value) || 18.294;
            const CaCl2_Cl = parseFloat(document.getElementById('salt_CaCl2_Cl')?.value) || 32.366;
            let nCaCl2;
            const cacl = round1(CaCl2_Ca);
            if (cacl === 18.3) nCaCl2 = '–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è 6-–≤–æ–¥–Ω—ã–π CaCl2*6H2O';
            else if (cacl === 36.1) nCaCl2 = '–•–ª–æ—Ä–∏–¥ –∫–∞–ª—å—Ü–∏—è –±–µ–∑–≤–æ–¥–Ω—ã–π CaCl2';
            else nCaCl2 = `–ö–∞–ª—å—Ü–∏–π —Ö–ª–æ—Ä–∏—Å—Ç—ã–π CaO-${round1(CaCl2_Ca/0.714691)}% Cl-${round1(CaCl2_Cl)}%`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ú–∞–∫—Ä–æ"
            const labelCaNO3 = document.getElementById('label_CaNO3');
            const labelKNO3 = document.getElementById('label_KNO3');
            const labelNH4NO3 = document.getElementById('label_NH4NO3');
            const labelMgSO4 = document.getElementById('label_MgSO4');
            const labelKH2PO4 = document.getElementById('label_KH2PO4');
            const labelK2SO4 = document.getElementById('label_K2SO4');
            const labelMgNO3 = document.getElementById('label_MgNO3');
            const labelCaCl2 = document.getElementById('label_CaCl2');
            
            if (labelCaNO3) labelCaNO3.textContent = nCaNO3;
            if (labelKNO3) labelKNO3.textContent = nKNO3;
            if (labelNH4NO3) labelNH4NO3.textContent = nNH4NO3;
            if (labelMgSO4) labelMgSO4.textContent = nMgSO4;
            if (labelKH2PO4) labelKH2PO4.textContent = nKH2PO4;
            if (labelK2SO4) labelK2SO4.textContent = nK2SO4;
            if (labelMgNO3) labelMgNO3.textContent = nMgNO3;
            if (labelCaCl2) labelCaCl2.textContent = nCaCl2;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
            return {
                CaNO3: nCaNO3,
                KNO3: nKNO3,
                NH4NO3: nNH4NO3,
                MgSO4: nMgSO4,
                KH2PO4: nKH2PO4,
                K2SO4: nK2SO4,
                MgNO3: nMgNO3,
                CaCl2: nCaCl2
            };
        }
        
        function updateConcentrateTable(section, data) {
            const saltNames = updateSaltNames();
            const tableBodies = document.querySelectorAll('#calc .concentrate-table tbody');
            tableBodies.forEach(tableBody => {
                const rows = tableBody.querySelectorAll('tr');
            
                rows.forEach(row => {
                    const firstCell = row.cells[0];
                    const cellText = firstCell.textContent;
                    let key = '';
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ —á–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É)
                    if (cellText.includes('–∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('Ca')) key = 'CaNO3';
                    else if (cellText.includes('–∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('K')) key = 'KNO3';
                    else if (cellText.includes('–∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('NH4')) key = 'NH4NO3';
                    else if (cellText.includes('–∞–∑–æ—Ç–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('Mg')) key = 'MgNO3';
                    else if (cellText.includes('—Ö–ª–æ—Ä–∏–¥') || cellText.includes('–•–ª–æ—Ä–∏–¥') || cellText.includes('—Ö–ª–æ—Ä–∏—Å—Ç—ã–π')) key = 'CaCl2';
                    else if (cellText.includes('—Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('Mg')) key = 'MgSO4';
                    else if (cellText.includes('—Ñ–æ—Å—Ñ–æ—Ä–Ω–æ–∫–∏—Å–ª—ã–π') || cellText.includes('–ú–æ–Ω–æ—Ñ–æ—Å—Ñ–∞—Ç')) key = 'KH2PO4';
                    else if (cellText.includes('—Å–µ—Ä–Ω–æ–∫–∏—Å–ª—ã–π') && cellText.includes('K')) key = 'K2SO4';
                    else if (cellText.includes('Fe=')) key = 'Fe';
                    else if (cellText.includes('Mn=')) key = 'Mn';
                    else if (cellText.includes('B=')) key = 'B';
                    else if (cellText.includes('Zn=')) key = 'Zn';
                    else if (cellText.includes('Cu=')) key = 'Cu';
                    else if (cellText.includes('Mo=')) key = 'Mo';
                    else if (cellText.includes('Co=')) key = 'Co';
                    else if (cellText.includes('Si=')) key = 'Si';
                    else if (cellText.includes('–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤')) key = 'Cmplx';
                    
                    if (key && data[key]) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–ª–∏
                        if (saltNames[key]) {
                            firstCell.textContent = saltNames[key];
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
                        row.cells[1].querySelector('input').value = data[key].g_l.toFixed(1);
                        row.cells[2].querySelector('input').value = data[key].g_ml.toFixed(4);
                        row.cells[3].querySelector('input').value = data[key].ml.toFixed(2);
                        row.cells[4].querySelector('input').value = data[key].gr.toFixed(2);
                    }
                });
            });
        }
        
        function updatePreparationTab(weights) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('g2gCaNO3').value = weights.CaNO3.toFixed(2);
            document.getElementById('g2gKNO3').value = weights.KNO3.toFixed(2);
            document.getElementById('g2gNH4NO3').value = weights.NH4NO3.toFixed(2);
            document.getElementById('g2gMgNO3').value = weights.MgNO3.toFixed(2);
            document.getElementById('g2gCaCl2').value = weights.CaCl2.toFixed(2);
            document.getElementById('g2gMgSO4').value = weights.MgSO4.toFixed(2);
            document.getElementById('g2gKH2PO4').value = weights.KH2PO4.toFixed(2);
            document.getElementById('g2gK2SO4').value = weights.K2SO4.toFixed(2);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const isComplexMode = document.getElementById('use_complex')?.checked || false;
            
            if (isComplexMode) {
                // –í —Ä–µ–∂–∏–º–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ –∫–æ–º–ø–ª–µ–∫—Å–∞
                document.getElementById('g2gCmplx').value = weights.Cmplx.toFixed(2);
            } else {
                // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                document.getElementById('g2gFe').value = weights.Fe.toFixed(2);
                document.getElementById('g2gMn').value = weights.Mn.toFixed(2);
                document.getElementById('g2gB').value = weights.B.toFixed(2);
                document.getElementById('g2gZn').value = weights.Zn.toFixed(2);
                document.getElementById('g2gCu').value = weights.Cu.toFixed(2);
                document.getElementById('g2gMo').value = weights.Mo.toFixed(2);
                document.getElementById('g2gCo').value = weights.Co.toFixed(2);
                document.getElementById('g2gSi').value = weights.Si.toFixed(2);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–∞–Ω–∞–ª–æ–≥ SoilName –∏–∑ –ª–µ–≥–∞—Å–∏)
            const saltNames = updateSaltNames();
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–∞–Ω–∞–ª–æ–≥ legacy —Å—Ç—Ä–æ–∫–∏ 1623-1630)
            const microNames = updateMicroNames();
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–∞–Ω–∞–ª–æ–≥ CalcConc –∏–∑ –ª–µ–≥–∞—Å–∏)
            const glCaNO3 = parseFloat(document.getElementById('conc_glCaNO3')?.value) || 600;
            const glKNO3 = parseFloat(document.getElementById('conc_glKNO3')?.value) || 250;
            const glNH4NO3 = parseFloat(document.getElementById('conc_glNH4NO3')?.value) || 100;
            const glMgNO3 = parseFloat(document.getElementById('conc_glMgNO3')?.value) || 500;
            const glCaCl2 = parseFloat(document.getElementById('conc_glCaCl2')?.value) || 100;
            const glMgSO4 = parseFloat(document.getElementById('conc_glMgSO4')?.value) || 600;
            const glKH2PO4 = parseFloat(document.getElementById('conc_glKH2PO4')?.value) || 150;
            const glK2SO4 = parseFloat(document.getElementById('conc_glK2SO4')?.value) || 100;
            
            const gmlCaNO3 = parseFloat(document.getElementById('conc_gmlCaNO3')?.value) || 1.0000;
            const gmlKNO3 = parseFloat(document.getElementById('conc_gmlKNO3')?.value) || 1.0000;
            const gmlNH4NO3 = parseFloat(document.getElementById('conc_gmlNH4NO3')?.value) || 1.0000;
            const gmlMgNO3 = parseFloat(document.getElementById('conc_gmlMgNO3')?.value) || 1.0000;
            const gmlCaCl2 = parseFloat(document.getElementById('conc_gmlCaCl2')?.value) || 1.0000;
            const gmlMgSO4 = parseFloat(document.getElementById('conc_gmlMgSO4')?.value) || 1.0000;
            const gmlKH2PO4 = parseFloat(document.getElementById('conc_gmlKH2PO4')?.value) || 1.0000;
            const gmlK2SO4 = parseFloat(document.getElementById('conc_gmlK2SO4')?.value) || 1.0000;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å –≤–µ—Å–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è–º–∏ (–∫–∞–∫ –≤ legacy CalcConc —Å—Ç—Ä–æ–∫–∏ 1652-1659)
            const k2nCaNO3 = document.querySelector('label[for="k2nCaNO3"]');
            const k2nKNO3 = document.querySelector('label[for="k2nKNO3"]');
            const k2nNH4NO3 = document.querySelector('label[for="k2nNH4NO3"]');
            const k2nMgNO3 = document.querySelector('label[for="k2nMgNO3"]');
            const k2nMgSO4 = document.querySelector('label[for="k2nMgSO4"]');
            const k2nKH2PO4 = document.querySelector('label[for="k2nKH2PO4"]');
            const k2nK2SO4 = document.querySelector('label[for="k2nK2SO4"]');
            const k2nCaCl2 = document.querySelector('label[for="k2nCaCl2"]');
            
            if (k2nCaNO3) k2nCaNO3.textContent = `${saltNames.CaNO3} ${weights.CaNO3.toFixed(3)} –≥. (${glCaNO3} –≥/–ª, ${gmlCaNO3.toFixed(4)} –≥/–º–ª)`;
            if (k2nKNO3) k2nKNO3.textContent = `${saltNames.KNO3} ${weights.KNO3.toFixed(3)} –≥. (${glKNO3} –≥/–ª, ${gmlKNO3.toFixed(4)} –≥/–º–ª)`;
            if (k2nNH4NO3) k2nNH4NO3.textContent = `${saltNames.NH4NO3} ${weights.NH4NO3.toFixed(3)} –≥. (${glNH4NO3} –≥/–ª, ${gmlNH4NO3.toFixed(4)} –≥/–º–ª)`;
            if (k2nMgNO3) k2nMgNO3.textContent = `${saltNames.MgNO3} ${weights.MgNO3.toFixed(3)} –≥. (${glMgNO3} –≥/–ª, ${gmlMgNO3.toFixed(4)} –≥/–º–ª)`;
            if (k2nMgSO4) k2nMgSO4.textContent = `${saltNames.MgSO4} ${weights.MgSO4.toFixed(3)} –≥. (${glMgSO4} –≥/–ª, ${gmlMgSO4.toFixed(4)} –≥/–º–ª)`;
            if (k2nKH2PO4) k2nKH2PO4.textContent = `${saltNames.KH2PO4} ${weights.KH2PO4.toFixed(3)} –≥. (${glKH2PO4} –≥/–ª, ${gmlKH2PO4.toFixed(4)} –≥/–º–ª)`;
            if (k2nK2SO4) k2nK2SO4.textContent = `${saltNames.K2SO4} ${weights.K2SO4.toFixed(3)} –≥. (${glK2SO4} –≥/–ª, ${gmlK2SO4.toFixed(4)} –≥/–º–ª)`;
            if (k2nCaCl2) k2nCaCl2.textContent = `${saltNames.CaCl2} ${weights.CaCl2.toFixed(3)} –≥. (${glCaCl2} –≥/–ª, ${gmlCaCl2.toFixed(4)} –≥/–º–ª)`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ CalcConc —Å—Ç—Ä–æ–∫–∏ 1662-1669)
            const glFe = parseFloat(document.getElementById('conc_glFe')?.value) || 10;
            const glMn = parseFloat(document.getElementById('conc_glMn')?.value) || 10;
            const glB = parseFloat(document.getElementById('conc_glB')?.value) || 10;
            const glZn = parseFloat(document.getElementById('conc_glZn')?.value) || 10;
            const glCu = parseFloat(document.getElementById('conc_glCu')?.value) || 10;
            const glMo = parseFloat(document.getElementById('conc_glMo')?.value) || 10;
            const glCo = parseFloat(document.getElementById('conc_glCo')?.value) || 10;
            const glSi = parseFloat(document.getElementById('conc_glSi')?.value) || 10;
            
            const gmlFe = parseFloat(document.getElementById('conc_gmlFe')?.value) || 1.000;
            const gmlMn = parseFloat(document.getElementById('conc_gmlMn')?.value) || 1.000;
            const gmlB = parseFloat(document.getElementById('conc_gmlB')?.value) || 1.000;
            const gmlZn = parseFloat(document.getElementById('conc_gmlZn')?.value) || 1.000;
            const gmlCu = parseFloat(document.getElementById('conc_gmlCu')?.value) || 1.000;
            const gmlMo = parseFloat(document.getElementById('conc_gmlMo')?.value) || 1.000;
            const gmlCo = parseFloat(document.getElementById('conc_gmlCo')?.value) || 1.000;
            const gmlSi = parseFloat(document.getElementById('conc_gmlSi')?.value) || 1.000;
            
            const l2Cmplx = document.querySelector('.prep-complex-text');
            const l2Fe = document.querySelector('label[for="l2Fe"]');
            const l2Mn = document.querySelector('label[for="l2Mn"]');
            const l2B = document.querySelector('label[for="l2B"]');
            const l2Zn = document.querySelector('label[for="l2Zn"]');
            const l2Cu = document.querySelector('label[for="l2Cu"]');
            const l2Mo = document.querySelector('label[for="l2Mo"]');
            const l2Co = document.querySelector('label[for="l2Co"]');
            const l2Si = document.querySelector('label[for="l2Si"]');
            
            if (l2Cmplx) l2Cmplx.textContent = `–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ ${weights.Cmplx.toFixed(3)} –≥. (10 –≥/–ª, 1.000 –≥/–º–ª)`;
            if (l2Fe) l2Fe.textContent = `${microNames.Fe} ${weights.Fe.toFixed(3)} –≥. (${glFe} –≥/–ª, ${gmlFe.toFixed(3)} –≥/–º–ª)`;
            if (l2Mn) l2Mn.textContent = `${microNames.Mn} ${weights.Mn.toFixed(3)} –≥. (${glMn} –≥/–ª, ${gmlMn.toFixed(3)} –≥/–º–ª)`;
            if (l2B) l2B.textContent = `${microNames.B} ${weights.B.toFixed(3)} –≥. (${glB} –≥/–ª, ${gmlB.toFixed(3)} –≥/–º–ª)`;
            if (l2Zn) l2Zn.textContent = `${microNames.Zn} ${weights.Zn.toFixed(3)} –≥. (${glZn} –≥/–ª, ${gmlZn.toFixed(3)} –≥/–º–ª)`;
            if (l2Cu) l2Cu.textContent = `${microNames.Cu} ${weights.Cu.toFixed(3)} –≥. (${glCu} –≥/–ª, ${gmlCu.toFixed(3)} –≥/–º–ª)`;
            if (l2Mo) l2Mo.textContent = `${microNames.Mo} ${weights.Mo.toFixed(3)} –≥. (${glMo} –≥/–ª, ${gmlMo.toFixed(3)} –≥/–º–ª)`;
            if (l2Co) l2Co.textContent = `${microNames.Co} ${weights.Co.toFixed(3)} –≥. (${glCo} –≥/–ª, ${gmlCo.toFixed(3)} –≥/–º–ª)`;
            if (l2Si) l2Si.textContent = `${microNames.Si} ${weights.Si.toFixed(3)} –≥. (${glSi} –≥/–ª, ${gmlSi.toFixed(3)} –≥/–º–ª)`;
        }
        
        // –ü–µ—Ä–µ–≤–æ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤–µ—Å–æ–∫ –≤ –ø—Ä–æ—Ñ–∏–ª—å (–∞–Ω–∞–ª–æ–≥ btchClick –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 4269-4301)
        function transferToProfile() {
            // 1. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≥—Ä–∞–º–º—ã –∏–∑ –Ω–∞–≤–µ—Å–æ–∫: gSalt = (g2gSalt * glSalt) / (1000 * gmlSalt)
            const g2g = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            const gl = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            const gml = (id) => parseFloat(document.getElementById(id)?.value) || 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–º–º—ã –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('g_CaNO3').value = ((g2g('g2gCaNO3') * gl('conc_glCaNO3')) / (1000 * gml('conc_gmlCaNO3'))).toFixed(5);
            document.getElementById('g_KNO3').value = ((g2g('g2gKNO3') * gl('conc_glKNO3')) / (1000 * gml('conc_gmlKNO3'))).toFixed(5);
            document.getElementById('g_NH4NO3').value = ((g2g('g2gNH4NO3') * gl('conc_glNH4NO3')) / (1000 * gml('conc_gmlNH4NO3'))).toFixed(5);
            document.getElementById('g_MgSO4').value = ((g2g('g2gMgSO4') * gl('conc_glMgSO4')) / (1000 * gml('conc_gmlMgSO4'))).toFixed(5);
            document.getElementById('g_KH2PO4').value = ((g2g('g2gKH2PO4') * gl('conc_glKH2PO4')) / (1000 * gml('conc_gmlKH2PO4'))).toFixed(5);
            document.getElementById('g_K2SO4').value = ((g2g('g2gK2SO4') * gl('conc_glK2SO4')) / (1000 * gml('conc_gmlK2SO4'))).toFixed(5);
            document.getElementById('g_MgNO3').value = ((g2g('g2gMgNO3') * gl('conc_glMgNO3')) / (1000 * gml('conc_gmlMgNO3'))).toFixed(5);
            document.getElementById('g_CaCl2').value = ((g2g('g2gCaCl2') * gl('conc_glCaCl2')) / (1000 * gml('conc_gmlCaCl2'))).toFixed(5);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–º–º—ã –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('g_Fe').value = ((g2g('g2gFe') * gl('conc_glFe')) / (1000 * gml('conc_gmlFe'))).toFixed(5);
            document.getElementById('g_Mn').value = ((g2g('g2gMn') * gl('conc_glMn')) / (1000 * gml('conc_gmlMn'))).toFixed(5);
            document.getElementById('g_B').value = ((g2g('g2gB') * gl('conc_glB')) / (1000 * gml('conc_gmlB'))).toFixed(5);
            document.getElementById('g_Zn').value = ((g2g('g2gZn') * gl('conc_glZn')) / (1000 * gml('conc_gmlZn'))).toFixed(5);
            document.getElementById('g_Cu').value = ((g2g('g2gCu') * gl('conc_glCu')) / (1000 * gml('conc_gmlCu'))).toFixed(5);
            document.getElementById('g_Mo').value = ((g2g('g2gMo') * gl('conc_glMo')) / (1000 * gml('conc_gmlMo'))).toFixed(5);
            document.getElementById('g_Co').value = ((g2g('g2gCo') * gl('conc_glCo')) / (1000 * gml('conc_gmlCo'))).toFixed(5);
            document.getElementById('g_Si').value = ((g2g('g2gSi') * gl('conc_glSi')) / (1000 * gml('conc_gmlSi'))).toFixed(5);
            
            // 2. WeghtTomicro - –ø–µ—Ä–µ—Å—á–µ—Ç –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –≥—Ä–∞–º–º–æ–≤
            weightToMicro();
            
            // 3. fromWeight - –ø–µ—Ä–µ—Å—á–µ—Ç –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–≤—ã–∑—ã–≤–∞–µ–º onSaltWeightChange –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ –¥–µ–ª–∞–µ—Ç)
            onSaltWeightChange();
            
            // 4. CalculateS - —Ä–∞—Å—á–µ—Ç —Å–µ—Ä—ã (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ calcAll)
            // 5. CalcKoef - —Ä–∞—Å—á–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ calcAll)
            // 6. CalcEC - —Ä–∞—Å—á–µ—Ç EC (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ calcAll)
            // 7. genProfile - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ calcAll)
        }
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä–∞ –∫—Ä—É—Ç–∏–ª–æ–∫
        let priceAdjustInterval = null;
        let priceAdjustTimeout = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫—Ä—É—Ç–∏–ª–æ–∫
        function adjustPrice(inputId, delta) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + delta); // –ù–µ –¥–∞–µ–º —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å
            input.value = newValue.toFixed(4);
            
            updatePriceResults();
        }
        
        // –ù–∞—á–∞—Ç—å –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏
        function startPriceAdjust(inputId, delta) {
            // –ü–µ—Ä–≤–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
            adjustPrice(inputId, delta);
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä–∞
            priceAdjustTimeout = setTimeout(() => {
                // –ê–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä –∫–∞–∂–¥—ã–µ 50ms
                priceAdjustInterval = setInterval(() => {
                    adjustPrice(inputId, delta);
                }, 50);
            }, 300); // –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 300ms
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä
        function stopPriceAdjust() {
            if (priceAdjustTimeout) {
                clearTimeout(priceAdjustTimeout);
                priceAdjustTimeout = null;
            }
            if (priceAdjustInterval) {
                clearInterval(priceAdjustInterval);
                priceAdjustInterval = null;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫—Ä—É—Ç–∏–ª–æ–∫ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π)
        function initPriceSpinners() {
            document.addEventListener('mousedown', (e) => {
                const button = e.target.closest('.price-spinner button');
                if (!button) return;
                
                const inputId = button.getAttribute('data-input');
                const delta = parseFloat(button.getAttribute('data-delta'));
                
                if (inputId && !isNaN(delta)) {
                    startPriceAdjust(inputId, delta);
                }
            });
            
            document.addEventListener('mouseup', (e) => {
                if (e.target.closest('.price-spinner button')) {
                    stopPriceAdjust();
                }
            });
            
            document.addEventListener('mouseleave', (e) => {
                if (e.target.closest('.price-spinner button')) {
                    stopPriceAdjust();
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ü–µ–Ω (–∞–Ω–∞–ª–æ–≥ price() –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∏ 1073-1147)
        function updatePriceResults() {
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π –∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ knCaNO3.caption, lFe.caption –∏–∑ –ª–µ–≥–∞—Å–∏)
            const saltNames = updateSaltNames();
            const microNames = updateMicroNames();
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å–∞ —É–¥–æ–±—Ä–µ–Ω–∏–π –∏–∑ –≤–∫–ª–∞–¥–∫–∏ "–†–∞—Å—á–µ—Ç"
            const weights = {
                CaNO3: parseFloat(document.getElementById('g_CaNO3')?.value) || 0,
                KNO3: parseFloat(document.getElementById('g_KNO3')?.value) || 0,
                NH4NO3: parseFloat(document.getElementById('g_NH4NO3')?.value) || 0,
                MgNO3: parseFloat(document.getElementById('g_MgNO3')?.value) || 0,
                CaCl2: parseFloat(document.getElementById('g_CaCl2')?.value) || 0,
                MgSO4: parseFloat(document.getElementById('g_MgSO4')?.value) || 0,
                KH2PO4: parseFloat(document.getElementById('g_KH2PO4')?.value) || 0,
                K2SO4: parseFloat(document.getElementById('g_K2SO4')?.value) || 0,
                Fe: parseFloat(document.getElementById('g_Fe')?.value) || 0,
                Mn: parseFloat(document.getElementById('g_Mn')?.value) || 0,
                B: parseFloat(document.getElementById('g_B')?.value) || 0,
                Zn: parseFloat(document.getElementById('g_Zn')?.value) || 0,
                Cu: parseFloat(document.getElementById('g_Cu')?.value) || 0,
                Mo: parseFloat(document.getElementById('g_Mo')?.value) || 0,
                Co: parseFloat(document.getElementById('g_Co')?.value) || 0,
                Si: parseFloat(document.getElementById('g_Si')?.value) || 0,
                Cmplx: parseFloat(document.getElementById('g_Cmplx')?.value) || 0
            };
            
            // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –∑–∞ –≥—Ä–∞–º–º
            const prices = {
                CaNO3: parseFloat(document.getElementById('price_CaNO3')?.value) || 0,
                KNO3: parseFloat(document.getElementById('price_KNO3')?.value) || 0,
                NH4NO3: parseFloat(document.getElementById('price_NH4NO3')?.value) || 0,
                MgNO3: parseFloat(document.getElementById('price_MgNO3')?.value) || 0,
                CaCl2: parseFloat(document.getElementById('price_CaCl2')?.value) || 0,
                MgSO4: parseFloat(document.getElementById('price_MgSO4')?.value) || 0,
                KH2PO4: parseFloat(document.getElementById('price_KH2PO4')?.value) || 0,
                K2SO4: parseFloat(document.getElementById('price_K2SO4')?.value) || 0,
                Fe: parseFloat(document.getElementById('price_Fe')?.value) || 0,
                Mn: parseFloat(document.getElementById('price_Mn')?.value) || 0,
                B: parseFloat(document.getElementById('price_B')?.value) || 0,
                Zn: parseFloat(document.getElementById('price_Zn')?.value) || 0,
                Cu: parseFloat(document.getElementById('price_Cu')?.value) || 0,
                Mo: parseFloat(document.getElementById('price_Mo')?.value) || 0,
                Co: parseFloat(document.getElementById('price_Co')?.value) || 0,
                Si: parseFloat(document.getElementById('price_Si')?.value) || 0,
                Cmplx: parseFloat(document.getElementById('price_Cmplx')?.value) || 0
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const useComplex = document.getElementById('use_complex')?.checked || false;
            const useK2SO4 = document.getElementById('use_K2SO4')?.checked || false;
            const useMgNO3 = document.getElementById('use_MgNO3')?.checked || false;
            
            let totalPrice = 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ —Å—Ç—Ä–æ–∫ 1087-1094, 1110, 1142)
            // –í –ª–µ–≥–∞—Å–∏ –≤—Å–µ —Å–æ–ª–∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ —Å—É–º–º—É, –Ω–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–µ—é—Ç –≤–µ—Å 0
            // –ó–¥–µ—Å—å —è–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Å–æ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
            const macroSalts = ['CaNO3', 'KNO3', 'NH4NO3', 'CaCl2', 'MgSO4', 'KH2PO4'];
            
            // –î–æ–±–∞–≤–ª—è–µ–º K2SO4 –∏–ª–∏ MgNO3 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö)
            if (useK2SO4) macroSalts.push('K2SO4');
            if (useMgNO3) macroSalts.push('MgNO3');
            
            macroSalts.forEach(key => {
                const price = Math.round(prices[key] * weights[key] * 100) / 100;
                totalPrice += price;
                const resultEl = document.getElementById(`price_result_${key}`);
                const nameEl = resultEl?.previousElementSibling; // —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º price-name
                if (resultEl) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (–∞–Ω–∞–ª–æ–≥ knCaNO3.caption)
                    if (nameEl && nameEl.classList.contains('price-name') && saltNames[key]) {
                        nameEl.textContent = saltNames[key];
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤–µ—Å + —Ü–µ–Ω–∞)
                    resultEl.textContent = `${(Math.round(weights[key] * 1000) / 1000).toFixed(3)} –≥. —Ü–µ–Ω–∞: ${price.toFixed(2)}`;
                }
            });
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if (useComplex) {
                // –ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ —Å—Ç—Ä–æ–∫–∏ 1108)
                const price = Math.round(prices.Cmplx * weights.Cmplx * 100) / 100;
                totalPrice += price;
                const resultEl = document.getElementById('price_result_Cmplx');
                const nameEl = resultEl?.previousElementSibling;
                if (resultEl) {
                    // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Å–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ "–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤"
                    if (nameEl && nameEl.classList.contains('price-name')) {
                        nameEl.textContent = '–ö–æ–º–ø–ª–µ–∫—Å –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤';
                    }
                    resultEl.textContent = `${(Math.round(weights.Cmplx * 1000) / 1000).toFixed(3)} –≥. —Ü–µ–Ω–∞: ${price.toFixed(2)}`;
                }
            } else {
                // –û—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã (–∞–Ω–∞–ª–æ–≥ —Å—Ç—Ä–æ–∫ 1133-1140)
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(key => {
                    const price = Math.round(prices[key] * weights[key] * 100) / 100;
                    totalPrice += price;
                    const resultEl = document.getElementById(`price_result_${key}`);
                    const nameEl = resultEl?.previousElementSibling;
                    if (resultEl) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ (–∞–Ω–∞–ª–æ–≥ lFe.caption)
                        if (nameEl && nameEl.classList.contains('price-name') && microNames[key]) {
                            nameEl.textContent = microNames[key];
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤–µ—Å + —Ü–µ–Ω–∞)
                        resultEl.textContent = `${(Math.round(weights[key] * 1000) / 1000).toFixed(3)} –≥. —Ü–µ–Ω–∞: ${price.toFixed(2)}`;
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Ü–µ–Ω—É –∑–∞ –ª–∏—Ç—Ä
            const volume = parseFloat(document.getElementById('volume')?.value) || 1;
            const pricePerLiter = volume > 0 ? Math.round(totalPrice / volume * 100) / 100 : 0;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–æ–¥–≤–∫–ª–∞–¥–∫–µ "–¶–µ–Ω–∞"
            document.getElementById('total_price').textContent = (Math.round(totalPrice * 100) / 100).toFixed(2);
            document.getElementById('price_per_liter').textContent = pricePerLiter.toFixed(2);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∞–Ω–∞–ª–æ–≥ lprice –∏–∑ –ª–µ–≥–∞—Å–∏ —Å—Ç—Ä–æ–∫–∞ 1145)
            const bottomTotalPrice = document.getElementById('bottom_total_price');
            const bottomPricePerLiter = document.getElementById('bottom_price_per_liter');
            if (bottomTotalPrice) bottomTotalPrice.textContent = (Math.round(totalPrice * 100) / 100).toFixed(2);
            if (bottomPricePerLiter) bottomPricePerLiter.textContent = pricePerLiter.toFixed(2);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª–µ–π —Ü–µ–Ω –∏ —Ç–∞—Ä—ã
        function addPriceEventListeners() {
            const priceInputs = document.querySelectorAll('#price input[type="number"]');
            priceInputs.forEach(input => {
                input.addEventListener('input', () => {
                    updatePriceResults();
                });
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 4 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
                input.addEventListener('blur', () => {
                    const value = parseFloat(input.value) || 0;
                    input.value = value.toFixed(4);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π —Ç–∞—Ä—ã
            const tankA = document.getElementById('tank_A');
            const tankB = document.getElementById('tank_B');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –ø–æ–¥–≤–∫–ª–∞–¥–∫–µ –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
            const preparationInputs = document.querySelectorAll('#preparation input[type="text"]');
            preparationInputs.forEach(input => {
                input.addEventListener('input', () => {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
                    console.log(`Field ${input.id} changed to: ${input.value}`);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –≤ –ø–æ–¥–≤–∫–ª–∞–¥–∫–µ –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
            const preparationCheckboxes = document.querySelectorAll('#preparation input[type="checkbox"]');
            preparationCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ–∫–±–æ–∫—Å–æ–≤
                    console.log(`Checkbox ${checkbox.id} changed to: ${checkbox.checked}`);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ legacy)
            const cbCmplx = document.getElementById('cbCmplx');
            if (cbCmplx) {
                cbCmplx.addEventListener('change', () => {
                    toggleMicroElements(cbCmplx.checked);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –º–∏–∫—Å–µ—Ä–∞
            const addrMixer = document.getElementById('addrMixer');
            const nmix = document.getElementById('nmix');
            
            if (addrMixer) {
                addrMixer.addEventListener('input', () => {
                    console.log(`Mixer address changed to: ${addrMixer.value}`);
                });
            }
            
            if (nmix) {
                nmix.addEventListener('input', () => {
                    console.log(`Mix number changed to: ${nmix.value}`);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
            const btnManufacture = document.getElementById('btnManufacture');
            const btnToProfile = document.getElementById('btnToProfile');
            const btnToJournal = document.getElementById('btnToJournal');
            
            if (btnManufacture) {
                btnManufacture.addEventListener('click', () => {
                    manufactureSolution();
                });
            }
            
            if (btnToProfile) {
                btnToProfile.addEventListener('click', () => {
                    transferToProfile();
                });
            }
            
            if (btnToJournal) {
                btnToJournal.addEventListener('click', () => {
                    addToJournal();
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
        function manufactureSolution() {
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ—Å–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ –ø–µ—Ä–µ–¥ Button2Click –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è CalcAll -> CalcConc)
            calcConcentrates();
            
            const addrMixerInput = document.getElementById('addrMixer');
            const nmixInput = document.getElementById('nmix');

            if (!addrMixerInput || !nmixInput) {
                console.warn('Mixer controls not found');
                return;
            }

            const addrMixer = addrMixerInput.value.trim();
            const nmix = nmixInput.value.trim();

            if (!addrMixer) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –º–∏–∫—Å–µ—Ä–∞');
                return;
            }
            if (!nmix) {
                alert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ä–∞—Å—Ç–≤–æ—Ä–∞ (s)');
                return;
            }

            let mixlink = `http://${addrMixer}/?`;
            mixlink += `s=${encodeURIComponent(nmix)}&`;

            const macroPairs = [
                ['mCaNO3', 'g2gCaNO3'],
                ['mKNO3', 'g2gKNO3'],
                ['mNH4NO3', 'g2gNH4NO3'],
                ['mMgNO3', 'g2gMgNO3'],
                ['mCaCl2', 'g2gCaCl2'],
                ['mMgSO4', 'g2gMgSO4'],
                ['mKH2PO4', 'g2gKH2PO4'],
                ['mK2SO4', 'g2gK2SO4']
            ];

            macroPairs.forEach(([pumpId, valueId]) => {
                const pumpInput = document.getElementById(pumpId);
                const valueInput = document.getElementById(valueId);
                if (!pumpInput || !valueInput) {
                    return;
                }
                const pump = pumpInput.value.trim();
                if (!pump) {
                    return;
                }
                const grams = valueInput.value.trim();
                if (grams === '' || grams === '0' || grams === '0.00') {
                    return;
                }
                mixlink += `${encodeURIComponent(pump)}=${encodeURIComponent(grams)}&`;
            });

            const useComplex = document.getElementById('use_complex')?.checked;
            if (useComplex) {
                const pumpInput = document.getElementById('mCmplx');
                const valueInput = document.getElementById('g2gCmplx');
                if (pumpInput && valueInput) {
                    const pump = pumpInput.value.trim();
                    const grams = valueInput.value.trim();
                    if (pump && grams !== '' && grams !== '0' && grams !== '0.00') {
                        mixlink += `${encodeURIComponent(pump)}=${encodeURIComponent(grams)}&`;
                    }
                }
            } else {
                const microPairs = [
                    ['mFe', 'g2gFe'],
                    ['mMn', 'g2gMn'],
                    ['mB', 'g2gB'],
                    ['mZn', 'g2gZn'],
                    ['mCu', 'g2gCu'],
                    ['mMo', 'g2gMo'],
                    ['mCo', 'g2gCo'],
                    ['mSi', 'g2gSi']
                ];
                microPairs.forEach(([pumpId, valueId]) => {
                    const pumpInput = document.getElementById(pumpId);
                    const valueInput = document.getElementById(valueId);
                    if (!pumpInput || !valueInput) {
                        return;
                    }
                    const pump = pumpInput.value.trim();
                    if (!pump) {
                        return;
                    }
                    const grams = valueInput.value.trim();
                    if (grams === '' || grams === '0' || grams === '0.00') {
                        return;
                    }
                    mixlink += `${encodeURIComponent(pump)}=${encodeURIComponent(grams)}&`;
                });
            }

            if (mixlink.endsWith('&')) {
                mixlink = mixlink.slice(0, -1);
            }

            window.open(mixlink, '_blank');
        }
        
        
        // –ê–≤—Ç–æ–∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª –ø—Ä–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ Button9Click)
        function addToJournal() {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ yyyy-mm-dd
            const currentDate = new Date().toISOString().split('T')[0];
            
            // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–º
            const volume = parseFloat(document.getElementById('volume')?.value) || 10;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: m1.Text)
            const desc = `–ê–≤—Ç–æ–∑–∞–ø–∏—Å—å. –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω —Ä–∞—Å—Ç–≤–æ—Ä –Ω–∞ ${volume} –ª–∏—Ç—Ä–æ–≤.`;
            
            // –ë–µ—Ä–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –ø–æ–ª—è profile-string (–∞–Ω–∞–ª–æ–≥ profile.Caption –≤ –ª–µ–≥–∞—Å–∏)
            const profileStr = document.getElementById('profile-string')?.value || '';
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏: date=...;...;...)
            const journalEntry = {
                date: currentDate,
                desc: desc,
                memo: desc, // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
                profile: profileStr
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∂—É—Ä–Ω–∞–ª
            journalEntries.push(journalEntry);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∂—É—Ä–Ω–∞–ª –ø–æ –¥–∞—Ç–µ (–∫–∞–∫ –≤ –ª–µ–≥–∞—Å–∏ DStr.Sort)
            journalEntries.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å–≤–µ—Ä—Ö—É
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∂—É—Ä–Ω–∞–ª–∞
            updateJournalList();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–§–∞–π–ª" —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            switchTab('file', document.querySelector('[onclick*="file"]'));
            
            alert('–ê–≤—Ç–æ–∑–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∂—É—Ä–Ω–∞–ª');
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–æ–º–ø–ª–µ–∫—Å–æ–º –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ (–∫–∞–∫ –≤ legacy)
        function toggleMicroElements(useComplex) {
            const complexItem = document.getElementById('complex-micro-item');
            
            if (useComplex) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (complexItem) complexItem.style.display = '';
                
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(element => {
                    const item = document.getElementById(`individual-micro-${element}`);
                    if (item) item.style.display = 'none';
                });
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å
                if (complexItem) complexItem.style.display = 'none';
                
                ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'].forEach(element => {
                    const item = document.getElementById(`individual-micro-${element}`);
                    if (item) item.style.display = '';
                });
            }
        }
        
        function saveData() {
            saveProfile();
        }

        function resetSalts() {
            // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–æ—Å—Ç–∞–≤–∞–º —Å–æ–ª–µ–π
            document.getElementById('salt_CaNO3_Ca').value = 16.972;
            document.getElementById('salt_CaNO3_NO3').value = 11.863;
            document.getElementById('salt_CaNO3_NH4').value = 0.000;
            document.getElementById('salt_KNO3_K').value = 38.672;
            document.getElementById('salt_KNO3_NO3').value = 13.854;
            document.getElementById('salt_NH4NO3_NH4').value = 17.499;
            document.getElementById('salt_NH4NO3_NO3').value = 17.499;
            document.getElementById('salt_MgSO4_Mg').value = 9.861;
            document.getElementById('salt_MgSO4_S').value = 13.010;
            document.getElementById('salt_KH2PO4_K').value = 28.731;
            document.getElementById('salt_KH2PO4_P').value = 22.761;
            document.getElementById('salt_K2SO4_K').value = 44.874;
            document.getElementById('salt_K2SO4_S').value = 18.401;
            document.getElementById('salt_MgNO3_Mg').value = 9.479;
            document.getElementById('salt_MgNO3_NO3').value = 10.925;
            document.getElementById('salt_CaCl2_Ca').value = 18.294;
            document.getElementById('salt_CaCl2_Cl').value = 32.366;
            onSaltCompositionChange();
        }

        function resetProfile() {
            currentProfile = {
                N: 220, NO3: 200, NH4: 20, P: 40, K: 180, Ca: 200, Mg: 50, S: 73.049, Cl: 0, EC: 2.102,
                Fe: 2000, Mn: 550, B: 500, Zn: 330, Cu: 63, Mo: 63, Co: 0, Si: 0,
                volume: 10.0
            };
            applyProfile();
        }

        function recalculate() {
            // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º —á–µ—Ä–µ–∑ –∏–º–∏—Ç–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            
            // –û—á–∏—Å—Ç–∫–∞ localStorage
            localStorage.removeItem('hpg_profile');
            localStorage.removeItem('hpg_journal');
            
            // –û—á–∏—Å—Ç–∫–∞ –∂—É—Ä–Ω–∞–ª–∞
            journalEntries = [];
            updateJournalList();
            
            // –°–æ–∑–¥–∞–µ–º –ü–û–õ–ù–´–ô –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ñ–∞–π–ª —Å–æ –í–°–ï–ú–ò –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const defaultFileContent = `version=Hydroponic Profile Generator HTML5
Comment=–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
N=220
NO3=200
NH4=20
P=40
K=180
Ca=200
Mg=50
S=73.049
Cl=0
Fe=2000
Mn=550
B=500
Zn=330
Cu=63
Mo=63
Co=0
Si=0
CaNO3_Ca=16.972
CaNO3_NO3=11.863
CaNO3_NH4=0.000
KNO3_K=38.672
KNO3_NO3=13.854
NH4NO3_NH4=17.499
NH4NO3_NO3=17.499
MgSO4_Mg=9.861
MgSO4_S=13.010
KH2PO4_K=28.731
KH2PO4_P=22.761
K2SO4_K=44.874
K2SO4_S=18.401
MgNO3_Mg=9.479
MgNO3_NO3=10.926
CaCl2_Ca=18.294
CaCl2_Cl=32.366
dFe=20.1000
dMn=36.4000
dB=17.5000
dZn=22.7000
dCu=25.5000
dMo=54.3000
dCo=13.0000
dSi=7.0000
glCaNO3=600.0
gmlCaNO3=1.0000
glKNO3=250.0
gmlKNO3=1.0000
glNH4NO3=100.0
gmlNH4NO3=1.0000
glMgNO3=500.0
gmlMgNO3=1.0000
glMgSO4=600.0
gmlMgSO4=1.0000
glK2SO4=100.0
gmlK2SO4=1.0000
glKH2PO4=150.0
gmlKH2PO4=1.0000
glCaCl2=100.0
gmlCaCl2=1.0000
glCmplx=10.00
gmlCmplx=1.000
glFe=10.00
gmlFe=1.000
glMn=10.00
gmlMn=1.000
glB=10.00
gmlB=1.000
glZn=10.00
gmlZn=1.000
glCu=10.00
gmlCu=1.000
glMo=10.00
gmlMo=1.000
glCo=10.00
gmlCo=1.000
glSi=10.00
gmlSi=1.000
chkComplex=False
chK2SO4=True
chMgNO3=False
V=10.0
mCaNO3=p1
mKNO3=p2
mNH4NO3=p3
mMgNO3=
mMgSO4=p4
mKH2PO4=p5
mK2SO4=p6
mCaCl2=
mCmplx=
mFe=
mMn=
mB=
mZn=
mCu=
mMo=
mCo=
mSi=
addrMixer=mixer.local
nmix=1
tAml=500
tBml=500
cgCaNO3=0.4000
cgKNO3=0.3500
cgNH4NO3=0.2500
cgMgNO3=0.3500
cgMgSO4=0.1200
cgK2SO4=0.3200
cgKH2PO4=0.4000
cgCaCl2=7.7000
cgCmplx=0.0500
cgFe=3.0000
cgMn=0.3000
cgB=0.4000
cgZn=0.1500
cgCu=0.4000
cgMo=3.0000
cgCo=2.3000
cgSi=0.2700`;
            
            // –ü–∞—Ä—Å–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ñ–∞–π–ª - —ç—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            parseFullFile(defaultFileContent);
            
            // –°–±—Ä–æ—Å –ø–æ–ª–µ–π –≤–∫–ª–∞–¥–∫–∏ "–§–∞–π–ª"
            document.getElementById('file_filename').value = 'default.hpg';
            document.getElementById('file_comment').value = '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é';
            document.getElementById('file_journal_desc').value = '';
            document.getElementById('file_journal_date').value = '';
            document.getElementById('file_journal_memo').value = '';
            document.getElementById('file_profile_info').value = ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º .value –¥–ª—è input
            clearFileProfileDetails();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ (–∫–æ–º–ø–ª–µ–∫—Å, K2SO4, MgNO3)
            onComplexChange(true); // true = –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            onK2SO4Change();
            onMgNO3Change();
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ
            calcAll();
            calcConcentrates();
            updatePriceResults();
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã —Ñ–∞–π–ª–∞ (SHA-256, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–∏–º–≤–æ–ª–∞)
        async function calculateChecksum() {
            try {
                const response = await fetch(window.location.href);
                const text = await response.text();
                const msgBuffer = new TextEncoder().encode(text);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex.slice(-3); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–∏–º–≤–æ–ª–∞
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã:', error);
                return '---';
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function detectDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);
            const screenWidth = window.innerWidth;
            
            let deviceType = 'Desktop';
            if (isMobile && !isTablet) {
                deviceType = 'Mobile';
            } else if (isTablet) {
                deviceType = 'Tablet';
            }
            
            console.log('=== HPG Device Info ===');
            console.log('Device Type:', deviceType);
            console.log('Screen Width:', screenWidth + 'px');
            console.log('User Agent:', navigator.userAgent);
            console.log('Touch Support:', 'ontouchstart' in window);
            console.log('======================');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫ body –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            document.body.classList.add(deviceType.toLowerCase());
            
            return {
                type: deviceType,
                isMobile: isMobile && !isTablet,
                isTablet: isTablet,
                isDesktop: !isMobile && !isTablet,
                screenWidth: screenWidth
            };
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const device = detectDevice();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞
            initCorrector();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            updateMobileDisplay();
            checkMobileBanner();
            initSwipeControls();
            
            const k2so4Checkbox = document.getElementById('use_K2SO4');
            const mgno3Checkbox = document.getElementById('use_MgNO3');

            useK2SO4 = k2so4Checkbox.checked;
            useMgNO3 = mgno3Checkbox.checked;

            syncSaltCompositions();
            updateSaltLabels();
            updateSaltNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateMicroNames(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            const restored = restoreAutoSave();
            
            if (!restored) {
                calcAll();
            }
            onMicroChange();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–∫—Ä–æ –≤–∫–ª–∞–¥–∫–∏
            onComplexChange(restored);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤
            calcConcentrates();
            addPriceEventListeners();
            initPriceSpinners(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫—Ä—É—Ç–∏–ª–æ–∫
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
            const useComplexCheckbox = document.getElementById('use_complex');
            toggleMicroElements(!!useComplexCheckbox?.checked);
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏–∑ localStorage
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && document.getElementById(savedTab)) {
                switchTab(savedTab);
                
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã", –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≤–∫–ª–∞–¥–∫—É
                if (savedTab === 'concentrates') {
                    const savedInnerTab = localStorage.getItem('activeInnerTab');
                    if (savedInnerTab && document.getElementById(savedInnerTab)) {
                        switchInnerTab(savedInnerTab);
                    }
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏–∏ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö
            document.getElementById('help-version').textContent = APP_VERSION_FULL;
            document.getElementById('desktop-version').textContent = APP_VERSION;
            document.getElementById('mobile-version').textContent = APP_VERSION_FULL;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É –∫ –≤–µ—Ä—Å–∏–∏
            const checksum = await calculateChecksum();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É –∫ –≤–µ—Ä—Å–∏—è–º
            const helpVersionSpan = document.getElementById('help-version');
            if (helpVersionSpan) {
                helpVersionSpan.textContent = `${APP_VERSION} (HTML5 –ø–æ—Ä—Ç - ${APP_DATE}-${checksum})`;
            }
            
            const desktopVersionSpan = document.getElementById('desktop-version');
            if (desktopVersionSpan) {
                desktopVersionSpan.textContent = `${APP_VERSION}-${checksum}`;
            }
            
            const mobileVersionSpan = document.getElementById('mobile-version');
            if (mobileVersionSpan) {
                mobileVersionSpan.textContent = `${APP_VERSION} (HTML5 –ø–æ—Ä—Ç - ${APP_DATE}-${checksum})`;
            }
        };

        // ========== –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• ==========
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–æ–º
        function closeMobileBanner() {
            document.getElementById('mobile-info-banner').style.display = 'none';
            localStorage.setItem('hpg_mobile_banner_closed', 'true');
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
        function updateMobileFileInfo() {
            const filename = document.getElementById('file_filename')?.value || 'default.hpg';
            const comment = document.getElementById('file_comment')?.value || '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é';
            
            document.getElementById('mobile-file-name').textContent = filename;
            document.getElementById('mobile-file-desc').textContent = comment;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (—Å debounce)
            updateCloudSaveButtonDebounced();
        }

        function normalizeProfileName(name) {
            return (name || '').trim().replace(/\.hpg$/i, '').toLowerCase();
        }

        function setCloudSaveButtonState(isUpdate) {
            const saveBtn = document.querySelector('#cloud-logged-in-section button[onclick="saveProfileToCloud()"]');
            const mobileBtn = document.getElementById('mobile-save-cloud-button');

            if (saveBtn) {
                saveBtn.innerHTML = isUpdate ? 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.style.background = isUpdate ? '#0b8043' : '#34a853';
                saveBtn.dataset.mode = isUpdate ? 'update' : 'save';
            }

            if (mobileBtn) {
                mobileBtn.textContent = isUpdate ? 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                mobileBtn.dataset.mode = isUpdate ? 'update' : 'save';
            }
        }

        // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function updateCloudSaveButton() {
            const filenameInput = document.getElementById('file_filename');
            if (!filenameInput) return;

            const normalizedName = normalizeProfileName(filenameInput.value);
            const matched = userCloudProfilesMap.get(normalizedName) || null;

            currentMatchedCloudProfile = matched;
            setCloudSaveButtonState(!!matched);
        }

        // Debounced –≤–µ—Ä—Å–∏—è –¥–ª—è —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞)
        const updateCloudSaveButtonDebounced = debounce(updateCloudSaveButton, 500);

        function updateUserCloudProfilesMapFromSnapshot(snapshot) {
            const newMap = new Map();
            snapshot?.forEach?.(doc => {
                const data = doc.data();
                const normalizedName = normalizeProfileName(data?.name);
                if (!normalizedName) return;
                newMap.set(normalizedName, {
                    id: doc.id,
                    name: data.name,
                    description: data.description || '',
                    public: !!data.public,
                    modified: data.modified || null
                });
            });

            userCloudProfilesMap = newMap;
            isCloudProfilesLoaded = true;
            currentMatchedCloudProfile = null;
            updateCloudSaveButton();
        }

        async function refreshUserCloudProfiles(force = false) {
            const user = auth.currentUser;
            if (!user) {
                userCloudProfilesMap = new Map();
                currentMatchedCloudProfile = null;
                isCloudProfilesLoaded = false;
                setCloudSaveButtonState(false);
                return;
            }

            if (isCloudProfilesLoaded && !force) {
                updateCloudSaveButton();
                return;
            }

            try {
                const snapshot = await db.collection('profiles')
                    .where('userId', '==', user.uid)
                    .where('appKey', '==', 'wega-hpg-profile')
                    .get();

                updateUserCloudProfilesMapFromSnapshot(snapshot);
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ offline —Ä–µ–∂–∏–º–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    console.log('–†–∞–±–æ—Ç–∞ –≤ offline —Ä–µ–∂–∏–º–µ - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏');
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–ª–∞—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
                }
            }
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö alert-–æ–∫–æ–Ω
        function showCustomAlert(message, title = 'HPG Calculator') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10002;
                    animation: fadeIn 0.2s ease-in;
                `;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                let icon = 'üåê';
                let iconColor = '#4285f4';
                if (message.includes('‚úÖ') || message.includes('—É—Å–ø–µ—à–Ω–æ') || message.includes('–∑–∞–≥—Ä—É–∂–µ–Ω')) {
                    icon = '‚úÖ';
                    iconColor = '#34a853';
                } else if (message.includes('‚ùå') || message.includes('–û—à–∏–±–∫–∞')) {
                    icon = '‚ùå';
                    iconColor = '#f44336';
                } else if (message.includes('‚ö†Ô∏è') || message.includes('–í–Ω–∏–º–∞–Ω–∏–µ')) {
                    icon = '‚ö†Ô∏è';
                    iconColor = '#ff9800';
                }
                
                modal.innerHTML = `
                    <div style="background: white; padding: 35px 30px; border-radius: 12px; max-width: 420px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.12); animation: slideIn 0.3s ease-out; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">
                            ${icon}
                        </div>
                        
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #202020; font-weight: 600;">
                            ${title}
                        </h3>
                        
                        <div style="margin-bottom: 30px; font-size: 15px; color: #666; line-height: 1.6;">
                            ${message.replace(/‚úÖ|‚ùå|‚ö†Ô∏è|‚ÑπÔ∏è/g, '').trim()}
                        </div>
                        
                        <button id="custom-alert-ok" style="padding: 12px 32px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; min-width: 100px; box-shadow: 0 2px 8px rgba(66,133,244,0.3);">
                            OK
                        </button>
                    </div>
                    
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-20px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                    </style>
                `;
                
                document.body.appendChild(modal);
                
                const okBtn = modal.querySelector('#custom-alert-ok');
                okBtn.onmouseover = () => {
                    okBtn.style.background = '#3367d6';
                    okBtn.style.transform = 'translateY(-2px)';
                    okBtn.style.boxShadow = '0 4px 12px rgba(66,133,244,0.4)';
                };
                okBtn.onmouseout = () => {
                    okBtn.style.background = '#4285f4';
                    okBtn.style.transform = 'translateY(0)';
                    okBtn.style.boxShadow = '0 2px 8px rgba(66,133,244,0.3)';
                };
                
                okBtn.onclick = () => {
                    modal.remove();
                    resolve();
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve();
                    }
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Enter –∏–ª–∏ Escape
                const keyHandler = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', keyHandler);
                        resolve();
                    }
                };
                document.addEventListener('keydown', keyHandler);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å default –ø—Ä–æ—Ñ–∏–ª—å
        function showDefaultProfileModal(profileId, dateStr, description) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10002;
                    animation: fadeIn 0.2s ease-in;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 12px; max-width: 480px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="font-size: 32px;">üîç</div>
                            <h3 style="margin: 0; font-size: 20px; color: #202020;">–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å "default" –≤ –æ–±–ª–∞–∫–µ</h3>
                        </div>
                        
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #666; font-size: 13px;">–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</strong><br>
                                <span style="font-size: 15px; color: #202020;">${dateStr}</span>
                            </div>
                            <div>
                                <strong style="color: #666; font-size: 13px;">–û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
                                <span style="font-size: 15px; color: #202020;">${description || '–Ω–µ—Ç'}</span>
                            </div>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #1565c0;">
                            ‚ÑπÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å?
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="default-modal-cancel" style="flex: 1; padding: 12px; background: #757575; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s;">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button id="default-modal-ok" style="flex: 1; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s;">
                                OK
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-20px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                    </style>
                `;
                
                document.body.appendChild(modal);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                const cancelBtn = modal.querySelector('#default-modal-cancel');
                const okBtn = modal.querySelector('#default-modal-ok');
                
                cancelBtn.onmouseover = () => cancelBtn.style.background = '#616161';
                cancelBtn.onmouseout = () => cancelBtn.style.background = '#757575';
                
                okBtn.onmouseover = () => okBtn.style.background = '#3367d6';
                okBtn.onmouseout = () => okBtn.style.background = '#4285f4';
                
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                okBtn.onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escapeHandler);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å default.hpg –∏–∑ –æ–±–ª–∞–∫–∞
        async function checkAndOfferDefaultProfile() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–º—è —Ñ–∞–π–ª–∞
                const currentFilename = document.getElementById('file_filename')?.value || '';
                const normalizedCurrent = normalizeProfileName(currentFilename);
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –Ω–µ default - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (normalizedCurrent !== 'default') {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ default –≤ –æ–±–ª–∞–∫–µ
                const cloudDefault = userCloudProfilesMap.get('default');
                if (!cloudDefault) {
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const user = auth.currentUser;
                if (!user) return;
                
                const doc = await db.collection('profiles').doc(cloudDefault.id).get();
                if (!doc.exists) return;
                
                const profile = doc.data();
                const modifiedDate = profile.modified?.toDate();
                const dateStr = modifiedDate ? modifiedDate.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const shouldLoad = await showDefaultProfileModal(cloudDefault.id, dateStr, profile.description);
                
                if (shouldLoad) {
                    await loadCloudProfile(cloudDefault.id);
                }
                
            } catch (error) {
                // –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å default –ø—Ä–æ—Ñ–∏–ª—å:', error);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchMobileTab(tab) {
            const buttons = document.querySelectorAll('.mobile-tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            const mainContent = document.querySelector('.mobile-content-wrapper');
            const journalContainer = document.getElementById('mobile-journal-container');
            
            if (tab === 'main') {
                buttons[0].classList.add('active');
                mainContent.style.display = 'block';
                journalContainer.style.display = 'none';
            } else if (tab === 'journal') {
                buttons[1].classList.add('active');
                mainContent.style.display = 'none';
                journalContainer.style.display = 'block';
                updateMobileJournal();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞
        function updateMobileJournal() {
            const list = document.getElementById('mobile-journal-list');
            list.innerHTML = '';
            
            if (journalEntries.length === 0) {
                list.innerHTML = '<div class="mobile-journal-empty">üìã –ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>';
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É, –Ω–æ–≤—ã–µ –≤–Ω–∏–∑—É)
            const sortedEntries = [...journalEntries].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });
            
            sortedEntries.forEach((entry, sortedIndex) => {
                const item = document.createElement('div');
                item.className = 'mobile-journal-item';
                // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è showJournalDetails
                const originalIndex = journalEntries.indexOf(entry);
                item.onclick = () => showJournalDetails(originalIndex);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—è—Ü–∞ –∏ –¥–Ω–µ–º –Ω–µ–¥–µ–ª–∏
                const dateObj = new Date(entry.date);
                const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
                const weekdays = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
                const day = dateObj.getDate();
                const month = months[dateObj.getMonth()];
                const year = dateObj.getFullYear();
                const weekday = weekdays[dateObj.getDay()];
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å–∏
                let daysSinceText = '';
                if (sortedIndex > 0) {
                    const prevEntry = sortedEntries[sortedIndex - 1];
                    if (prevEntry) {
                        const prevDateObj = new Date(prevEntry.date);
                        const diffTime = dateObj - prevDateObj;
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            daysSinceText = ` +${diffDays} ${diffDays === 1 ? '—Å—É—Ç–∫–∏' : diffDays < 5 ? '—Å—É—Ç–æ–∫' : '—Å—É—Ç–æ–∫'}`;
                        }
                    }
                }
                
                const formattedDate = `${day} ${month} ${year} (${weekday})${daysSinceText}`;
                
                const date = document.createElement('div');
                date.className = 'mobile-journal-date';
                date.textContent = formattedDate;
                
                const desc = document.createElement('div');
                desc.className = 'mobile-journal-desc';
                desc.textContent = entry.desc;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–∏–ª–µ
                if (entry.fullProfile) {
                    const profile = entry.fullProfile;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º EC –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    let ec = parseFloat(profile.EC) || 0;
                    if (ec === 0 && profile.NH4 && profile.Ca && profile.Mg && profile.K && profile.N) {
                        const vNH4 = parseFloat(profile.NH4);
                        const vCa = parseFloat(profile.Ca);
                        const vMg = parseFloat(profile.Mg);
                        const vK = parseFloat(profile.K);
                        const vN = parseFloat(profile.N);
                        ec = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                                    2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                                    2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
                    }
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
                    const n = parseFloat(profile.N) || 0;
                    const k = parseFloat(profile.K) || 0;
                    const ca = parseFloat(profile.Ca) || 0;
                    const mg = parseFloat(profile.Mg) || 0;
                    const nh4 = parseFloat(profile.NH4) || 0;
                    const no3 = parseFloat(profile.NO3) || 0;
                    
                    const kn = n !== 0 ? (k / n) : 0;
                    const kca = ca !== 0 ? (k / ca) : 0;
                    const kmg = mg !== 0 ? (k / mg) : 0;
                    const nh4no3 = no3 !== 0 ? (nh4 / no3) : 0;
                    const no3nh4 = nh4 !== 0 ? Math.round(no3 / nh4) : 0;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ EC –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–ø–∏—Å—å—é
                    let ecChangeText = '';
                    if (sortedIndex > 0) {
                        const prevEntry = sortedEntries[sortedIndex - 1];
                        if (prevEntry && prevEntry.fullProfile) {
                            let prevEc = parseFloat(prevEntry.fullProfile.EC) || 0;
                            if (prevEc === 0 && prevEntry.fullProfile.NH4 && prevEntry.fullProfile.Ca && prevEntry.fullProfile.Mg && prevEntry.fullProfile.K && prevEntry.fullProfile.N) {
                                const vNH4 = parseFloat(prevEntry.fullProfile.NH4);
                                const vCa = parseFloat(prevEntry.fullProfile.Ca);
                                const vMg = parseFloat(prevEntry.fullProfile.Mg);
                                const vK = parseFloat(prevEntry.fullProfile.K);
                                const vN = parseFloat(prevEntry.fullProfile.N);
                                prevEc = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                                            2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                                            2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
                            }
                            if (prevEc !== 0 && ec !== prevEc) {
                                const ecPercentChange = ((ec - prevEc) / prevEc * 100);
                                if (Math.abs(ecPercentChange) >= 1) {
                                    const sign = ecPercentChange > 0 ? '+' : '';
                                    ecChangeText = ` <span style="font-size: 10px;">(${sign}${ecPercentChange.toFixed(0)}%)</span>`;
                                }
                            }
                        }
                    }
                    
                    // –°—Ç—Ä–æ–∫–∞ —Å EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ (–∫–∞–∫ –≤ —à–∞–ø–∫–µ)
                    const ratiosInfo = document.createElement('div');
                    ratiosInfo.className = 'mobile-journal-ratios';
                    ratiosInfo.style.cssText = 'margin-top: 6px; padding: 6px; background: #e8f4ff; border-radius: 4px; font-size: 11px; color: #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center;';
                    ratiosInfo.innerHTML = `<span><strong>NH4/NO3=</strong>${nh4no3.toFixed(2)} (1:${no3nh4}) <strong>K/N=</strong>${kn.toFixed(2)} <strong>K/Ca=</strong>${kca.toFixed(2)} <strong>K/Mg=</strong>${kmg.toFixed(2)}</span><span style="color: #4a90e2; font-size: 13px;"><strong>EC:</strong>${ec.toFixed(2)}${ecChangeText}</span>`;
                    
                    // –°—Ç—Ä–æ–∫–∞ —Å –ø–æ–ª–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
                    const p = profile.P || '0';
                    const s = profile.S || '0';
                    
                    // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                    const fe = profile.Fe || '0';
                    const mn = profile.Mn || '0';
                    const b = profile.B || '0';
                    const zn = profile.Zn || '0';
                    const cu = profile.Cu || '0';
                    const mo = profile.Mo || '0';
                    
                    const profileInfo = document.createElement('div');
                    profileInfo.className = 'mobile-journal-profile';
                    profileInfo.style.cssText = 'margin-top: 4px; padding: 6px; background: #f5f5f5; border-radius: 4px; font-size: 11px; color: #555; line-height: 1.6;';
                    profileInfo.innerHTML = `<strong>N:</strong>${n.toFixed(0)} <strong>P:</strong>${parseFloat(p).toFixed(0)} <strong>K:</strong>${k.toFixed(0)} <strong>Ca:</strong>${ca.toFixed(0)} <strong>Mg:</strong>${mg.toFixed(0)} <strong>S:</strong>${s.toFixed(0)} <strong>Fe:</strong>${parseFloat(fe).toFixed(0)} <strong>Mn:</strong>${parseFloat(mn).toFixed(0)} <strong>B:</strong>${parseFloat(b).toFixed(0)} <strong>Zn:</strong>${parseFloat(zn).toFixed(0)} <strong>Cu:</strong>${parseFloat(cu).toFixed(0)} <strong>Mo:</strong>${parseFloat(mo).toFixed(0)}`;
                    
                    item.appendChild(date);
                    item.appendChild(desc);
                    item.appendChild(ratiosInfo);
                    item.appendChild(profileInfo);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏)
                    if (sortedIndex > 0) {
                        const prevEntry = sortedEntries[sortedIndex - 1];
                        if (prevEntry && prevEntry.fullProfile) {
                            const prevProfile = prevEntry.fullProfile;
                            const changes = [];
                            
                            // –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                            const elements = [
                                {key: 'N', label: 'N'},
                                {key: 'P', label: 'P'},
                                {key: 'K', label: 'K'},
                                {key: 'Ca', label: 'Ca'},
                                {key: 'Mg', label: 'Mg'},
                                {key: 'S', label: 'S'},
                                {key: 'Fe', label: 'Fe'},
                                {key: 'Mn', label: 'Mn'},
                                {key: 'B', label: 'B'},
                                {key: 'Zn', label: 'Zn'},
                                {key: 'Cu', label: 'Cu'},
                                {key: 'Mo', label: 'Mo'}
                            ];
                            
                            elements.forEach(el => {
                                const curr = parseFloat(profile[el.key]) || 0;
                                const prev = parseFloat(prevProfile[el.key]) || 0;
                                
                                if (prev !== 0 && curr !== prev) {
                                    const percentChange = ((curr - prev) / prev * 100);
                                    if (Math.abs(percentChange) >= 1) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è >= 1%
                                        const sign = percentChange > 0 ? '+' : '';
                                        changes.push(`${el.label}${sign}${percentChange.toFixed(0)}%`);
                                    }
                                }
                            });
                            
                            if (changes.length > 0) {
                                const changesInfo = document.createElement('div');
                                changesInfo.className = 'mobile-journal-changes';
                                changesInfo.style.cssText = 'margin-top: 4px; padding: 6px; background: #fff8e1; border-radius: 4px; font-size: 10px; color: #666; line-height: 1.4;';
                                changesInfo.innerHTML = `<strong>–ò–∑–º–µ–Ω–µ–Ω–∏—è:</strong> ${changes.join(' ')}`;
                                item.appendChild(changesInfo);
                            }
                        }
                    }
                } else {
                    item.appendChild(date);
                    item.appendChild(desc);
                }
                
                const memo = document.createElement('div');
                memo.className = 'mobile-journal-memo';
                memo.textContent = entry.memo || '';
                if (entry.memo) item.appendChild(memo);
                
                list.appendChild(item);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞
        function showJournalDetails(index) {
            const entry = journalEntries[index];
            if (!entry) return;
            
            if (!entry.fullProfile) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
            const currentProfile = getValues();
            const journalProfile = entry.fullProfile;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º EC –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
            let currentEC = parseFloat(currentProfile.EC) || 0;
            if (currentEC === 0 && currentProfile.NH4 && currentProfile.Ca && currentProfile.Mg && currentProfile.K && currentProfile.N) {
                const vNH4 = parseFloat(currentProfile.NH4);
                const vCa = parseFloat(currentProfile.Ca);
                const vMg = parseFloat(currentProfile.Mg);
                const vK = parseFloat(currentProfile.K);
                const vN = parseFloat(currentProfile.N);
                currentEC = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                            2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                            2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
            }
            
            let journalEC = parseFloat(journalProfile.EC) || 0;
            if (journalEC === 0 && journalProfile.NH4 && journalProfile.Ca && journalProfile.Mg && journalProfile.K && journalProfile.N) {
                const vNH4 = parseFloat(journalProfile.NH4);
                const vCa = parseFloat(journalProfile.Ca);
                const vMg = parseFloat(journalProfile.Mg);
                const vK = parseFloat(journalProfile.K);
                const vN = parseFloat(journalProfile.N);
                journalEC = 0.095 * (vNH4 * molCa * molMg * molK + 2 * vCa * molN * molMg * molK + 
                            2 * vMg * molN * molCa * molK + vK * molN * molCa * molMg + 
                            2 * molN * molCa * molMg * molK) / (molN * molCa * molMg * molK);
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            const currN = parseFloat(currentProfile.N) || 0;
            const currK = parseFloat(currentProfile.K) || 0;
            const currCa = parseFloat(currentProfile.Ca) || 0;
            const currMg = parseFloat(currentProfile.Mg) || 0;
            const currNH4 = parseFloat(currentProfile.NH4) || 0;
            const currNO3 = parseFloat(currentProfile.NO3) || 0;
            
            const currKN = currN !== 0 ? (currK / currN) : 0;
            const currKCa = currCa !== 0 ? (currK / currCa) : 0;
            const currKMg = currMg !== 0 ? (currK / currMg) : 0;
            const currNH4NO3 = currNO3 !== 0 ? (currNH4 / currNO3) : 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –¥–ª—è –∂—É—Ä–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            const jourN = parseFloat(journalProfile.N) || 0;
            const jourK = parseFloat(journalProfile.K) || 0;
            const jourCa = parseFloat(journalProfile.Ca) || 0;
            const jourMg = parseFloat(journalProfile.Mg) || 0;
            const jourNH4 = parseFloat(journalProfile.NH4) || 0;
            const jourNO3 = parseFloat(journalProfile.NO3) || 0;
            
            const jourKN = jourN !== 0 ? (jourK / jourN) : 0;
            const jourKCa = jourCa !== 0 ? (jourK / jourCa) : 0;
            const jourKMg = jourMg !== 0 ? (jourK / jourMg) : 0;
            const jourNH4NO3 = jourNO3 !== 0 ? (jourNH4 / jourNO3) : 0;
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –Ω–∞—Ö–æ–¥–∏–º —Ä–∞–∑–ª–∏—á–∏—è (—Å–Ω–∞—á–∞–ª–∞ –º–∞–∫—Ä–æ, –ø–æ—Ç–æ–º –º–∏–∫—Ä–æ)
            const elements = ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'NH4', 'NO3', 'Cl'];
            const microElements = ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo'];
            const differences = [];
            
            elements.forEach(el => {
                let curr = parseFloat(currentProfile[el]) || 0;
                let jour = parseFloat(journalProfile[el]) || 0;
                
                // –î–ª—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤: —Ç–µ–∫—É—â–∏–µ –≤ –º–∫–≥, –∂—É—Ä–Ω–∞–ª—å–Ω—ã–µ –≤ –º–≥ - –ø—Ä–∏–≤–æ–¥–∏–º –∫ –º–≥
                if (microElements.includes(el)) {
                    curr = curr / 1000; // –º–∫–≥ -> –º–≥
                }
                
                if (Math.abs(curr - jour) > 0.01) {
                    const diff = jour - curr;
                    const percent = curr !== 0 ? ((diff / curr) * 100) : 0;
                    
                    if (Math.abs(percent) >= 1) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ >= 1%
                        const percentSign = percent > 0 ? '+' : '';
                        differences.push({
                            element: el,
                            current: curr.toFixed(2),
                            journal: jour.toFixed(2),
                            diff: `${percentSign}${percent.toFixed(0)}%`
                        });
                    }
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 10px; padding: 20px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Å EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏
            const ecRatiosDiffs = [];
            
            // EC
            const ecDiff = journalEC - currentEC;
            const ecPercent = currentEC !== 0 ? ((ecDiff / currentEC) * 100) : 0;
            if (Math.abs(ecPercent) >= 1) {
                const ecPercentSign = ecPercent > 0 ? '+' : '';
                const ecColor = ecDiff > 0 ? '#4CAF50' : '#f44336';
                ecRatiosDiffs.push({
                    param: 'EC',
                    current: currentEC.toFixed(2),
                    journal: journalEC.toFixed(2),
                    diff: `${ecPercentSign}${ecPercent.toFixed(0)}%`,
                    color: ecColor
                });
            }
            
            // NH4/NO3
            const nh4no3Diff = jourNH4NO3 - currNH4NO3;
            const nh4no3Percent = currNH4NO3 !== 0 ? ((nh4no3Diff / currNH4NO3) * 100) : 0;
            if (Math.abs(nh4no3Percent) >= 1) {
                const nh4no3PercentSign = nh4no3Percent > 0 ? '+' : '';
                const nh4no3Color = nh4no3Diff > 0 ? '#4CAF50' : '#f44336';
                ecRatiosDiffs.push({
                    param: 'NH4/NO3',
                    current: currNH4NO3.toFixed(2),
                    journal: jourNH4NO3.toFixed(2),
                    diff: `${nh4no3PercentSign}${nh4no3Percent.toFixed(0)}%`,
                    color: nh4no3Color
                });
            }
            
            // K/N
            const knDiff = jourKN - currKN;
            const knPercent = currKN !== 0 ? ((knDiff / currKN) * 100) : 0;
            if (Math.abs(knPercent) >= 1) {
                const knPercentSign = knPercent > 0 ? '+' : '';
                const knColor = knDiff > 0 ? '#4CAF50' : '#f44336';
                ecRatiosDiffs.push({
                    param: 'K/N',
                    current: currKN.toFixed(2),
                    journal: jourKN.toFixed(2),
                    diff: `${knPercentSign}${knPercent.toFixed(0)}%`,
                    color: knColor
                });
            }
            
            // K/Ca
            const kcaDiff = jourKCa - currKCa;
            const kcaPercent = currKCa !== 0 ? ((kcaDiff / currKCa) * 100) : 0;
            if (Math.abs(kcaPercent) >= 1) {
                const kcaPercentSign = kcaPercent > 0 ? '+' : '';
                const kcaColor = kcaDiff > 0 ? '#4CAF50' : '#f44336';
                ecRatiosDiffs.push({
                    param: 'K/Ca',
                    current: currKCa.toFixed(2),
                    journal: jourKCa.toFixed(2),
                    diff: `${kcaPercentSign}${kcaPercent.toFixed(0)}%`,
                    color: kcaColor
                });
            }
            
            // K/Mg
            const kmgDiff = jourKMg - currKMg;
            const kmgPercent = currKMg !== 0 ? ((kmgDiff / currKMg) * 100) : 0;
            if (Math.abs(kmgPercent) >= 1) {
                const kmgPercentSign = kmgPercent > 0 ? '+' : '';
                const kmgColor = kmgDiff > 0 ? '#4CAF50' : '#f44336';
                ecRatiosDiffs.push({
                    param: 'K/Mg',
                    current: currKMg.toFixed(2),
                    journal: jourKMg.toFixed(2),
                    diff: `${kmgPercentSign}${kmgPercent.toFixed(0)}%`,
                    color: kmgColor
                });
            }
            
            let ecRatiosTable = '';
            if (ecRatiosDiffs.length > 0) {
                ecRatiosTable = '<div style="margin: 15px 0;"><strong>EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è:</strong><table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 12px;"><tr style="background: #e8f4ff; font-weight: bold;"><td style="padding: 5px; border: 1px solid #ddd;">–ü–∞—Ä–∞–º–µ—Ç—Ä</td><td style="padding: 5px; border: 1px solid #ddd;">–¢–µ–∫—É—â–∏–π</td><td style="padding: 5px; border: 1px solid #ddd;">–ò–∑ –∂—É—Ä–Ω–∞–ª–∞</td><td style="padding: 5px; border: 1px solid #ddd;">–†–∞–∑–Ω–∏—Ü–∞</td></tr>';
                ecRatiosDiffs.forEach(r => {
                    ecRatiosTable += `<tr><td style="padding: 5px; border: 1px solid #ddd;"><strong>${r.param}</strong></td><td style="padding: 5px; border: 1px solid #ddd;">${r.current}</td><td style="padding: 5px; border: 1px solid #ddd;">${r.journal}</td><td style="padding: 5px; border: 1px solid #ddd; color: ${r.color}; font-weight: bold;">${r.diff}</td></tr>`;
                });
                ecRatiosTable += '</table></div>';
            }
            
            let diffTable = '';
            if (differences.length > 0) {
                diffTable = '<div style="margin: 15px 0;"><strong>–ò–∑–º–µ–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤:</strong><table style="width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 12px;"><tr style="background: #f0f0f0; font-weight: bold;"><td style="padding: 5px; border: 1px solid #ddd;">–≠–ª–µ–º–µ–Ω—Ç</td><td style="padding: 5px; border: 1px solid #ddd;">–¢–µ–∫—É—â–∏–π</td><td style="padding: 5px; border: 1px solid #ddd;">–ò–∑ –∂—É—Ä–Ω–∞–ª–∞</td><td style="padding: 5px; border: 1px solid #ddd;">–†–∞–∑–Ω–∏—Ü–∞</td></tr>';
                differences.forEach(d => {
                    const color = d.diff.startsWith('+') ? '#4CAF50' : '#f44336';
                    diffTable += `<tr><td style="padding: 5px; border: 1px solid #ddd;"><strong>${d.element}</strong></td><td style="padding: 5px; border: 1px solid #ddd;">${d.current}</td><td style="padding: 5px; border: 1px solid #ddd;">${d.journal}</td><td style="padding: 5px; border: 1px solid #ddd; color: ${color}; font-weight: bold;">${d.diff}</td></tr>`;
                });
                diffTable += '</table></div>';
            } else {
                diffTable = '<div style="margin: 15px 0; color: #4CAF50;"><strong>‚úì –≠–ª–µ–º–µ–Ω—Ç—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ç–µ–∫—É—â–∏–º–∏</strong></div>';
            }
            
            modalContent.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #333;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –∂—É—Ä–Ω–∞–ª–∞?</h3>
                <div style="margin-bottom: 10px;"><strong>–î–∞—Ç–∞:</strong> ${entry.date}</div>
                <div style="margin-bottom: 10px;"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${entry.desc}</div>
                ${entry.memo ? `<div style="margin-bottom: 10px;"><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${entry.memo}</div>` : ''}
                ${ecRatiosTable}
                ${diffTable}
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="modal-apply" style="flex: 1; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button id="modal-cancel" style="flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('modal-apply').onclick = () => {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –∂—É—Ä–Ω–∞–ª–∞ (–∫–∞–∫ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ acceptProfileFromJournal)
                // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è –≤ profile-string –∏ –≤—ã–∑—ã–≤–∞–µ–º –ø–∞—Ä—Å–µ—Ä
                const profileString = entry.profile;
                if (profileString) {
                    document.getElementById('profile-string').value = profileString;
                    parseProfile(); // –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –ø–æ–ª—è
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.body.removeChild(modal);
                
                // –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É - –æ—Å—Ç–∞–µ–º—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–π
            };
            
            document.getElementById('modal-cancel').onclick = () => {
                document.body.removeChild(modal);
            };
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        function checkMobileBanner() {
            const bannerClosed = localStorage.getItem('hpg_mobile_banner_closed');
            if (!bannerClosed) {
                document.getElementById('mobile-info-banner').style.display = 'block';
            }
        }

        // –°–≤–∞–π–ø-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        function initSwipeControls() {
            const inputs = document.querySelectorAll('.mobile-version input[type="number"]');
            
            inputs.forEach(input => {
                let startX = 0;
                let lastX = 0;
                let isDragging = false;
                let isSwipeMode = false; // –†–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ—Ç
                let initialValue = 0;
                let wrapper = input.parentElement;
                let lastUpdateTime = 0;
                let tapTimeout = null;
                
                // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–≤–∞–π–ø–∞
                if (!wrapper.querySelector('.swipe-indicator')) {
                    wrapper.style.position = 'relative';
                    const leftIndicator = document.createElement('div');
                    leftIndicator.className = 'swipe-indicator left';
                    leftIndicator.textContent = '‚àí';
                    const rightIndicator = document.createElement('div');
                    rightIndicator.className = 'swipe-indicator right';
                    rightIndicator.textContent = '+';
                    wrapper.appendChild(leftIndicator);
                    wrapper.appendChild(rightIndicator);
                }
                
                const leftInd = wrapper.querySelector('.swipe-indicator.left');
                const rightInd = wrapper.querySelector('.swipe-indicator.right');
                
                let allowFocus = false; // –§–ª–∞–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ–∫—É—Å –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∞–ø –ø–æ —á–∏—Å–ª—É
                input.addEventListener('focus', (e) => {
                    if (!allowFocus) {
                        e.preventDefault();
                        input.blur();
                    }
                    allowFocus = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
                });
                
                input.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    lastX = startX;
                    initialValue = parseFloat(input.value) || 0;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–∞–ø–∞
                    const rect = input.getBoundingClientRect();
                    const tapX = e.touches[0].clientX - rect.left;
                    const fieldWidth = rect.width;
                    
                    // –¢–∞–ø –ø–æ —á–∏—Å–ª—É —Å–ø—Ä–∞–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30% —à–∏—Ä–∏–Ω—ã) - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                    if (tapX > fieldWidth * 0.7) {
                        allowFocus = true; // –†–∞–∑—Ä–µ—à–∞–µ–º —Ñ–æ–∫—É—Å
                        return; // –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                    }
                    
                    // –¢–∞–ø –ø–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π/–ª–µ–≤–æ–π —á–∞—Å—Ç–∏ - –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–≤–∞–π–ø–∞
                    allowFocus = false; // –ó–∞–ø—Ä–µ—â–∞–µ–º —Ñ–æ–∫—É—Å
                    
                    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
                    if (!isSwipeMode) {
                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞
                        isSwipeMode = true;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ä–∞–∑—É
                        leftInd.classList.add('active');
                        rightInd.classList.add('active');
                        input.classList.add('swipe-mode');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
                        tapTimeout = setTimeout(() => {
                            isSwipeMode = false;
                            leftInd.classList.remove('active');
                            rightInd.classList.remove('active');
                            input.classList.remove('swipe-mode', 'swipe-left', 'swipe-right');
                        }, 3000);
                        return; // –ù–µ –Ω–∞—á–∏–Ω–∞–µ–º –¥—Ä–∞–≥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ç–∞–ø–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    }
                    
                    // –†–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –∞–∫—Ç–∏–≤–µ–Ω - –º–æ–∂–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å –¥—Ä–∞–≥
                    isDragging = true;
                    lastUpdateTime = Date.now();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    if (tapTimeout) {
                        clearTimeout(tapTimeout);
                        tapTimeout = null;
                    }
                }, { passive: true });
                
                input.addEventListener('touchmove', (e) => {
                    if (!isDragging || !isSwipeMode) return;
                    
                    const currentX = e.touches[0].clientX;
                    const totalDiff = currentX - startX;
                    const step = parseFloat(input.step) || 1;
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    if (totalDiff < -5) {
                        input.classList.add('swipe-left');
                        input.classList.remove('swipe-right');
                    } else if (totalDiff > 5) {
                        input.classList.add('swipe-right');
                        input.classList.remove('swipe-left');
                    } else {
                        input.classList.remove('swipe-left', 'swipe-right');
                    }
                    
                    // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    // –ö–∞–∂–¥—ã–µ 10 –ø–∏–∫—Å–µ–ª–µ–π = 1 —à–∞–≥
                    const pixelsPerStep = 10;
                    const steps = Math.round(totalDiff / pixelsPerStep);
                    let newValue = initialValue + (steps * step);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º—É–º –Ω—É–ª–µ–º
                    newValue = Math.max(0, newValue);
                    
                    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –Ω—É–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
                    const decimals = step < 1 ? (step.toString().split('.')[1] || '').length : 0;
                    newValue = parseFloat(newValue.toFixed(decimals));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                    if (parseFloat(input.value) !== newValue) {
                        input.value = newValue;
                        
                        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –≤—ã–∑–æ–≤–∞ input —Å–æ–±—ã—Ç–∏—è (–Ω–µ —á–∞—â–µ 50ms)
                        const now = Date.now();
                        if (now - lastUpdateTime > 50) {
                            input.dispatchEvent(new Event('input'));
                            lastUpdateTime = now;
                        }
                    }
                    
                    lastX = currentX;
                }, { passive: true });
                
                input.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    
                    // –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    input.dispatchEvent(new Event('input'));
                    
                    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    input.classList.remove('swipe-left', 'swipe-right');
                    
                    isDragging = false;
                    startX = 0;
                    lastX = 0;
                    
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    tapTimeout = setTimeout(() => {
                        isSwipeMode = false;
                        leftInd.classList.remove('active');
                        rightInd.classList.remove('active');
                        input.classList.remove('swipe-mode');
                    }, 2000);
                }, { passive: true });
            });
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–π
        function syncVolumeToDesktop(value) {
            document.getElementById('volume').value = value;
            onVolumeChange(); // –í—ã–∑—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞
            updateMobileDisplay();
        }

        function syncMacroToDesktop(element, value) {
            document.getElementById(element).value = value;
            
            // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            switch(element) {
                case 'N':
                    onNChange();
                    break;
                case 'NO3':
                    onNO3Change();
                    break;
                case 'NH4':
                    onNH4Change();
                    break;
                case 'P':
                    onPChange();
                    break;
                case 'S':
                    onSChange();
                    break;
                case 'K':
                case 'Ca':
                case 'Mg':
                    onMacroChange();
                    break;
                default:
                    calcAll();
            }
            
            updateMobileDisplay();
        }

        function syncMicroToDesktop(element, value) {
            document.getElementById(element).value = value;
            onMicroChange(); // –í—ã–∑—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞
            updateMobileDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function updateMobileDisplay() {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø–æ–ª–µ–π –≤ –º–æ–±–∏–ª—å–Ω—ã–µ
            document.getElementById('mobile-volume-display').value = document.getElementById('volume').value;
            
            // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
            document.getElementById('mobile-N-display').value = document.getElementById('N').value;
            document.getElementById('mobile-NO3-display').value = document.getElementById('NO3').value;
            document.getElementById('mobile-NH4-display').value = document.getElementById('NH4').value;
            document.getElementById('mobile-P-display').value = document.getElementById('P').value;
            document.getElementById('mobile-K-display').value = document.getElementById('K').value;
            document.getElementById('mobile-Ca-display').value = document.getElementById('Ca').value;
            document.getElementById('mobile-Mg-display').value = document.getElementById('Mg').value;
            document.getElementById('mobile-S-display').value = document.getElementById('S').value;
            document.getElementById('mobile-Cl-display').value = document.getElementById('Cl').value;
            
            // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
            document.getElementById('mobile-Fe-display').value = document.getElementById('Fe').value;
            document.getElementById('mobile-Mn-display').value = document.getElementById('Mn').value;
            document.getElementById('mobile-B-display').value = document.getElementById('B').value;
            document.getElementById('mobile-Zn-display').value = document.getElementById('Zn').value;
            document.getElementById('mobile-Cu-display').value = document.getElementById('Cu').value;
            document.getElementById('mobile-Mo-display').value = document.getElementById('Mo').value;
            document.getElementById('mobile-Co-display').value = document.getElementById('Co').value;
            document.getElementById('mobile-Si-display').value = document.getElementById('Si').value;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è (–∫—Ä–æ–º–µ B)
            const isComplexMode = document.getElementById('use_complex')?.checked || false;
            const microFields = ['mobile-Fe-display', 'mobile-Mn-display', 'mobile-Zn-display', 'mobile-Cu-display', 'mobile-Mo-display', 'mobile-Co-display', 'mobile-Si-display'];
            
            if (isComplexMode) {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –∫—Ä–æ–º–µ B
                microFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.readOnly = true;
                        field.style.background = '#e8e8e8';
                        field.style.color = '#666';
                    }
                });
                // B –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
                const bField = document.getElementById('mobile-B-display');
                if (bField) {
                    bField.readOnly = false;
                    bField.style.background = '';
                    bField.style.color = '';
                }
            } else {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                microFields.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.readOnly = false;
                        field.style.background = '';
                        field.style.color = '';
                    }
                });
                const bField = document.getElementById('mobile-B-display');
                if (bField) {
                    bField.readOnly = false;
                    bField.style.background = '';
                    bField.style.color = '';
                }
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
            const mobileFileName = document.getElementById('mobile-file-name');
            const mobileFileDesc = document.getElementById('mobile-file-desc');
            if (mobileFileName) mobileFileName.textContent = document.getElementById('file_filename').value;
            if (mobileFileDesc) mobileFileDesc.textContent = document.getElementById('file_comment').value;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º EC –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
            const mobileEC = document.getElementById('mobile-ec');
            const mobileP = document.getElementById('mobile-p');
            const mobileCl = document.getElementById('mobile-cl');
            const mobileNH4NO3 = document.getElementById('mobile-nh4no3');
            const mobileKN = document.getElementById('mobile-kn');
            const mobileKCa = document.getElementById('mobile-kca');
            const mobileKMg = document.getElementById('mobile-kmg');
            
            if (mobileEC) mobileEC.textContent = parseFloat(document.getElementById('EC').value).toFixed(2);
            if (mobileP) mobileP.textContent = parseFloat(document.getElementById('P').value).toFixed(0);
            if (mobileCl) mobileCl.textContent = parseFloat(document.getElementById('Cl').value).toFixed(0);
            if (mobileNH4NO3) mobileNH4NO3.textContent = parseFloat(document.getElementById('NH4_ratio').value).toFixed(2);
            if (mobileKN) mobileKN.textContent = parseFloat(document.getElementById('m_K_N').value).toFixed(2);
            if (mobileKCa) mobileKCa.textContent = parseFloat(document.getElementById('m_K_Ca').value).toFixed(2);
            if (mobileKMg) mobileKMg.textContent = parseFloat(document.getElementById('m_K_Mg').value).toFixed(2);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
            updateMobileRatios();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            updateMobileResults();
        }

        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤
        function toggleAccordion(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                content.classList.add('open');
                icon.classList.add('open');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—á–∏—Ç–∞–µ–º –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã)
        function updateMobileRatios() {
            // –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π
            const matrixData = [
                { row: 'N', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] },
                { row: 'P', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] },
                { row: 'K', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] },
                { row: 'Ca', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] },
                { row: 'Mg', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] },
                { row: 'S', cols: ['N', 'P', 'K', 'Ca', 'Mg', 'S'] }
            ];

            let html = '<div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">';
            html += '<table style="border-collapse: collapse; font-size: 14px; width: 100%;">';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            html += '<thead><tr style="background: #e8f5e9;">';
            html += '<th style="padding: 8px 2px; border: 1px solid #ddd; font-weight: bold; width: 40px;"></th>';
            matrixData[0].cols.forEach(col => {
                html += `<th style="padding: 8px 2px; border: 1px solid #ddd; font-weight: bold; text-align: center;">${col}</th>`;
            });
            html += '</tr></thead>';
            
            // –°—Ç—Ä–æ–∫–∏ –º–∞—Ç—Ä–∏—Ü—ã
            html += '<tbody>';
            matrixData.forEach(rowData => {
                html += '<tr>';
                html += `<th style="padding: 8px 2px; border: 1px solid #ddd; font-weight: bold; background: #e8f5e9; text-align: center;">${rowData.row}</th>`;
                
                rowData.cols.forEach(col => {
                    if (rowData.row === col) {
                        // –î–∏–∞–≥–æ–Ω–∞–ª—å - –≤—Å–µ–≥–¥–∞ 1
                        html += '<td style="padding: 8px 2px; border: 1px solid #ddd; text-align: center; background: #f5f5f5; font-weight: bold;">1</td>';
                    } else {
                        // –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã
                        const inputId = `m_${col}_${rowData.row}`;
                        const input = document.getElementById(inputId);
                        const value = input ? parseFloat(input.value).toFixed(2) : '0.00';
                        html += `<td style="padding: 8px 2px; border: 1px solid #ddd; text-align: center;">${value}</td>`;
                    }
                });
                
                html += '</tr>';
            });
            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            document.getElementById('mobile-ratios-content').innerHTML = html;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—á–∏—Ç–∞–µ–º –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø–æ–ª–µ–π)
        function updateMobileResults() {
            // –ï—Å–ª–∏ –∏–¥–µ—Ç —Å–≤–∞–π–ø - –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            if (isSwiping) {
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø–æ–ª–µ–π
            const salts = [
                { id: 'CaNO3', label: 'label_CaNO3' },
                { id: 'KNO3', label: 'label_KNO3' },
                { id: 'NH4NO3', label: 'label_NH4NO3' },
                { id: 'MgSO4', label: 'label_MgSO4' },
                { id: 'KH2PO4', label: 'label_KH2PO4' },
                { id: 'K2SO4', label: 'label_K2SO4' },
                { id: 'MgNO3', label: 'label_MgNO3' },
                { id: 'CaCl2', label: 'label_CaCl2' }
            ];

            const micros = [
                { id: 'Fe', label: 'micro_Fe_label' },
                { id: 'Mn', label: 'micro_Mn_label' },
                { id: 'B', label: 'micro_B_label' },
                { id: 'Zn', label: 'micro_Zn_label' },
                { id: 'Cu', label: 'micro_Cu_label' },
                { id: 'Mo', label: 'micro_Mo_label' },
                { id: 'Co', label: 'micro_Co_label' },
                { id: 'Si', label: 'micro_Si_label' }
            ];

            let html = '<div style="font-size: 14px;">';
            html += '<div style="position: relative; margin: 10px 0;"><h4 style="margin: 0; color: #2e7d32; display: inline;">–ú–∞–∫—Ä–æ—Å–æ–ª–∏:</h4><span style="position: absolute; right: 0; top: 2px; font-size: 12px; color: #999; font-weight: normal;">–≥—Ä–∞–º–º</span></div>';
            
            // –ú–∞–∫—Ä–æ—Å–æ–ª–∏ —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
            salts.forEach(salt => {
                const weight = parseFloat(document.getElementById('g_' + salt.id)?.value) || 0;
                if (weight > 0) {
                    const labelEl = document.getElementById(salt.label);
                    const name = labelEl ? labelEl.textContent : salt.id;
                    html += `<div style="margin-bottom: 8px;">
                        <div style="position: relative;">
                            <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">${name}:</div>
                            <input type="number" 
                                   id="mobile-salt-${salt.id}" 
                                   value="${weight.toFixed(2)}" 
                                   step="0.01" 
                                   oninput="syncSaltToDesktop('${salt.id}', this.value)"
                                   style="width: 100%; padding: 10px 10px 10px 30px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                        </div>
                    </div>`;
                }
            });

            html += '<div style="position: relative; margin: 15px 0 10px 0;"><h4 style="margin: 0; color: #2e7d32; display: inline;">–ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã:</h4><span style="position: absolute; right: 0; top: 2px; font-size: 12px; color: #999; font-weight: normal;">–≥—Ä–∞–º–º</span></div>';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞
            const isComplexMode = document.getElementById('use_complex')?.checked || false;
            
            if (isComplexMode) {
                // –†–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—â—É—é –Ω–∞–≤–µ—Å–∫—É –∫–æ–º–ø–ª–µ–∫—Å–∞
                const complexWeight = parseFloat(document.getElementById('total_micro_grams')?.value) || 0;
                if (complexWeight > 0) {
                    // –ß–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö –ø–æ–ª–µ–π
                    const pFe = parseFloat(document.getElementById('micro_Fe_percent')?.value) || 0;
                    const pMn = parseFloat(document.getElementById('micro_Mn_percent')?.value) || 0;
                    const pB = parseFloat(document.getElementById('micro_B_percent')?.value) || 0;
                    const pZn = parseFloat(document.getElementById('micro_Zn_percent')?.value) || 0;
                    const pCu = parseFloat(document.getElementById('micro_Cu_percent')?.value) || 0;
                    const pMo = parseFloat(document.getElementById('micro_Mo_percent')?.value) || 0;
                    const pCo = parseFloat(document.getElementById('micro_Co_percent')?.value) || 0;
                    const pSi = parseFloat(document.getElementById('micro_Si_percent')?.value) || 0;
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ—Å—Ç–∞–≤–∞ (–æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞, —É–±–∏—Ä–∞–µ–º .0)
                    const formatPercent = (val) => {
                        const rounded = val.toFixed(1);
                        return rounded.endsWith('.0') ? rounded.slice(0, -2) : rounded;
                    };
                    const line1 = `Fe:${formatPercent(pFe)}% Mn:${formatPercent(pMn)}% B:${formatPercent(pB)}% Zn:${formatPercent(pZn)}%`;
                    const line2 = `Cu:${formatPercent(pCu)}% Mo:${formatPercent(pMo)}% Co:${formatPercent(pCo)}% Si:${formatPercent(pSi)}%`;
                    
                    html += `<div style="margin-bottom: 8px;">
                        <div style="position: relative;">
                            <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: #333; pointer-events: none; z-index: 1; line-height: 1.3;">
                                –ú–∏–∫—Ä–æ–∫–æ–º–ø–ª–µ–∫—Å<br>${line1}<br>${line2}
                            </div>
                            <input type="number" 
                                   id="mobile-complex-total" 
                                   value="${complexWeight.toFixed(2)}" 
                                   step="0.01" 
                                   oninput="syncComplexToDesktop(this.value)"
                                   style="width: 100%; padding: 10px 10px 10px 30px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold; height: 60px;">
                        </div>
                    </div>`;
                }
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
                const microPercents = {
                    Fe: parseFloat(document.getElementById('micro_Fe_percent')?.value) || 0,
                    Mn: parseFloat(document.getElementById('micro_Mn_percent')?.value) || 0,
                    B: parseFloat(document.getElementById('micro_B_percent')?.value) || 0,
                    Zn: parseFloat(document.getElementById('micro_Zn_percent')?.value) || 0,
                    Cu: parseFloat(document.getElementById('micro_Cu_percent')?.value) || 0,
                    Mo: parseFloat(document.getElementById('micro_Mo_percent')?.value) || 0,
                    Co: parseFloat(document.getElementById('micro_Co_percent')?.value) || 0,
                    Si: parseFloat(document.getElementById('micro_Si_percent')?.value) || 0
                };
                
                const microNames = {
                    Fe: '–ñ–µ–ª–µ–∑–æ',
                    Mn: '–ú–∞—Ä–≥–∞–Ω–µ—Ü',
                    B: '–ë–æ—Ä',
                    Zn: '–¶–∏–Ω–∫',
                    Cu: '–ú–µ–¥—å',
                    Mo: '–ú–æ–ª–∏–±–¥–µ–Ω',
                    Co: '–ö–æ–±–∞–ª—å—Ç',
                    Si: '–ö—Ä–µ–º–Ω–∏–π'
                };
                
                micros.forEach(micro => {
                    const weight = parseFloat(document.getElementById('g_' + micro.id)?.value) || 0;
                    if (weight > 0) {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º: "–ñ–µ–ª–µ–∑–æ (Fe) 8.143%"
                        const baseName = microNames[micro.id] || micro.id;
                        const percent = microPercents[micro.id] || 0;
                        const name = `${baseName} (${micro.id}) ${percent}%`;
                        
                        html += `<div style="margin-bottom: 8px;">
                            <div style="position: relative;">
                                <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">${name}:</div>
                                <input type="number" 
                                       id="mobile-micro-${micro.id}" 
                                       value="${weight.toFixed(2)}" 
                                       step="0.01" 
                                       oninput="syncMicroSaltToDesktop('${micro.id}', this.value)"
                                       style="width: 100%; padding: 10px 10px 10px 30px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                            </div>
                        </div>`;
                    }
                });
            }

            const totalSalts = parseFloat(document.getElementById('total-salts')?.value) || 0;
            html += `<div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px; text-align: center;">`;
            html += `<strong style="font-size: 16px;">–í—Å–µ–≥–æ —Å–æ–ª–µ–π: ${totalSalts.toFixed(2)} –≥</strong>`;
            html += `</div>`;
            html += '</div>';

            document.getElementById('mobile-results-content').innerHTML = html;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–≤–∞–π–ø-–∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
            initSwipeControlsForSalts();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø-–∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –¥–ª—è –Ω–∞–≤–µ—Å–æ–∫ —Å–æ–ª–µ–π
        function initSwipeControlsForSalts() {
            const inputs = document.querySelectorAll('#mobile-results-content input[type="number"]');
            
            inputs.forEach(input => {
                let startX = 0;
                let lastX = 0;
                let isDragging = false;
                let isSwipeMode = false; // –†–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ—Ç
                let initialValue = 0;
                let wrapper = input.parentElement;
                let lastUpdateTime = 0;
                let tapTimeout = null;
                
                // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–≤–∞–π–ø–∞
                if (!wrapper.querySelector('.swipe-indicator')) {
                    wrapper.style.position = 'relative';
                    const leftIndicator = document.createElement('div');
                    leftIndicator.className = 'swipe-indicator left';
                    leftIndicator.textContent = '‚àí';
                    const rightIndicator = document.createElement('div');
                    rightIndicator.className = 'swipe-indicator right';
                    rightIndicator.textContent = '+';
                    wrapper.appendChild(leftIndicator);
                    wrapper.appendChild(rightIndicator);
                }
                
                const leftInd = wrapper.querySelector('.swipe-indicator.left');
                const rightInd = wrapper.querySelector('.swipe-indicator.right');
                
                let allowFocus = false; // –§–ª–∞–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ–∫—É—Å –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∞–ø –ø–æ —á–∏—Å–ª—É
                input.addEventListener('focus', (e) => {
                    if (!allowFocus) {
                        e.preventDefault();
                        input.blur();
                    }
                    allowFocus = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
                });
                
                input.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    lastX = startX;
                    initialValue = parseFloat(input.value) || 0;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–∞–ø–∞
                    const rect = input.getBoundingClientRect();
                    const tapX = e.touches[0].clientX - rect.left;
                    const fieldWidth = rect.width;
                    
                    // –¢–∞–ø –ø–æ —á–∏—Å–ª—É —Å–ø—Ä–∞–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30% —à–∏—Ä–∏–Ω—ã) - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                    if (tapX > fieldWidth * 0.7) {
                        allowFocus = true; // –†–∞–∑—Ä–µ—à–∞–µ–º —Ñ–æ–∫—É—Å
                        return; // –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                    }
                    
                    // –¢–∞–ø –ø–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π/–ª–µ–≤–æ–π —á–∞—Å—Ç–∏ - –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–≤–∞–π–ø–∞
                    allowFocus = false; // –ó–∞–ø—Ä–µ—â–∞–µ–º —Ñ–æ–∫—É—Å
                    
                    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
                    if (!isSwipeMode) {
                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞
                        isSwipeMode = true;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ä–∞–∑—É
                        leftInd.classList.add('active');
                        rightInd.classList.add('active');
                        input.classList.add('swipe-mode');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
                        tapTimeout = setTimeout(() => {
                            isSwipeMode = false;
                            leftInd.classList.remove('active');
                            rightInd.classList.remove('active');
                            input.classList.remove('swipe-mode', 'swipe-left', 'swipe-right');
                        }, 3000);
                        return; // –ù–µ –Ω–∞—á–∏–Ω–∞–µ–º –¥—Ä–∞–≥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ç–∞–ø–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    }
                    
                    // –†–µ–∂–∏–º —Å–≤–∞–π–ø–∞ –∞–∫—Ç–∏–≤–µ–Ω - –º–æ–∂–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å –¥—Ä–∞–≥
                    isDragging = true;
                    lastUpdateTime = Date.now();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    if (tapTimeout) {
                        clearTimeout(tapTimeout);
                        tapTimeout = null;
                    }
                }, { passive: true });
                
                input.addEventListener('touchmove', (e) => {
                    if (!isDragging || !isSwipeMode) return;
                    
                    const currentX = e.touches[0].clientX;
                    const totalDiff = currentX - startX;
                    const step = parseFloat(input.step) || 0.01;
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    if (totalDiff < -5) {
                        input.classList.add('swipe-left');
                        input.classList.remove('swipe-right');
                    } else if (totalDiff > 5) {
                        input.classList.add('swipe-right');
                        input.classList.remove('swipe-left');
                    } else {
                        input.classList.remove('swipe-left', 'swipe-right');
                    }
                    
                    // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    const pixelsPerStep = 10;
                    const steps = Math.round(totalDiff / pixelsPerStep);
                    let newValue = initialValue + (steps * step);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º—É–º –Ω—É–ª–µ–º
                    newValue = Math.max(0, newValue);
                    
                    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –Ω—É–∂–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
                    const decimals = step < 1 ? (step.toString().split('.')[1] || '').length : 0;
                    newValue = parseFloat(newValue.toFixed(decimals));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                    if (parseFloat(input.value) !== newValue) {
                        input.value = newValue;
                        
                        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –≤—ã–∑–æ–≤–∞
                        const now = Date.now();
                        if (now - lastUpdateTime > 50) {
                            input.dispatchEvent(new Event('input'));
                            lastUpdateTime = now;
                        }
                    }
                    
                    lastX = currentX;
                }, { passive: true });
                
                input.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    
                    // –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    input.dispatchEvent(new Event('input'));
                    
                    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    input.classList.remove('swipe-left', 'swipe-right');
                    
                    isDragging = false;
                    startX = 0;
                    lastX = 0;
                    
                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Å–≤–∞–π–ø–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    tapTimeout = setTimeout(() => {
                        isSwipeMode = false;
                        leftInd.classList.remove('active');
                        rightInd.classList.remove('active');
                        input.classList.remove('swipe-mode');
                    }, 2000);
                }, { passive: true });
            });
        }
        
        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≤–æ –≤—Ä–µ–º—è —Å–≤–∞–π–ø–∞
        let isSwiping = false;
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞–≤–µ—Å–æ–∫ –º–∞–∫—Ä–æ—Å–æ–ª–µ–π —Å –¥–µ—Å–∫—Ç–æ–ø–æ–º
        function syncSaltToDesktop(saltId, value) {
            const desktopInput = document.getElementById('g_' + saltId);
            if (desktopInput) {
                isSwiping = true;
                desktopInput.value = value;
                // –í—ã–∑—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞
                onSaltWeightChange();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ
                updateMobileSaltsValues();
                isSwiping = false;
            }
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞–≤–µ—Å–æ–∫ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –¥–µ—Å–∫—Ç–æ–ø–æ–º
        function syncMicroSaltToDesktop(microId, value) {
            const desktopInput = document.getElementById('g_' + microId);
            if (desktopInput) {
                isSwiping = true;
                desktopInput.value = value;
                // –í—ã–∑—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞
                onMicroWeightChange();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
                updateMobileSaltsValues();
                isSwiping = false;
            }
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–∞ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –¥–µ—Å–∫—Ç–æ–ø–æ–º
        function syncComplexToDesktop(value) {
            const desktopInput = document.getElementById('total_micro_grams');
            if (desktopInput) {
                isSwiping = true;
                desktopInput.value = value;
                // –í—ã–∑—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞
                onTotalMicroGramsChange();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
                updateMobileSaltsValues();
                isSwiping = false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
        function updateMobileSaltsValues() {
            const salts = ['CaNO3', 'KNO3', 'NH4NO3', 'MgSO4', 'KH2PO4', 'K2SO4', 'MgNO3', 'CaCl2'];
            const micros = ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo', 'Co', 'Si'];
            const isComplexMode = document.getElementById('use_complex')?.checked || false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–æ–ª–µ–π
            salts.forEach(saltId => {
                const mobileInput = document.getElementById('mobile-salt-' + saltId);
                const desktopInput = document.getElementById('g_' + saltId);
                if (mobileInput && desktopInput && mobileInput !== document.activeElement) {
                    mobileInput.value = parseFloat(desktopInput.value).toFixed(2);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∫–æ–º–ø–ª–µ–∫—Å–∞
            if (isComplexMode) {
                // –†–µ–∂–∏–º –∫–æ–º–ø–ª–µ–∫—Å–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é –Ω–∞–≤–µ—Å–∫—É
                const mobileComplexInput = document.getElementById('mobile-complex-total');
                const desktopComplexInput = document.getElementById('total_micro_grams');
                if (mobileComplexInput && desktopComplexInput && mobileComplexInput !== document.activeElement) {
                    mobileComplexInput.value = parseFloat(desktopComplexInput.value).toFixed(2);
                }
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã
                micros.forEach(microId => {
                    const mobileInput = document.getElementById('mobile-micro-' + microId);
                    const desktopInput = document.getElementById('g_' + microId);
                    if (mobileInput && desktopInput && mobileInput !== document.activeElement) {
                        mobileInput.value = parseFloat(desktopInput.value).toFixed(3);
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
            const totalSalts = parseFloat(document.getElementById('total-salts')?.value) || 0;
            const totalDiv = document.querySelector('#mobile-results-content > div > div:last-child strong');
            if (totalDiv) {
                totalDiv.textContent = `–í—Å–µ–≥–æ —Å–æ–ª–µ–π: ${totalSalts.toFixed(2)} –≥`;
            }
        }
        
        // ===== FIREBASE CLOUD STORAGE =====
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAR5qXMGP8Erapla69wJ7cUbbF4MNlbkcY",
            authDomain: "wega-hpg.firebaseapp.com",
            projectId: "wega-hpg",
            storageBucket: "wega-hpg.firebasestorage.app",
            messagingSenderId: "652081809935",
            appId: "1:652081809935:web:84a407f1a6bfc719aa717a",
            measurementId: "G-W6EDZTWP3F"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firestore –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        const settings = {
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
            // –û—Ç–∫–ª—é—á–∞–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            experimentalForceLongPolling: false,
            experimentalAutoDetectLongPolling: true
        };
        db.settings(settings);
        
        // –í–∫–ª—é—á–∞–µ–º offline persistence –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
        db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
                console.log('‚úÖ Offline persistence –≤–∫–ª—é—á–µ–Ω');
            })
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn('‚ö†Ô∏è Persistence –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω (–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ)');
                } else if (err.code === 'unimplemented') {
                    console.warn('‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç persistence');
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è persistence:', err);
                }
            });
        
        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ onUserLoggedIn
        let isAuthInitialized = false;
        
        // –§–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Firebase
        let isFirebaseReady = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
        const urlParams = new URLSearchParams(window.location.search);
        const sharedProfileId = urlParams.get('profile');
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.email);
                // –í—ã–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (!isAuthInitialized) {
                    isAuthInitialized = true;
                    onUserLoggedIn(user);
                }
            } else {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                isAuthInitialized = false;
                onUserLoggedOut();
            }
            
            // –ü–æ–º–µ—á–∞–µ–º Firebase –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ auth callback
            if (!isFirebaseReady) {
                isFirebaseReady = true;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –≤ URL - –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
                if (sharedProfileId) {
                    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å:', sharedProfileId);
                    loadSharedProfile(sharedProfileId).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:', err);
                    });
                }
            }
        });
        
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª
        async function onUserLoggedIn(user) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('cloud-login-section').style.display = 'none';
            document.getElementById('cloud-logged-in-section').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('user-name').textContent = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('user-email').textContent = user.email;
            
            if (user.photoURL) {
                const avatar = document.getElementById('user-avatar');
                avatar.src = user.photoURL;
                avatar.style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ—Ñ–∏–ª—è –≤ –º–æ–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            const mobileLogoutBtn = document.getElementById('mobile-logout-button');
            const mobileUserEmail = document.getElementById('mobile-user-email');
            const mobileUserName = document.getElementById('mobile-user-name');
            const mobileUserAvatar = document.getElementById('mobile-user-avatar');
            const mobileUserAvatarPlaceholder = document.getElementById('mobile-user-avatar-placeholder');
            
            if (mobileLogoutBtn) {
                mobileLogoutBtn.style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º email
                if (mobileUserEmail) {
                    mobileUserEmail.textContent = user.email;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è
                if (mobileUserName) {
                    mobileUserName.textContent = user.displayName || user.email.split('@')[0];
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                if (user.photoURL && mobileUserAvatar && mobileUserAvatarPlaceholder) {
                    mobileUserAvatar.src = user.photoURL;
                    mobileUserAvatar.style.display = 'block';
                    mobileUserAvatarPlaceholder.style.display = 'none';
                } else if (mobileUserAvatarPlaceholder) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π –∏–º–µ–Ω–∏
                    const firstLetter = (user.displayName || user.email)[0].toUpperCase();
                    mobileUserAvatarPlaceholder.textContent = firstLetter;
                    mobileUserAvatarPlaceholder.style.display = 'flex';
                    if (mobileUserAvatar) mobileUserAvatar.style.display = 'none';
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
            await createOrUpdateUser(user);
            await refreshUserCloudProfiles(true);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å default.hpg –∏–∑ –æ–±–ª–∞–∫–∞
            await checkAndOfferDefaultProfile();
        }
        
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
        function onUserLoggedOut() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—Ö–æ–¥–∞
            document.getElementById('cloud-login-section').style.display = 'block';
            document.getElementById('cloud-logged-in-section').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            const mobileLogoutBtn = document.getElementById('mobile-logout-button');
            if (mobileLogoutBtn) {
                mobileLogoutBtn.style.display = 'none';
            }

            userCloudProfilesMap = new Map();
            currentMatchedCloudProfile = null;
            isCloudProfilesLoaded = false;
            setCloudSaveButtonState(false);
        }
        
        // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
        async function loginWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                await showCustomAlert('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –æ–∫–Ω–æ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                } else {
                    await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                }
            }
        }
        
        // –í—ã—Ö–æ–¥
        async function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                try {
                    await auth.signOut();
                    await showCustomAlert('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
                }
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
        async function createOrUpdateUser(user) {
            try {
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    await userRef.set({
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        settings: {
                            autoSave: false,
                            autoSaveInterval: 300,
                            theme: 'light',
                            language: 'ru'
                        },
                        profilesCount: 0,
                        publicProfilesCount: 0,
                        created: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º lastLogin
                    await userRef.update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ offline —Ä–µ–∂–∏–º–∞ - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    console.log('–†–∞–±–æ—Ç–∞ –≤ offline —Ä–µ–∂–∏–º–µ - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏');
                } else {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
            }
        }
        
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ñ–∞–π–ª–∞
        function openMobileFileOptionsModal() {
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
            const overlay = document.createElement('div');
            overlay.id = 'mobile-file-options-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.55);
                display: flex;
                justify-content: center;
                align-items: flex-end;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            `;

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–∏—Å—Ç–∞
            const sheet = document.createElement('div');
            sheet.style.cssText = `
                width: 100%;
                max-width: 420px;
                background: #ffffff;
                border-top-left-radius: 18px;
                border-top-right-radius: 18px;
                padding: 18px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
                animation: slideUp 0.2s ease;
                box-sizing: border-box;
            `;

            sheet.innerHTML = `
                <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                    <div style="width: 40px; height: 4px; background: #d0d0d0; border-radius: 2px;"></div>
                </div>
                <h3 style="margin: 0 0 12px 0; font-size: 18px; text-align: center;">üìÇ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <p style="margin: 0 0 18px 0; font-size: 13px; color: #666; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–∫—É–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button id="mobile-open-local" style="width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e0e0e0; background: #f7f7f7; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                        <span style="font-size: 20px;">üìÅ</span>
                        <span style="flex: 1; text-align: left;">–û—Ç–∫—Ä—ã—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
                    </button>

                    <div id="mobile-cloud-login" style="display: none;">
                        <button id="mobile-cloud-login-btn" style="width: 100%; padding: 14px; border-radius: 10px; border: none; background: #4285f4; color: #fff; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 10px; justify-content: center;">
                            <span style="font-size: 20px;">üîê</span>
                            <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                        </button>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #777; text-align: center;">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ –æ–±–ª–∞–∫–∞</p>
                    </div>

                    <div id="mobile-cloud-actions" style="display: none;">
                        <button id="mobile-open-cloud-my" style="width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e0e0e0; background: #eef4ff; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <span style="font-size: 20px;">üì•</span>
                            <span style="flex: 1; text-align: left;">–ú–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏</span>
                        </button>
                        <button id="mobile-open-cloud-public" style="margin-top: 10px; width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #e0e0e0; background: #fff7ec; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <span style="font-size: 20px;">üåç</span>
                            <span style="flex: 1; text-align: left;">–û–±—â–∏–π –∫–∞—Ç–∞–ª–æ–≥</span>
                        </button>
                    </div>
                </div>

                <button id="mobile-close-modal" style="margin-top: 18px; width: 100%; padding: 12px; border: none; border-radius: 10px; background: #f0f0f0; font-size: 14px; font-weight: 600; color: #444;">–û—Ç–º–µ–Ω–∞</button>
            `;

            overlay.appendChild(sheet);
            document.body.appendChild(overlay);

            const isLoggedIn = !!auth.currentUser;
            const loginBlock = sheet.querySelector('#mobile-cloud-login');
            const cloudActions = sheet.querySelector('#mobile-cloud-actions');

            if (isLoggedIn) {
                cloudActions.style.display = 'block';
                loginBlock.style.display = 'none';
            } else {
                loginBlock.style.display = 'block';
                cloudActions.style.display = 'none';
            }

            sheet.querySelector('#mobile-open-local').onclick = () => {
                overlay.remove();
                fileOpen();
            };

            sheet.querySelector('#mobile-close-modal').onclick = () => overlay.remove();

            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    overlay.remove();
                }
            });

            if (!isLoggedIn) {
                sheet.querySelector('#mobile-cloud-login-btn').onclick = async () => {
                    overlay.remove();
                    await loginWithGoogle();
                };
            } else {
                sheet.querySelector('#mobile-open-cloud-my').onclick = async () => {
                    overlay.remove();
                    await showCloudProfilesModal();
                };

                sheet.querySelector('#mobile-open-cloud-public').onclick = async () => {
                    overlay.remove();
                    await showPublicProfilesModal();
                };
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–±–ª–∞–∫–æ
        async function saveProfileToCloud() {
            const user = auth.currentUser;
            if (!user) {
                await showCustomAlert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google');
                loginWithGoogle();
                return;
            }

            await refreshUserCloudProfiles();

            const filenameInput = document.getElementById('file_filename');
            const filenameValue = filenameInput?.value || 'default.hpg';
            const normalizedName = normalizeProfileName(filenameValue);
            const existingProfile = userCloudProfilesMap.get(normalizedName);

            if (existingProfile) {
                await updateCloudProfile(existingProfile.id);
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π
            const currentFilename = document.getElementById('file_filename').value || 'default.hpg';
            const currentDescription = document.getElementById('file_comment').value || '';
            const defaultName = currentFilename.replace(/\.hpg$/i, '');
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–æ—Ä–º–æ–π
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <h3 style="margin: 0 0 15px 0; font-size: 18px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–±–ª–∞–∫–æ</h3>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
                    <input type="text" id="save-name" value="${defaultName}" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="save-description" rows="3" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; resize: vertical;">${currentDescription}</textarea>
                </div>
                
                <div style="margin-bottom: 12px; position: relative;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                    <input type="text" id="save-tags" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–µ–≥..." autocomplete="off" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <div id="save-tags-autocomplete" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å - –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–≥–æ–≤</div>
                </div>
                
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="save-public" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">üåê –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–º</div>
                            <div style="font-size: 12px; color: #666;">–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å</div>
                        </div>
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="save-btn" style="flex: 1; padding: 10px; background: #34a853; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button id="cancel-btn" style="flex: 1; padding: 10px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            setTimeout(() => {
                document.getElementById('save-name').focus();
                document.getElementById('save-name').select();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è —Ç–µ–≥–æ–≤
                const saveTagsInput = document.getElementById('save-tags');
                if (saveTagsInput) {
                    saveTagsInput.addEventListener('input', (e) => updateHPGTagsAutocomplete(e, 'save-tags'));
                    saveTagsInput.addEventListener('keydown', (e) => handleHPGTagsKeydown(e, 'save-tags'));
                }
            }, 100);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
            document.getElementById('save-btn').onclick = async () => {
                const name = document.getElementById('save-name').value.trim();
                if (!name) {
                    await showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                    return;
                }
                
                const description = document.getElementById('save-description').value.trim();
                const tagsInput = document.getElementById('save-tags').value.trim();
                const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                const isPublic = document.getElementById('save-public').checked;
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.remove();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                await doSaveProfileToCloud(name, description, tags, isPublic);
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
            document.getElementById('cancel-btn').onclick = () => {
                modal.remove();
            };
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Enter –≤ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            document.getElementById('save-name').onkeypress = (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('save-btn').click();
                }
            };
        }
        
        // –°–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ HPG (–∫–∞–∫ –≤ fileSaveAs)
        function buildFullHPGContent() {
            try {
                getValues();
                const comment = document.getElementById('file_comment').value;
            
            let content = '';
            content += 'version=Hydroponic Profile Generator HTML5 https://github.com/siv237/HPG\n';
            content += 'Comment=' + (comment || '') + '\n';
            
            // –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            content += 'N=' + currentProfile.N + '\n';
            content += 'NH4=' + currentProfile.NH4 + '\n';
            content += 'NO3=' + currentProfile.NO3 + '\n';
            content += 'P=' + currentProfile.P + '\n';
            content += 'K=' + currentProfile.K + '\n';
            content += 'Ca=' + currentProfile.Ca + '\n';
            content += 'Mg=' + currentProfile.Mg + '\n';
            content += 'S=' + currentProfile.S + '\n';
            content += 'Cl=' + currentProfile.Cl + '\n';
            
            // –°–æ—Å—Ç–∞–≤—ã —Å–æ–ª–µ–π - –ø—Ä–æ—Ü–µ–Ω—Ç—ã –º–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤
            content += 'CaNO3_Ca=' + getSaltPercent('CaNO3', 'Ca') + '\n';
            content += 'CaNO3_NO3=' + getSaltPercent('CaNO3', 'NO3') + '\n';
            content += 'CaNO3_NH4=' + getSaltPercent('CaNO3', 'NH4') + '\n';
            content += 'KNO3_K=' + getSaltPercent('KNO3', 'K') + '\n';
            content += 'KNO3_NO3=' + getSaltPercent('KNO3', 'NO3') + '\n';
            content += 'NH4NO3_NH4=' + getSaltPercent('NH4NO3', 'NH4') + '\n';
            content += 'NH4NO3_NO3=' + getSaltPercent('NH4NO3', 'NO3') + '\n';
            content += 'MgSO4_Mg=' + getSaltPercent('MgSO4', 'Mg') + '\n';
            content += 'MgSO4_S=' + getSaltPercent('MgSO4', 'S') + '\n';
            content += 'KH2PO4_K=' + getSaltPercent('KH2PO4', 'K') + '\n';
            content += 'KH2PO4_P=' + getSaltPercent('KH2PO4', 'P') + '\n';
            content += 'K2SO4_K=' + getSaltPercent('K2SO4', 'K') + '\n';
            content += 'K2SO4_S=' + getSaltPercent('K2SO4', 'S') + '\n';
            content += 'MgNO3_Mg=' + getSaltPercent('MgNO3', 'Mg') + '\n';
            content += 'MgNO3_NO3=' + getSaltPercent('MgNO3', 'NO3') + '\n';
            content += 'CaCl2_Ca=' + getSaltPercent('CaCl2', 'Ca') + '\n';
            content += 'CaCl2_Cl=' + getSaltPercent('CaCl2', 'Cl') + '\n';
            
            // –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            content += 'Fe=' + currentProfile.Fe + '\n';
            content += 'Mn=' + currentProfile.Mn + '\n';
            content += 'B=' + currentProfile.B + '\n';
            content += 'Zn=' + currentProfile.Zn + '\n';
            content += 'Cu=' + currentProfile.Cu + '\n';
            content += 'Mo=' + currentProfile.Mo + '\n';
            content += 'Co=' + currentProfile.Co + '\n';
            content += 'Si=' + currentProfile.Si + '\n';
            
            // –î–æ–ª–∏ –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–ª—è—Ö
            content += 'dFe=' + getMicroPercent('Fe') + '\n';
            content += 'dMn=' + getMicroPercent('Mn') + '\n';
            content += 'dB=' + getMicroPercent('B') + '\n';
            content += 'dZn=' + getMicroPercent('Zn') + '\n';
            content += 'dCu=' + getMicroPercent('Cu') + '\n';
            content += 'dMo=' + getMicroPercent('Mo') + '\n';
            content += 'dCo=' + getMicroPercent('Co') + '\n';
            content += 'dSi=' + getMicroPercent('Si') + '\n';
            
            // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤
            content += 'glCaNO3=' + getConcentration('CaNO3') + '\n';
            content += 'glKNO3=' + getConcentration('KNO3') + '\n';
            content += 'glNH4NO3=' + getConcentration('NH4NO3') + '\n';
            content += 'glMgNO3=' + getConcentration('MgNO3') + '\n';
            content += 'glMgSO4=' + getConcentration('MgSO4') + '\n';
            content += 'glK2SO4=' + getConcentration('K2SO4') + '\n';
            content += 'glKH2PO4=' + getConcentration('KH2PO4') + '\n';
            content += 'glCaCl2=' + getConcentration('CaCl2') + '\n';
            content += 'glCmplx=' + getConcentration('Cmplx') + '\n';
            content += 'glFe=' + getConcentration('Fe') + '\n';
            content += 'glMn=' + getConcentration('Mn') + '\n';
            content += 'glB=' + getConcentration('B') + '\n';
            content += 'glZn=' + getConcentration('Zn') + '\n';
            content += 'glCu=' + getConcentration('Cu') + '\n';
            content += 'glMo=' + getConcentration('Mo') + '\n';
            content += 'glCo=' + getConcentration('Co') + '\n';
            content += 'glSi=' + getConcentration('Si') + '\n';
            
            // –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤
            content += 'gmlCaNO3=' + getDensity('CaNO3') + '\n';
            content += 'gmlKNO3=' + getDensity('KNO3') + '\n';
            content += 'gmlNH4NO3=' + getDensity('NH4NO3') + '\n';
            content += 'gmlMgNO3=' + getDensity('MgNO3') + '\n';
            content += 'gmlMgSO4=' + getDensity('MgSO4') + '\n';
            content += 'gmlK2SO4=' + getDensity('K2SO4') + '\n';
            content += 'gmlKH2PO4=' + getDensity('KH2PO4') + '\n';
            content += 'gmlCaCl2=' + getDensity('CaCl2') + '\n';
            content += 'gmlCmplx=' + getDensity('Cmplx') + '\n';
            content += 'gmlFe=' + getDensity('Fe') + '\n';
            content += 'gmlMn=' + getDensity('Mn') + '\n';
            content += 'gmlB=' + getDensity('B') + '\n';
            content += 'gmlZn=' + getDensity('Zn') + '\n';
            content += 'gmlCu=' + getDensity('Cu') + '\n';
            content += 'gmlMo=' + getDensity('Mo') + '\n';
            content += 'gmlCo=' + getDensity('Co') + '\n';
            content += 'gmlSi=' + getDensity('Si') + '\n';
            
            // –ß–µ–∫–±–æ–∫—Å—ã
            content += 'chkComplex=' + (document.getElementById('use_complex')?.checked ? 'True' : 'False') + '\n';
            content += 'chK2SO4=' + (document.getElementById('use_K2SO4')?.checked ? 'True' : 'False') + '\n';
            content += 'chMgNO3=' + (document.getElementById('use_MgNO3')?.checked ? 'True' : 'False') + '\n';
            
            // –û–±—ä–µ–º
            content += 'V=' + (currentProfile.volume || 10) + '\n';
            
            // –ù–∞–∑–≤–∞–Ω–∏—è —Å–æ–ª–µ–π
            content += 'mCaNO3=' + getSaltName('CaNO3') + '\n';
            content += 'mKNO3=' + getSaltName('KNO3') + '\n';
            content += 'mNH4NO3=' + getSaltName('NH4NO3') + '\n';
            content += 'mMgNO3=' + getSaltName('MgNO3') + '\n';
            content += 'mMgSO4=' + getSaltName('MgSO4') + '\n';
            content += 'mKH2PO4=' + getSaltName('KH2PO4') + '\n';
            content += 'mK2SO4=' + getSaltName('K2SO4') + '\n';
            content += 'mCaCl2=' + getSaltName('CaCl2') + '\n';
            content += 'mCmplx=' + getSaltName('Cmplx') + '\n';
            content += 'mFe=' + getSaltName('Fe') + '\n';
            content += 'mMn=' + getSaltName('Mn') + '\n';
            content += 'mB=' + getSaltName('B') + '\n';
            content += 'mZn=' + getSaltName('Zn') + '\n';
            content += 'mCu=' + getSaltName('Cu') + '\n';
            content += 'mMo=' + getSaltName('Mo') + '\n';
            content += 'mCo=' + getSaltName('Co') + '\n';
            content += 'mSi=' + getSaltName('Si') + '\n';
            content += 'addrMixer=' + (document.getElementById('addrMixer')?.value || '') + '\n';
            content += 'nmix=' + (document.getElementById('nmix')?.value || '') + '\n';
            
            // –û–±—ä–µ–º—ã –±–∞–∫–æ–≤
            content += 'tAml=' + getTankVolume('A') + '\n';
            content += 'tBml=' + getTankVolume('B') + '\n';
            
            // –¶–µ–Ω—ã
            content += 'cgCaNO3=' + getPrice('CaNO3') + '\n';
            content += 'cgKNO3=' + getPrice('KNO3') + '\n';
            content += 'cgNH4NO3=' + getPrice('NH4NO3') + '\n';
            content += 'cgMgNO3=' + getPrice('MgNO3') + '\n';
            content += 'cgMgSO4=' + getPrice('MgSO4') + '\n';
            content += 'cgK2SO4=' + getPrice('K2SO4') + '\n';
            content += 'cgKH2PO4=' + getPrice('KH2PO4') + '\n';
            content += 'cgCaCl2=' + getPrice('CaCl2') + '\n';
            content += 'cgCmplx=' + getPrice('Cmplx') + '\n';
            content += 'cgFe=' + getPrice('Fe') + '\n';
            content += 'cgMn=' + getPrice('Mn') + '\n';
            content += 'cgB=' + getPrice('B') + '\n';
            content += 'cgZn=' + getPrice('Zn') + '\n';
            content += 'cgCu=' + getPrice('Cu') + '\n';
            content += 'cgMo=' + getPrice('Mo') + '\n';
            content += 'cgCo=' + getPrice('Co') + '\n';
            content += 'cgSi=' + getPrice('Si') + '\n';
            
            // –ñ—É—Ä–Ω–∞–ª (–≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞)
            console.log('üìù –î–æ–±–∞–≤–ª—è–µ–º –∂—É—Ä–Ω–∞–ª –≤ HPG —Ñ–∞–π–ª. –ó–∞–ø–∏—Å–µ–π:', journalEntries.length);
            journalEntries.forEach(entry => {
                // –§–æ—Ä–º–∞—Ç: date=2024-10-10;–û–ø–∏—Å–∞–Ω–∏–µ;N=220 NO3=200...
                const journalLine = 'date=' + entry.date + ';' + entry.desc + ';' + entry.profile + '\n';
                console.log('  –ó–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞:', journalLine.substring(0, 100) + '...');
                content += journalLine;
            });
            
            console.log('‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä HPG —Ñ–∞–π–ª–∞:', content.length, '—Å–∏–º–≤–æ–ª–æ–≤');
            return content;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ HPG –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
                return '';
            }
        }
        
        // –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function doSaveProfileToCloud(name, description, tags, isPublic) {
            const user = auth.currentUser;
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –ü–û–õ–ù–û–ï —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ HPG
                const fullHPGContent = buildFullHPGContent();
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
                const profileData = {
                    // –í–ª–∞–¥–µ–ª–µ—Ü
                    userId: user.uid,
                    userEmail: user.email,
                    userName: user.displayName,
                    userPhotoURL: user.photoURL || null,
                    
                    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
                    appKey: 'wega-hpg-profile',
                    
                    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    name: name,
                    description: description,
                    tags: tags,
                    
                    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è - –ü–û–õ–ù–´–ô —Ñ–∞–π–ª HPG
                    profile: fullHPGContent,
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    profileString: document.getElementById('profile-string').value,
                    
                    // –ñ—É—Ä–Ω–∞–ª
                    journal: journalEntries.map(entry => ({
                        date: entry.date,
                        desc: entry.desc || entry.memo,
                        profile: entry.profile
                    })),
                    
                    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    modified: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '1.0',
                    
                    // –ü—É–±–ª–∏—á–Ω–æ—Å—Ç—å
                    public: isPublic,
                    
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    views: 0,
                    likes: 0,
                    dislikes: 0,
                    downloads: 0,
                    commentsCount: 0
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
                const docRef = await db.collection('profiles').add(profileData);
                
                // –ï—Å–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏–Ω–¥–µ–∫—Å
                if (isPublic) {
                    await db.collection('public_profiles').doc(docRef.id).set({
                        profileId: docRef.id,
                        name: name,
                        userName: user.displayName,
                        tags: tags,
                        views: 0,
                        likes: 0,
                        created: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    // –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º
                    await userRef.update({
                        profilesCount: firebase.firestore.FieldValue.increment(1),
                        publicProfilesCount: isPublic ? firebase.firestore.FieldValue.increment(1) : 0
                    });
                } else {
                    // –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–µ–º —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    await userRef.set({
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        settings: {
                            autoSave: false,
                            autoSaveInterval: 300,
                            theme: 'light',
                            language: 'ru'
                        },
                        profilesCount: 1,
                        publicProfilesCount: isPublic ? 1 : 0,
                        created: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await refreshUserCloudProfiles(true);
                await showCustomAlert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ–±–ª–∞–∫–µ!\n\n–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –ø—Ä–æ—Å—Ç–æ –≤–æ–π–¥—è –≤ —Å–≤–æ–π Google –∞–∫–∫–∞—É–Ω—Ç.');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ–±–ª–∞—á–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏
        async function showCloudProfilesModal() {
            const user = auth.currentUser;
            if (!user) {
                await showCustomAlert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">‚òÅÔ∏è –ú–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –≤ –æ–±–ª–∞–∫–µ</h3>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="width: 30px; height: 30px; border: none; background: #f44336; color: white; border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1;">√ó</button>
                </div>
                <div id="cloud-profiles-list" style="min-height: 100px;">
                    <div style="text-align: center; padding: 20px; color: #666;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π...</div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
            loadCloudProfiles();
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
        async function loadCloudProfiles() {
            const user = auth.currentUser;
            if (!user) return;
            
            const listDiv = document.getElementById('cloud-profiles-list');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const snapshot = await db.collection('profiles')
                    .where('userId', '==', user.uid)
                    .where('appKey', '==', 'wega-hpg-profile')
                    .orderBy('modified', 'desc')
                    .get();

                updateUserCloudProfilesMapFromSnapshot(snapshot);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                            <div style="font-size: 16px;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
                            <div style="font-size: 13px; margin-top: 5px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –∑–¥–µ—Å—å</div>
                        </div>
                    `;
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
                let html = '';
                snapshot.forEach(doc => {
                    const profile = doc.data();
                    const date = profile.modified?.toDate().toLocaleDateString('ru-RU') || '';
                    const icon = profile.public ? 'üåê' : 'üîí';
                    
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 5px; padding: 12px; margin-bottom: 10px; background: #f9f9f9;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 15px; margin-bottom: 3px;">
                                        ${icon} ${profile.name}
                                    </div>
                                    ${profile.description ? `<div style="font-size: 12px; color: #666; margin-bottom: 3px;">${profile.description}</div>` : ''}
                                    <div style="font-size: 11px; color: #999;">
                                        üìÖ ${date}
                                        ${profile.tags && profile.tags.length > 0 ? ` ‚Ä¢ üè∑Ô∏è ${profile.tags.join(', ')}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: stretch;">
                                <button onclick="loadCloudProfile('${doc.id}')" style="flex: 1; min-width: 110px; padding: 10px 12px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.background='#3367d6'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.25)'" onmouseout="this.style.background='#4285f4'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)'">
                                    üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                                <button onclick="downloadCloudProfile('${doc.id}')" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.background='#f57c00'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.25)'" onmouseout="this.style.background='#ff9800'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)'">
                                    <span style="font-size: 18px;">üíæ</span>
                                    <span style="font-size: 9px; opacity: 0.9;">–°–∫–∞—á–∞—Ç—å</span>
                                </button>
                                ${profile.public ? `
                                <button onclick="shareCloudProfile('${doc.id}', '${profile.name.replace(/'/g, "\\'")}', event)" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 12px; background: #0288d1; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.background='#0277bd'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.25)'" onmouseout="this.style.background='#0288d1'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)'">
                                    <span style="font-size: 18px;">üîó</span>
                                    <span style="font-size: 9px; opacity: 0.9;">–°—Å—ã–ª–∫–∞</span>
                                </button>
                                ` : ''}
                                <button onclick="editCloudProfile('${doc.id}')" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 12px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.background='#7b1fa2'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.25)'" onmouseout="this.style.background='#9c27b0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)'">
                                    <span style="font-size: 18px;">‚úèÔ∏è</span>
                                    <span style="font-size: 9px; opacity: 0.9;">–ò–∑–º–µ–Ω–∏—Ç—å</span>
                                </button>
                                <button onclick="deleteCloudProfile('${doc.id}')" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" onmouseover="this.style.background='#d32f2f'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.25)'" onmouseout="this.style.background='#f44336'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)'">
                                    <span style="font-size: 18px;">üóëÔ∏è</span>
                                    <span style="font-size: 9px; opacity: 0.9;">–£–¥–∞–ª–∏—Ç—å</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
                
                // –î–ª—è offline —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ff9800;">
                            üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É<br>
                            <small style="color: #666;">–ü—Ä–æ—Ñ–∏–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏</small>
                        </div>
                    `;
                } else {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #f44336;">
                            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –æ–±–ª–∞–∫–∞
        async function loadCloudProfile(profileId) {
            try {
                const doc = await db.collection('profiles').doc(profileId).get();
                
                if (!doc.exists) {
                    alert('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const profile = doc.data();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–û–õ–ù–´–ô –ø—Ä–æ—Ñ–∏–ª—å (–∫–∞–∫ –∏–∑ —Ñ–∞–π–ª–∞ .hpg)
                if (profile.profile) {
                    // –û—á–∏—â–∞–µ–º localStorage –∏ –∂—É—Ä–Ω–∞–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                    localStorage.removeItem('hpg_profile');
                    localStorage.removeItem('hpg_journal');
                    
                    // –ü–∞—Ä—Å–∏–º –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª HPG (–≤–∫–ª—é—á–∞—è –∂—É—Ä–Ω–∞–ª!)
                    // parseFullFile —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
                    // - applyProfile()
                    // - updateJournalList()
                    // - updateMobileDisplay()
                    // - updateMobileResults()
                    // - updateMobileSaltsValues()
                    parseFullFile(profile.profile);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
                    if (profile.name) {
                        document.getElementById('file_filename').value = profile.name + '.hpg';
                    }
                    if (profile.description) {
                        document.getElementById('file_comment').value = profile.description;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                    if (typeof updateMobileFileInfo === 'function') {
                        updateMobileFileInfo();
                    }
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.querySelector('[style*="position: fixed"]')?.remove();
                
                await showCustomAlert(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å "${profile.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }
        
        // –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –æ–±–ª–∞–∫–∞ –∫–∞–∫ .hpg —Ñ–∞–π–ª
        async function downloadCloudProfile(profileId) {
            try {
                const doc = await db.collection('profiles').doc(profileId).get();
                
                if (!doc.exists) {
                    await showCustomAlert('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const profile = doc.data();
                
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ HPG
                const content = profile.profile;
                
                if (!content) {
                    alert('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –ø—É—Å—Ç–æ–π');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º Blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (profile.name || 'profile') + '.hpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–∫–∞—á–∞–Ω:', profile.name);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' + error.message);
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–≥–∏, –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å)
        async function editCloudProfile(profileId) {
            try {
                const doc = await db.collection('profiles').doc(profileId).get();
                
                if (!doc.exists) {
                    alert('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const profile = doc.data();
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 15px 0;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                            <input type="text" id="edit-name" value="${profile.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                            <textarea id="edit-description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box; min-height: 60px;">${profile.description || ''}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 10px; position: relative;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                            <input type="text" id="edit-tags" value="${profile.tags ? profile.tags.join(', ') : ''}" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–µ–≥..." autocomplete="off" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;">
                            <div id="edit-tags-autocomplete" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å - –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–≥–æ–≤</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="edit-public" ${profile.public ? 'checked' : ''} style="margin-right: 8px;">
                                <span>üåê –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–º (–¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –≤ –∫–∞—Ç–∞–ª–æ–≥–µ)</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="save-edit-btn" style="flex: 1; padding: 10px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button id="cancel-edit-btn" style="flex: 1; padding: 10px; background: #999; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">
                                ‚ùå –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è —Ç–µ–≥–æ–≤
                setTimeout(() => {
                    const editTagsInput = document.getElementById('edit-tags');
                    if (editTagsInput) {
                        editTagsInput.addEventListener('input', (e) => updateHPGTagsAutocomplete(e, 'edit-tags'));
                        editTagsInput.addEventListener('keydown', (e) => handleHPGTagsKeydown(e, 'edit-tags'));
                    }
                }, 100);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                document.getElementById('save-edit-btn').onclick = async () => {
                    const name = document.getElementById('edit-name').value.trim();
                    const description = document.getElementById('edit-description').value.trim();
                    const tagsInput = document.getElementById('edit-tags').value.trim();
                    const isPublic = document.getElementById('edit-public').checked;
                    
                    if (!name) {
                        alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                        return;
                    }
                    
                    // –ü–∞—Ä—Å–∏–º —Ç–µ–≥–∏
                    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    try {
                        await db.collection('profiles').doc(profileId).update({
                            name: name,
                            description: description,
                            tags: tags,
                            public: isPublic,
                            modified: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        modal.remove();
                        await showCustomAlert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                        loadCloudProfiles(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                        await showCustomAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                    }
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
                document.getElementById('cancel-edit-btn').onclick = () => {
                    modal.remove();
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                await showCustomAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–±–ª–∞–∫–µ —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        async function updateCloudProfile(profileId, options = {}) {
            const { silent = false } = options;

            if (!silent && !confirm('–û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?')) return;
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –ü–û–õ–ù–û–ï —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ HPG
                const fullHPGContent = buildFullHPGContent();
                
                await db.collection('profiles').doc(profileId).update({
                    profile: fullHPGContent,
                    profileString: document.getElementById('profile-string').value,
                    journal: journalEntries.map(entry => ({
                        date: entry.date,
                        desc: entry.desc || entry.memo,
                        profile: entry.profile
                    })),
                    modified: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (!silent) {
                    await showCustomAlert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                }

                await refreshUserCloudProfiles(true);

                if (document.getElementById('cloud-profiles-list')) {
                    loadCloudProfiles();
                } else {
                    updateCloudSaveButton();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –æ–±–ª–∞–∫–∞
        async function deleteCloudProfile(profileId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –æ–±–ª–∞–∫–∞?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            
            try {
                const doc = await db.collection('profiles').doc(profileId).get();
                const profile = doc.data();
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                await db.collection('profiles').doc(profileId).delete();
                
                // –ï—Å–ª–∏ –±—ã–ª –ø—É–±–ª–∏—á–Ω—ã–π - —É–¥–∞–ª—è–µ–º –∏–∑ –∏–Ω–¥–µ–∫—Å–∞
                if (profile.public) {
                    await db.collection('public_profiles').doc(profileId).delete();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userRef = db.collection('users').doc(profile.userId);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    await userRef.update({
                        profilesCount: firebase.firestore.FieldValue.increment(-1),
                        publicProfilesCount: profile.public ? firebase.firestore.FieldValue.increment(-1) : 0
                    });
                }
                
                await showCustomAlert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª–µ–Ω');
                loadCloudProfiles(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                await showCustomAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        async function shareCloudProfile(profileId, profileName, event) {
            event?.preventDefault();
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞
                const shareUrl = `${window.location.origin}${window.location.pathname}?profile=${profileId}`;
                
                // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(shareUrl);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const button = event?.target;
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                        button.style.background = '#34a853';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.background = '#00bcd4';
                        }, 2000);
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                    showShareModal(shareUrl, profileName);
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', shareUrl);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                await showCustomAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        async function loadSharedProfile(profileId) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'shared-profile-loading';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4285f4;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                loadingDiv.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å...';
                document.body.appendChild(loadingDiv);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ Firestore (–∞–Ω–æ–Ω–∏–º–Ω–æ)
                const doc = await db.collection('profiles').doc(profileId).get();
                
                if (!doc.exists) {
                    throw new Error('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const profile = doc.data();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–π
                if (!profile.public) {
                    throw new Error('–≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–º');
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                // –û–Ω–∞ —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ: parseFullFile, updateMobileDisplay –∏ —Ç.–¥.
                if (profile.profile) {
                    // –û—á–∏—â–∞–µ–º localStorage –∏ –∂—É—Ä–Ω–∞–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                    localStorage.removeItem('hpg_profile');
                    localStorage.removeItem('hpg_journal');
                    
                    // –ü–∞—Ä—Å–∏–º –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª HPG (–≤–∫–ª—é—á–∞—è –∂—É—Ä–Ω–∞–ª!)
                    parseFullFile(profile.profile);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
                    if (profile.name) {
                        document.getElementById('file_filename').value = profile.name + '.hpg';
                    }
                    if (profile.description) {
                        document.getElementById('file_comment').value = profile.description;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∂—É—Ä–Ω–∞–ª–∞ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                    if (typeof updateJournalList === 'function') {
                        updateJournalList();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                    if (typeof updateMobileFileInfo === 'function') {
                        updateMobileFileInfo();
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
                if (auth.currentUser) {
                    await db.collection('profiles').doc(profileId).update({
                        views: firebase.firestore.FieldValue.increment(1)
                    }).catch(err => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫:', err));
                }
                
                // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                const url = new URL(window.location);
                url.searchParams.delete('profile');
                window.history.replaceState({}, '', url);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                loadingDiv.style.background = '#34a853';
                loadingDiv.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–æ—Ñ–∏–ª—å: <strong>${profile.name}</strong>`;
                
                setTimeout(() => {
                    loadingDiv.remove();
                }, 3000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—à–∞—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                
                const loadingDiv = document.getElementById('shared-profile-loading');
                if (loadingDiv) {
                    loadingDiv.style.background = '#f44336';
                    loadingDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    
                    setTimeout(() => {
                        loadingDiv.remove();
                    }, 5000);
                }
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —à–∞—Ä–∏–Ω–≥–µ
        function showShareModal(shareUrl, profileName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px;">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>${profileName}</strong>
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; word-break: break-all; font-size: 12px; font-family: monospace;">
                        ${shareUrl}
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 5px; margin-bottom: 15px; font-size: 13px;">
                        ‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!<br>
                        <small style="color: #666;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –∫–æ–º—É —É–≥–æ–¥–Ω–æ - –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; padding: 10px; background: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            –ì–æ—Ç–æ–≤–æ
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
        async function showPublicProfilesModal() {
            const user = auth.currentUser;
            if (!user) {
                await showCustomAlert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google');
                loginWithGoogle();
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">üåç –ö–∞—Ç–∞–ª–æ–≥ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</h3>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="width: 30px; height: 30px; border: none; background: #f44336; color: white; border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1;">√ó</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button id="group-by-users" onclick="switchCatalogGrouping('users')" style="flex: 1; padding: 8px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                            üë• –ü–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                        </button>
                        <button id="group-by-tags" onclick="switchCatalogGrouping('tags')" style="flex: 1; padding: 8px; background: #e0e0e0; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            üè∑Ô∏è –ü–æ —Ç–µ–≥–∞–º
                        </button>
                        <button id="group-by-none" onclick="switchCatalogGrouping('none')" style="flex: 1; padding: 8px; background: #e0e0e0; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            üìã –í—Å–µ
                        </button>
                    </div>
                    <input type="text" id="public-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–≥–∞–º..." style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                
                <div id="public-profiles-list" style="min-height: 100px;">
                    <div style="text-align: center; padding: 20px; color: #666;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π...</div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
            loadPublicProfiles();
            
            // –ü–æ–∏—Å–∫
            document.getElementById('public-search').oninput = (e) => {
                loadPublicProfiles(e.target.value.toLowerCase());
            };
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞
        function switchCatalogGrouping(mode) {
            catalogGrouping = mode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
            const buttons = {
                'users': document.getElementById('group-by-users'),
                'tags': document.getElementById('group-by-tags'),
                'none': document.getElementById('group-by-none')
            };
            
            Object.keys(buttons).forEach(key => {
                if (key === mode) {
                    buttons[key].style.background = '#4285f4';
                    buttons[key].style.color = 'white';
                    buttons[key].style.fontWeight = 'bold';
                } else {
                    buttons[key].style.background = '#e0e0e0';
                    buttons[key].style.color = '#666';
                    buttons[key].style.fontWeight = 'normal';
                }
            });
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
            const searchQuery = document.getElementById('public-search').value.toLowerCase();
            loadPublicProfiles(searchQuery);
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
        async function loadPublicProfiles(searchQuery = '') {
            const listDiv = document.getElementById('public-profiles-list');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏
                let query = db.collection('profiles')
                    .where('public', '==', true)
                    .where('appKey', '==', 'wega-hpg-profile')
                    .orderBy('created', 'desc')
                    .limit(100);
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üåç</div>
                            <div style="font-size: 16px;">–ü–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
                            <div style="font-size: 13px; margin-top: 5px;">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–∫ –ø—É–±–ª–∏—á–Ω—ã–π</div>
                        </div>
                    `;
                    return;
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
                let profiles = [];
                snapshot.forEach(doc => {
                    const profile = doc.data();
                    profile.id = doc.id;
                    
                    if (searchQuery) {
                        const name = (profile.name || '').toLowerCase();
                        const desc = (profile.description || '').toLowerCase();
                        const tags = (profile.tags || []).join(' ').toLowerCase();
                        const author = (profile.userName || '').toLowerCase();
                        
                        if (name.includes(searchQuery) || desc.includes(searchQuery) || 
                            tags.includes(searchQuery) || author.includes(searchQuery)) {
                            profiles.push(profile);
                        }
                    } else {
                        profiles.push(profile);
                    }
                });
                
                if (profiles.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                            <div style="font-size: 16px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            <div style="font-size: 13px; margin-top: 5px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
                        </div>
                    `;
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –ª–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const currentUser = auth.currentUser;
                let userLikes = {};
                if (currentUser) {
                    try {
                        const likesSnapshot = await db.collection('likes')
                            .where('userId', '==', currentUser.uid)
                            .get();
                        likesSnapshot.forEach(doc => {
                            const data = doc.data();
                            userLikes[data.profileId] = data.type; // 'like' –∏–ª–∏ 'dislike'
                        });
                    } catch (error) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∞–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
                let html = '';
                
                if (catalogGrouping === 'users') {
                    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                    const userGroups = {};
                    profiles.forEach(profile => {
                        const userId = profile.userId || 'anonymous';
                        if (!userGroups[userId]) {
                            userGroups[userId] = {
                                userName: profile.userName || '–ê–Ω–æ–Ω–∏–º',
                                userEmail: profile.userEmail || '',
                                profiles: []
                            };
                        }
                        userGroups[userId].profiles.push(profile);
                    });
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
                    const userPhotos = {};
                    const userIds = Object.keys(userGroups).filter(id => id !== 'anonymous');
                    
                    if (userIds.length > 0) {
                        try {
                            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–∞—á–∫–∞–º–∏ (Firestore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 10 –≤ in)
                            for (let i = 0; i < userIds.length; i += 10) {
                                const batch = userIds.slice(i, i + 10);
                                const usersSnapshot = await db.collection('users')
                                    .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                    .get();
                                
                                usersSnapshot.forEach(doc => {
                                    const userData = doc.data();
                                    if (userData.photoURL) {
                                        userPhotos[doc.id] = userData.photoURL;
                                    }
                                });
                            }
                        } catch (error) {
                            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                        }
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    Object.keys(userGroups).forEach(userId => {
                        const group = userGroups[userId];
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ –∏–Ω–∏—Ü–∏–∞–ª–∞–º
                        const avatarUrl = userPhotos[userId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(group.userName)}&size=40&background=4285f4&color=fff`;
                        const isExpanded = Object.keys(userGroups).length === 1; // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #fff;">
                                <div onclick="toggleUserGroup('${userId}')" style="display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; background: #f5f5f5; border-radius: 5px 5px 0 0;">
                                    <img src="${avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%;" alt="${group.userName}">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 14px;">${group.userName}</div>
                                        <div style="font-size: 11px; color: #666;">${group.profiles.length} ${group.profiles.length === 1 ? '–ø—Ä–æ—Ñ–∏–ª—å' : group.profiles.length < 5 ? '–ø—Ä–æ—Ñ–∏–ª—è' : '–ø—Ä–æ—Ñ–∏–ª–µ–π'}</div>
                                    </div>
                                    <span id="user-group-icon-${userId}" style="font-size: 16px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                </div>
                                <div id="user-group-${userId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 10px;">
                        `;
                        
                        group.profiles.forEach(profile => {
                            html += renderProfileCard(profile, userLikes);
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                } else if (catalogGrouping === 'tags') {
                    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–µ–≥–∞–º
                    const tagGroups = {};
                    profiles.forEach(profile => {
                        const tags = profile.tags && profile.tags.length > 0 ? profile.tags : ['–ë–µ–∑ —Ç–µ–≥–æ–≤'];
                        tags.forEach(tag => {
                            if (!tagGroups[tag]) {
                                tagGroups[tag] = [];
                            }
                            tagGroups[tag].push(profile);
                        });
                    });
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ—Ñ–∏–ª–µ–π
                    const sortedTags = Object.keys(tagGroups).sort((a, b) => tagGroups[b].length - tagGroups[a].length);
                    
                    sortedTags.forEach(tag => {
                        const tagProfiles = tagGroups[tag];
                        const isExpanded = sortedTags.length === 1;
                        
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #fff;">
                                <div onclick="toggleTagGroup('${tag}')" style="display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; background: #f5f5f5; border-radius: 5px 5px 0 0;">
                                    <div style="font-size: 24px;">üè∑Ô∏è</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 14px;">${tag}</div>
                                        <div style="font-size: 11px; color: #666;">${tagProfiles.length} ${tagProfiles.length === 1 ? '–ø—Ä–æ—Ñ–∏–ª—å' : tagProfiles.length < 5 ? '–ø—Ä–æ—Ñ–∏–ª—è' : '–ø—Ä–æ—Ñ–∏–ª–µ–π'}</div>
                                    </div>
                                    <span id="tag-group-icon-${tag}" style="font-size: 16px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                </div>
                                <div id="tag-group-${tag}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 10px;">
                        `;
                        
                        tagProfiles.forEach(profile => {
                            html += renderProfileCard(profile, userLikes);
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                } else {
                    // –ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ - –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫
                    profiles.forEach(profile => {
                        html += renderProfileCard(profile, userLikes);
                    });
                }
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #f44336;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
                    </div>
                `;
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function renderProfileCard(profile, userLikes) {
            const date = profile.created?.toDate().toLocaleDateString('ru-RU') || '';
            const author = profile.userName || '–ê–Ω–æ–Ω–∏–º';
            const likes = profile.likes || 0;
            const dislikes = profile.dislikes || 0;
            const views = profile.views || 0;
            const commentsCount = profile.commentsCount || 0;
            
            const userLikeType = userLikes[profile.id] || null;
            const likeActive = userLikeType === 'like' ? 'background: #4caf50; color: white;' : 'background: #f0f0f0; color: #666;';
            const dislikeActive = userLikeType === 'dislike' ? 'background: #f44336; color: white;' : 'background: #f0f0f0; color: #666;';
            
            return `
                <div style="border: 1px solid #ddd; border-radius: 5px; padding: 12px; margin-bottom: 10px; background: #f9f9f9;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 15px; margin-bottom: 3px;">
                                üåê ${profile.name}
                            </div>
                            ${profile.description ? `<div style="font-size: 12px; color: #666; margin-bottom: 3px;">${profile.description}</div>` : ''}
                            <div style="font-size: 11px; color: #999;">
                                üë§ ${author} ‚Ä¢ üìÖ ${date}
                                ${profile.tags && profile.tags.length > 0 ? ` ‚Ä¢ üè∑Ô∏è ${profile.tags.join(', ')}` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ä–µ–∞–∫—Ü–∏–∏ -->
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; font-size: 12px; color: #666;">
                        <span title="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã">üëÅÔ∏è ${views}</span>
                        <button onclick="toggleLike('${profile.id}', 'like')" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; ${likeActive}" title="–ù—Ä–∞–≤–∏—Ç—Å—è">
                            üëç ${likes}
                        </button>
                        <button onclick="toggleLike('${profile.id}', 'dislike')" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; ${dislikeActive}" title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                            üëé ${dislikes}
                        </button>
                        <button onclick="showComments('${profile.id}')" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; background: #f0f0f0; color: #666;" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">
                            üí¨ ${commentsCount}
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 5px;">
                        <button onclick="loadPublicProfile('${profile.id}')" style="flex: 1; padding: 8px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px;">
                            üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                        <button onclick="downloadCloudProfile('${profile.id}')" style="flex: 1; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px;">
                            üíæ –°–∫–∞—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            `;
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function toggleUserGroup(userId) {
            const content = document.getElementById(`user-group-${userId}`);
            const icon = document.getElementById(`user-group-icon-${userId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã —Ç–µ–≥–∞
        function toggleTagGroup(tag) {
            const content = document.getElementById(`tag-group-${tag}`);
            const icon = document.getElementById(`tag-group-icon-${tag}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞
        async function toggleLike(profileId, type) {
            const user = auth.currentUser;
            if (!user) {
                await showCustomAlert('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∞–π–∫
                const likeQuery = await db.collection('likes')
                    .where('userId', '==', user.uid)
                    .where('profileId', '==', profileId)
                    .get();
                
                if (!likeQuery.empty) {
                    // –õ–∞–π–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    const likeDoc = likeQuery.docs[0];
                    const existingType = likeDoc.data().type;
                    
                    if (existingType === type) {
                        // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫
                        await likeDoc.ref.delete();
                        
                        // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                        const field = type === 'like' ? 'likes' : 'dislikes';
                        await db.collection('profiles').doc(profileId).update({
                            [field]: firebase.firestore.FieldValue.increment(-1)
                        });
                    } else {
                        // –ú–µ–Ω—è–µ–º —Ç–∏–ø –ª–∞–π–∫–∞
                        await likeDoc.ref.update({ type: type });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                        const oldField = existingType === 'like' ? 'likes' : 'dislikes';
                        const newField = type === 'like' ? 'likes' : 'dislikes';
                        await db.collection('profiles').doc(profileId).update({
                            [oldField]: firebase.firestore.FieldValue.increment(-1),
                            [newField]: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∞–π–∫
                    await db.collection('likes').add({
                        userId: user.uid,
                        profileId: profileId,
                        type: type,
                        created: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    const field = type === 'like' ? 'likes' : 'dislikes';
                    await db.collection('profiles').doc(profileId).update({
                        [field]: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏
                const searchQuery = document.getElementById('public-search').value.toLowerCase();
                loadPublicProfiles(searchQuery);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø—Ä–æ—Ñ–∏–ª—é
        async function showComments(profileId) {
            const user = auth.currentUser;
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–∏–ª–µ
            let profileName = '–ü—Ä–æ—Ñ–∏–ª—å';
            try {
                const profileDoc = await db.collection('profiles').doc(profileId).get();
                if (profileDoc.exists) {
                    profileName = profileDoc.data().name || '–ü—Ä–æ—Ñ–∏–ª—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            }
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 16px;">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ${profileName}</h3>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="width: 30px; height: 30px; border: none; background: #f44336; color: white; border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1;">√ó</button>
                </div>
                
                ${user ? `
                    <div style="margin-bottom: 15px;">
                        <textarea id="comment-text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; min-height: 60px; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; resize: vertical;"></textarea>
                        <button onclick="addComment('${profileId}')" style="width: 100%; padding: 10px; margin-top: 5px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                ` : `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; text-align: center;">
                        –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                    </div>
                `}
                
                <div id="comments-list" style="min-height: 100px;">
                    <div style="text-align: center; padding: 20px; color: #666;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            loadComments(profileId);
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        async function loadComments(profileId) {
            const listDiv = document.getElementById('comments-list');
            
            try {
                const snapshot = await db.collection('comments')
                    .where('profileId', '==', profileId)
                    .orderBy('created', 'desc')
                    .limit(50)
                    .get();
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 32px; margin-bottom: 5px;">üí¨</div>
                            <div style="font-size: 14px;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                            <div style="font-size: 12px; margin-top: 3px;">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>
                        </div>
                    `;
                    return;
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ userId –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
                const userIds = new Set();
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    if (comment.userId) {
                        userIds.add(comment.userId);
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
                const userPhotos = {};
                if (userIds.size > 0) {
                    try {
                        const userIdsArray = Array.from(userIds);
                        for (let i = 0; i < userIdsArray.length; i += 10) {
                            const batch = userIdsArray.slice(i, i + 10);
                            const usersSnapshot = await db.collection('users')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            
                            usersSnapshot.forEach(doc => {
                                const userData = doc.data();
                                if (userData.photoURL) {
                                    userPhotos[doc.id] = userData.photoURL;
                                }
                            });
                        }
                    } catch (error) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    }
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const date = comment.created?.toDate().toLocaleString('ru-RU') || '';
                    const userName = comment.userName || '–ê–Ω–æ–Ω–∏–º';
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ –∏–Ω–∏—Ü–∏–∞–ª–∞–º
                    const avatarUrl = userPhotos[comment.userId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&size=32&background=random`;
                    
                    html += `
                        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                            <div style="display: flex; gap: 10px;">
                                <img src="${avatarUrl}" style="width: 32px; height: 32px; border-radius: 50%;" alt="${userName}">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 13px; margin-bottom: 2px;">${userName}</div>
                                    <div style="font-size: 11px; color: #999; margin-bottom: 5px;">${date}</div>
                                    <div style="font-size: 13px; color: #333;">${comment.text}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #f44336;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
                    </div>
                `;
            }
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        async function addComment(profileId) {
            const user = auth.currentUser;
            if (!user) {
                await showCustomAlert('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
                return;
            }
            
            const textarea = document.getElementById('comment-text');
            const text = textarea.value.trim();
            
            if (!text) {
                await showCustomAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                return;
            }
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                await db.collection('comments').add({
                    profileId: profileId,
                    userId: user.uid,
                    userName: user.displayName || '–ê–Ω–æ–Ω–∏–º',
                    userEmail: user.email,
                    text: text,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                await db.collection('profiles').doc(profileId).update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                textarea.value = '';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                loadComments(profileId);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                const searchQuery = document.getElementById('public-search')?.value.toLowerCase() || '';
                if (document.getElementById('public-profiles-list')) {
                    loadPublicProfiles(searchQuery);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function showSecurityInfo() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div style="font-size: 32px;">üîí</div>
                    <h3 style="margin: 0; font-size: 18px;">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google</h3>
                </div>
                
                <div style="font-size: 14px; line-height: 1.6; color: #333;">
                    <p style="margin: 0 0 10px 0;"><strong>‚úÖ –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ:</strong></p>
                    
                    <ul style="margin: 0 0 15px 0; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">
                            <strong>–ú—ã –Ω–µ –≤–∏–¥–∏–º –≤–∞—à –ø–∞—Ä–æ–ª—å</strong> ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Google
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Firebase</strong> ‚Äî —Å–µ—Ä–≤–∏—Å Google –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>–ú—ã —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π</strong> ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∫—Ä–æ–º–µ email –∏ –∏–º–µ–Ω–∏
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–π—Ç–∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç</strong> ‚Äî –∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ –ø—Ä–æ—Ñ–∏–ª–∏
                        </li>
                        <li style="margin-bottom: 8px;">
                            <strong>–û—Ç–∫—Ä—ã—Ç—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</strong> ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –Ω–∞ GitHub
                        </li>
                    </ul>
                    
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; border-left: 4px solid #2196f3;">
                        <strong>üí° –ß—Ç–æ –º—ã —Ö—Ä–∞–Ω–∏–º:</strong><br>
                        ‚Ä¢ –í–∞—à–∏ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤<br>
                        ‚Ä¢ –ñ—É—Ä–Ω–∞–ª—ã –¥–µ–π—Å—Ç–≤–∏–π<br>
                        ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    </div>
                </div>
                
                <button onclick="this.closest('[style*=fixed]').remove()" style="width: 100%; padding: 10px; margin-top: 15px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    –ü–æ–Ω—è—Ç–Ω–æ, —Å–ø–∞—Å–∏–±–æ!
                </button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        async function loadPublicProfile(profileId) {
            try {
                const doc = await db.collection('profiles').doc(profileId).get();
                
                if (!doc.exists) {
                    alert('‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const profile = doc.data();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –ø—É–±–ª–∏—á–Ω—ã–π
                if (!profile.public) {
                    alert('‚ùå –≠—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å –±–æ–ª—å—à–µ –Ω–µ –ø—É–±–ª–∏—á–Ω—ã–π');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–û–õ–ù–´–ô –ø—Ä–æ—Ñ–∏–ª—å (–∫–∞–∫ –∏–∑ —Ñ–∞–π–ª–∞ .hpg)
                if (profile.profile) {
                    // –û—á–∏—â–∞–µ–º localStorage –∏ –∂—É—Ä–Ω–∞–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                    localStorage.removeItem('hpg_profile');
                    localStorage.removeItem('hpg_journal');
                    
                    // –ü–∞—Ä—Å–∏–º –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª HPG (–≤–∫–ª—é—á–∞—è –∂—É—Ä–Ω–∞–ª!)
                    // parseFullFile —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
                    // - applyProfile()
                    // - updateJournalList()
                    // - updateMobileDisplay()
                    // - updateMobileResults()
                    // - updateMobileSaltsValues()
                    parseFullFile(profile.profile);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
                    if (profile.name) {
                        document.getElementById('file_filename').value = profile.name + '.hpg';
                    }
                    if (profile.description) {
                        document.getElementById('file_comment').value = profile.description;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                    if (typeof updateMobileFileInfo === 'function') {
                        updateMobileFileInfo();
                    }
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.querySelector('[style*="position: fixed"]')?.remove();
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —á—É–∂–æ–π
                const currentUser = auth.currentUser;
                if (currentUser && profile.userId !== currentUser.uid) {
                    alert(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å "${profile.name}" –æ—Ç ${profile.userName} –∑–∞–≥—Ä—É–∂–µ–Ω!\n\n‚ö†Ô∏è –≠—Ç–æ —á—É–∂–æ–π –ø—Ä–æ—Ñ–∏–ª—å. –í—ã –º–æ–∂–µ—Ç–µ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –≤ –æ–±–ª–∞–∫–µ.\n–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –ø–æ–¥ –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º.`);
                } else {
                    alert(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å "${profile.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑-–∑–∞ –ø—Ä–∞–≤, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
                try {
                    await db.collection('profiles').doc(profileId).update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - —Å—á–µ—Ç—á–∏–∫ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–Ω–µ—Ç –ø—Ä–∞–≤)');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }
        
        // ========== –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ –¢–ï–ì–û–í –î–õ–Ø –§–û–†–ú ==========
        
        let cachedTags = null;
        let selectedHPGAutocompleteIndex = {};
        
        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –∏–∑ Firebase
        async function getAllHPGExistingTags() {
            if (cachedTags) return cachedTags;
            
            try {
                const snapshot = await db.collection('profiles')
                    .where('public', '==', true)
                    .limit(500)
                    .get();
                
                const tagsSet = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.tags && Array.isArray(data.tags)) {
                        data.tags.forEach(tag => {
                            if (tag && tag.trim()) {
                                tagsSet.add(tag.trim().toLowerCase());
                            }
                        });
                    }
                });
                
                cachedTags = Array.from(tagsSet).sort();
                return cachedTags;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:', error);
                return [];
            }
        }
        
        async function updateHPGTagsAutocomplete(e, inputId) {
            const input = e.target;
            const autocompleteDiv = document.getElementById(`${inputId}-autocomplete`);
            
            if (!input || !autocompleteDiv) return;
            
            const fullText = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = fullText.substring(0, cursorPos);
            const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
            const currentTag = textBeforeCursor.substring(lastCommaIndex + 1).trim().toLowerCase();
            
            if (!currentTag || currentTag.length < 1) {
                autocompleteDiv.style.display = 'none';
                selectedHPGAutocompleteIndex[inputId] = -1;
                return;
            }
            
            const existingTags = await getAllHPGExistingTags();
            
            const enteredTags = fullText.split(',')
                .map(t => t.trim().toLowerCase())
                .filter(t => t && t !== currentTag);
            
            const matchingTags = existingTags.filter(tag => 
                tag.startsWith(currentTag) && !enteredTags.includes(tag)
            );
            
            if (matchingTags.length === 0) {
                autocompleteDiv.style.display = 'none';
                selectedHPGAutocompleteIndex[inputId] = -1;
                return;
            }
            
            autocompleteDiv.innerHTML = matchingTags.map((tag, index) => `
                <div class="autocomplete-item" data-tag="${escapeHtml(tag)}" data-index="${index}"
                     style="padding: 10px 12px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                     onmouseover="this.style.background='#f0f9f9'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectHPGTagFromAutocomplete('${escapeHtml(tag)}', '${inputId}')">
                    üè∑Ô∏è ${escapeHtml(tag)}
                </div>
            `).join('');
            
            autocompleteDiv.style.display = 'block';
            selectedHPGAutocompleteIndex[inputId] = -1;
        }
        
        function handleHPGTagsKeydown(e, inputId) {
            const autocompleteDiv = document.getElementById(`${inputId}-autocomplete`);
            if (!autocompleteDiv || autocompleteDiv.style.display === 'none') return;
            
            const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedHPGAutocompleteIndex[inputId] = Math.min((selectedHPGAutocompleteIndex[inputId] || -1) + 1, items.length - 1);
                updateHPGAutocompleteSelection(items, inputId);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedHPGAutocompleteIndex[inputId] = Math.max((selectedHPGAutocompleteIndex[inputId] || 0) - 1, -1);
                updateHPGAutocompleteSelection(items, inputId);
            } else if (e.key === 'Enter' && (selectedHPGAutocompleteIndex[inputId] || -1) >= 0) {
                e.preventDefault();
                const selectedTag = items[selectedHPGAutocompleteIndex[inputId]].getAttribute('data-tag');
                selectHPGTagFromAutocomplete(selectedTag, inputId);
            } else if (e.key === 'Escape') {
                autocompleteDiv.style.display = 'none';
                selectedHPGAutocompleteIndex[inputId] = -1;
            }
        }
        
        function updateHPGAutocompleteSelection(items, inputId) {
            items.forEach((item, index) => {
                if (index === selectedHPGAutocompleteIndex[inputId]) {
                    item.style.background = '#e3f2fd';
                    item.style.fontWeight = '600';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = 'white';
                    item.style.fontWeight = 'normal';
                }
            });
        }
        
        function selectHPGTagFromAutocomplete(tag, inputId) {
            const input = document.getElementById(inputId);
            const autocompleteDiv = document.getElementById(`${inputId}-autocomplete`);
            
            if (!input) return;
            
            const fullText = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = fullText.substring(0, cursorPos);
            const textAfterCursor = fullText.substring(cursorPos);
            
            const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
            
            let newText;
            if (lastCommaIndex >= 0) {
                newText = textBeforeCursor.substring(0, lastCommaIndex + 1) + ' ' + tag;
                if (textAfterCursor.trim()) {
                    newText += ', ' + textAfterCursor.trim();
                }
            } else {
                newText = tag;
                if (textAfterCursor.trim()) {
                    newText += ', ' + textAfterCursor.trim();
                }
            }
            
            input.value = newText;
            
            const newCursorPos = newText.indexOf(tag) + tag.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            if (autocompleteDiv) {
                autocompleteDiv.style.display = 'none';
            }
            selectedHPGAutocompleteIndex[inputId] = -1;
            
            input.focus();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö ‚â§768px) -->
    <div class="mobile-version">
        <div class="mobile-header">
            <div class="mobile-header-title">
                <span>üå± HPG</span>
                <span style="font-size: 13px;">Hydroponic Profile Generator</span>
            </div>
            <div class="mobile-file-info">
                <div class="mobile-file-name" id="mobile-file-name">default.hpg</div>
                <div class="mobile-file-desc" id="mobile-file-desc">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
            </div>
            <div class="mobile-ratios-info">
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">EC:</span><span class="mobile-ratio-value" id="mobile-ec">2.31</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">P:</span><span class="mobile-ratio-value" id="mobile-p">40</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">Cl:</span><span class="mobile-ratio-value" id="mobile-cl">0</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">NH4/NO3:</span><span class="mobile-ratio-value" id="mobile-nh4no3">0.10</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">K/N:</span><span class="mobile-ratio-value" id="mobile-kn">1.22</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">K/Ca:</span><span class="mobile-ratio-value" id="mobile-kca">1.11</span></span>
                <span class="mobile-ratio-item"><span class="mobile-ratio-label">K/Mg:</span><span class="mobile-ratio-value" id="mobile-kmg">0.28</span></span>
            </div>
            <div class="mobile-header-tabs">
                <button class="mobile-tab-button active" onclick="switchMobileTab('main')">–û—Å–Ω–æ–≤–Ω–∞—è</button>
                <button class="mobile-tab-button" onclick="switchMobileTab('journal')">–ñ—É—Ä–Ω–∞–ª</button>
            </div>
        </div>
        
        <div class="mobile-content-wrapper">

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä -->
        <div id="mobile-info-banner" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin: 10px; border-radius: 5px; font-size: 13px; line-height: 1.5; position: relative; display: none;">
            <button onclick="closeMobileBanner()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; font-size: 20px; cursor: pointer; color: #856404; padding: 0; width: 24px; height: 24px; line-height: 20px;">√ó</button>
            <strong>üì± –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</strong><br>
            –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç –Ω–∞–≤–µ—Å–æ–∫ –ø–æ –ø—Ä–æ—Ñ–∏–ª—é. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Å—Ç–∞–≤–æ–≤ —Å–æ–ª–µ–π, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç—ã, –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä, –∂—É—Ä–Ω–∞–ª) –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏–ª–∏ –ø–ª–∞–Ω—à–µ—Ç–µ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (‚â•768px).
        </div>
        
        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
        <div class="mobile-accordion">
            <div class="mobile-accordion-header" onclick="toggleAccordion('macro')">
                <span>üåø –ú–∞–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã (–º–≥/–ª)</span>
                <span class="mobile-accordion-icon" id="icon-macro">‚ñº</span>
            </div>
            <div class="mobile-accordion-content" id="content-macro">
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">N (–ê–∑–æ—Ç):</div>
                        <input type="number" id="mobile-N-display" step="1" oninput="syncMacroToDesktop('N', this.value)" style="width: 100%; padding: 10px 10px 10px 100px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">NO3 (–ù–∏—Ç—Ä–∞—Ç):</div>
                        <input type="number" id="mobile-NO3-display" step="1" oninput="syncMacroToDesktop('NO3', this.value)" style="width: 100%; padding: 10px 10px 10px 120px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">NH4 (–ê–º–º–æ–Ω–∏–π):</div>
                        <input type="number" id="mobile-NH4-display" step="1" oninput="syncMacroToDesktop('NH4', this.value)" style="width: 100%; padding: 10px 10px 10px 140px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">P (–§–æ—Å—Ñ–æ—Ä):</div>
                        <input type="number" id="mobile-P-display" step="1" oninput="syncMacroToDesktop('P', this.value)" style="width: 100%; padding: 10px 10px 10px 110px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">K (–ö–∞–ª–∏–π):</div>
                        <input type="number" id="mobile-K-display" step="1" oninput="syncMacroToDesktop('K', this.value)" style="width: 100%; padding: 10px 10px 10px 100px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Ca (–ö–∞–ª—å—Ü–∏–π):</div>
                        <input type="number" id="mobile-Ca-display" step="1" oninput="syncMacroToDesktop('Ca', this.value)" style="width: 100%; padding: 10px 10px 10px 120px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Mg (–ú–∞–≥–Ω–∏–π):</div>
                        <input type="number" id="mobile-Mg-display" step="1" oninput="syncMacroToDesktop('Mg', this.value)" style="width: 100%; padding: 10px 10px 10px 120px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">S (–°–µ—Ä–∞):</div>
                        <input type="number" id="mobile-S-display" step="1" oninput="syncMacroToDesktop('S', this.value)" style="width: 100%; padding: 10px 10px 10px 90px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Cl (–•–ª–æ—Ä):</div>
                        <input type="number" id="mobile-Cl-display" step="1" oninput="syncMacroToDesktop('Cl', this.value)" style="width: 100%; padding: 10px 10px 10px 100px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã -->
        <div class="mobile-accordion">
            <div class="mobile-accordion-header" onclick="toggleAccordion('micro')">
                <span>üî¨ –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã (–º–∫–≥/–ª)</span>
                <span class="mobile-accordion-icon" id="icon-micro">‚ñº</span>
            </div>
            <div class="mobile-accordion-content" id="content-micro">
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Fe (–ñ–µ–ª–µ–∑–æ):</div>
                        <input type="number" id="mobile-Fe-display" step="10" oninput="syncMicroToDesktop('Fe', this.value)" style="width: 100%; padding: 10px 10px 10px 120px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Mn (–ú–∞—Ä–≥–∞–Ω–µ—Ü):</div>
                        <input type="number" id="mobile-Mn-display" step="10" oninput="syncMicroToDesktop('Mn', this.value)" style="width: 100%; padding: 10px 10px 10px 140px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">B (–ë–æ—Ä):</div>
                        <input type="number" id="mobile-B-display" step="10" oninput="syncMicroToDesktop('B', this.value)" style="width: 100%; padding: 10px 10px 10px 90px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Zn (–¶–∏–Ω–∫):</div>
                        <input type="number" id="mobile-Zn-display" step="10" oninput="syncMicroToDesktop('Zn', this.value)" style="width: 100%; padding: 10px 10px 10px 100px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Cu (–ú–µ–¥—å):</div>
                        <input type="number" id="mobile-Cu-display" step="10" oninput="syncMicroToDesktop('Cu', this.value)" style="width: 100%; padding: 10px 10px 10px 100px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Mo (–ú–æ–ª–∏–±–¥–µ–Ω):</div>
                        <input type="number" id="mobile-Mo-display" step="10" oninput="syncMicroToDesktop('Mo', this.value)" style="width: 100%; padding: 10px 10px 10px 140px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Co (–ö–æ–±–∞–ª—å—Ç):</div>
                        <input type="number" id="mobile-Co-display" step="10" oninput="syncMicroToDesktop('Co', this.value)" style="width: 100%; padding: 10px 10px 10px 130px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
                <div class="mobile-input-group">
                    <div style="position: relative;">
                        <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: bold; color: #333; pointer-events: none; z-index: 1;">Si (–ö—Ä–µ–º–Ω–∏–π):</div>
                        <input type="number" id="mobile-Si-display" step="10" oninput="syncMicroToDesktop('Si', this.value)" style="width: 100%; padding: 10px 10px 10px 120px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: right; font-weight: bold;">
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω: –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
        <div class="mobile-accordion">
            <div class="mobile-accordion-header" onclick="toggleAccordion('ratios')">
                <span>üìä –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤</span>
                <span class="mobile-accordion-icon" id="icon-ratios">‚ñº</span>
            </div>
            <div class="mobile-accordion-content" id="content-ratios">
                <div id="mobile-ratios-content"></div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∞–≤–µ—Å–∫–∏ -->
        <div class="mobile-accordion">
            <div class="mobile-accordion-header" onclick="toggleAccordion('results')">
                <span>‚öñÔ∏è –ù–∞–≤–µ—Å–∫–∏ —Å–æ–ª–µ–π</span>
                <span class="mobile-accordion-icon open" id="icon-results">‚ñº</span>
            </div>
            <div class="mobile-accordion-content open" id="content-results">
                <div id="mobile-results-content"></div>
            </div>
        </div>

        <!-- –û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ -->
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div class="mobile-input-group">
                <label>–û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–ª–∏—Ç—Ä—ã):</label>
                <input type="number" id="mobile-volume-display" step="0.1" oninput="syncVolumeToDesktop(this.value)" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <button onclick="openMobileFileOptionsModal()" style="width: 100%; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; font-size: 15px; font-weight: bold;">
                üìÇ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ –∏–∑ –æ–±–ª–∞–∫–∞</p>
        </div>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö) -->
        <div id="mobile-logout-button" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="position: relative;">
                    <img id="mobile-user-avatar" src="" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; object-fit: cover;">
                    <div id="mobile-user-avatar-placeholder" style="width: 60px; height: 60px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">üë§</div>
                </div>
                <div style="flex: 1; margin-left: 15px; color: white;">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 2px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
                    <div id="mobile-user-name" style="font-size: 16px; font-weight: bold; margin-bottom: 3px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div id="mobile-user-email" style="font-size: 11px; opacity: 0.85;"></div>
                </div>
            </div>
            <button onclick="logout()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.25); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 14px; font-weight: bold; backdrop-filter: blur(10px); transition: all 0.3s;">
                üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>
        
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="mobile-journal-container" id="mobile-journal-container">
            <div class="mobile-journal-list" id="mobile-journal-list">
                <div class="mobile-journal-empty">üìã –ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="mobile-info" style="display: none;">
            <div class="mobile-notice">
                <h3>‚ö†Ô∏è –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</h3>
                <p>–≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–≤–µ—Å–æ–∫.</p>
                <p>–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ.</p>
                <a href="https://wega-project.github.io/wega-hpg/hpg.html" class="mobile-link">
                    –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é
                </a>
            </div>

            <div class="mobile-features">
                <h4>‚ú® –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤–∫–ª—é—á–∞–µ—Ç:</h4>
                <ul>
                    <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Å—Ç–∞–≤–æ–≤ —Å–æ–ª–µ–π</li>
                    <li>–ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤</li>
                    <li>–†–∞—Å—á–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–æ–≤</li>
                    <li>–ö–æ—Ä—Ä–µ–∫—Ç–æ—Ä —Ä–∞—Å—Ç–≤–æ—Ä–æ–≤</li>
                    <li>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</li>
                    <li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π</li>
                </ul>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 12px;">
            <p class="mobile-version">–í–µ—Ä—Å–∏—è: <span id="mobile-version"></span></p>
            <p>¬© <a href="https://github.com/WEGA-project" target="_blank" style="color: #666; text-decoration: none;">WEGA-PROJECT</a></p>
        </div>
    </div>
</body>
</html>
